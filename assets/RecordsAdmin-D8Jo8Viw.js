import{r as d,j as e}from"./vendor-ui-CMUPCwTD.js";import{b as X,u as J,c as x}from"./vendor-query-WtxIVPOV.js";import{u as W,i as Y,g as o,m as Z,B as _,C as N,b as C,c as F,d as I,f as E}from"./index-T_agY1No.js";import{I as p}from"./input-3OPSM2FB.js";import{S as ee}from"./switch-B63MwlLq.js";import{B}from"./badge-CHYaj2Uv.js";import{T as k,a as M,b,c as i,d as P,e as n}from"./table-CaA_WKH7.js";import{S as U,a as V,b as q,c as z,d as D}from"./select-CiW2Vdzo.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-BHfjz9SJ.js";import"./vendor-supabase-CrvtPqJM.js";import"./check-DdXCpPtH.js";const H=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],re=a=>a==="user"?"Compte":"Ancien",se=a=>{if(!a)return"-";const t=new Date(a);return Number.isNaN(t.getTime())?a:t.toLocaleDateString("fr-FR")+" "+t.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},te=a=>{switch(a){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},ae=a=>{switch(a){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return a}};function fe(){const a=W(r=>r.role),{toast:t}=Y(),K=X(),[c,m]=d.useState({display_name:"",iuf:"",sex:"",birthdate:""}),[h,A]=d.useState([]),[S,T]=d.useState(!1),[j,w]=d.useState(null),f=a==="coach"||a==="admin",{data:R=[],refetch:g}=J({queryKey:["import-logs"],queryFn:()=>o.getImportLogs({limit:20}),enabled:f}),u=d.useCallback(async()=>{if(f){T(!0),w(null);try{const r=await o.getClubRecordSwimmers();A(r)}catch(r){const s=Z(r,"Impossible de charger la liste.");w(s.message),A([])}finally{T(!1)}}},[f]);d.useEffect(()=>{u()},[u]);const $=x({mutationFn:()=>o.createClubRecordSwimmer({display_name:c.display_name.trim(),iuf:c.iuf.trim()||null,sex:c.sex?c.sex:null,birthdate:c.birthdate||null,is_active:!0}),onSuccess:()=>{t({title:"Nageur ajouté"}),m({display_name:"",iuf:"",sex:"",birthdate:""}),u()},onError:()=>{t({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),O=x({mutationFn:({id:r,payload:s})=>o.updateClubRecordSwimmer(r,s),onSuccess:()=>{u(),t({title:"Sauvegardé"})},onError:()=>{t({title:"Mise à jour impossible",variant:"destructive"})}}),Q=x({mutationFn:({userId:r,payload:s})=>o.updateClubRecordSwimmerForUser(r,s),onSuccess:()=>{u(),t({title:"Sauvegardé"})},onError:()=>{t({title:"Mise à jour impossible",variant:"destructive"})}}),v=(r,s)=>{if(r.source_type==="user"&&r.user_id){Q.mutate({userId:r.user_id,payload:s});return}r.id&&O.mutate({id:r.id,payload:s})},y=x({mutationFn:()=>o.importClubRecords(),onSuccess:r=>{t({title:"Import terminé",description:r?`Performances importées: ${r.imported??0}. Erreurs: ${r.errors??0}.`:""}),u(),g(),K.invalidateQueries({queryKey:["club-records"]})},onError:()=>{t({title:"Import impossible",variant:"destructive"}),g()}}),L=x({mutationFn:({iuf:r,name:s})=>o.importSingleSwimmer(r,s),onSuccess:(r,s)=>{t({title:`Import de ${s.name??s.iuf}`,description:`${r.total_found} performances trouvées, ${r.new_imported} nouvelles importées.`}),g()},onError:(r,s)=>{t({title:`Erreur import ${s.name??s.iuf}`,variant:"destructive"}),g()}}),G=d.useMemo(()=>[...h].sort((r,s)=>r.source_type!==s.source_type?r.source_type.localeCompare(s.source_type):r.display_name.localeCompare(s.display_name)),[h]);return f?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"G\\u00e9rez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsx(_,{onClick:()=>y.mutate(),disabled:y.isPending,children:y.isPending?"Import en cours...":"Mettre à jour les records"})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsx(F,{children:"Ajouter un ancien nageur"}),e.jsx(I,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(E,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_1fr_auto]",children:[e.jsx(p,{placeholder:"Nom du nageur",value:c.display_name,onChange:r=>m(s=>({...s,display_name:r.target.value}))}),e.jsx(p,{placeholder:"IUF",value:c.iuf,onChange:r=>m(s=>({...s,iuf:r.target.value}))}),e.jsxs(U,{value:c.sex,onValueChange:r=>m(s=>({...s,sex:r})),children:[e.jsx(V,{children:e.jsx(q,{placeholder:"Sexe"})}),e.jsx(z,{children:H.map(r=>e.jsx(D,{value:r.value,children:r.label},r.value))})]}),e.jsx(p,{type:"date",value:c.birthdate,onChange:r=>m(s=>({...s,birthdate:r.target.value}))}),e.jsx(_,{onClick:()=>$.mutate(),disabled:!c.display_name.trim()||$.isPending,children:"Ajouter"})]})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsx(F,{children:"Liste des nageurs suivis"}),e.jsx(I,{children:"Mettre \\u00e0 jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(E,{children:[S&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(r=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},r))}),j&&e.jsx("p",{className:"text-sm text-destructive",children:j}),!S&&!j&&h.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!S&&!j&&h.length>0&&e.jsxs(k,{children:[e.jsx(M,{children:e.jsxs(b,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Source"}),e.jsx(i,{children:"IUF"}),e.jsx(i,{children:"Sexe"}),e.jsx(i,{children:"Naissance"}),e.jsx(i,{children:"Actif"}),e.jsx(i,{children:"Actions"})]})}),e.jsx(P,{children:G.map(r=>{const s=r.id??`user-${r.user_id??"unknown"}`;return e.jsxs(b,{children:[e.jsx(n,{className:"font-medium",children:r.display_name}),e.jsx(n,{children:e.jsx(B,{variant:r.source_type==="manual"?"secondary":"outline",children:re(r.source_type)})}),e.jsx(n,{children:e.jsx(p,{defaultValue:r.iuf??"",onBlur:l=>v(r,{iuf:l.target.value.trim()||null})},`${s}-${r.iuf??""}`)}),e.jsx(n,{children:e.jsxs(U,{value:r.sex??"",onValueChange:l=>v(r,{sex:l||null}),children:[e.jsx(V,{children:e.jsx(q,{placeholder:"Sexe"})}),e.jsx(z,{children:H.map(l=>e.jsx(D,{value:l.value,children:l.label},l.value))})]})}),e.jsx(n,{children:e.jsx(p,{type:"date",defaultValue:r.birthdate??"",onBlur:l=>v(r,{birthdate:l.target.value||null})},`${s}-${r.birthdate??""}`)}),e.jsx(n,{children:e.jsx(ee,{checked:!!r.is_active,onCheckedChange:l=>v(r,{is_active:l})})}),e.jsx(n,{children:r.iuf?e.jsx(_,{size:"sm",variant:"outline",disabled:L.isPending,onClick:()=>L.mutate({iuf:r.iuf,name:r.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},s)})})]})]})]}),e.jsxs(N,{children:[e.jsxs(C,{children:[e.jsx(F,{children:"Historique des imports"}),e.jsx(I,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(E,{children:R.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectu\\u00e9."}):e.jsxs(k,{children:[e.jsx(M,{children:e.jsxs(b,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Statut"}),e.jsx(i,{children:"Trouv\\u00e9es"}),e.jsx(i,{children:"Import\\u00e9es"}),e.jsx(i,{children:"Date"}),e.jsx(i,{children:"Erreur"})]})}),e.jsx(P,{children:R.map(r=>e.jsxs(b,{children:[e.jsx(n,{className:"font-medium",children:r.swimmer_name??r.swimmer_iuf}),e.jsx(n,{children:e.jsx(B,{variant:te(r.status),children:ae(r.status)})}),e.jsx(n,{children:r.performances_found??"-"}),e.jsx(n,{children:r.performances_imported??"-"}),e.jsx(n,{className:"text-xs",children:se(r.started_at)}),e.jsx(n,{className:"max-w-[200px] truncate text-xs text-destructive",children:r.error_message??""})]},r.id))})]})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Acc\\u00e8s r\\u00e9serv\\u00e9 aux coachs."})]})}export{fe as default};
