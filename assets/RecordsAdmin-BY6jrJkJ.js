import{r as d,j as e}from"./vendor-ui-DJQMR4VV.js";import{b as me,u as xe,c as j}from"./vendor-query-BT4y-huw.js";import{u as he,f as pe,d as o,n as je,B as g,r as ge,a as y,C as E,g as I,h as R,l as L,i as T,I as x,w as fe}from"./index-p3lMzPTv.js";import{S as ae}from"./switch-kXQ4_pJp.js";import{B as V}from"./badge-BHPa30oT.js";import{T as z,a as U,b,c as n,d as q,e as i}from"./table-BKqIaDGu.js";import{S as K,a as Q,b as H,c as O,d as G}from"./select-BFT7QT53.js";import{E as ve}from"./eye-CQqGk55G.js";import{C as be}from"./chevron-up-VxPSOCWt.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Db4xOvcx.js";import"./vendor-supabase-D7B1G6YZ.js";import"./check-BguUDhs-.js";const Y=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],ne=l=>l==="user"?"Compte":"Ancien",_e=l=>{if(!l)return"-";const a=new Date(l);return Number.isNaN(a.getTime())?l:a.toLocaleDateString("fr-FR")+" "+a.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},ie=l=>{if(!l)return"Jamais";const a=new Date(l);return Number.isNaN(a.getTime())?l:a.toLocaleDateString("fr-FR")},ye=(l,a=30)=>{if(!l)return!0;const f=new Date(l);return Number.isNaN(f.getTime())?!0:Date.now()-f.getTime()>a*24*60*60*1e3},Ne=l=>{switch(l){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},Se=l=>{switch(l){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return l}};function Pe(){const l=he(s=>s.role),{toast:a}=pe(),f=me(),[m,N]=d.useState({display_name:"",iuf:"",sex:""}),[v,J]=d.useState([]),[S,X]=d.useState(!1),[C,W]=d.useState(null),[Z,le]=d.useState(!1),[D,ce]=d.useState(!1),[h,$]=d.useState(null),F=l==="coach"||l==="admin",B=l==="admin",{data:ee=[],refetch:w}=xe({queryKey:["import-logs"],queryFn:()=>o.getImportLogs({limit:20}),enabled:F}),p=d.useCallback(async()=>{if(F){X(!0),W(null);try{await o.syncClubRecordSwimmersFromUsers();const s=await o.getClubRecordSwimmers();J(s)}catch(s){const t=je(s,"Impossible de charger la liste.");W(t.message),J([])}finally{X(!1)}}},[F]);d.useEffect(()=>{p()},[p]),d.useEffect(()=>{B&&o.getAppSettings("import_rate_limits").then(s=>{s&&$(s)})},[B]);const se=j({mutationFn:()=>o.createClubRecordSwimmer({display_name:m.display_name.trim(),iuf:m.iuf.trim()||null,sex:m.sex?m.sex:null,is_active:!0}),onSuccess:()=>{a({title:"Nageur ajouté"}),N({display_name:"",iuf:"",sex:""}),p()},onError:()=>{a({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),de=j({mutationFn:({id:s,payload:t})=>o.updateClubRecordSwimmer(s,t),onSuccess:()=>{p(),a({title:"Sauvegardé"})},onError:()=>{a({title:"Mise à jour impossible",variant:"destructive"})}}),oe=j({mutationFn:({userId:s,payload:t})=>o.updateClubRecordSwimmerForUser(s,t),onSuccess:()=>{p(),a({title:"Sauvegardé"})},onError:()=>{a({title:"Mise à jour impossible",variant:"destructive"})}}),u=(s,t)=>{if(s.source_type==="user"&&s.user_id){oe.mutate({userId:s.user_id,payload:t});return}s.id&&de.mutate({id:s.id,payload:t})},P=j({mutationFn:()=>o.importClubRecords(),onSuccess:s=>{const t=s?.summary??s,r=s?.recalc_stats;let c=t?`Performances importées: ${t.imported??0}. Erreurs: ${t.errors??0}.`:"";r&&(c+=` Records: ${r.club_records_upserted} (${r.processed} perfs traitées).`,r.skipped_no_age&&(c+=` Ignorées (pas d'âge): ${r.skipped_no_age}.`)),a({title:"Import terminé",description:c}),p(),w(),f.invalidateQueries({queryKey:["club-records"]})},onError:s=>{const t=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:"Import impossible";a({title:t,variant:"destructive"}),w()}}),te=j({mutationFn:({iuf:s,name:t})=>o.importSingleSwimmer(s,t),onSuccess:(s,t)=>{a({title:`Import de ${t.name??t.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),w(),o.recalculateClubRecords().then(()=>{f.invalidateQueries({queryKey:["club-records"]})}),p()},onError:(s,t)=>{const r=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:`Erreur import ${t.name??t.iuf}`;a({title:r,variant:"destructive"}),w()}}),re=j({mutationFn:s=>o.updateAppSettings("import_rate_limits",s),onSuccess:()=>{a({title:"Limites sauvegardées"})},onError:()=>{a({title:"Erreur de sauvegarde",variant:"destructive"})}}),{activeSwimmers:ue,inactiveSwimmers:_}=d.useMemo(()=>{const s=[...v].sort((t,r)=>t.source_type!==r.source_type?t.source_type.localeCompare(r.source_type):t.display_name.localeCompare(r.display_name));return{activeSwimmers:s.filter(t=>t.is_active),inactiveSwimmers:s.filter(t=>!t.is_active)}},[v]),A=d.useMemo(()=>v.filter(s=>s.is_active&&(!s.iuf||!s.sex||!s.birthdate)).length,[v]),M=j({mutationFn:()=>o.recalculateClubRecords(),onSuccess:s=>{const t=s?.recalc_stats,r=t?`${t.swimmers_with_sex} nageur(s), ${t.total_performances} perfs, ${t.processed} traitées, ${t.club_records_upserted} records.${t.skipped_no_swimmer?` Ignorées (pas de nageur): ${t.skipped_no_swimmer}.`:""}${t.skipped_no_event_code?` Ignorées (épreuve inconnue): ${t.skipped_no_event_code}.`:""}${t.skipped_no_age?` Ignorées (pas d'âge): ${t.skipped_no_age}.`:""}${t.unmapped_event_codes?.length?` Épreuves inconnues: ${t.unmapped_event_codes.join(", ")}`:""}`:"";a({title:"Records recalculés",description:r}),f.invalidateQueries({queryKey:["club-records"]})},onError:()=>{a({title:"Erreur de recalcul",variant:"destructive"})}});return F?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gérez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>{window.location.hash="#/records-club"},children:[e.jsx(ve,{className:"h-4 w-4 mr-1"}),"Voir les records"]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>M.mutate(),disabled:M.isPending,children:[e.jsx(ge,{className:y("h-4 w-4 mr-1",M.isPending&&"animate-spin")}),"Recalculer"]}),e.jsx(g,{onClick:()=>P.mutate(),disabled:P.isPending,children:P.isPending?"Import en cours...":"Mettre à jour les records"})]})]}),e.jsxs(E,{children:[e.jsxs(I,{children:[e.jsx(R,{children:"Ajouter un ancien nageur"}),e.jsx(L,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(T,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_auto]",children:[e.jsx(x,{placeholder:"Nom du nageur",value:m.display_name,onChange:s=>N(t=>({...t,display_name:s.target.value}))}),e.jsx(x,{placeholder:"IUF",value:m.iuf,onChange:s=>N(t=>({...t,iuf:s.target.value}))}),e.jsxs(K,{value:m.sex,onValueChange:s=>N(t=>({...t,sex:s})),children:[e.jsx(Q,{children:e.jsx(H,{placeholder:"Sexe"})}),e.jsx(O,{children:Y.map(s=>e.jsx(G,{value:s.value,children:s.label},s.value))})]}),e.jsx(g,{onClick:()=>se.mutate(),disabled:!m.display_name.trim()||se.isPending,children:"Ajouter"})]})]}),e.jsxs(E,{children:[e.jsxs(I,{children:[e.jsx(R,{children:"Liste des nageurs suivis"}),e.jsx(L,{children:"Mettre à jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(T,{children:[!S&&A>0&&e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-300 bg-amber-50 p-3 text-sm text-amber-800 dark:border-amber-700 dark:bg-amber-950/30 dark:text-amber-300",children:[e.jsxs("strong",{children:[A," nageur",A>1?"s":""," incomplet",A>1?"s":""]})," ","— les champs IUF, Sexe et Année de naissance sont requis pour le calcul des records."]}),S&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s))}),C&&e.jsx("p",{className:"text-sm text-destructive",children:C}),!S&&!C&&v.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!S&&!C&&v.length>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(b,{children:[e.jsx(n,{children:"Nageur"}),e.jsx(n,{children:"Source"}),e.jsx(n,{children:"IUF"}),e.jsx(n,{children:"Sexe"}),e.jsx(n,{children:"Année naiss."}),e.jsx(n,{children:"Dernière maj"}),e.jsx(n,{children:"Actif"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(q,{children:ue.map(s=>{const t=s.id??`user-${s.user_id??"unknown"}`,r=ye(s.last_imported_at);return e.jsxs(b,{className:r?"bg-amber-50/50 dark:bg-amber-950/10":"",children:[e.jsx(i,{className:"font-medium",children:s.display_name}),e.jsx(i,{children:e.jsx(V,{variant:s.source_type==="manual"?"secondary":"outline",children:ne(s.source_type)})}),e.jsx(i,{children:e.jsx(x,{defaultValue:s.iuf??"",onBlur:c=>u(s,{iuf:c.target.value.trim()||null}),className:y("w-24",!s.iuf&&"ring-2 ring-destructive/50")},`${t}-${s.iuf??""}`)}),e.jsx(i,{children:e.jsxs(K,{value:s.sex??"",onValueChange:c=>u(s,{sex:c||null}),children:[e.jsx(Q,{className:y("w-28",!s.sex&&"ring-2 ring-destructive/50"),children:e.jsx(H,{placeholder:"Sexe"})}),e.jsx(O,{children:Y.map(c=>e.jsx(G,{value:c.value,children:c.label},c.value))})]})}),e.jsx(i,{children:e.jsx(x,{type:"number",placeholder:"Année",defaultValue:s.birthdate?new Date(s.birthdate).getFullYear():"",onBlur:c=>{const k=c.target.value.trim();k&&/^\d{4}$/.test(k)?u(s,{birthdate:`${k}-01-01`}):k||u(s,{birthdate:null})},className:y("w-20",!s.birthdate&&"ring-2 ring-amber-400/50")},`${t}-birth-${s.birthdate??""}`)}),e.jsx(i,{children:e.jsx("span",{className:r?"text-amber-600 dark:text-amber-400 text-xs font-medium":"text-xs text-muted-foreground",children:ie(s.last_imported_at)})}),e.jsx(i,{children:e.jsx(ae,{checked:!!s.is_active,onCheckedChange:c=>u(s,{is_active:c})})}),e.jsx(i,{children:s.iuf?e.jsx(g,{size:"sm",variant:"outline",disabled:te.isPending,onClick:()=>te.mutate({iuf:s.iuf,name:s.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},t)})})]})}),_.length>0&&e.jsxs("div",{className:"mt-4 border-t pt-2",children:[e.jsxs("button",{type:"button",onClick:()=>ce(!D),className:"flex w-full items-center gap-2 rounded-md px-2 py-2 text-sm font-medium text-muted-foreground hover:bg-muted/50 transition-colors",children:[e.jsx(be,{className:y("h-4 w-4 transition-transform",D&&"rotate-180")}),"Archive (",_.length," nageur",_.length>1?"s":""," inactif",_.length>1?"s":"",")"]}),D&&e.jsx("div",{className:"mt-2 overflow-x-auto opacity-75",children:e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(b,{children:[e.jsx(n,{children:"Nageur"}),e.jsx(n,{children:"Source"}),e.jsx(n,{children:"IUF"}),e.jsx(n,{children:"Sexe"}),e.jsx(n,{children:"Année naiss."}),e.jsx(n,{children:"Dernière maj"}),e.jsx(n,{children:"Actif"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(q,{children:_.map(s=>{const t=s.id??`user-${s.user_id??"unknown"}`;return e.jsxs(b,{className:"text-muted-foreground",children:[e.jsx(i,{className:"font-medium",children:s.display_name}),e.jsx(i,{children:e.jsx(V,{variant:s.source_type==="manual"?"secondary":"outline",children:ne(s.source_type)})}),e.jsx(i,{children:e.jsx(x,{defaultValue:s.iuf??"",onBlur:r=>u(s,{iuf:r.target.value.trim()||null}),className:"w-24"},`${t}-${s.iuf??""}`)}),e.jsx(i,{children:e.jsxs(K,{value:s.sex??"",onValueChange:r=>u(s,{sex:r||null}),children:[e.jsx(Q,{className:"w-28",children:e.jsx(H,{placeholder:"Sexe"})}),e.jsx(O,{children:Y.map(r=>e.jsx(G,{value:r.value,children:r.label},r.value))})]})}),e.jsx(i,{children:e.jsx(x,{type:"number",placeholder:"Année",defaultValue:s.birthdate?new Date(s.birthdate).getFullYear():"",onBlur:r=>{const c=r.target.value.trim();c&&/^\d{4}$/.test(c)?u(s,{birthdate:`${c}-01-01`}):c||u(s,{birthdate:null})},className:"w-20"},`${t}-birth-${s.birthdate??""}`)}),e.jsx(i,{children:e.jsx("span",{className:"text-xs text-muted-foreground",children:ie(s.last_imported_at)})}),e.jsx(i,{children:e.jsx(ae,{checked:!1,onCheckedChange:r=>u(s,{is_active:r})})}),e.jsx(i,{children:e.jsx("span",{className:"text-xs text-muted-foreground",children:"Inactif"})})]},t)})})]})})]})]})]})]}),e.jsxs(E,{children:[e.jsxs(I,{children:[e.jsx(R,{children:"Historique des imports"}),e.jsx(L,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(T,{children:ee.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectué."}):e.jsxs(z,{children:[e.jsx(U,{children:e.jsxs(b,{children:[e.jsx(n,{children:"Nageur"}),e.jsx(n,{children:"Statut"}),e.jsx(n,{children:"Trouvées"}),e.jsx(n,{children:"Importées"}),e.jsx(n,{children:"Date"}),e.jsx(n,{children:"Erreur"})]})}),e.jsx(q,{children:ee.map(s=>e.jsxs(b,{children:[e.jsx(i,{className:"font-medium",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(i,{children:e.jsx(V,{variant:Ne(s.status),children:Se(s.status)})}),e.jsx(i,{children:s.performances_found??"-"}),e.jsx(i,{children:s.performances_imported??"-"}),e.jsx(i,{className:"text-xs",children:_e(s.started_at)}),e.jsx(i,{className:"max-w-[200px] truncate text-xs text-destructive",children:s.error_message??""})]},s.id))})]})})]}),B&&e.jsxs(E,{children:[e.jsxs(I,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(R,{children:"Paramètres d'import"}),e.jsx(L,{children:"Limites mensuelles d'import par rôle."})]}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>le(!Z),children:e.jsx(fe,{className:"h-4 w-4"})})]}),Z&&h&&e.jsxs(T,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Coach (par mois)"}),e.jsx(x,{type:"number",value:h.coach_monthly,onChange:s=>$({...h,coach_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Nageur (par mois)"}),e.jsx(x,{type:"number",value:h.athlete_monthly,onChange:s=>$({...h,athlete_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Admin (par mois, -1=illimité)"}),e.jsx(x,{type:"number",value:h.admin_monthly,onChange:s=>$({...h,admin_monthly:Number(s.target.value)}),min:-1})]})]}),e.jsx(g,{size:"sm",onClick:()=>re.mutate(h),disabled:re.isPending,children:"Enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Accès réservé aux coachs."})]})}export{Pe as default};
