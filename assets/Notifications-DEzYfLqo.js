import{c as W,r as T,u as L,d as F,j as e}from"./vendor-query-BiSH4r2z.js";import{c as J,u as P,f as V,J as k,H as C,M as D,C as x,h,i as z,k as H,y as O,B as X,d as _}from"./index-6muuOvs8.js";import{B as $}from"./badge-DL9uOR-m.js";import{T as Y}from"./textarea-CFzKIu7Y.js";import{A as Z}from"./arrow-left-DdkH37No.js";import{f as E}from"./format-B9mPVj_w.js";import{f as G}from"./fr-CFyqyHeU.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],se=J("send",ee),re=(r,t)=>r.target_group_id?`group:${r.target_group_id}`:t&&r.sender_id!==null&&r.sender_id!==void 0&&r.sender_id!==t?`user:${r.sender_id}`:t&&r.counterparty_id!==null&&r.counterparty_id!==void 0?`user:${r.counterparty_id}`:t&&r.target_user_id?`user:${r.target_user_id}`:r.counterparty_id!==null&&r.counterparty_id!==void 0?`user:${r.counterparty_id}`:r.sender_id!==null&&r.sender_id!==void 0?`user:${r.sender_id}`:r.sender_email?`email:${r.sender_email}`:`sender:${r.sender}`,te=r=>[...r].sort((t,d)=>new Date(t.date).getTime()-new Date(d.date).getTime()),ae=r=>r.filter(t=>!t.read).map(t=>t.target_id??t.id).filter(t=>Number.isFinite(t)),ne=({message:r,senderId:t,senderLabel:d,targetUserId:l,targetGroupId:a,title:u="Message"})=>({id:Date.now(),sender:d||"Coach",sender_name:d||null,sender_id:t??null,sender_email:null,target_user_id:l??null,target_group_id:a??null,title:u,message:r,type:"message",read:!0,date:new Date().toISOString()}),ie=(r,t)=>{const d=new Map;return r.forEach(l=>{const a=re(l,t);d.has(a)||d.set(a,[]),d.get(a)?.push(l)}),Array.from(d.entries()).map(([l,a])=>{const u=te(a),m=u[u.length-1],f=a.some(i=>!i.read),y=l.startsWith("user:")?Number(l.split(":")[1]):null,j=l.startsWith("group:")?Number(l.split(":")[1]):null,w=t?a.find(i=>i.sender_id&&i.sender_id!==t)??m:m,N=a.find(i=>i.counterparty_name)?.counterparty_name,b=a.find(i=>i.target_group_name)?.target_group_name??null,v=t?a.find(i=>i.target_id)?.target_id??null:a.find(i=>i.target_id)?.target_id??null;return{key:l,senderId:m.sender_id??null,senderLabel:b??N??w.sender,messages:u,lastMessage:m,lastTimestamp:new Date(m.date).getTime(),hasUnread:f,counterpartyId:Number.isFinite(y)?y:null,targetGroupId:Number.isFinite(j)?j:null,targetGroupName:b,replyTargetId:v}})};function he(){const{user:r,userId:t,role:d}=P(),{toast:l}=V(),a=W(),[u,m]=T.useState(null),[f,y]=T.useState(""),{data:j,isLoading:w,error:N}=L({queryKey:["notifications",t,r,"threads"],queryFn:()=>_.notifications_list({targetUserId:t,targetAthleteName:r,limit:200,offset:0,type:"message",order:"desc"}),enabled:!!r,refetchInterval:1e4}),{data:b,error:v}=L({queryKey:["capabilities","messaging"],queryFn:()=>_.getCapabilities(),enabled:k.hasSupabase}),i=F({mutationFn:s=>_.notifications_mark_read({targetId:s}),onMutate:async s=>{await a.cancelQueries({queryKey:["notifications"]});const n=a.getQueryData(["notifications",t,r,"threads"]);return a.setQueryData(["notifications",t,r,"threads"],o=>{const p=o;return p?.notifications?{...p,notifications:p.notifications.map(g=>(g.target_id??g.id)===s?{...g,read:!0}:g)}:o}),{previous:n}},onError:(s,n,o)=>{o?.previous&&a.setQueryData(["notifications",t,r,"threads"],o.previous)},onSettled:()=>{a.invalidateQueries({queryKey:["notifications"]})}}),S=F({mutationFn:s=>_.notifications_send({title:"Message",body:s.message,type:"message",targets:[s.targetGroupId?{target_group_id:s.targetGroupId}:{target_user_id:s.targetUserId||null}],reply_to_target_id:s.replyTargetId??void 0}),onMutate:async s=>{if(!s.message.trim())return;await a.cancelQueries({queryKey:["notifications",t,r,"threads"]});const n=a.getQueryData(["notifications",t,r,"threads"]),o=ne({message:s.message,senderId:t,senderLabel:r??"Coach",targetUserId:s.targetUserId,targetGroupId:s.targetGroupId??null});return a.setQueryData(["notifications",t,r,"threads"],p=>{const g=p;return g?.notifications?{...g,notifications:[o,...g.notifications]}:p}),{previous:n}},onSuccess:()=>{y(""),a.invalidateQueries({queryKey:["notifications"]})},onError:(s,n,o)=>{o?.previous&&a.setQueryData(["notifications",t,r,"threads"],o.previous);const p=C(s,"Le message n'a pas pu être envoyé.");l({title:"Envoi impossible",description:p.message,variant:"destructive"})}}),M=j?.notifications??[],q=M.filter(s=>!s.read).length,I=T.useMemo(()=>ie(M,t).sort((s,n)=>n.lastTimestamp-s.lastTimestamp),[M,t]),Q=I.filter(s=>!s.targetGroupId),U=I.filter(s=>s.targetGroupId),c=u?I.find(s=>s.key===u):null,B=!!(c?.counterpartyId||c?.targetGroupId)&&(d!=="athlete"||!k.hasSupabase||!!c?.replyTargetId),R=s=>{m(s.key),ae(s.messages).forEach(o=>i.mutate(o))};if(w)return e.jsx("div",{className:"space-y-4 p-4",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-start gap-3 rounded-xl bg-muted animate-pulse motion-reduce:animate-none p-4",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-muted-foreground/10"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-3/4 rounded bg-muted-foreground/10"}),e.jsx("div",{className:"h-3 w-1/2 rounded bg-muted-foreground/10"})]})]},s))});const A=v?C(v,"Impossible de vérifier la messagerie.").message:b?.mode==="supabase"&&!b.messaging.available?"Messagerie indisponible (tables manquantes côté D1).":null,K=N?C(N,"Impossible de charger les messages.").message:null;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"sticky top-0 z-overlay -mx-4 backdrop-blur-md bg-background/90 border-b border-primary/15",children:e.jsxs("div",{className:"px-4 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(D,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Messagerie"})]}),q>0&&e.jsxs($,{variant:"destructive",children:[q," non lus"]})]})}),A?e.jsx(x,{className:"border-dashed",children:e.jsx(h,{className:"py-4 text-sm text-muted-foreground",children:A})}):null,K?e.jsx(x,{className:"border-destructive/40",children:e.jsx(h,{className:"py-4 text-sm text-destructive",children:K})}):null,c?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 text-sm text-muted-foreground",onClick:()=>m(null),children:[e.jsx(Z,{className:"h-4 w-4"}),"Retour"]}),e.jsxs(x,{children:[e.jsxs(z,{children:[e.jsx(H,{children:c.senderLabel}),e.jsx(O,{children:"Conversation"})]}),e.jsx(h,{className:"space-y-3",children:c.messages.map(s=>{const n=s.sender_id===t;return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-end gap-2 ${n?"flex-row-reverse":"flex-row"}`,children:[e.jsxs("div",{className:`max-w-[80%] rounded-2xl border px-4 py-3 text-sm shadow-sm ${n?"border-primary/40 bg-primary text-primary-foreground":"border-border bg-muted/50 text-foreground"}`,children:[e.jsx("div",{className:`text-xs ${n?"text-primary-foreground/80":"text-muted-foreground"}`,children:s.sender}),e.jsx("div",{className:"mt-1",children:s.message})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:E(new Date(s.date),"HH:mm",{locale:G})})]})},s.id)})})]}),e.jsxs(x,{children:[e.jsxs(z,{children:[e.jsx(H,{children:B?"Répondre":"Réponse indisponible"}),e.jsx(O,{children:"Répondez à ce fil."})]}),e.jsx(h,{className:"space-y-3",children:B?e.jsxs(e.Fragment,{children:[e.jsx(Y,{value:f,onChange:s=>y(s.target.value),placeholder:"Votre message...",rows:3}),e.jsxs(X,{onClick:()=>{const s=c.counterpartyId,n=c.targetGroupId;if(!s&&!n){l({title:"Envoi impossible",description:"Destinataire introuvable pour ce fil.",variant:"destructive"});return}S.mutate({targetUserId:s??0,targetGroupId:n,message:f,replyTargetId:d==="athlete"&&k.hasSupabase?c.replyTargetId:null})},disabled:!f.trim()||S.isPending,children:[e.jsx(se,{className:"mr-2 h-4 w-4"}),"Envoyer"]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:d==="athlete"?"Réponse possible uniquement sur un fil existant.":"Aucun destinataire disponible pour ce fil."})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-bold uppercase text-muted-foreground tracking-wider ml-1",children:"Discussions"}),e.jsxs("div",{className:"space-y-3",children:[Q.map(s=>e.jsx("button",{type:"button",onClick:()=>R(s),className:"w-full text-left",children:e.jsx(x,{className:"group hover:bg-muted/50 transition-colors border-l-4 border-l-transparent hover:border-l-primary",children:e.jsxs(h,{className:"p-4 flex items-start gap-4",children:[e.jsx("div",{className:`p-2 rounded-full ${s.hasUnread?"bg-primary/20":"bg-muted"}`,children:e.jsx(D,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-bold truncate",children:s.senderLabel}),e.jsx("div",{className:"text-xs text-muted-foreground shrink-0 ml-2",children:E(new Date(s.lastMessage.date),"dd MMM",{locale:G})})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1 break-words",children:s.lastMessage.message})]}),s.hasUnread?e.jsx($,{variant:"secondary",children:"Non lu"}):null]})})},s.key)),Q.length===0?e.jsx(x,{className:"border-dashed",children:e.jsx(h,{className:"py-10 text-center text-sm text-muted-foreground",children:"Aucune discussion directe pour le moment."})}):null]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-bold uppercase text-muted-foreground tracking-wider ml-1",children:"Groupes"}),e.jsxs("div",{className:"space-y-3",children:[U.map(s=>e.jsx("button",{type:"button",onClick:()=>R(s),className:"w-full text-left",children:e.jsx(x,{className:"group hover:bg-muted/50 transition-colors border-l-4 border-l-transparent hover:border-l-primary",children:e.jsxs(h,{className:"p-4 flex items-start gap-4",children:[e.jsx("div",{className:`p-2 rounded-full ${s.hasUnread?"bg-primary/20":"bg-muted"}`,children:e.jsx(D,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-bold truncate",children:s.senderLabel}),e.jsx("div",{className:"text-xs text-muted-foreground shrink-0 ml-2",children:E(new Date(s.lastMessage.date),"dd MMM",{locale:G})})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1 break-words",children:s.lastMessage.message})]}),s.hasUnread?e.jsx($,{variant:"secondary",children:"Non lu"}):null]})})},s.key)),U.length===0?e.jsx(x,{className:"border-dashed",children:e.jsx(h,{className:"py-10 text-center text-sm text-muted-foreground",children:"Aucun message de groupe pour le moment."})}):null]})]})]})]})}export{ne as buildOptimisticNotification,ae as collectThreadMarkReadTargets,he as default,re as getThreadKey,ie as groupNotificationsBySender,te as sortThreadMessages};
