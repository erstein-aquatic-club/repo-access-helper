import{u as Le,M as De,N as qe,r as p,a as q,Q as A,j as e,C as $,i as Q,W as P,D as se,T as te,B as y,Z as N,_ as C,ar as ce,ap as me,S as Ae,b as $e,d as Qe,e as Oe,f as ne,k as S}from"./index-DqxBy9a5.js";import{T as ie}from"./textarea-DAeIa66o.js";import{T as Ve,a as Be,b as re,c as ae}from"./tabs-DWvja1RP.js";import{R as Ke,s as ze}from"./Profile-DrtuiVHE.js";import{P as le}from"./save-BRIS4vk0.js";const L=(...t)=>t.filter(Boolean).join(" ");function de(t){if(!t)return"—";const i=new Date(t);return Number.isNaN(i.getTime())?t:i.toLocaleDateString("fr-FR",{day:"2-digit",month:"2-digit",year:"2-digit"})}function oe(t){if(t==null)return"—";const i=Math.round(Math.max(0,t*1e3)),c=Math.floor(i/6e4),l=Math.floor(i%6e4/1e3),f=Math.floor(i%1e3/10);return c>0?`${c}:${String(l).padStart(2,"0")}.${String(f).padStart(2,"0")}`:`${l}.${String(f).padStart(2,"0")}`}function We(t){const i=t.trim();if(!i)return null;if(i.includes(":")){const[l,f]=i.split(":"),h=Number(l);if(!Number.isFinite(h)||h<0)return null;const w=f.replace(",","."),v=Number(w);return!Number.isFinite(v)||v<0?null:h*60+v}const c=Number(i.replace(",","."));return!Number.isFinite(c)||c<0?null:c}function Xe(t){if(!t)return null;const i=t.match(/FFN\s*\((\d+)\s*pts\)/i);if(!i)return null;const c=Number(i[1]);return Number.isFinite(c)?c:null}function Ye({value:t,placeholder:i,onSave:c,onCancel:l,inputMode:f="decimal",hint:h}){const[w,v]=p.useState(t);return p.useEffect(()=>{v(t)},[t]),e.jsx("div",{className:"w-full",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(C,{value:w,onChange:n=>v(n.target.value),placeholder:i,inputMode:f,className:"h-10 rounded-xl",autoFocus:!0}),h?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:h}):null]}),e.jsx(y,{type:"button",onClick:()=>c(w),className:"h-10 w-10 p-0 rounded-xl","aria-label":"Valider",children:e.jsx(me,{className:"h-5 w-5"})}),e.jsx(y,{type:"button",variant:"outline",onClick:l,className:"h-10 w-10 p-0 rounded-xl","aria-label":"Annuler",children:e.jsx(ce,{className:"h-5 w-5"})})]})})}const _=()=>e.jsx("div",{className:"h-10 rounded-xl bg-muted animate-pulse motion-reduce:animate-none"});function ns(){const{user:t,userId:i,role:c}=Le(),{toast:l}=De(),f=qe(),h={id:null,event_name:"",pool_length:"",time_seconds:"",record_date:"",notes:""},[w,v]=p.useState("swim"),[n,u]=p.useState(h),[a,ue]=p.useState("training"),[R,xe]=p.useState(25),[O,M]=p.useState(null),[pe,V]=p.useState(null),[he,B]=p.useState(""),T=ze(c);p.useEffect(()=>{window.scrollTo({top:0,left:0,behavior:"auto"})},[]);const K=s=>{const r=s?.pool_length??s?.poolLength??s?.poolLen??s?.pool;if(r==null)return null;if(typeof r=="number")return r===25||r===50?r:null;const x=String(r).match(/\b(25|50)\b/);if(!x)return null;const d=Number(x[1]);return d===25||d===50?d:null},ge=q({queryKey:["1rm",t,i],queryFn:()=>S.get1RM({athleteName:t,athleteId:i}),enabled:!!t&&T}),fe=q({queryKey:["exercises"],queryFn:()=>S.getExercises(),enabled:T}),je=q({queryKey:["swim-records",i,t],queryFn:()=>S.getSwimRecords({athleteId:i??void 0,athleteName:t??void 0}),enabled:!!t&&T}),{data:ve,isLoading:be,isError:Ne}=ge,{data:we,isLoading:ye,isError:Se}=fe,{data:z,isLoading:_e,isFetching:Ze,isError:Ce,refetch:Re}=je,ke=()=>{Re()};p.useEffect(()=>{a==="comp"&&ke()},[a]);const W=A({mutationFn:s=>S.update1RM({...s,athlete_id:i,athlete_name:t}),onSuccess:()=>{f.invalidateQueries({queryKey:["1rm"]}),l({title:"1RM mis à jour"})}}),D=A({mutationFn:s=>S.upsertSwimRecord(s),onSuccess:()=>{f.invalidateQueries({queryKey:["swim-records"]}),u(h),M(null),l({title:"Record mis à jour"})}});A({mutationFn:s=>S.syncFfnSwimRecords({athleteId:i??void 0,athleteName:t??void 0,iuf:s}),onSuccess:s=>{f.invalidateQueries({queryKey:["swim-records"]}),l({title:"Synchro FFN terminée",description:`${s?.inserted??0} ajouté(s), ${s?.updated??0} mis à jour, ${s?.skipped??0} inchangé(s)`})},onError:s=>{l({title:"Synchro FFN impossible",description:String(s?.message||s),variant:"destructive"})}});const I=()=>{u(h),M(null)},Ee=s=>{const r=K(s);u({id:s.id,event_name:s.event_name??"",pool_length:r?String(r):"",time_seconds:s.time_seconds!=null?oe(Number(s.time_seconds)):"",record_date:s.record_date?String(s.record_date).split("T")[0]:"",notes:s.notes??""}),M(s.id)},X=()=>{if(!n.event_name.trim()){l({title:"Nom d'épreuve requis",variant:"destructive"});return}if(!n.pool_length){l({title:"Bassin requis",variant:"destructive"});return}const s=We(n.time_seconds);if(s===null){l({title:"Temps invalide",description:"Ex: 1:02.34 ou 62.34",variant:"destructive"});return}D.mutate({id:n.id||null,athlete_id:i,athleteName:t,athlete_name:t,event_name:n.event_name,pool_length:parseInt(n.pool_length,10),time_seconds:s,record_date:n.record_date||null,notes:n.notes||null,record_type:a})},Fe=s=>{s.preventDefault(),X()},Y=p.useMemo(()=>(z?.records??[]).filter(o=>{const x=K(o);if(!x||x!==R)return!1;const d=String(o.record_type??"training");return a==="comp"?d==="comp":d==="training"}).sort((o,x)=>{const d=String(o.event_name??""),g=String(x.event_name??""),j=F=>String(F??"").toLowerCase().replace(/\./g,"").replace(/\s+/g," ").trim(),k=F=>{const m=j(F);return m.includes("nl")||m.includes("nage libre")?0:m.includes("dos")?1:m.includes("bra")||m.includes("brasse")?2:m.includes("pap")||m.includes("papillon")?3:m.includes("4n")||m.includes("4 n")||m.includes("4 nages")?4:99},E=F=>{const m=String(F??"").match(/^(\d+)/);return m?Number(m[1]):Number.POSITIVE_INFINITY},b=k(d),J=k(g);if(b!==J)return b-J;const U=E(d),ee=E(g);return U!==ee?U-ee:j(d).localeCompare(j(g),"fr")}),[z,R,a]),Me=()=>{u({...h,pool_length:String(R)}),M("add")},Z=s=>{ue(s),I()},Te=()=>{xe(s=>s===25?50:25),I()},Ie=(s,r)=>{V(s),B(r!=null&&Number(r)>0?String(r):"")},G=()=>{V(null),B("")},Pe=(s,r)=>{const o=Number(String(r??"").replace(",","."));if(!Number.isFinite(o)||o<=0){l({title:"Valeur invalide",description:"Entrez un nombre > 0",variant:"destructive"});return}W.mutate({exercise_id:s,one_rm:o}),G()},H=a==="training"?"grid-cols-[minmax(0,1fr)_4.75rem_4.75rem_2.5rem]":"grid-cols-[minmax(0,1fr)_4.75rem_3.75rem_4.75rem]";return T?e.jsx("div",{className:"min-h-[100dvh]",children:e.jsxs("div",{className:"mx-auto max-w-lg",children:[e.jsx("div",{className:"sticky top-0 z-20 scroll-mt-16 backdrop-blur bg-background/80 border-b border-border",children:e.jsxs("div",{className:"px-4 pt-4 pb-3",children:[e.jsx("div",{className:"text-xl font-semibold tracking-tight",children:"Records"}),e.jsx("div",{className:"mt-0.5 text-sm text-muted-foreground",children:"Natation & 1RM musculation"})]})}),e.jsx("div",{className:"px-2 sm:px-4 pt-3",children:e.jsxs(Ve,{value:w,onValueChange:s=>v(s),children:[e.jsxs(Be,{className:"w-full rounded-3xl bg-muted/60 border border-border shadow-sm p-1.5 flex",children:[e.jsxs(re,{value:"swim","aria-label":"Records de natation",className:`flex-1 rounded-2xl px-4 py-2.5 text-sm font-semibold uppercase tracking-wide gap-2
                  data-[state=active]:bg-background data-[state=active]:text-foreground
                  data-[state=inactive]:text-muted-foreground`,children:[e.jsx(P,{className:"h-4 w-4"}),"Natation"]}),e.jsxs(re,{value:"1rm","aria-label":"Records de musculation",className:`flex-1 rounded-2xl px-4 py-2.5 text-sm font-semibold uppercase tracking-wide gap-2
                  data-[state=active]:bg-background data-[state=active]:text-foreground
                  data-[state=inactive]:text-muted-foreground`,children:[e.jsx(se,{className:"h-4 w-4"}),"Musculation"]})]}),w==="swim"?e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"w-full rounded-2xl bg-muted/25 border border-border/60 p-1 flex",children:[e.jsxs("button",{type:"button",onClick:()=>Z("training"),className:L("flex-1 rounded-2xl px-3 py-2 text-sm max-[360px]:text-xs font-semibold transition inline-flex items-center justify-center gap-2 whitespace-nowrap",a==="training"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),"aria-pressed":a==="training",children:[e.jsx(te,{className:"h-4 w-4 max-[360px]:hidden"}),"Entraînement"]}),e.jsxs("button",{type:"button",onClick:()=>Z("comp"),className:L("flex-1 rounded-2xl px-3 py-2 text-sm max-[360px]:text-xs font-semibold transition inline-flex items-center justify-center gap-2 whitespace-nowrap",a==="comp"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),"aria-pressed":a==="comp",children:[e.jsx(P,{className:"h-4 w-4 max-[360px]:hidden"}),"Compétition"]})]})}):null,e.jsxs(ae,{value:"swim",className:"mt-0",children:[e.jsxs("div",{className:"mt-5 mb-2 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted/50 border border-border flex items-center justify-center",children:a==="training"?e.jsx(te,{className:"h-5 w-5"}):e.jsx(P,{className:"h-5 w-5"})}),e.jsxs("div",{className:"text-sm font-semibold",children:[a==="training"?"Records entraînement":"Records compétition"," "]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",onClick:Te,className:"inline-flex items-center gap-2 whitespace-nowrap rounded-2xl bg-muted/25 border border-border/60 px-3 py-2 text-sm font-semibold active:scale-[0.99] transition cursor-pointer focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary","aria-label":"Changer le bassin",title:"Appuie pour basculer 25m / 50m",children:[e.jsx("span",{className:"inline-flex items-center justify-center h-6 w-6 rounded-xl bg-background/60 border border-border",children:e.jsx(P,{className:"h-4 w-4"})}),e.jsxs("span",{className:"tabular-nums",children:[R,"m"]})]}),a!=="comp"?e.jsx(y,{type:"button",size:"sm",onClick:Me,className:"rounded-2xl",children:"Ajouter"}):null]})]}),a==="comp"?e.jsx("div",{className:"-mt-1 mb-2 text-xs text-muted-foreground",children:"Records fédération (lecture seule)."}):null,e.jsx($,{className:"w-full min-w-0 overflow-x-auto overflow-hidden rounded-2xl",children:e.jsx(Q,{className:"p-0",children:_e?e.jsxs("div",{className:"p-4 grid gap-3",children:[e.jsx(_,{}),e.jsx(_,{}),e.jsx(_,{})]}):Ce?e.jsx("div",{className:"mx-4 my-4 rounded-lg border border-destructive/20 bg-destructive/10 p-4 text-sm text-destructive",children:"Impossible de charger les records natation."}):Y.length===0?e.jsxs("div",{className:"px-4 py-6 text-sm text-muted-foreground",children:["Aucun record en bassin ",R,"m."]}):e.jsxs("div",{className:"w-full",children:[e.jsx("div",{className:"px-3 sm:px-4 py-2 text-[11px] text-muted-foreground border-b border-border",children:e.jsxs("div",{className:L("grid items-center gap-2",H),children:[e.jsx("div",{className:"truncate justify-self-start",children:"Épreuve"}),e.jsx("div",{className:"whitespace-nowrap justify-self-end",children:"Temps"}),a==="comp"?e.jsx("div",{className:"whitespace-nowrap justify-self-end",children:"Pts"}):e.jsx("div",{className:"whitespace-nowrap justify-self-end",children:"Date"}),a==="comp"?e.jsx("div",{className:"whitespace-nowrap justify-self-end",children:"Date"}):e.jsx("div",{className:"sr-only",children:"Actions"})]})}),e.jsx("div",{className:"divide-y divide-border",children:Y.map(s=>{const r=O===s.id,o=oe(s.time_seconds),x=de(s.record_date),d=(s.notes??"").trim(),g=s?.ffn_points??s?.ffnPoints??s?.points??s?.pts??null,j=g==null||g===""?NaN:Number(g),k=Number.isFinite(j)?j:Xe(s?.notes),E=(s?.meet??s?.meet_name??s?.meetName??s?.competition??"").trim?.()??"";return e.jsxs("div",{className:"px-3 sm:px-4 py-3",children:[e.jsxs("div",{className:L("grid items-center gap-2",H),children:[e.jsx("div",{className:"min-w-0 justify-self-start",children:e.jsx("div",{className:"text-sm font-semibold truncate",children:s.event_name})}),e.jsx("div",{className:"justify-self-end text-sm font-semibold tabular-nums whitespace-nowrap overflow-hidden font-mono",children:o}),a==="comp"?e.jsx("div",{className:"justify-self-end text-sm tabular-nums text-muted-foreground whitespace-nowrap overflow-hidden",children:k==null?"—":String(k)}):e.jsx("div",{className:"justify-self-end text-sm tabular-nums text-muted-foreground whitespace-nowrap overflow-hidden",children:x}),a==="comp"?e.jsx("div",{className:"justify-self-end text-sm tabular-nums text-muted-foreground whitespace-nowrap overflow-hidden",children:x}):e.jsx("button",{type:"button",onClick:()=>Ee(s),className:"justify-self-end inline-flex items-center justify-center h-9 w-9 rounded-xl bg-transparent text-muted-foreground hover:text-foreground hover:bg-muted/60 focus:outline-none focus:ring-2 focus:ring-ring/20","aria-label":`Modifier ${s.event_name}`,title:"Modifier",children:e.jsx(le,{className:"h-4 w-4"})})]}),a==="comp"&&E?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground truncate",children:E}):null,a==="training"&&d?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground truncate",children:d}):null,a==="training"&&r?e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"rounded-2xl bg-muted/30 border border-border p-4 space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-2",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Temps"}),e.jsx(C,{value:n.time_seconds,inputMode:"decimal",placeholder:"1:02.34",onChange:b=>u({...n,time_seconds:b.target.value}),className:"rounded-xl"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Format: mm:ss.cc ou secondes"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Date"}),e.jsx(C,{type:"date",value:n.record_date,onChange:b=>u({...n,record_date:b.target.value}),className:"rounded-xl"})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Notes"}),e.jsx(ie,{value:n.notes,onChange:b=>u({...n,notes:b.target.value}),rows:2,className:"rounded-xl"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsxs(y,{type:"button",size:"sm",variant:"outline",onClick:I,className:"rounded-2xl gap-2",children:[e.jsx(ce,{className:"h-4 w-4"}),"Annuler"]}),e.jsxs(y,{type:"button",size:"sm",onClick:X,disabled:D.isPending,className:"rounded-2xl gap-2",children:[e.jsx(me,{className:"h-4 w-4"}),"Enregistrer"]})]})]})}):null]},s.id)})})]})})}),a==="training"&&O==="add"?e.jsx("div",{className:"px-4 mt-4",children:e.jsx("form",{onSubmit:Fe,children:e.jsxs("div",{className:"rounded-2xl border border-border p-4 space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Épreuve"}),e.jsx(C,{value:n.event_name,onChange:s=>u({...n,event_name:s.target.value}),placeholder:"Ex: 100 NL, 200 Dos",className:"rounded-xl"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Bassin (m)"}),e.jsxs(Ae,{value:n.pool_length,onValueChange:s=>u({...n,pool_length:s}),children:[e.jsx($e,{className:"rounded-xl",children:e.jsx(Qe,{placeholder:"Choisir"})}),e.jsxs(Oe,{children:[e.jsx(ne,{value:"25",children:"25"}),e.jsx(ne,{value:"50",children:"50"})]})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Temps"}),e.jsx(C,{value:n.time_seconds,inputMode:"decimal",placeholder:"1:02.34",onChange:s=>u({...n,time_seconds:s.target.value}),className:"rounded-xl"})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Date"}),e.jsx(C,{type:"date",value:n.record_date,onChange:s=>u({...n,record_date:s.target.value}),className:"rounded-xl"})]})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(N,{children:"Notes"}),e.jsx(ie,{value:n.notes,onChange:s=>u({...n,notes:s.target.value}),rows:3,className:"rounded-xl"})]}),e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(y,{type:"button",variant:"outline",onClick:I,className:"rounded-2xl",children:"Annuler"}),e.jsx(y,{type:"submit",disabled:D.isPending,className:"rounded-2xl",children:"Ajouter"})]})]})})}):null,e.jsx("div",{className:"h-10"})]}),e.jsxs(ae,{value:"1rm",className:"mt-0",children:[e.jsx("div",{className:"mt-5 mb-2 flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted/50 border border-border flex items-center justify-center",children:e.jsx(se,{className:"h-5 w-5"})}),e.jsx("div",{className:"text-sm font-semibold",children:"1RM musculation"})]})}),e.jsx($,{className:"w-full min-w-0 overflow-x-auto overflow-hidden rounded-2xl",children:e.jsxs(Q,{className:"p-0",children:[be||ye?e.jsxs("div",{className:"p-4 grid gap-3",children:[e.jsx(_,{}),e.jsx(_,{}),e.jsx(_,{})]}):Ne||Se?e.jsx("div",{className:"p-4 text-sm text-muted-foreground",children:"Impossible de charger les records musculation."}):e.jsx("div",{className:"divide-y divide-border",children:we?.filter(s=>s.exercise_type!=="warmup").map(s=>{const r=ve?.find(j=>j.exercise_id===s.id),o=Number(r?.weight??0),x=o>0?`${o} kg`:"—",d=r?.recorded_at??r?.date??null,g=pe===s.id;return e.jsxs("div",{className:"px-3 sm:px-4 py-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"text-sm font-semibold truncate",children:s.nom_exercice}),e.jsx("div",{className:"mt-0.5 text-xs text-muted-foreground tabular-nums",children:de(d)})]}),e.jsxs("div",{className:"text-right shrink-0",children:[e.jsx("div",{className:"text-base font-semibold tabular-nums whitespace-nowrap font-mono",children:x}),g?null:e.jsxs("button",{type:"button",onClick:()=>Ie(s.id,r?.weight??null),className:"mt-1 inline-flex items-center gap-1 text-xs text-muted-foreground hover:text-foreground",children:[e.jsx(le,{className:"h-3.5 w-3.5"}),"Modifier"]})]})]}),g?e.jsx("div",{className:"mt-3",children:e.jsx(Ye,{value:he,placeholder:"Ex: 100",inputMode:"decimal",hint:"Charge max (kg).",onCancel:G,onSave:j=>Pe(s.id,j)})}):null]},s.id)})}),W.isPending?e.jsxs("div",{className:"px-4 pb-4 text-xs text-muted-foreground flex items-center gap-2",children:[e.jsx(Ke,{className:"h-3 w-3 animate-spin"})," Mise à jour..."]}):null]})}),e.jsx("div",{className:"h-10"})]})]})}),e.jsx("div",{className:"pb-10"})]})}):e.jsx("div",{className:"min-h-[100dvh]",children:e.jsxs("div",{className:"mx-auto max-w-lg",children:[e.jsx("div",{className:"sticky top-0 z-20 scroll-mt-16 backdrop-blur bg-background/80 border-b border-border",children:e.jsxs("div",{className:"px-4 pt-4 pb-3",children:[e.jsx("div",{className:"text-xl font-semibold tracking-tight",children:"Records"}),e.jsx("div",{className:"mt-0.5 text-sm text-muted-foreground",children:"Natation & 1RM musculation"})]})}),e.jsx("div",{className:"px-4 pt-4 pb-10",children:e.jsx($,{className:"rounded-2xl",children:e.jsx(Q,{className:"pt-6 text-sm text-muted-foreground",children:"Cette page est réservée aux nageurs."})})})]})})}export{ns as default};
