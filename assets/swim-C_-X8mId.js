import{q as y,s as a}from"./index-AQJx-bCr.js";const w=()=>typeof navigator>"u"?!0:navigator.onLine,_=()=>y.hasSupabase&&w(),c={SESSIONS:"suivi_natation_sessions",EXERCISES:"suivi_natation_exercises",STRENGTH_SESSIONS:"suivi_natation_strength_sessions",SWIM_SESSIONS:"suivi_natation_swim_sessions",ASSIGNMENTS:"suivi_natation_assignments",STRENGTH_RUNS:"suivi_natation_strength_runs",NOTIFICATIONS:"suivi_natation_notifications",ONE_RM:"suivi_natation_1rm",SWIM_RECORDS:"suivi_natation_swim_records",TIMESHEET_SHIFTS:"suivi_natation_timesheet_shifts",TIMESHEET_LOCATIONS:"suivi_natation_timesheet_locations"},p=(e,r=0)=>{const n=Number(e);return Number.isFinite(n)?Math.round(n):r},i=e=>{const r=Number(e);return Number.isFinite(r)?Math.round(r):null},m=e=>{const r=Number(e);return Number.isFinite(r)?r:null},M=e=>{if(e==null)return null;const r=Number(e);return Number.isFinite(r)?r<=5?Math.max(1,Math.round(r)):Math.min(5,Math.max(1,Math.round(r/2))):null},O=e=>{if(e==null)return null;const r=Number(e);return Number.isFinite(r)?r<=5?Math.round(r*2):Math.round(r):null},T=(e,r)=>!Number.isFinite(e)||!Number.isFinite(r)||(e??0)<=0||(r??0)<=0?null:Math.round(r===1?e:e*(1+r/30)),h=new Set,b=e=>{if(e instanceof Error){const r=e;return{message:r.message||"Erreur inconnue",code:r.code,status:r.status}}return{message:String(e||"Erreur inconnue")}},A=(e,r)=>{const n=b(e),t=n.status,s=n.code;let o=n.message||r;s==="unknown_action"?o="Action inconnue côté serveur.":s==="table_missing"?o="Base de données non initialisée (table manquante).":t===401?o="Authentification expirée ou manquante.":t===403&&(o="Accès refusé pour ce rôle.");const u=`${s??"none"}:${t??"none"}:${o}`;return h.has(u)||(console.error("[api] error:",n),h.add(u)),{...n,message:o}},E=e=>{const r=String(e??"").trim().toLowerCase();return r==="hypertrophie"||r==="force"||r==="endurance"?r:"endurance"},N=e=>e==="strength"||e==="warmup",I=e=>N(e)?e:"strength",q=(e,r,n)=>({exercise_id:p(e.exercise_id),order_index:i(e.ordre??e.order_index)??r,sets:i(e.sets)??0,reps:i(e.reps)??0,rest_seconds:i(e.rest_series_s??e.rest_seconds)??0,percent_1rm:i(e.pct_1rm??e.percent_1rm)??0,cycle_type:E(e.cycle_type??n),notes:e.notes??"",exercise_name:e.exercise_name??e.nom_exercice,category:e.category??e.exercise_type}),F=e=>{for(let r=0;r<e.length;r+=1){const n=e[r];if(!Number.isFinite(n.sets)||n.sets<0)throw new Error(`Séries invalides pour l'exercice #${r+1}`);if(!Number.isFinite(n.reps)||n.reps<0)throw new Error(`Reps invalides pour l'exercice #${r+1}`);if(!Number.isFinite(n.rest_seconds)||n.rest_seconds<0)throw new Error(`Repos invalide pour l'exercice #${r+1}`)}},W=e=>({id:p(e.id),numero_exercice:i(e.numero_exercice),nom_exercice:e.nom_exercice??"",description:e.description??null,illustration_gif:e.illustration_gif??null,exercise_type:I(e.exercise_type),warmup_reps:null,warmup_duration:null,Nb_series_endurance:i(e.nb_series_endurance),Nb_reps_endurance:i(e.nb_reps_endurance),pct_1rm_endurance:m(e.pourcentage_charge_1rm_endurance),recup_endurance:i(e.recup_series_endurance),recup_exercices_endurance:i(e.recup_exercices_endurance),Nb_series_hypertrophie:i(e.nb_series_hypertrophie),Nb_reps_hypertrophie:i(e.nb_reps_hypertrophie),pct_1rm_hypertrophie:m(e.pourcentage_charge_1rm_hypertrophie),recup_hypertrophie:i(e.recup_series_hypertrophie),recup_exercices_hypertrophie:i(e.recup_exercices_hypertrophie),Nb_series_force:i(e.nb_series_force),Nb_reps_force:i(e.nb_reps_force),pct_1rm_force:m(e.pourcentage_charge_1rm_force),recup_force:i(e.recup_series_force),recup_exercices_force:i(e.recup_exercices_force),folder_id:i(e.folder_id)}),G=e=>({numero_exercice:e.numero_exercice??null,nom_exercice:e.nom_exercice??e.name??"",description:e.description??null,illustration_gif:e.illustration_gif??null,exercise_type:e.exercise_type??"strength",nb_series_endurance:e.Nb_series_endurance??null,nb_reps_endurance:e.Nb_reps_endurance??null,pourcentage_charge_1rm_endurance:e.pct_1rm_endurance??null,recup_series_endurance:e.recup_endurance??null,recup_exercices_endurance:e.recup_exercices_endurance??null,nb_series_hypertrophie:e.Nb_series_hypertrophie??null,nb_reps_hypertrophie:e.Nb_reps_hypertrophie??null,pourcentage_charge_1rm_hypertrophie:e.pct_1rm_hypertrophie??null,recup_series_hypertrophie:e.recup_hypertrophie??null,recup_exercices_hypertrophie:e.recup_exercices_hypertrophie??null,nb_series_force:e.Nb_series_force??null,nb_reps_force:e.Nb_reps_force??null,pourcentage_charge_1rm_force:e.pct_1rm_force??null,recup_series_force:e.recup_force??null,recup_exercices_force:e.recup_exercices_force??null,folder_id:e.folder_id??null}),R=e=>new Promise(r=>setTimeout(r,e)),f=e=>{if(!e)return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return null}return typeof e=="object"?e:null},k=async e=>{if(!e||!_())return[];const{data:r,error:n}=await a.from("group_members").select("group_id").eq("user_id",e);return n||!r?[]:r.map(t=>t.group_id).filter(t=>t>0)},v=e=>{const r=[],n=new Set;let t=!1;for(const s of e){const o=s.groups;o.is_temporary?o.is_active&&(t=!0,n.add(s.group_id),o.parent_group_id&&n.add(o.parent_group_id)):r.push(s.group_id)}return{permanentGroupIds:r,temporaryGroupIds:Array.from(n),hasActiveTemporary:t}},C=async e=>{const r={permanentGroupIds:[],temporaryGroupIds:[],hasActiveTemporary:!1};if(!e||!_())return r;const{data:n,error:t}=await a.from("group_members").select("group_id, groups!inner(is_temporary, is_active, parent_group_id)").eq("user_id",e);return t||!n?r:v(n)},d=e=>{try{const r=localStorage.getItem(e);return r?JSON.parse(r):null}catch{return null}},l=(e,r)=>{try{localStorage.setItem(e,JSON.stringify(r))}catch(n){console.error("[localStorage] Failed to save:",e,n)}};async function z(){if(_()){const{data:r,error:n}=await a.from("swim_sessions_catalog").select("*, swim_session_items(*)").order("created_at",{ascending:!1});if(n)throw new Error(n.message);return(r??[]).map(t=>({id:p(t.id,Date.now()),name:String(t.name||""),description:t.description??null,created_by:i(t.created_by)??null,created_at:t.created_at??null,updated_at:t.updated_at??null,folder:t.folder??null,is_archived:t.is_archived??!1,items:Array.isArray(t.swim_session_items)?t.swim_session_items.sort((s,o)=>(s.ordre??0)-(o.ordre??0)).map((s,o)=>({id:i(s.id)??void 0,catalog_id:i(s.catalog_id)??void 0,ordre:i(s.ordre)??o,label:s.label??null,distance:i(s.distance)??null,duration:i(s.duration)??null,intensity:s.intensity??null,notes:s.notes??null,raw_payload:f(s.raw_payload)})):[]}))}return(d(c.SWIM_SESSIONS)||[]).map(r=>({id:p(r.id,Date.now()),name:String(r.name||r.title||""),description:r.description??null,created_by:i(r.created_by)??null,created_at:r.created_at??null,updated_at:r.updated_at??null,folder:r.folder??null,is_archived:r.is_archived??!1,items:Array.isArray(r.items)?r.items.map((n,t)=>({id:i(n.id)??void 0,catalog_id:i(n.catalog_id)??void 0,ordre:i(n.ordre)??t,label:n.label??n.section??null,distance:i(n.distance)??null,duration:i(n.duration)??null,intensity:n.intensity??null,notes:n.notes??n.instruction??null,raw_payload:f(n.raw_payload)??(n.section||n.stroke||n.instruction||n.rest?{section:n.section,stroke:n.stroke,instruction:n.instruction,rest:n.rest}:null)})):[]}))}async function D(e){if(_()){const n=Array.isArray(e.items)?e.items.map((o,u)=>({ordre:o.ordre??u,label:o.label??null,distance:o.distance??null,duration:o.duration??null,intensity:o.intensity??null,notes:o.notes??null,raw_payload:o.raw_payload??null})):[];if(e.id){const{error:o}=await a.from("swim_sessions_catalog").update({name:e.name,description:e.description??null,folder:e.folder??null}).eq("id",e.id);if(o)throw new Error(o.message);const{error:u}=await a.from("swim_session_items").delete().eq("catalog_id",e.id);if(u)throw new Error(u.message);if(n.length>0){const{error:S}=await a.from("swim_session_items").insert(n.map(g=>({...g,catalog_id:e.id})));if(S)throw new Error(S.message)}return{status:"updated"}}const{data:t,error:s}=await a.from("swim_sessions_catalog").insert({name:e.name,description:e.description??null,folder:e.folder??null}).select("id").single();if(s)throw new Error(s.message);if(n.length>0){const{error:o}=await a.from("swim_session_items").insert(n.map(u=>({...u,catalog_id:t.id})));if(o)throw new Error(o.message)}return{status:"created"}}const r=d(c.SWIM_SESSIONS)||[];if(e.id){const n=r.some(s=>s.id===e.id),t=n?r.map(s=>s.id===e.id?{...s,...e}:s):[...r,{...e,id:e.id}];return l(c.SWIM_SESSIONS,t),{status:n?"updated":"created"}}return l(c.SWIM_SESSIONS,[...r,{...e,id:Date.now()}]),{status:"created"}}async function $(e){if(_()){const{error:t}=await a.from("swim_sessions_catalog").delete().eq("id",e);if(t)throw new Error(t.message);return{status:"deleted"}}const n=(d(c.SWIM_SESSIONS)||[]).filter(t=>t.id!==e);return l(c.SWIM_SESSIONS,n),{status:"deleted"}}async function H(e,r){if(_()){const{error:s}=await a.from("swim_sessions_catalog").update({is_archived:r}).eq("id",e);if(s)throw new Error(s.message);return{status:r?"archived":"restored"}}const t=(d(c.SWIM_SESSIONS)||[]).map(s=>s.id===e?{...s,is_archived:r}:s);return l(c.SWIM_SESSIONS,t),{status:r?"archived":"restored"}}async function L(e,r){if(_()){const{error:s}=await a.from("swim_sessions_catalog").update({folder:r}).eq("id",e);if(s)throw new Error(s.message);return{status:"moved"}}const t=(d(c.SWIM_SESSIONS)||[]).map(s=>s.id===e?{...s,folder:r}:s);return l(c.SWIM_SESSIONS,t),{status:"moved"}}async function U(e){if(!_()||e.length===0)return;const{error:r}=await a.from("swim_sessions_catalog").update({is_archived:!0}).in("id",e);if(r)throw new Error(r.message)}async function J(e){if(!_())throw new Error("Supabase required for sharing");const{data:r,error:n}=await a.from("swim_sessions_catalog").select("share_token").eq("id",e).single();if(n)throw new Error(n.message);if(r?.share_token)return r.share_token;const{data:t,error:s}=await a.rpc("generate_swim_share_token",{p_catalog_id:e});if(s)throw new Error(s.message);return t}async function j(e){const{data:r,error:n}=await a.from("swim_sessions_catalog").select("name, description, swim_session_items(*)").eq("share_token",e).single();if(n||!r)return null;const t=Array.isArray(r.swim_session_items)?r.swim_session_items.sort((s,o)=>(s.ordre??0)-(o.ordre??0)).map((s,o)=>({id:i(s.id)??void 0,catalog_id:i(s.catalog_id)??void 0,ordre:i(s.ordre)??o,label:s.label??null,distance:i(s.distance)??null,duration:i(s.duration)??null,intensity:s.intensity??null,notes:s.notes??null,raw_payload:f(s.raw_payload)})):[];return{name:String(r.name||""),description:r.description??null,items:t}}export{D as A,c as S,i as a,m as b,p as c,M as d,O as e,_ as f,J as g,R as h,l as i,k as j,T as k,d as l,E as m,I as n,q as o,G as p,W as q,C as r,A as s,z as t,j as u,F as v,U as w,L as x,H as y,$ as z};
