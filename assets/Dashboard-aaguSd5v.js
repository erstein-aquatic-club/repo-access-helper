import{r as i,j as e,R as vt}from"./vendor-ui-DJQMR4VV.js";import{b as wt,u as We,c as Fe}from"./vendor-query-BT4y-huw.js";import{c as re,b as kt,X as qe,W as ze,F as St,u as Mt,f as Dt,B as _t,d as Ne}from"./index-Bj8AzmgP.js";import{C as Ct}from"./chevron-left-Uhe6bn7v.js";import{C as Qe,A as Me,B as At,I as Xe}from"./BottomActionBar-DVlB_MpN.js";import{C as De}from"./circle-DD3PXCGC.js";import{m as ne,a as Ot,s as $t,l as Ge}from"./animations-BTr26p-C.js";import{d as Ze}from"./design-tokens-CGMys_0P.js";import{T as xt}from"./timer-Ctg_F0Ro.js";import{P as ge,T as Ie}from"./trash-2-Ci40sppp.js";import{C as Ue}from"./check-CRs7ucvQ.js";import{C as Ft}from"./circle-alert-Ci0NmZSy.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Db4xOvcx.js";import"./vendor-supabase-D7B1G6YZ.js";import"./loader-circle-CLUUnNlC.js";import"./circle-check-WRbSE2g8.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const It=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],Et=re("activity",It);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pt=[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]],Kt=re("hash",Pt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Lt=[["path",{d:"M5 12h14",key:"1ays0h"}]],ft=re("minus",Lt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Tt=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],Bt=re("moon",Tt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Rt=[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]],qt=re("power",Rt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],et=re("settings-2",zt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],Yt=re("sun",Jt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],tt=re("user-check",Qt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Vt=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],we=re("user-x",Vt),st={NL:"",DOS:"",BR:"",PAP:"",QN:""};function nt(t){return String(t).padStart(2,"0")}function rt(t){return`${t.getFullYear()}-${nt(t.getMonth()+1)}-${nt(t.getDate())}`}function ot(t){return new Date(t.getFullYear(),t.getMonth(),1)}function it(t,s){const n=new Date(t);return n.setDate(n.getDate()+s),n}function Ee(t){return(t.getDay()+6)%7}function _e(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function Ht(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}function Wt(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(n=>n.trim()).filter(Boolean).flatMap(n=>{const r=n.replace(/^[•\\-–—]\\s*/,"").trim();return r?[r]:[]}):[]}function Xt(t){if(!t)return null;const n=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!n)return null;const r=Number(String(n[1]).replace(",","."));return Number.isFinite(r)?n[2].toLowerCase()==="m"?_e(r):r:null}function Gt(t,s){const n=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,r=String(n||"").toLowerCase();if(r.includes("mat")||r.includes("morning")||r==="am")return"AM";if(r.includes("soir")||r.includes("evening")||r==="pm")return"PM";const f=`${t?.title??""} ${t?.description??""}`.toLowerCase();return f.includes("matin")||f.includes(" am ")||f.includes("(am)")?"AM":f.includes("soir")||f.includes(" pm ")||f.includes("(pm)")?"PM":s===0?"AM":"PM"}function Zt(t){const s=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!s)return null;const n=String(s),r=n.length>=10?n.slice(0,10):n;return/\d{4}-\d{2}-\d{2}/.test(r)?r:null}function Ut(t){const s=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(s!=null&&Number.isFinite(Number(s))){const f=Number(s);return f>0&&f<=50?f:_e(f)}const n=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(n!=null&&Number.isFinite(Number(n)))return Number(n);const r=Xt(`${t?.title??""} ${t?.description??""}`);return r??null}function at(t){const s=Number(t);if(!Number.isFinite(s))return"—";const n=Math.round(s*100)/100,r=String(n);return r.endsWith(".0")?r.slice(0,-2):r}function es(){const t={};for(let s=0;s<7;s++)t[s]={AM:!0,PM:!0};return t}function Pe(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function ts({sessions:t,assignments:s,userId:n,user:r}){const f=`swim-dashboard-v2:${n??r??"anon"}`,m=`${f}:presenceDefaults`,S=`${f}:attendanceOverrides`,u=`${f}:stableFields`,[g,v]=i.useState(()=>es()),[N,M]=i.useState({}),[E,P]=i.useState(90);i.useEffect(()=>{if(typeof window>"u")return;const l=Pe(window.localStorage.getItem(m));l&&v(l);const a=Pe(window.localStorage.getItem(S));a&&M(a);const d=Pe(window.localStorage.getItem(u));d?.duration&&Number.isFinite(d.duration)&&d.duration>=30&&d.duration<=240&&P(d.duration)},[m,S,u]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(m,JSON.stringify(g))},[g,m]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(S,JSON.stringify(N))},[N,S]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(u,JSON.stringify({duration:E}))},[E,u]);const b=i.useMemo(()=>new Date,[]),[c,p]=i.useState(()=>ot(new Date)),[h,A]=i.useState(()=>rt(new Date)),[Y,fe]=i.useState(!1),[Q,de]=i.useState(!1),[he,_]=i.useState(!1),[w,K]=i.useState(null),[D,V]=i.useState(!1),[O,U]=i.useState(null),[H,W]=i.useState(!1),[y,F]=i.useTransition(),q=i.useMemo(()=>(Array.isArray(s)?s:[]).filter(a=>a?.session_type==="swim"),[s]),ee=i.useMemo(()=>{const l=new Map;for(const a of q){const d=Zt(a);d&&(l.has(d)||l.set(d,[]),l.get(d).push(a))}for(const[a,d]of l.entries())d.sort((j,k)=>Number(j?.id??0)-Number(k?.id??0)),l.set(a,d);return l},[q]),T=i.useMemo(()=>{const l=Array.isArray(t)?t:[],a={};for(const d of l){const j=String(d?.date??"").slice(0,10),k=d?.slot==="Soir"?"PM":"AM";a[`${j}__${k}`]=d}return a},[t]),ye=i.useRef(new Map);i.useEffect(()=>{ye.current.clear()},[ee]);const oe=i.useCallback(l=>{const a=ye.current;if(a.has(l))return a.get(l);const d=[{id:`${l}__AM`,iso:l,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${l}__PM`,iso:l,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],j=ee.get(l)??[],k=new Set;return j.forEach((I,le)=>{const Z=I,se=Gt(Z,le);if(k.has(se))return;const xe=se==="AM"?0:1,Ce=Ut(Z),Ae=Array.isArray(Z?.details)?Z.details.map(String):Wt(I?.description);d[xe]={id:`${l}__${se}`,iso:l,slotKey:se,title:String(I?.title??"Séance coach"),km:Ce,details:Ae,assignmentId:typeof I?.id=="number"?I.id:Number(I?.id)||void 0,isEmpty:!1},k.add(se)}),a.set(l,d),d},[ee]),ce=i.useCallback((l,a)=>{const d=Ee(a),j=!!g?.[d]?.[l.slotKey],k=N[l.id];return k==="present"?{status:"present",expected:!0,expectedByDefault:j}:k==="absent"?{status:"absent",expected:!0,expectedByDefault:j}:j?{status:"present",expected:!0,expectedByDefault:j}:{status:"not_expected",expected:!1,expectedByDefault:j}},[N,g]),J=i.useMemo(()=>ot(c),[c]),X=i.useMemo(()=>{const l=Ee(J),a=it(J,-l),d=[];for(let j=0;j<42;j++)d.push(it(a,j));return d},[J]),ue=i.useMemo(()=>{const l={};for(const a of X){const d=rt(a),j=oe(d);let k=0,I=0;for(const le of j){const Z=ce(le,a);if(!Z.expected)continue;k+=1;const se=!!T[le.id],xe=Z.status==="absent";(se||xe)&&(I+=1)}l[d]={completed:I,total:k}}return l},[X,oe,ce,T]),ie=i.useMemo(()=>{const[l,a,d]=h.split("-").map(Number);return new Date(l,a-1,d)},[h]),te=i.useMemo(()=>oe(h),[oe,h]),G=ue[h]||{completed:0,total:2},R=i.useMemo(()=>{const l=Array.isArray(t)?t:[];let a=0;for(const d of l){const j=String(d?.date??"").slice(0,10),k=d?.slot==="Soir"?"PM":"AM",I=`${j}__${k}`;if(N[I]==="absent")continue;const le=Ee(new Date(j));(g?.[le]?.[k]||N[I]==="present")&&Number.isFinite(Number(d?.distance))&&(a+=Number(d.distance))}return at(_e(a))},[t,N,g]),B=i.useMemo(()=>{const l=te;let a=0;for(const d of l){const j=ce(d,ie);if(!j.expected||j.status==="absent")continue;const k=T[d.id];k&&Number.isFinite(Number(k?.distance))&&(a+=Number(k.distance))}return at(_e(a))},[te,ce,ie,T]),me=i.useMemo(()=>w&&T[w]||null,[w,T]),ae=i.useMemo(()=>{const l=me||{},a=l?.stroke_distances,d=a?{NL:a.NL?String(a.NL):"",DOS:a.DOS?String(a.DOS):"",BR:a.BR?String(a.BR):"",PAP:a.PAP?String(a.PAP):"",QN:a.QN?String(a.QN):""}:st;return{difficulty:l?.effort??null,fatigue_end:l?.fatigue??l?.feeling??null,performance:l?.performance??l?.feeling??null,engagement:l?.engagement??l?.feeling??null,comment:String(l?.comments??""),distanceMeters:Number.isFinite(Number(l?.distance))?Number(l.distance):null,showStrokeDetail:!!(a&&Object.values(a).some(j=>j&&j>0)),strokes:d,exerciseLogs:[]}},[me]),[z,be]=i.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:st,exerciseLogs:[]}));return i.useEffect(()=>{const l=te.find(a=>a.id===w);if(l){const a=Ht(l.km??0);be(d=>({...d,...ae,distanceMeters:ae.distanceMeters==null?a:ae.distanceMeters}));return}be(a=>({...a,...ae}))},[ae,w,te]),i.useEffect(()=>{Y&&H&&G.total>0&&G.completed>=G.total&&(fe(!1),K(null),V(!1),W(!1))},[Y,H,G.completed,G.total]),{today:b,monthCursor:c,selectedISO:h,drawerOpen:Y,settingsOpen:Q,infoOpen:he,activeSessionId:w,detailsOpen:D,selectedDayIndex:O,isPending:y,presenceDefaults:g,attendanceOverrideBySessionId:N,stableDurationMin:E,draftState:z,gridDates:X,completionByISO:ue,selectedDate:ie,sessionsForSelectedDay:te,selectedDayStatus:G,globalKm:R,dayKm:B,logsBySessionId:T,setMonthCursor:p,setSelectedISO:A,setDrawerOpen:fe,setSettingsOpen:de,setInfoOpen:_,setActiveSessionId:K,setDetailsOpen:V,setSelectedDayIndex:U,setPresenceDefaults:v,setAttendanceOverrideBySessionId:M,setStableDurationMin:P,setDraftState:be,setAutoCloseArmed:W,startTransition:F,getSessionStatus:ce,getSessionsForISO:oe}}function Je(...t){return t.filter(Boolean).join(" ")}function ss(t){return t.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})}function Ke({onClick:t,label:s,children:n,tone:r="neutral",disabled:f}){const m={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:f,className:Je("inline-flex items-center justify-center rounded-2xl border p-2 transition",m[r],f&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":s,title:s,children:[n,e.jsx("span",{className:"sr-only",children:s})]})}function ns({monthCursor:t,selectedDayStatus:s,onPrevMonth:n,onNextMonth:r,onJumpToday:f}){return e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Ke,{onClick:n,label:"Mois précédent",children:e.jsx(Ct,{className:"h-5 w-5"})}),e.jsx(Ke,{onClick:r,label:"Mois suivant",children:e.jsx(Qe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"min-w-0 text-center",children:[e.jsx("div",{className:"text-base font-semibold text-foreground capitalize truncate",children:ss(t)}),e.jsxs("div",{className:"mt-1 flex items-center justify-center gap-1",children:[e.jsx("span",{className:Je("h-1.5 w-1.5 rounded-full",s.total>0&&s.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:Je("h-1.5 w-1.5 rounded-full",s.total>0&&s.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]}),e.jsx(Ke,{onClick:f,label:"Aller à aujourd'hui",tone:"neutral",children:e.jsx(De,{className:"h-5 w-5"})})]})}function ke(...t){return t.filter(Boolean).join(" ")}function rs(t){const s=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())}`}function os({completed:t,total:s}){return s===0?"rest":t>=s?"full":t>0?"half":"none"}const is=i.memo(function({date:s,inMonth:n,isToday:r,isSelected:f,isFocused:m,status:S,onClick:u,onKeyDown:g}){const{completed:v,total:N}=S,M=os(S),E=M==="full"?"bg-primary":M==="half"?"bg-primary/10":M==="none"?"bg-muted":"bg-muted/50",P=M==="full"?"border-primary":M==="half"?"border-primary/30":M==="none"?"border-muted-foreground/20":"border-border",b=M==="full"?"text-primary-foreground":"text-foreground",c=M==="full"?"bg-primary-foreground/25":"bg-muted-foreground/30",p=M==="full"?"bg-primary-foreground":"bg-primary",h=f?M==="full"?"ring-2 ring-primary-foreground/50":"ring-2 ring-primary/30":"",A=r?M==="full"?"ring-2 ring-primary-foreground/40":"ring-2 ring-primary/50":"",Y=m?"ring-2 ring-primary":"";return e.jsx("button",{type:"button",onClick:u,onKeyDown:g,tabIndex:m?0:-1,"data-calendar-cell":"true",className:ke("aspect-square min-w-0 rounded-2xl border p-1 transition",E,P,!n&&"opacity-40","hover:shadow-sm focus:outline-none",h,A,Y),"aria-label":`${rs(s)} — ${N===0?"Repos":`${v}/${N}`}`,children:e.jsxs("div",{className:"flex h-full flex-col justify-between",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("div",{className:ke("text-[12px] font-semibold",b),children:s.getDate()}),e.jsx("div",{className:"h-[14px] w-[14px]"})]}),e.jsx("div",{className:"flex items-center justify-end",children:N>0&&e.jsx("div",{className:"w-6",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:ke("h-1.5 flex-1 rounded-full",v>=1?p:c)}),e.jsx("span",{className:ke("h-1.5 flex-1 rounded-full",v>=2?p:c)})]})})})]})})}),as=["L","M","M","J","V","S","D"],ls=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];function ds(t){const s=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())}`}function cs(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function us({monthCursor:t,gridDates:s,completionByISO:n,selectedISO:r,selectedDayIndex:f,today:m,onDayClick:S,onKeyDown:u}){return e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[as.map((g,v)=>e.jsxs("div",{className:"px-0.5 pb-1 text-[10px] font-semibold text-muted-foreground text-center",children:[e.jsx("span",{className:"sm:hidden",children:g}),e.jsx("span",{className:"hidden sm:inline",children:ls[v]})]},g+v)),s.map((g,v)=>{const N=ds(g),M=g.getMonth()===t.getMonth(),E=N===r,P=n[N]||{completed:0,total:2},b=cs(g,m),c=f===v||f===null&&b;return e.jsx(is,{date:g,inMonth:M,isToday:b,isSelected:E,isFocused:c,status:P,onClick:()=>S(N),onKeyDown:p=>u(p,v)},N)})]})})}function Le(...t){return t.filter(Boolean).join(" ")}const lt={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function ms({strokes:t,showStrokeDetail:s,disabled:n=!1,onToggle:r,onChange:f}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:n,onClick:r,className:Le("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",n?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(Qe,{className:Le("h-4 w-4 transition-transform",s&&"rotate-90")})]}),s&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(lt).map(m=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:lt[m]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:n,value:t[m],onChange:S=>f({...t,[m]:S.target.value}),placeholder:"0",className:Le("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",n?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},m))})]})}function Te(...t){return t.filter(Boolean).join(" ")}function xs({exerciseLogs:t,assignmentItems:s,disabled:n=!1,onLogsChange:r}){const[f,m]=i.useState(t.length>0),[S,u]=i.useState(""),g=b=>{const c=b.label||`Exercice ${b.ordre??""}`;t.some(p=>p.source_item_id===b.id)||r([...t,{exercise_label:c,source_item_id:b.id??null,split_times:[],tempo:null,stroke_count:[],notes:null}])},v=()=>{const b=S.trim();b&&(r([...t,{exercise_label:b,source_item_id:null,split_times:[],tempo:null,stroke_count:[],notes:null}]),u(""))},N=b=>{r(t.filter((c,p)=>p!==b))},M=(b,c)=>{r(t.map((p,h)=>h===b?{...p,...c}:p))},P=(Array.isArray(s)?s:[]).filter(b=>b.id!=null&&!t.some(c=>c.source_item_id===b.id));return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:n,onClick:()=>m(b=>!b),className:Te("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",n?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(xt,{className:"h-4 w-4"}),"Notes techniques",t.length>0&&e.jsx("span",{className:"inline-flex items-center rounded-full bg-primary/10 px-1.5 py-0.5 text-xs font-semibold text-primary",children:t.length})]}),e.jsx(Qe,{className:Te("h-4 w-4 transition-transform",f&&"rotate-90")})]}),f&&!n&&e.jsxs("div",{className:"mt-2 space-y-3",children:[P.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground",children:"Exercices de la seance"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:P.map(b=>e.jsxs("button",{type:"button",onClick:()=>g(b),className:"inline-flex items-center gap-1 rounded-full border border-border bg-card px-2.5 py-1 text-xs font-medium text-foreground hover:bg-muted transition",children:[e.jsx(ge,{className:"h-3 w-3"}),b.label||`Ex. ${b.ordre??""}`]},b.id))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:S,onChange:b=>u(b.target.value),onKeyDown:b=>{b.key==="Enter"&&(b.preventDefault(),v())},placeholder:"Exercice libre (ex: 4x50 max)",className:"flex-1 rounded-xl border border-border bg-card px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:v,disabled:!S.trim(),className:Te("rounded-xl border px-3 py-2 text-sm font-semibold transition",S.trim()?"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:e.jsx(ge,{className:"h-4 w-4"})})]}),t.map((b,c)=>e.jsx(fs,{log:b,onUpdate:p=>M(c,p),onRemove:()=>N(c)},c))]})]})}function fs({log:t,onUpdate:s,onRemove:n}){const[r,f]=i.useState((t.split_times?.length??0)>0),[m,S]=i.useState((t.stroke_count?.length??0)>0),u=t.split_times??[],g=t.stroke_count??[],v=()=>{s({split_times:[...u,{rep:u.length+1,time_seconds:0}]}),f(!0)},N=(c,p)=>{s({split_times:u.map((h,A)=>A===c?{...h,time_seconds:p}:h)})},M=c=>{const p=u.filter((h,A)=>A!==c).map((h,A)=>({...h,rep:A+1}));s({split_times:p}),p.length===0&&f(!1)},E=()=>{s({stroke_count:[...g,{rep:g.length+1,count:0}]}),S(!0)},P=(c,p)=>{s({stroke_count:g.map((h,A)=>A===c?{...h,count:p}:h)})},b=c=>{const p=g.filter((h,A)=>A!==c).map((h,A)=>({...h,rep:A+1}));s({stroke_count:p}),p.length===0&&S(!1)};return e.jsxs("div",{className:"rounded-2xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-border bg-muted/50",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground truncate",children:t.exercise_label}),e.jsx("button",{type:"button",onClick:n,className:"p-1 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition","aria-label":"Supprimer",children:e.jsx(Ie,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground min-w-[80px]",children:[e.jsx(Et,{className:"h-3.5 w-3.5"}),"Tempo"]}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:t.tempo??"",onChange:c=>s({tempo:c.target.value?Number(c.target.value):null}),placeholder:"coups/min",className:"w-24 rounded-xl border border-border bg-background px-2 py-1.5 text-sm text-center outline-none focus:ring-2 focus:ring-foreground/10"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(xt,{className:"h-3.5 w-3.5"}),"Temps"]}),e.jsxs("button",{type:"button",onClick:v,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(ge,{className:"h-3 w-3"}),"Rep"]})]}),r&&u.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:u.map((c,p)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:c.rep}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:c.time_seconds||"",onChange:h=>N(p,Number(h.target.value)||0),placeholder:"sec",className:"w-16 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>M(p),className:"p-0.5 text-muted-foreground hover:text-destructive transition","aria-label":`Supprimer rep ${c.rep}`,children:e.jsx(Ie,{className:"h-3 w-3"})})]},p))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(Kt,{className:"h-3.5 w-3.5"}),"Coups de bras"]}),e.jsxs("button",{type:"button",onClick:E,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(ge,{className:"h-3 w-3"}),"Rep"]})]}),m&&g.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:g.map((c,p)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:c.rep}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,value:c.count||"",onChange:h=>P(p,Number(h.target.value)||0),placeholder:"nb",className:"w-14 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>b(p),className:"p-0.5 text-muted-foreground hover:text-destructive transition","aria-label":`Supprimer rep ${c.rep}`,children:e.jsx(Ie,{className:"h-3 w-3"})})]},p))})]}),e.jsx("div",{children:e.jsx("textarea",{value:t.notes??"",onChange:c=>s({notes:c.target.value||null}),placeholder:"Notes libres...",rows:2,className:"w-full resize-none rounded-xl border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"})})]})]})}function $(...t){return t.filter(Boolean).join(" ")}function bs(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function Ye(t){const s=Number(t);if(!Number.isFinite(s))return"—";const n=Math.round(s*100)/100,r=String(n);return r.endsWith(".0")?r.slice(0,-2):r}function ps(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function gs(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}const Be=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],hs=[{key:"AM",label:"Matin",Icon:Yt},{key:"PM",label:"Soir",Icon:Bt}];function Se({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function ve({onClick:t,label:s,children:n,tone:r="neutral",disabled:f}){const m={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:f,className:$("inline-flex items-center justify-center rounded-2xl border p-2 transition",m[r],f&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":s,title:s,children:[n,e.jsx("span",{className:"sr-only",children:s})]})}function ys(t,s){const n=Number(s);return!Number.isFinite(n)||n<1||n>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[n]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[n]}function js({plannedMeters:t,valueMeters:s,onChange:n,disabled:r}){const u=Number.isFinite(Number(s))?Number(s):t,g=u-t;return e.jsxs("div",{className:$("mt-4 rounded-3xl border px-4 py-3",r?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:$("text-xs font-semibold",r?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),e.jsx("div",{className:$("text-xs","text-muted-foreground"),children:g===0?"":g>0?`+${g}m`:`${g}m`})]}),e.jsxs("div",{className:"mt-2 flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:r||u-100<0,onClick:()=>n(u-100),className:$("h-11 w-11 rounded-2xl border flex items-center justify-center",r?"bg-muted border-border text-muted-foreground":"bg-card border-border text-foreground hover:bg-muted"),"aria-label":"-100m",children:e.jsx(ft,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-[120px] text-center",children:[e.jsxs("div",{className:$("text-lg font-semibold",r?"text-muted-foreground":"text-foreground"),children:[u,"m"]}),e.jsxs("div",{className:$("text-xs","text-muted-foreground"),children:["(",Ye(ps(u))," km)"]})]}),e.jsx("button",{type:"button",disabled:r||u+100>3e4,onClick:()=>n(u+100),className:$("h-11 w-11 rounded-2xl border flex items-center justify-center",r?"bg-muted border-border text-muted-foreground":"bg-card border-border text-foreground hover:bg-muted"),"aria-label":"+100m",children:e.jsx(ge,{className:"h-5 w-5"})})]})]})}function Ns({open:t,selectedDate:s,sessionsForSelectedDay:n,selectedDayStatus:r,dayKm:f,activeSessionId:m,detailsOpen:S,draftState:u,saveState:g,isPending:v,logsBySessionId:N,assignmentItems:M,onClose:E,onDayOffAll:P,onOpenSession:b,onCloseSession:c,onToggleDetails:p,onMarkAbsent:h,onMarkPresent:A,onClearOverride:Y,onSaveFeedback:fe,onDraftStateChange:Q,getSessionStatus:de}){const[,he]=kt(),_=i.useMemo(()=>m&&n.find(w=>w.id===m)||null,[m,n]);return e.jsx(Me,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(ne.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:E}),e.jsx(ne.div,{className:$("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:Ot,initial:"hidden",animate:"visible",exit:"exit",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden",children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b bg-background px-4 sm:px-5 py-3",children:[e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-base font-semibold text-foreground",children:bs(s)})}),e.jsx(ve,{onClick:E,label:"Fermer",children:e.jsx(qe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 pb-24 sm:p-5 sm:pb-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl border border-border bg-card flex items-center justify-center",children:e.jsx(ze,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[f," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:$("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:$("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})]}),e.jsx(ve,{onClick:P,label:"OFF (absent journée)",tone:"dark",disabled:v,children:e.jsx(qt,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mt-4 grid gap-2",children:n.map(w=>{const K=de(w,s),D=!!N[w.id],V=K.status==="absent",O=K.status==="not_expected",U=V||O,H=K.expected&&!D&&!V,W=D?"bg-status-success-bg border-status-success/30":U?"bg-sky-50 border-sky-200":H?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",y=hs.find(F=>F.key===w.slotKey)?.Icon||De;return e.jsx("button",{type:"button",onClick:()=>b(w.id),className:$("w-full rounded-3xl border px-3 py-3 text-left transition",W,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:$("h-10 w-10 rounded-2xl border flex items-center justify-center",D?"border-status-success/30 bg-status-success-bg":U?"border-sky-200 bg-sky-100":H?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(y,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:w.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[w.isEmpty?e.jsx(Se,{children:"Vide"}):e.jsxs(Se,{children:[Ye(w.km)," km"]}),D&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),U&&!D&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),H&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(De,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[O&&e.jsx(ve,{onClick:F=>{F.stopPropagation(),A(w.id)},label:"Je suis venu",disabled:v,children:e.jsx(tt,{className:"h-5 w-5"})}),K.expected&&!D&&!V&&e.jsx(ve,{onClick:F=>{F.stopPropagation(),h(w.id)},label:"Absent",tone:"sky",disabled:v,children:e.jsx(we,{className:"h-5 w-5"})})]})]})},w.id)})}),e.jsx(Me,{children:_&&e.jsx(ne.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:Ze.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const w=de(_,s),K=w.status==="absent",D=w.status==="not_expected",V=!!N[_.id],O=w.expected&&!K,U=K?"Annuler":D?"Je suis venu":"Absent",H=K?()=>Y(_.id):D?()=>A(_.id):()=>h(_.id),W=gs(_.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:_.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[_.isEmpty?e.jsx(Se,{children:"Vide"}):e.jsxs(Se,{children:[Ye(_.km)," km"]}),V?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(Ue,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):K||D?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(we,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(De,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx(ve,{onClick:c,label:"Retour",children:e.jsx(qe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:H,className:$("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",D?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[D?e.jsx(tt,{className:"h-4 w-4"}):e.jsx(we,{className:"h-4 w-4"}),U]}),e.jsxs("button",{type:"button",onClick:p,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(St,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(Me,{children:S&&e.jsxs(ne.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:Ze.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:[_.details?.length?e.jsx("ul",{className:"list-disc pl-5 space-y-1 text-sm text-foreground",children:_.details.map((y,F)=>e.jsx("li",{children:y},F))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:_.assignmentId?"Séance coach — détails dans la fiche.":"Aucun détail pour ce créneau."}),_.assignmentId?e.jsx("div",{className:"mt-3",children:e.jsx("button",{type:"button",onClick:()=>he(`/swim-session?assignmentId=${_.assignmentId}`),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:"Ouvrir la fiche complète"})}):null]})}),e.jsxs("div",{className:"px-4 pb-4",children:[!O&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:K?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(ne.div,{className:"space-y-4",variants:$t,initial:"hidden",animate:"visible",children:[Be.map(y=>{const F=u[y.key];return e.jsxs(ne.div,{className:"space-y-2",variants:Ge,children:[e.jsx("div",{className:$("text-sm font-semibold",O?"text-foreground":"text-muted-foreground"),children:y.label}),e.jsx("div",{className:"flex items-center gap-2",children:[1,2,3,4,5].map(q=>{const ee=F===q;return e.jsx("button",{type:"button",disabled:!O,onClick:()=>Q({...u,[y.key]:q}),className:$("h-11 w-11 rounded-2xl border text-sm font-semibold transition",O?ee?ys(y.mode,q):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:q},q)})})]},y.key)}),e.jsxs(ne.div,{className:"space-y-2",variants:Ge,children:[e.jsx("div",{className:$("text-sm font-semibold",O?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:u.comment,onChange:y=>Q({...u,comment:y.target.value}),disabled:!O,rows:3,placeholder:"Sensations, points techniques…",className:$("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",O?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsx(js,{plannedMeters:W,valueMeters:u.distanceMeters,onChange:y=>Q({...u,distanceMeters:y}),disabled:!O}),e.jsx(ms,{strokes:u.strokes,showStrokeDetail:u.showStrokeDetail,disabled:!O,onToggle:()=>Q({...u,showStrokeDetail:!u.showStrokeDetail}),onChange:y=>Q({...u,strokes:y})}),e.jsx(xs,{exerciseLogs:u.exerciseLogs,assignmentItems:M,disabled:!O,onLogsChange:y=>Q({...u,exerciseLogs:y})}),e.jsxs(At,{saveState:g,children:[e.jsx("button",{type:"button",onClick:fe,disabled:v||!O||!Be.every(y=>Number.isInteger(u[y.key])),className:$("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",v||!O?"bg-muted text-muted-foreground cursor-not-allowed":Be.every(y=>Number.isInteger(u[y.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"→ km"})]})]})]})})()},_.id)})]})]})})]})})}const vs=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],ws=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],ks=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function dt(...t){return t.filter(Boolean).join(" ")}function ct(t){return String(t).padStart(2,"0")}function Re(t){return`${t.getFullYear()}-${ct(t.getMonth()+1)}-${ct(t.getDate())}`}function Ss(t){return new Date(t.getFullYear(),t.getMonth(),1)}function Ms(t){const s=String(t).split("__");return{iso:s[0],slotKey:s[1]||""}}function ut(t,s){return Number.isFinite(t)?Math.round(t/s)*s:0}function mt({open:t,title:s,onClose:n,children:r}){return e.jsx(Me,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(ne.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:n}),e.jsx(ne.div,{className:"fixed inset-0 z-modal flex items-end sm:items-center justify-center p-3 pb-24 sm:p-4 sm:pb-4",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:e.jsxs("div",{className:"w-full max-w-md rounded-3xl border bg-background shadow-2xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[e.jsx("div",{className:"truncate text-base font-semibold text-foreground",children:s}),e.jsxs("button",{type:"button",onClick:n,className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Fermer",children:[e.jsx(qe,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"Fermer"})]})]}),e.jsx("div",{className:"p-4",children:r})]})})]})})}function Js(){const{user:t,userId:s}=Mt(),{toast:n}=Dt(),r=wt(),[f,m]=vt.useState("idle"),{data:S,isLoading:u,error:g,refetch:v}=We({queryKey:["sessions",s??t],queryFn:()=>Ne.getSessions(t,s),enabled:!!t}),{data:N,isLoading:M,error:E,refetch:P}=We({queryKey:["assignments",t],queryFn:()=>Ne.getAssignments(t,s),enabled:!!t}),b=u||M,c=g||E,p=()=>{v(),P()},h=Fe({mutationFn:o=>Ne.deleteSession(o),onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),n({title:"Séance supprimée",description:"La saisie a été supprimée."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),A=Fe({mutationFn:o=>Ne.syncSession({...o,athlete_name:t,athlete_id:s??void 0}),onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["assignments"]}),n({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),Y=Fe({mutationFn:o=>Ne.updateSession(o),onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),n({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),fe=ts({sessions:S,assignments:N,userId:s,user:t}),{today:Q,monthCursor:de,selectedISO:he,drawerOpen:_,settingsOpen:w,infoOpen:K,activeSessionId:D,detailsOpen:V,selectedDayIndex:O,isPending:U,presenceDefaults:H,stableDurationMin:W,draftState:y,gridDates:F,completionByISO:q,selectedDate:ee,sessionsForSelectedDay:T,selectedDayStatus:ye,globalKm:oe,dayKm:ce,logsBySessionId:J,setMonthCursor:X,setSelectedISO:ue,setDrawerOpen:ie,setSettingsOpen:te,setInfoOpen:G,setActiveSessionId:R,setDetailsOpen:B,setSelectedDayIndex:me,setPresenceDefaults:ae,setAttendanceOverrideBySessionId:z,setStableDurationMin:be,setDraftState:l,setAutoCloseArmed:a,startTransition:d,getSessionStatus:j}=fe,k=i.useCallback(o=>{ue(o),ie(!0),R(null),B(!1);const x=q[o]||{completed:0,total:2};a(x.total>0&&x.completed<x.total)},[q,ue,ie,R,B,a]),I=i.useCallback(()=>{ie(!1),R(null),B(!1),a(!1),me(null)},[ie,R,B,a,me]),le=i.useCallback(()=>{X(o=>new Date(o.getFullYear(),o.getMonth()-1,1))},[X]),Z=i.useCallback(()=>{X(o=>new Date(o.getFullYear(),o.getMonth()+1,1))},[X]),se=i.useCallback(()=>{const o=new Date;X(Ss(o)),k(Re(o))},[k,X]),xe=i.useCallback(o=>{R(o),B(!1)},[R,B]),Ce=i.useCallback(o=>{d(()=>{z(C=>({...C,[o]:"absent"}))});const x=J[o];x?.id&&h.mutate(Number(x.id))},[h,J,d,z]),Ae=i.useCallback(o=>{d(()=>{z(x=>({...x,[o]:"present"}))})},[d,z]),bt=i.useCallback(o=>{d(()=>{z(x=>{const C={...x};return delete C[o],C})})},[d,z]),pt=i.useCallback(()=>{const o=T.map(x=>j(x,ee).expected?x.id:null).filter(Boolean);o.length!==0&&(d(()=>{z(x=>{const C={...x};for(const L of o)C[L]="absent";return C}),R(null),B(!1)}),o.forEach(x=>{const C=J[x];C?.id&&h.mutate(Number(C.id))}))},[T,j,ee,d,J,h,z,R,B]),gt=i.useCallback(()=>{if(!D||!t||!ks.every(je=>Number.isInteger(y[je.key])))return;const{iso:x,slotKey:C}=Ms(D),L=C==="PM"?"Soir":"Matin",pe=ut(Number(y.distanceMeters??0),100),jt=ut(Number(W),15),Oe={};for(const[je,Nt]of Object.entries(y.strokes)){const He=Number(Nt);He>0&&(Oe[je]=He)}const Ve={date:x,slot:L,distance:pe,duration:jt,effort:Number(y.difficulty),feeling:Number(y.fatigue_end),performance:Number(y.performance),engagement:Number(y.engagement),comments:String(y.comment||"").slice(0,400),athlete_name:t,athlete_id:s??void 0,stroke_distances:Object.keys(Oe).length>0?Oe:null},$e=J[D];d(()=>{z(je=>({...je,[D]:"present"}))}),$e?.id?Y.mutate({...Ve,id:$e.id,created_at:$e.created_at??new Date().toISOString()}):A.mutate(Ve),R(null),B(!1)},[D,t,s,y,W,J,d,Y,A,z,R,B]),ht=i.useCallback((o,x)=>{ae(C=>({...C,[o]:{...C[o],[x]:!C[o][x]}}))},[ae]);i.useEffect(()=>{if(!_)return;const o=x=>{if(x.key==="Escape"){x.preventDefault(),I();return}(x.key==="Enter"||x.key===" ")&&(x.preventDefault(),T.length>0&&!D&&xe(T[0].id))};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[_,I,T,D,xe]);const yt=i.useCallback((o,x)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(o.key))return;if(o.preventDefault(),o.key==="Enter"||o.key===" "){const pe=Re(F[x]);k(pe);return}let L=x;o.key==="ArrowLeft"&&(L=Math.max(0,x-1)),o.key==="ArrowRight"&&(L=Math.min(F.length-1,x+1)),o.key==="ArrowUp"&&(L=Math.max(0,x-7)),o.key==="ArrowDown"&&(L=Math.min(F.length-1,x+7)),me(L),ue(Re(F[L])),setTimeout(()=>{const pe=document.querySelectorAll('[data-calendar-cell="true"]');pe[L]&&pe[L].focus()},0)},[F,k,me,ue]);return b?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-border bg-card/90 backdrop-blur",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl bg-muted animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((o,x)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${x}`)),Array.from({length:35}).map((o,x)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${x}`))]})})]})})]}):c?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Ft,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:c.message}),e.jsx(_t,{onClick:()=>p(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-border bg-card/90 backdrop-blur",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl bg-card border border-border flex items-center justify-center",children:e.jsx(ze,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Suivi"}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[oe," km"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>G(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Infos",children:e.jsx(Xe,{className:"h-5 w-5"})}),e.jsx("button",{type:"button",onClick:()=>te(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Paramètres",children:e.jsx(et,{className:"h-5 w-5"})})]})]})}),e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:[e.jsxs("div",{className:"invisible sm:visible flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl bg-card border border-border flex items-center justify-center",children:e.jsx(ze,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Suivi"}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[oe," km"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>G(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Infos",children:e.jsx(Xe,{className:"h-5 w-5"})}),e.jsx("button",{type:"button",onClick:()=>te(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Paramètres",children:e.jsx(et,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(ns,{monthCursor:de,selectedDayStatus:ye,onPrevMonth:le,onNextMonth:Z,onJumpToday:se}),e.jsx(us,{monthCursor:de,gridDates:F,completionByISO:q,selectedISO:he,selectedDayIndex:O,today:Q,onDayClick:k,onKeyDown:yt})]}),e.jsx(mt,{open:K,title:"Codes",onClose:()=>G(!1),children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-orange-200 bg-orange-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Orange"}),e.jsx("span",{className:"text-foreground",children:"À compléter"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Vert"}),e.jsx("span",{className:"text-foreground",children:"Validé → km"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-sky-200 bg-sky-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Bleu"}),e.jsx("span",{className:"text-foreground",children:"Absent / Non prévu"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Les km comptent uniquement après validation."})]})}),e.jsx(mt,{open:w,title:"Présence",onClose:()=>te(!1),children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Toggle hebdo (séances attendues)."}),e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_110px_110px] bg-muted border-b border-border px-3 py-2 text-xs font-semibold text-muted-foreground",children:[e.jsx("div",{children:"Jour"}),e.jsx("div",{className:"text-center",children:"Matin"}),e.jsx("div",{className:"text-center",children:"Soir"})]}),vs.map((o,x)=>e.jsxs("div",{className:dt("grid grid-cols-[1fr_110px_110px] items-center px-3 py-2",x!==6&&"border-b border-border"),children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:o}),ws.map(C=>{const L=!!H?.[x]?.[C.key];return e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{type:"button",onClick:()=>ht(x,C.key),className:dt("w-24 rounded-2xl border px-3 py-2 text-sm font-semibold transition",L?"bg-foreground text-background border-foreground":"bg-card text-foreground border-border hover:bg-muted"),"aria-label":`${o} ${C.label}`,children:L?"On":"Off"})},C.key)})]},o))]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>be(o=>Math.max(30,o-15)),"aria-label":"Diminuer la durée",children:e.jsx(ft,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[W," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>be(o=>Math.min(240,o+15)),"aria-label":"Augmenter la durée",children:e.jsx(ge,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-1 text-[11px] text-muted-foreground",children:"Durée envoyée au back-end (non affichée dans la maquette)."})]})]})}),e.jsx(Ns,{open:_,selectedDate:ee,sessionsForSelectedDay:T,selectedDayStatus:ye,dayKm:ce,activeSessionId:D,detailsOpen:V,draftState:y,saveState:f,isPending:U,logsBySessionId:J,onClose:I,onDayOffAll:pt,onOpenSession:xe,onCloseSession:()=>{R(null),B(!1)},onToggleDetails:()=>B(o=>!o),onMarkAbsent:Ce,onMarkPresent:Ae,onClearOverride:bt,onSaveFeedback:gt,onDraftStateChange:l,getSessionStatus:j})]})]})}export{Js as default};
