import{r as f,j as e,a as R,c as pt,u as fe,d as z}from"./vendor-query-BiSH4r2z.js";import{c as X,a as g,a3 as xt,T as ft,I as D,f as Oe,F as ht,B as I,u as gt,d as T,S as O}from"./index-D3EmcOuK.js";import{D as K,a as H,b as he,c as ge}from"./dialog-DSbHsAHo.js";import{A as be,a as ye,b as je,c as ve,d as Ne,e as we,f as Se,g as ke}from"./alert-dialog-Cjcvl1nv.js";import{C as bt}from"./chevron-right-B8RQ11Wd.js";import{i as Ue,g as yt,c as We,L as Ke,b as jt,a as He,R as vt}from"./SwimSessionConsultation-M4C3BVpb.js";import{F as Nt,S as wt,A as St,a as kt,d as _e,c as _t,e as Vt}from"./SessionListView-DcblIeYL.js";import{T as Ct}from"./textarea-Dvm_ht8P.js";import{S as Ve,a as Ce,b as Me,c as Ae,d as Te}from"./select-bk5-C2eI.js";import{T as te}from"./trash-2-CUhJ_2H1.js";import{P as se}from"./plus-CinS_FQV.js";import{f as Mt}from"./format-B9mPVj_w.js";import{C as De}from"./circle-alert-BeWS__P9.js";import{S as At}from"./search-CgAhGfVo.js";import{T as Tt}from"./timer-DN5gFM0R.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";import"./index-Cb_8mQdf.js";import"./index-CRFtnTRm.js";import"./index-BfpvRJnF.js";import"./badge-bC7rq-7G.js";import"./chevron-down-CHKNzRtt.js";import"./chevron-left-FXrqf1OZ.js";import"./save-CWnAO8a1.js";import"./index-BIJR8ldT.js";import"./check-DkoPzHvL.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Dt=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Et=X("copy",Dt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=[["path",{d:"m6 14 1.5-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.54 6a2 2 0 0 1-1.95 1.5H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H18a2 2 0 0 1 2 2v2",key:"usdka0"}]],Ee=X("folder-open",qt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ft=[["path",{d:"M15 21v-8a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v8",key:"5wwlr5"}],["path",{d:"M3 10a2 2 0 0 1 .709-1.528l7-6a2 2 0 0 1 2.582 0l7 6A2 2 0 0 1 21 10v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",key:"r6nss1"}]],qe=X("house",Ft);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $t=[["path",{d:"M11.017 2.814a1 1 0 0 1 1.966 0l1.051 5.558a2 2 0 0 0 1.594 1.594l5.558 1.051a1 1 0 0 1 0 1.966l-5.558 1.051a2 2 0 0 0-1.594 1.594l-1.051 5.558a1 1 0 0 1-1.966 0l-1.051-5.558a2 2 0 0 0-1.594-1.594l-5.558-1.051a1 1 0 0 1 0-1.966l5.558-1.051a2 2 0 0 0 1.594-1.594z",key:"1s2grr"}],["path",{d:"M20 2v4",key:"1rf3ol"}],["path",{d:"M22 4h-4",key:"gwowj6"}],["circle",{cx:"4",cy:"20",r:"2",key:"6kqj1y"}]],Bt=X("sparkles",$t),Qe=f.forwardRef(({...t},s)=>e.jsx("nav",{ref:s,"aria-label":"breadcrumb",...t}));Qe.displayName="Breadcrumb";const Xe=f.forwardRef(({className:t,...s},n)=>e.jsx("ol",{ref:n,className:g("flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5",t),...s}));Xe.displayName="BreadcrumbList";const Q=f.forwardRef(({className:t,...s},n)=>e.jsx("li",{ref:n,className:g("inline-flex items-center gap-1.5",t),...s}));Q.displayName="BreadcrumbItem";const re=f.forwardRef(({asChild:t,className:s,...n},a)=>{const i=t?xt:"a";return e.jsx(i,{ref:a,className:g("transition-colors hover:text-foreground",s),...n})});re.displayName="BreadcrumbLink";const ne=f.forwardRef(({className:t,...s},n)=>e.jsx("span",{ref:n,role:"link","aria-disabled":"true","aria-current":"page",className:g("font-normal text-foreground",t),...s}));ne.displayName="BreadcrumbPage";const ie=({children:t,className:s,...n})=>e.jsx("li",{role:"presentation","aria-hidden":"true",className:g("[&>svg]:w-3.5 [&>svg]:h-3.5",s),...n,children:t??e.jsx(bt,{})});ie.displayName="BreadcrumbSeparator";const Fe=["V0","V1","V2","V3","Max","Prog"],Lt={V0:"bg-intensity-1",V1:"bg-intensity-2",V2:"bg-intensity-3",V3:"bg-intensity-4",Max:"bg-intensity-5",Prog:"bg-intensity-prog"},$e={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},Pt=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if($e[n])return $e[n];if(n==="prog"||n==="progressif")return"Prog";const a=s.toUpperCase();if(a==="MAX")return"Max";if(a.startsWith("V")){const i=a.replace("V","V");return i==="V4"||i==="V5"?"Max":i}return s};function Rt({value:t,onChange:s,className:n,ariaLabel:a="S√©lection d'intensit√©"}){const i=Pt(t),h=Fe.includes(i)?i:"Max";return e.jsx("div",{role:"radiogroup","aria-label":a,className:g("flex flex-wrap items-center gap-1",n),children:Fe.map(x=>{const l=h===x,y=x==="Max"?"MAX":x==="Prog"?"Prog":x;return e.jsxs("button",{type:"button",role:"radio","aria-checked":l,"aria-label":`Intensit√© ${y}`,onClick:()=>s(x),className:g("flex flex-col items-center gap-1 rounded-full px-2 py-1 text-[10px] font-semibold text-muted-foreground transition","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",l?"text-foreground":"hover:text-foreground"),children:[x==="Prog"?e.jsx(ft,{className:g("h-3 w-3",l?"text-intensity-prog":"text-muted-foreground")}):e.jsx("span",{className:g("h-3 w-3 rounded-full",l?Lt[x]??"bg-primary":"bg-muted")}),e.jsx("span",{children:y})]},x)})})}const U=t=>t?{min:Math.floor(t/60),sec:t%60}:{min:0,sec:0},It=[{value:"palmes",label:"Palmes"},{value:"tuba",label:"Tuba"},{value:"plaquettes",label:"Plaquettes"},{value:"pull",label:"Pull"},{value:"elastique",label:"√âlastique"}],zt=[{value:"pap",label:"Papillon"},{value:"dos",label:"Dos"},{value:"brasse",label:"Brasse"},{value:"crawl",label:"Crawl"},{value:"4n",label:"4 nages"},{value:"spe",label:"Sp√©"}],Ot=[{value:"nc",label:"NC"},{value:"educ",label:"Educ"},{value:"jambes",label:"Jambes"}],Be={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},Ut=["V0","V1","V2","V3","Max","Prog"],Wt=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if(n==="prog"||n==="progressif")return"Prog";if(Be[n])return Be[n];const a=s.toUpperCase();if(a==="MAX")return"Max";if(a.startsWith("V")){const i=Number.parseInt(a.slice(1),10);if(Number.isFinite(i)&&i>=4)return"Max";if(Ut.includes(a))return a}return s},Kt=t=>t==="Max"?"MAX":t,Ht={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5",Prog:"text-intensity-prog"},Qt={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30",Prog:"ring-intensity-prog/30"};function Xt({exercise:t,onChange:s,onDelete:n,onDuplicate:a,showDelete:i=!0}){const h=Wt(t.intensity),x=t.modalities??"";return e.jsx("div",{className:"rounded-2xl border border-border bg-card p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"grid flex-1 grid-cols-2 sm:grid-cols-4 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"R√©p."}),e.jsx("div",{className:"mt-1",children:e.jsx(D,{type:"number",min:1,value:t.repetitions??"",onChange:l=>s("repetitions",l.target.value===""?null:Number(l.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Dist. (m)"}),e.jsx("div",{className:"mt-1",children:e.jsx(D,{type:"number",min:0,value:t.distance??"",onChange:l=>s("distance",l.target.value===""?null:Number(l.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Nage"}),e.jsx("div",{className:"mt-1",children:e.jsxs(Ve,{value:t.stroke,onValueChange:l=>s("stroke",l),children:[e.jsx(Ce,{className:"rounded-2xl",children:e.jsx(Me,{})}),e.jsx(Ae,{children:zt.map(l=>e.jsx(Te,{value:l.value,children:l.label},l.value))})]})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Type"}),e.jsx("div",{className:"mt-1",children:e.jsxs(Ve,{value:t.strokeType,onValueChange:l=>s("strokeType",l),children:[e.jsx(Ce,{className:"rounded-2xl",children:e.jsx(Me,{})}),e.jsx(Ae,{children:Ot.map(l=>e.jsx(Te,{value:l.value,children:l.label},l.value))})]})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Intensit√© (clic sur points)"}),e.jsxs("span",{className:g("inline-flex items-center gap-2 rounded-full bg-card px-2.5 py-1 text-xs font-semibold ring-1",Qt[h],Ht[h]),children:[e.jsx("span",{className:g("h-2 w-2 rounded-full",Ue[h]??"bg-muted")}),Kt(h)]})]}),e.jsx("div",{className:"mt-2 flex items-center justify-between gap-2",children:e.jsx(Rt,{value:t.intensity,onChange:l=>s("intensity",l)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"R√©cup√©ration"}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"inline-flex rounded-full border border-border bg-card p-0.5 text-xs font-semibold",children:[e.jsx("button",{type:"button",onClick:()=>s("restType","departure"),className:g("rounded-full px-2.5 py-1 transition-colors",t.restType==="departure"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:"D√©part"}),e.jsx("button",{type:"button",onClick:()=>s("restType","rest"),className:g("rounded-full px-2.5 py-1 transition-colors",t.restType==="rest"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:"Repos"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(D,{type:"number",min:0,max:59,value:U(t.rest).min||"",onChange:l=>{const y=l.target.value===""?0:Number(l.target.value),v=U(t.rest).sec;s("rest",y*60+v||null)},placeholder:"0",className:"w-12 rounded-2xl text-center"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"min"}),e.jsx(D,{type:"number",min:0,max:59,value:U(t.rest).sec||"",onChange:l=>{const y=l.target.value===""?0:Number(l.target.value),v=U(t.rest).min;s("rest",v*60+y||null)},placeholder:"0",className:"w-12 rounded-2xl text-center"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"sec"})]}),t.rest?e.jsx("button",{type:"button",onClick:()=>s("rest",null),className:"text-[11px] text-muted-foreground hover:text-foreground",children:"Effacer"}):null]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"√âquipements"}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:It.map(l=>{const y=t.equipment.includes(l.value),v=yt(l.value);return e.jsxs("button",{type:"button",onClick:()=>{const _=y?t.equipment.filter(k=>k!==l.value):[...t.equipment,l.value];s("equipment",_)},className:g("inline-flex items-center gap-2 rounded-full border px-3 py-2 text-xs font-semibold",y?"border-primary bg-primary text-primary-foreground":"border-border bg-card text-muted-foreground hover:bg-muted"),children:[e.jsx("span",{className:g("inline-flex h-7 w-7 items-center justify-center rounded-full",y?"bg-white/10":"bg-muted"),children:v?e.jsx("img",{src:v,alt:"",className:"h-4 w-4","aria-hidden":"true",loading:"lazy"}):null}),l.label]},l.value)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Modalit√©s"}),e.jsx("div",{className:"mt-1",children:e.jsx(Ct,{value:x,onChange:l=>s("modalities",l.target.value),placeholder:"Une modalit√© par ligne",rows:3,className:"rounded-2xl"})})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[a&&e.jsx("button",{type:"button",onClick:a,className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-muted-foreground hover:bg-muted","aria-label":"Dupliquer exercice",title:"Dupliquer exercice",children:e.jsx(Et,{className:"h-4 w-4"})}),i&&n&&e.jsx("button",{type:"button",onClick:n,className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer exercice",title:"Supprimer exercice",children:e.jsx(te,{className:"h-4 w-4"})})]})]})})}const Jt={nc:"NC",educ:"Educ",jambes:"Jambes"},Yt={nc:"bg-sky-100 text-sky-900 ring-sky-200",educ:"bg-violet-100 text-violet-900 ring-violet-200",jambes:"bg-teal-100 text-teal-900 ring-teal-200"},Gt={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5",Prog:"text-intensity-prog"},Zt={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30",Prog:"ring-intensity-prog/30"},Le={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},es=["V0","V1","V2","V3","Max","Prog"],ae=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if(n==="prog"||n==="progressif")return"Prog";if(Le[n])return Le[n];const a=s.toUpperCase();if(a==="MAX")return"Max";if(a.startsWith("V")){const i=Number.parseInt(a.slice(1),10);if(Number.isFinite(i)&&i>=4)return"Max";if(es.includes(a))return a}return s},ts=t=>t==="Max"?"MAX":t,ss=t=>{if(!t)return"";const s=Math.floor(t/60),n=t%60;return s>0&&n>0?`${s}'${n.toString().padStart(2,"0")}`:s>0?`${s}'00`:`${n}s`},Pe=t=>{let s=0;return t.flatMap((n,a)=>n.exercises.map((i,h)=>{const x={block_title:n.title,block_description:n.description||null,block_order:a,block_repetitions:n.repetitions??null,block_modalities:n.modalities||null,block_equipment:n.equipment??[],exercise_repetitions:i.repetitions??null,exercise_rest:i.rest??null,exercise_rest_type:i.restType??"rest",exercise_stroke:i.stroke||null,exercise_stroke_type:i.strokeType||null,exercise_intensity:i.intensity?ae(i.intensity):null,exercise_modalities:i.modalities||null,exercise_equipment:i.equipment??[],exercise_order:h},l=i.repetitions&&i.distance?`${i.repetitions}x${i.distance}m`:i.distance?`${i.distance}m`:null;return{ordre:s++,label:l,distance:i.distance??null,duration:null,intensity:i.intensity?ae(i.intensity):null,notes:i.modalities||null,raw_payload:x}}))};function rs({session:t,onSessionChange:s,onSave:n,onCancel:a,userId:i,isSaving:h}){const{toast:x}=Oe(),[l,y]=R.useState("blocks"),[v,_]=R.useState(""),[k,w]=R.useState(null),[E,b]=R.useState(null),q=f.useMemo(()=>We(Pe(t.blocks)),[t.blocks]),S=()=>{s({...t,blocks:[...t.blocks,{title:"Nouveau bloc",repetitions:1,description:"",modalities:"",equipment:[],exercises:[{repetitions:4,distance:50,rest:null,restType:"rest",stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}]}]})},F=(d,o,c)=>{const m=[...t.blocks];m[d]={...m[d],[o]:c},s({...t,blocks:m})},J=d=>{const o=t.blocks.filter((c,m)=>m!==d);s({...t,blocks:o})},A=(d,o)=>{const c=o==="up"?d-1:d+1;if(c<0||c>=t.blocks.length)return;const m=[...t.blocks],[j]=m.splice(d,1);m.splice(c,0,j),s({...t,blocks:m})},C=d=>{const o=[...t.blocks];o[d].exercises.push({repetitions:4,distance:50,rest:null,restType:"rest",stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}),s({...t,blocks:o})},$=(d,o,c,m)=>{const j=[...t.blocks],N=[...j[d].exercises];N[o]={...N[o],[c]:m},j[d]={...j[d],exercises:N},s({...t,blocks:j})},V=(d,o)=>{const c=[...t.blocks];c[d].exercises=c[d].exercises.filter((m,j)=>j!==o),s({...t,blocks:c})},B=(d,o)=>{const c=[...t.blocks],j={...c[d].exercises[o]};c[d].exercises=[...c[d].exercises.slice(0,o+1),j,...c[d].exercises.slice(o+1)],s({...t,blocks:c}),w({blockIndex:d,exerciseIndex:o+1})};return e.jsxs("div",{className:"animate-in slide-in-from-bottom-4 motion-reduce:animate-none",children:[e.jsx(Nt,{isEditing:!!t.id,isSaving:h,saveDisabled:l==="text",onSave:n,onCancel:a,onPreview:l==="blocks"?()=>b({id:t.id??Date.now(),name:t.name,description:t.description,created_by:i??null,items:Pe(t.blocks)}):void 0}),e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(wt,{name:t.name,onNameChange:d=>s({...t,name:d}),estimatedDuration:t.estimatedDuration,onEstimatedDurationChange:d=>s({...t,estimatedDuration:d}),totalDistance:l==="blocks"?q:void 0,showDuration:!0,showTotalDistance:l==="blocks"}),e.jsxs("div",{className:"flex items-center rounded-xl border border-border bg-muted/50 p-0.5",children:[e.jsxs("button",{type:"button",onClick:()=>y("blocks"),className:g("flex flex-1 items-center justify-center gap-1.5 rounded-lg px-3 py-2 text-xs font-semibold transition-colors",l==="blocks"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:[e.jsx(Ke,{className:"h-3.5 w-3.5"}),"Blocs"]}),e.jsxs("button",{type:"button",onClick:()=>y("text"),className:g("flex flex-1 items-center justify-center gap-1.5 rounded-lg px-3 py-2 text-xs font-semibold transition-colors",l==="text"?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:[e.jsx(ht,{className:"h-3.5 w-3.5"}),"Texte"]})]}),l==="text"?e.jsxs("div",{className:"space-y-3",children:[e.jsx("textarea",{value:v,onChange:d=>_(d.target.value),placeholder:`Collez ou tapez votre s√©ance ici‚Ä¶

Exemple :
√âchauffement
4x100 crawl V1 R30
8x50 educ dos V0

Corps de s√©ance
2x(4x100 NL V3 D1'30)
6x50 papillon jambes V2 R20

Retour au calme
200 4N souple`,className:"min-h-[280px] w-full resize-y rounded-2xl border border-border bg-card px-4 py-3 text-sm leading-relaxed placeholder:text-muted-foreground/60 focus:outline-none focus:ring-2 focus:ring-ring"}),e.jsxs("button",{type:"button",onClick:()=>{x({title:"Conversion IA",description:"Cette fonctionnalit√© sera bient√¥t disponible."})},className:"inline-flex w-full items-center justify-center gap-2 rounded-full bg-primary px-4 py-2.5 text-sm font-semibold text-primary-foreground transition-colors hover:bg-primary/90",children:[e.jsx(Bt,{className:"h-4 w-4"}),"Convertir en s√©ance"]}),e.jsx("p",{className:"text-center text-[11px] text-muted-foreground",children:"La conversion automatique analysera votre texte et cr√©era les blocs correspondants."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-3",children:[t.blocks.map((d,o)=>e.jsxs("div",{className:"rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between gap-1 px-3 py-2",children:[e.jsxs("div",{className:"flex min-w-0 flex-1 items-center gap-1.5",children:[e.jsxs("span",{className:"inline-flex shrink-0 items-center gap-1 rounded-full bg-primary px-2 py-0.5 text-[11px] font-semibold text-primary-foreground",children:[e.jsx(jt,{className:"inline h-3 w-3"})," ",d.repetitions??1,"x"]}),e.jsx(D,{value:d.title,onChange:c=>F(o,"title",c.target.value),placeholder:`Bloc ${o+1}`,className:"h-7 min-w-0 flex-1 rounded-lg border-none bg-transparent px-1 text-xs font-semibold shadow-none focus-visible:bg-muted focus-visible:ring-1"}),e.jsxs("div",{className:"shrink-0 text-[11px] text-muted-foreground whitespace-nowrap",children:["¬∑ ",d.exercises.length," ex"]})]}),e.jsxs("div",{className:"flex shrink-0 items-center gap-0.5",children:[e.jsx(D,{type:"number",min:1,value:d.repetitions??"",onChange:c=>F(o,"repetitions",c.target.value===""?null:Number(c.target.value)),className:"h-7 w-11 rounded-lg text-center text-xs",placeholder:"1"}),e.jsx("button",{type:"button",onClick:()=>A(o,"up"),className:"inline-flex h-7 w-7 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40",disabled:o===0,children:e.jsx(St,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>A(o,"down"),className:"inline-flex h-7 w-7 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40",disabled:o===t.blocks.length-1,children:e.jsx(kt,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>J(o),className:"inline-flex h-7 w-7 items-center justify-center rounded-full text-destructive hover:bg-destructive/10",children:e.jsx(te,{className:"h-3.5 w-3.5"})})]})]}),e.jsx("div",{className:"border-t border-border",children:d.exercises.map((c,m)=>{const j=k?.blockIndex===o&&k?.exerciseIndex===m,N=ae(c.intensity);return e.jsxs("div",{className:"border-b border-border last:border-b-0",children:[e.jsxs("button",{type:"button",onClick:()=>w(j?null:{blockIndex:o,exerciseIndex:m}),className:g("flex w-full items-center gap-1 px-3 py-2 text-left text-[11px] font-semibold transition-colors hover:bg-muted/50 overflow-hidden",j&&"bg-muted/50"),children:[e.jsxs("div",{className:"flex min-w-0 flex-1 flex-wrap items-center gap-1",children:[e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:[c.repetitions??"","√ó",c.distance??"","m"]}),e.jsx("span",{className:"text-muted-foreground whitespace-nowrap",children:c.stroke}),e.jsx("span",{className:g("inline-flex items-center rounded-full px-1.5 py-0.5 ring-1 whitespace-nowrap",Yt[c.strokeType]??"bg-muted ring-border"),children:Jt[c.strokeType]??c.strokeType}),e.jsxs("span",{className:g("inline-flex items-center gap-1 rounded-full bg-card px-1.5 py-0.5 ring-1 whitespace-nowrap",Zt[N],Gt[N]),children:[e.jsx("span",{className:g("h-1.5 w-1.5 rounded-full",Ue[N]??"bg-muted")}),ts(N)]}),c.rest?e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:[c.restType==="departure"?"‚è±":"‚è∏"," ",c.restType==="departure"?"D√©p.":"Repos"," ",ss(c.rest)]}):null,c.equipment.length>0?e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["üèä",c.equipment.length]}):null]}),e.jsx("span",{onClick:L=>{L.stopPropagation(),V(o,m)},className:"inline-flex h-6 w-6 shrink-0 items-center justify-center rounded-full text-destructive hover:bg-destructive/10",children:e.jsx(te,{className:"h-3 w-3"})})]}),j?e.jsx("div",{className:"border-t border-border bg-muted/30 px-3 py-3",children:e.jsx(Xt,{exercise:c,onChange:(L,Y)=>$(o,m,L,Y),onDelete:()=>V(o,m),onDuplicate:()=>B(o,m),showDelete:!0})}):null]},m)})}),e.jsx("div",{className:"border-t border-border px-3 py-2",children:e.jsxs("button",{type:"button",onClick:()=>C(o),className:"inline-flex items-center gap-1 rounded-full bg-muted px-3 py-1.5 text-[11px] font-semibold text-muted-foreground hover:bg-muted/80",children:[e.jsx(se,{className:"h-3 w-3"})," Exercice"]})})]},o)),t.blocks.length?null:e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-muted px-3 py-6 text-center text-sm text-muted-foreground",children:"Aucun bloc. Ajoute un bloc pour commencer."})]}),e.jsxs(I,{variant:"outline",size:"sm",onClick:S,className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(se,{className:"h-4 w-4"})," Ajouter bloc"]})]}),e.jsx("div",{className:"h-8"})]}),e.jsx(K,{open:!!E,onOpenChange:d=>{d||b(null)},children:e.jsx(H,{className:"max-w-4xl",children:e.jsx(He,{title:E?.name??"",description:E?.description??void 0,items:E?.items})})})]})}function ns(t){f.useEffect(()=>{if(!t)return;const s=n=>{n.preventDefault()};return window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)},[t])}function Re(t){return`S√©ance du ${Mt(t,"dd/MM/yyyy")} - Soir - Matin`}const Ie=t=>{const s=t.trim().toLowerCase();return s&&(s.startsWith("plaquette")?"plaquettes":s.startsWith("palm")?"palmes":s.startsWith("tuba")?"tuba":s.startsWith("pull")?"pull":s.startsWith("elas")?"elastique":s)},ze={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},is=["V0","V1","V2","V3","Max","Prog"],le=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if(n==="prog"||n==="progressif")return"Prog";if(ze[n])return ze[n];const a=s.toUpperCase();if(a==="MAX")return"Max";if(a.startsWith("V")){const i=Number.parseInt(a.slice(1),10);if(Number.isFinite(i)&&i>=4)return"Max";if(is.includes(a))return a}return s},as=t=>{let s=0;return t.flatMap((n,a)=>n.exercises.map((i,h)=>{const x={block_title:n.title,block_description:n.description||null,block_order:a,block_repetitions:n.repetitions??null,block_modalities:n.modalities||null,block_equipment:n.equipment??[],exercise_repetitions:i.repetitions??null,exercise_rest:i.rest??null,exercise_rest_type:i.restType??"rest",exercise_stroke:i.stroke||null,exercise_stroke_type:i.strokeType||null,exercise_intensity:i.intensity?le(i.intensity):null,exercise_modalities:i.modalities||null,exercise_equipment:i.equipment??[],exercise_order:h},l=i.repetitions&&i.distance?`${i.repetitions}x${i.distance}m`:i.distance?`${i.distance}m`:null;return{ordre:s++,label:l,distance:i.distance??null,duration:null,intensity:i.intensity?le(i.intensity):null,notes:i.modalities||null,raw_payload:x}}))},ls=(t=[])=>{const s=new Map;return t.forEach(n=>{const a=n.raw_payload??{},i=a.block_title||a.section||"Bloc",h=Number(a.block_order??0),x=`${h}-${i}`,l=a.block_equipment??a.equipment??[],y=(Array.isArray(l)?l:String(l).split(",")).map(w=>String(w)).map(w=>Ie(w)).filter(Boolean);s.has(x)||s.set(x,{title:i,repetitions:a.block_repetitions??null,description:a.block_description??"",modalities:a.block_modalities??a.modalities??"",equipment:y,exercises:[],order:Number.isFinite(h)?h:0,exerciseOrder:new Map});const v=s.get(x),_=Number(a.exercise_order??n.ordre??v.exercises.length),k=le(a.exercise_intensity??n.intensity??"V1");v.exerciseOrder.set(_,{repetitions:a.exercise_repetitions??null,distance:n.distance??null,rest:a.exercise_rest??null,restType:a.exercise_rest_type??"rest",stroke:a.exercise_stroke??a.stroke??"crawl",strokeType:a.exercise_stroke_type??a.stroke_type??"nc",intensity:k,modalities:a.exercise_modalities??n.notes??"",equipment:Array.isArray(a.exercise_equipment)?a.exercise_equipment.map(w=>Ie(w)):[]})}),Array.from(s.values()).sort((n,a)=>n.order-a.order).map(n=>({title:n.title,repetitions:n.repetitions,description:n.description,modalities:n.modalities,equipment:n.equipment,exercises:Array.from(n.exerciseOrder.entries()).sort(([a],[i])=>a-i).map(([,a])=>a)}))},os=(t=[])=>new Set(t.map(n=>{const a=n.raw_payload;return a?.block_title||a?.section||"Bloc"})).size,W="swim_catalog_archived_ids",P="swim_catalog_archive_migrated",cs=(t,s)=>s===null?!1:!s.some(n=>n.session_type==="swim"&&n.session_id===t),ds=(t,s)=>s===null?t:t.slice(s.length+1);function Bs(){const{toast:t}=Oe(),s=pt(),{userId:n,role:a}=gt(),[i,h]=f.useState(!1);ns(i);const[x,l]=f.useState(null),[y,v]=f.useState(null),[_,k]=f.useState(null),[w,E]=f.useState(""),[b,q]=f.useState(null),[S,F]=f.useState(!1),[J,A]=f.useState(!1),[C,$]=f.useState(""),[V,B]=f.useState(null),d=()=>({id:null,name:Re(new Date),description:"",estimatedDuration:0,folder:b,blocks:[]}),[o,c]=f.useState(d),{data:m,isLoading:j,error:N,refetch:L}=fe({queryKey:["swim_catalog"],queryFn:()=>T.getSwimCatalog()}),{data:Y,isLoading:Je,isError:Ye,error:oe,refetch:Ge}=fe({queryKey:["coach-assignments"],queryFn:()=>T.getAssignmentsForCoach(),enabled:a==="coach"||a==="admin"});f.useEffect(()=>{if(typeof window>"u"||window.localStorage.getItem(P))return;const r=window.localStorage.getItem(W);if(!r){window.localStorage.setItem(P,"true");return}try{const u=JSON.parse(r);if(Array.isArray(u)&&u.length>0){const p=u.map(Number).filter(Number.isFinite);T.migrateLocalStorageArchive(p).then(()=>{window.localStorage.removeItem(W),window.localStorage.setItem(P,"true"),s.invalidateQueries({queryKey:["swim_catalog"]})}).catch(()=>{})}else window.localStorage.removeItem(W),window.localStorage.setItem(P,"true")}catch{window.localStorage.removeItem(W),window.localStorage.setItem(P,"true")}},[s]);const G=f.useMemo(()=>{const r=new Set;return(m??[]).forEach(u=>{if(u.folder){const p=u.folder.split("/");for(let M=1;M<=p.length;M++)r.add(p.slice(0,M).join("/"))}}),Array.from(r).sort()},[m]),Z=f.useMemo(()=>{const r=b?b+"/":"",u=new Set;return G.forEach(p=>{if(b===null)p.includes("/")||u.add(p);else if(p.startsWith(r)){const M=p.slice(r.length);M&&!M.includes("/")&&u.add(p)}}),Array.from(u).sort()},[G,b]),Ze=f.useMemo(()=>{const r={};return(m??[]).filter(u=>!u.is_archived).forEach(u=>{u.folder&&Z.forEach(p=>{(u.folder===p||u.folder.startsWith(p+"/"))&&(r[p]=(r[p]??0)+1)})}),r},[m,Z]),ce=f.useMemo(()=>(m??[]).filter(r=>r.is_archived).length,[m]),et=f.useMemo(()=>{let r=m??[];const u=w.trim().toLowerCase();return S?r=r.filter(p=>p.is_archived):(r=r.filter(p=>!p.is_archived),r=r.filter(p=>b===null?!p.folder:p.folder===b)),u&&(r=r.filter(p=>p.name.toLowerCase().includes(u))),r},[m,w,b,S]),de=z({mutationFn:r=>T.createSwimSession(r),onSuccess:(r,u)=>{s.invalidateQueries({queryKey:["swim_catalog"]}),h(!1),c(d()),t({title:u?.id?"S√©ance natation mise √† jour":"S√©ance natation cr√©√©e"})}}),ue=z({mutationFn:r=>T.deleteSwimSession(r),onSuccess:()=>{s.invalidateQueries({queryKey:["swim_catalog"]}),v(null),t({title:"S√©ance supprim√©e"})},onError:()=>{t({title:"Suppression impossible",description:"Cette s√©ance est utilis√©e dans une assignation.",variant:"destructive"})}}),me=z({mutationFn:({sessionId:r,archived:u})=>T.archiveSwimSession(r,u),onSuccess:(r,u)=>{s.invalidateQueries({queryKey:["swim_catalog"]}),k(null),t({title:u.archived?"S√©ance archiv√©e":"S√©ance restaur√©e"})}}),tt=z({mutationFn:({sessionId:r,folder:u})=>T.moveSwimSession(r,u),onSuccess:()=>{s.invalidateQueries({queryKey:["swim_catalog"]}),B(null),t({title:"S√©ance d√©plac√©e"})}}),st=()=>{if(!o.name.trim()){t({title:"Titre requis",description:"Ajoutez un nom de s√©ance avant d'enregistrer.",variant:"destructive"});return}de.mutate({id:o.id??void 0,name:o.name,description:o.description,estimated_duration:o.estimatedDuration||null,folder:o.folder??b,items:as(o.blocks),created_by:n??null})},rt=()=>{h(!1),c(d())},nt=r=>{c({id:r.id??null,name:r.name??Re(new Date),description:r.description??"",estimatedDuration:Number(r.estimated_duration??0),folder:r.folder??null,blocks:ls(r.items??[])}),h(!0)},it=r=>{k(r)},at=()=>{_&&me.mutate({sessionId:_.id,archived:!0})},lt=r=>{me.mutate({sessionId:r.id,archived:!1})},ot=r=>{v(r)},ct=()=>{y&&ue.mutate(y.id)},pe=()=>{const r=C.trim();if(!r)return;const u=b?`${b}/${r}`:r;q(u),A(!1),$("")},xe=r=>{V&&tt.mutate({sessionId:V.id,folder:r})},dt=r=>{const u=We(r.items??[]),M=r.items?.some(ee=>ee.duration!=null)??!1?r.items?.reduce((ee,mt)=>ee+(mt.duration??0),0)??0:null,ut=os(r.items??[]);return e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(vt,{className:"h-3.5 w-3.5"}),u,"m"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Tt,{className:"h-3.5 w-3.5"}),"~",M??"‚Äî"," min"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ke,{className:"h-3.5 w-3.5"}),ut]})]})};return i?e.jsx(rs,{session:o,onSessionChange:c,onSave:st,onCancel:rt,userId:n,isSaving:de.isPending}):j||Je?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx(O,{className:"h-5 w-16 mb-1"}),e.jsx(O,{className:"h-3 w-20"})]}),e.jsx(O,{className:"h-9 w-24 rounded-full"})]}),e.jsxs("div",{className:"p-4",children:[e.jsx(O,{className:"h-10 w-full rounded-2xl mb-4"}),e.jsx(_e,{sessions:[],isLoading:!0,renderTitle:()=>"",renderMetrics:()=>null,onPreview:()=>{},onEdit:()=>{},onArchive:()=>{},onDelete:()=>{},canDelete:()=>!1})]})]}):N?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(De,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les donn√©es"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:N instanceof Error?N.message:"Une erreur s'est produite"}),e.jsx(I,{variant:"default",onClick:()=>L(),className:"mt-4 h-12 md:h-10",children:"R√©essayer"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:"Coach"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Cr√©ation"})]}),!S&&e.jsxs("button",{type:"button",onClick:()=>{c(d()),h(!0)},className:"inline-flex items-center gap-2 rounded-full bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground",children:[e.jsx(se,{className:"h-4 w-4"})," Nouvelle"]})]}),e.jsxs("div",{className:"p-4",children:[(b!==null||S)&&e.jsx(Qe,{className:"mb-3",children:e.jsxs(Xe,{children:[e.jsx(Q,{children:e.jsx(re,{className:"cursor-pointer",onClick:()=>{q(null),F(!1)},children:e.jsx(qe,{className:"h-4 w-4"})})}),S?e.jsxs(e.Fragment,{children:[e.jsx(ie,{}),e.jsx(Q,{children:e.jsx(ne,{children:"Archives"})})]}):b?.split("/").map((r,u,p)=>e.jsxs(R.Fragment,{children:[e.jsx(ie,{}),e.jsx(Q,{children:u===p.length-1?e.jsx(ne,{children:r}):e.jsx(re,{className:"cursor-pointer",onClick:()=>q(p.slice(0,u+1).join("/")),children:r})})]},u))]})}),e.jsxs("div",{className:"flex items-center gap-2 rounded-2xl border border-border bg-card px-3 py-2",children:[e.jsx(At,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{className:"w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground",placeholder:"Rechercher une s√©ance",value:w,onChange:r=>E(r.target.value)})]}),!S&&e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[Z.map(r=>e.jsxs("button",{type:"button",onClick:()=>q(r),className:"inline-flex items-center gap-1.5 rounded-xl border border-border bg-card px-3 py-1.5 text-sm font-medium hover:bg-muted transition-colors",children:[e.jsx(Ee,{className:"h-4 w-4 text-muted-foreground"}),ds(r,b),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",Ze[r]??0,")"]})]},r)),e.jsxs("button",{type:"button",onClick:()=>A(!0),className:"inline-flex items-center gap-1.5 rounded-xl border border-dashed border-border px-3 py-1.5 text-sm text-muted-foreground hover:bg-muted transition-colors",children:[e.jsx(_t,{className:"h-4 w-4"}),"Nouveau dossier"]}),b===null&&ce>0&&e.jsxs("button",{type:"button",onClick:()=>F(!0),className:"inline-flex items-center gap-1.5 rounded-xl border border-border bg-muted/50 px-3 py-1.5 text-sm text-muted-foreground hover:bg-muted transition-colors",children:[e.jsx(Vt,{className:"h-4 w-4"}),"Archives",e.jsxs("span",{className:"text-xs",children:["(",ce,")"]})]})]}),Ye&&e.jsxs("div",{className:"mt-4 flex flex-col items-center rounded-lg border border-destructive/20 bg-destructive/10 p-4",children:[e.jsx(De,{className:"h-8 w-8 text-destructive mb-2"}),e.jsx("p",{className:"text-sm text-destructive font-semibold",children:"Impossible de charger les assignations"}),e.jsx("p",{className:"text-xs text-destructive/80 mt-1",children:oe instanceof Error?oe.message:"Une erreur s'est produite"}),e.jsx(I,{variant:"outline",size:"sm",onClick:()=>Ge(),className:"mt-2 h-10",children:"R√©essayer"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(_e,{sessions:et,isLoading:j,error:N,renderTitle:r=>r.name,renderMetrics:dt,onPreview:l,onEdit:nt,onArchive:S?lt:it,onDelete:ot,canDelete:r=>cs(r,Y??null),isDeleting:ue.isPending,onMove:S?void 0:r=>B(r),archiveMode:S?"restore":"archive"})}),e.jsx("div",{className:"h-8"})]}),e.jsx(K,{open:!!x,onOpenChange:r=>{r||l(null)},children:e.jsx(H,{className:"max-w-4xl",children:e.jsx(He,{title:x?.name??"",description:x?.description??void 0,items:x?.items})})}),e.jsx(K,{open:J,onOpenChange:A,children:e.jsxs(H,{children:[e.jsx(he,{children:e.jsx(ge,{children:"Nouveau dossier"})}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(D,{placeholder:"Nom du dossier",value:C,onChange:r=>$(r.target.value),onKeyDown:r=>{r.key==="Enter"&&pe()},className:"rounded-2xl"}),C.trim()&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Chemin : ",b?`${b}/${C.trim()}`:C.trim()]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(I,{variant:"outline",onClick:()=>{A(!1),$("")},children:"Annuler"}),e.jsx(I,{onClick:pe,disabled:!C.trim(),children:"Cr√©er"})]})]})]})}),e.jsx(K,{open:!!V,onOpenChange:r=>{r||B(null)},children:e.jsxs(H,{children:[e.jsx(he,{children:e.jsxs(ge,{children:["D√©placer ¬´ ",V?.name," ¬ª"]})}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("button",{type:"button",onClick:()=>xe(null),className:`w-full rounded-xl px-3 py-2 text-left text-sm font-medium transition-colors hover:bg-muted ${V?.folder?"text-muted-foreground":"bg-muted text-foreground"}`,children:[e.jsx(qe,{className:"mr-2 inline h-4 w-4"}),"Racine"]}),G.map(r=>e.jsxs("button",{type:"button",onClick:()=>xe(r),className:`w-full rounded-xl px-3 py-2 text-left text-sm font-medium transition-colors hover:bg-muted ${V?.folder===r?"bg-muted text-foreground":"text-muted-foreground"}`,children:[e.jsx(Ee,{className:"mr-2 inline h-4 w-4"}),r]},r))]})]})}),e.jsx(be,{open:!!_,onOpenChange:r=>{r||k(null)},children:e.jsxs(ye,{children:[e.jsxs(je,{children:[e.jsx(ve,{children:"Archiver la s√©ance ?"}),e.jsx(Ne,{children:"La s√©ance sera d√©plac√©e dans les archives. Vous pourrez la restaurer √† tout moment."})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(ke,{onClick:at,children:"Archiver"})]})]})}),e.jsx(be,{open:!!y,onOpenChange:r=>{r||v(null)},children:e.jsxs(ye,{children:[e.jsxs(je,{children:[e.jsx(ve,{children:"Supprimer la s√©ance ?"}),e.jsx(Ne,{children:"Cette action est d√©finitive. La s√©ance sera supprim√©e du catalogue."})]}),e.jsxs(we,{children:[e.jsx(Se,{children:"Annuler"}),e.jsx(ke,{onClick:ct,children:"Supprimer"})]})]})})]})}export{cs as canDeleteSwimCatalog,Bs as default};
