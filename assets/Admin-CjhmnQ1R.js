import{b as xe,j as e}from"./vendor-ui-C9ymspZo.js";import{i as L,u as H,j as pe,R as je,B as h,C as _,b as k,d as I,f as E,g as U,L as x,I as R,h as o,n as fe}from"./index-Ckx1yfUE.js";import{b as ve,u as ie,c as j}from"./vendor-query-kM2vrB_e.js";import{u as ye,t as ge,o as Ne,s as F}from"./types-BSfQlzoI.js";import{S as G,a as O,b as X,c as Z,d as a}from"./select-BfTNK-GR.js";import{S as be}from"./switch-dN7IHaNu.js";import{B as f}from"./badge-BMs32RqT.js";import{T as Ce,a as we,b as re,c as v,d as Ae,e as y}from"./table-D9OFNef3.js";import{S as Se}from"./skeleton-CZirY6KC.js";import{C as _e}from"./circle-alert-CAD55kto.js";import{C as ke}from"./clock-DL99U5d2.js";import{C as Ie}from"./circle-x-tKtZUIYq.js";import{S as Ee}from"./search-CS3JxpuE.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-OPtm0Vk9.js";import"./check-CO911p3d.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ue=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Re=L("circle-check-big",Ue);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Le=L("shield-check",Fe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],qe=L("user-minus",Pe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Me=L("user-plus",Te),ae=["athlete","coach","comite","admin"],J=i=>!(i===!1||i===0),ze=Ne({display_name:F().min(2,"Le nom doit contenir au moins 2 caractères"),email:F().optional().refine(i=>!i||F().email().safeParse(i).success,"L'email doit être valide"),password:F().optional().refine(i=>!i||i.length>=8&&/[A-Z]/.test(i)&&/\d/.test(i),"Le mot de passe doit contenir au moins 8 caractères, une majuscule et un chiffre")}),Qe=(i,n,P)=>i.map(p=>p.id===n?{...p,role:P}:p),g=(i,n)=>fe(i,n).message;function ts(){const{useMemo:i,useState:n}=xe,P=typeof window>"u"?H.getState().role:H(s=>s.role),p=H(s=>s.userId),{toast:l}=pe(),c=ve(),[q,te]=n(""),[N,le]=n("all"),[b,ne]=n(!1),[C,ce]=n(null),[W,Y]=n(null),{register:T,handleSubmit:de,reset:oe,formState:{errors:m}}=ye({resolver:ge(ze),defaultValues:{display_name:"",email:"",password:""}}),M=P==="admin",{data:u=[],isLoading:me,error:z,refetch:ue}=ie({queryKey:["admin-users",b],queryFn:()=>o.listUsers({includeInactive:b}),enabled:M}),Q=j({mutationFn:s=>o.createCoach(s),onMutate:()=>{Y(null)},onSuccess:s=>{c.invalidateQueries({queryKey:["admin-users"]}),oe(),Y(s.initialPassword??null),l({title:"Coach créé"})},onError:s=>{l({title:"Erreur création coach",description:g(s,"Impossible de créer le coach.")})}}),w=j({mutationFn:s=>o.updateUserRole(s),onSuccess:(s,r)=>{c.setQueryData(["admin-users",b],d=>d&&Qe(d,r.userId,r.role)),c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Rôle mis à jour"})},onError:s=>{l({title:"Erreur mise à jour rôle",description:g(s,"Impossible de mettre à jour le rôle.")})}}),ee=j({mutationFn:s=>o.disableUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Compte désactivé"})},onError:s=>{l({title:"Erreur désactivation",description:g(s,"Impossible de désactiver le compte.")})}}),{data:K=[],error:V,refetch:he}=ie({queryKey:["pending-approvals"],queryFn:()=>o.getPendingApprovals(),enabled:M}),D=j({mutationFn:s=>o.approveUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Inscription validée"})},onError:s=>{l({title:"Erreur validation",description:g(s,"Impossible de valider l'inscription.")})}}),B=j({mutationFn:s=>o.rejectUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Inscription rejetée"})},onError:s=>{l({title:"Erreur rejet",description:g(s,"Impossible de rejeter l'inscription.")})}}),A=i(()=>u.find(r=>r.role==="admin")?.id??null,[u]),se=i(()=>{const s=q.trim().toLowerCase();return u.filter(r=>{if(N!=="all"&&r.role!==N)return!1;const d=r.display_name?.toLowerCase()??"",$=r.email?.toLowerCase()??"";return!(s&&!d.includes(s)&&!$.includes(s))})},[u,N,q]),t=i(()=>C?u.find(s=>s.id===C)??null:null,[C,u]);return M?z||V?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(_e,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:z instanceof Error?z.message:V instanceof Error?V.message:"Une erreur s'est produite"}),e.jsx(h,{onClick:()=>{ue(),he()},className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Le,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:"Accès admin"})]})]}),K.length>0?e.jsxs(_,{className:"border-status-warning/30 bg-status-warning-bg dark:border-status-warning/30 dark:bg-status-warning-bg",children:[e.jsxs(k,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(ke,{className:"h-5 w-5 text-status-warning"}),"Inscriptions en attente",e.jsx(f,{variant:"secondary",className:"ml-2",children:K.length})]}),e.jsx(E,{children:"Ces utilisateurs ont créé un compte et attendent votre validation."})]}),e.jsx(U,{children:e.jsx("div",{className:"space-y-3",children:K.map(s=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-lg border bg-background p-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email||"Pas d'email"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Inscrit le ",new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{size:"sm",className:"bg-status-success hover:opacity-90 text-white",onClick:()=>D.mutate(s.user_id),disabled:D.isPending||B.isPending,children:[e.jsx(Re,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>{window.confirm(`Rejeter l'inscription de "${s.display_name}" ? Le compte sera désactivé.`)&&B.mutate(s.user_id)},disabled:D.isPending||B.isPending,children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]},s.user_id))})})]}):null,e.jsxs(_,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Créer un coach"}),e.jsx(E,{children:"Laissez le mot de passe vide pour en générer un automatiquement (affiché une seule fois)."})]}),e.jsx(U,{children:e.jsxs("form",{className:"space-y-4",onSubmit:de(s=>{Q.mutate({display_name:s.display_name.trim(),email:s.email?.trim()||void 0,password:s.password||void 0})}),children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"coach-create-name",children:"Nom affiché"}),e.jsx(R,{id:"coach-create-name",...T("display_name"),placeholder:"Ex: Coach Martin"}),m.display_name&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:m.display_name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"coach-create-email",children:"Email"}),e.jsx(R,{id:"coach-create-email",type:"email",...T("email"),placeholder:"coach@email.com"}),m.email&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:m.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"coach-create-password",children:"Mot de passe (optionnel)"}),e.jsx(R,{id:"coach-create-password",type:"text",...T("password"),placeholder:"Laisser vide pour auto"}),m.password&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:m.password.message})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(h,{type:"submit",disabled:Q.isPending,children:Q.isPending?"Création...":"Créer le coach"}),W?e.jsxs("div",{className:"rounded-md border border-primary/30 bg-primary/5 px-4 py-2 text-sm",children:[e.jsx("p",{className:"font-medium text-primary",children:"Mot de passe initial (à copier)"}),e.jsx("p",{className:"font-mono",children:W})]}):null]})]})})]}),e.jsxs(_,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Gestion des comptes"}),e.jsx(E,{children:"Mettre à jour les rôles, filtrer et désactiver les comptes."})]}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(x,{htmlFor:"admin-search",children:"Recherche"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ee,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(R,{id:"admin-search",value:q,onChange:s=>te(s.target.value),placeholder:"Nom ou email",className:"pl-9"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Rôle"}),e.jsxs(G,{value:N,onValueChange:s=>le(s),children:[e.jsx(O,{children:e.jsx(X,{placeholder:"Tous"})}),e.jsxs(Z,{children:[e.jsx(a,{value:"all",children:"Tous"}),e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(be,{checked:b,onCheckedChange:ne,id:"inactive-toggle"}),e.jsx(x,{htmlFor:"inactive-toggle",className:"text-sm",children:"Inclure désactivés"})]})]}),me?e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((s,r)=>e.jsx("div",{className:"flex items-center gap-4 p-3 rounded-lg border",children:e.jsx(Se,{className:"h-10 w-full"})},`skeleton-${r}`))}):se.length?e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(Ce,{children:[e.jsx(we,{children:e.jsxs(re,{children:[e.jsx(v,{children:"Utilisateur"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Rôle"}),e.jsx(v,{children:"Statut"}),e.jsx(v,{className:"text-right",children:"Actions"})]})}),e.jsx(Ae,{children:se.map(s=>{const r=J(s.is_active),d=p===s.id,$=A!==null&&A!==s.id;return e.jsxs(re,{"data-selected":C===s.id,children:[e.jsx(y,{className:"font-medium",children:e.jsx(h,{variant:"ghost",size:"sm",className:"px-2",onClick:()=>ce(s.id),children:s.display_name})}),e.jsx(y,{className:"text-sm text-muted-foreground",children:s.email||"-"}),e.jsx(y,{children:e.jsxs(G,{value:s.role,onValueChange:S=>{ae.includes(S)&&s.id&&S!==s.role&&w.mutate({userId:s.id,role:S})},disabled:!r||w.isPending,children:[e.jsx(O,{className:"w-[140px]",children:e.jsx(X,{})}),e.jsxs(Z,{children:[e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",disabled:$,children:"Admin"})]})]})}),e.jsx(y,{children:r?e.jsx(f,{variant:"secondary",children:"Actif"}):e.jsx(f,{variant:"outline",children:"Désactivé"})}),e.jsx(y,{className:"text-right",children:e.jsxs(h,{variant:"destructive",size:"sm",onClick:()=>{if(!s.id)return;if(d){l({title:"Action impossible",description:"Vous ne pouvez pas désactiver votre propre compte."});return}window.confirm(`Confirmer la désactivation du compte "${s.display_name}" ?`)&&ee.mutate({userId:s.id})},disabled:!r||ee.isPending||d,children:[e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Désactiver"]})})]},s.id)})})]})}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Me,{className:"h-4 w-4"}),"Aucun utilisateur ne correspond à votre recherche."]})]})]}),e.jsxs(_,{children:[e.jsxs(k,{children:[e.jsx(I,{children:"Fiche utilisateur"}),e.jsx(E,{children:"Sélectionnez un compte pour afficher les détails."})]}),e.jsx(U,{children:t?e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nom affiché"}),e.jsx("p",{className:"text-lg font-semibold",children:t.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Email"}),e.jsx("p",{children:t.email||"-"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Rôle"}),e.jsxs(G,{value:t.role,onValueChange:s=>{ae.includes(s)&&t.id&&s!==t.role&&w.mutate({userId:t.id,role:s})},disabled:!J(t.is_active)||w.isPending,children:[e.jsx(O,{className:"w-[180px]",children:e.jsx(X,{})}),e.jsxs(Z,{children:[e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",disabled:A!==null&&A!==t.id,children:"Admin"})]})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Statut"}),J(t.is_active)?e.jsx(f,{variant:"secondary",children:"Actif"}):e.jsx(f,{variant:"outline",children:"Désactivé"})]}),t.group_label?e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Groupe"}),e.jsx("p",{children:t.group_label})]}):null]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun utilisateur sélectionné."})})]})]}):typeof window>"u"?null:e.jsx(je,{to:"/"})}export{ts as default,Qe as updateUserRoleInList};
