import{r as T,j as e}from"./vendor-ui-DJQMR4VV.js";import{b as W,u as K,c as L}from"./vendor-query-BT4y-huw.js";import{c as P,u as V,f as J,o as C,n as D,C as x,i as h,M as F,g as z,h as H,l as O,B as X,d as _}from"./index-DEbtO7mD.js";import{B as k}from"./badge-nM1BMyW6.js";import{T as Y}from"./textarea-C_k3ugiN.js";import{A as Z}from"./arrow-left-Bt5pZ18Z.js";import{f as $}from"./vendor-date-cQbdWov0.js";import{f as E}from"./fr-CqUxEDd2.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Db4xOvcx.js";import"./vendor-supabase-D7B1G6YZ.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],se=P("send",ee),te=(t,r)=>t.target_group_id?`group:${t.target_group_id}`:r&&t.sender_id!==null&&t.sender_id!==void 0&&t.sender_id!==r?`user:${t.sender_id}`:r&&t.counterparty_id!==null&&t.counterparty_id!==void 0?`user:${t.counterparty_id}`:r&&t.target_user_id?`user:${t.target_user_id}`:t.counterparty_id!==null&&t.counterparty_id!==void 0?`user:${t.counterparty_id}`:t.sender_id!==null&&t.sender_id!==void 0?`user:${t.sender_id}`:t.sender_email?`email:${t.sender_email}`:`sender:${t.sender}`,re=t=>[...t].sort((r,d)=>new Date(r.date).getTime()-new Date(d.date).getTime()),ae=t=>t.filter(r=>!r.read).map(r=>r.target_id??r.id).filter(r=>Number.isFinite(r)),ne=({message:t,senderId:r,senderLabel:d,targetUserId:l,targetGroupId:a,title:u="Message"})=>({id:Date.now(),sender:d||"Coach",sender_name:d||null,sender_id:r??null,sender_email:null,target_user_id:l??null,target_group_id:a??null,title:u,message:t,type:"message",read:!0,date:new Date().toISOString()}),ie=(t,r)=>{const d=new Map;return t.forEach(l=>{const a=te(l,r);d.has(a)||d.set(a,[]),d.get(a)?.push(l)}),Array.from(d.entries()).map(([l,a])=>{const u=re(a),m=u[u.length-1],f=a.some(i=>!i.read),y=l.startsWith("user:")?Number(l.split(":")[1]):null,j=l.startsWith("group:")?Number(l.split(":")[1]):null,M=r?a.find(i=>i.sender_id&&i.sender_id!==r)??m:m,N=a.find(i=>i.counterparty_name)?.counterparty_name,b=a.find(i=>i.target_group_name)?.target_group_name??null,v=r?a.find(i=>i.target_id)?.target_id??null:a.find(i=>i.target_id)?.target_id??null;return{key:l,senderId:m.sender_id??null,senderLabel:b??N??M.sender,messages:u,lastMessage:m,lastTimestamp:new Date(m.date).getTime(),hasUnread:f,counterpartyId:Number.isFinite(y)?y:null,targetGroupId:Number.isFinite(j)?j:null,targetGroupName:b,replyTargetId:v}})};function ye(){const{user:t,userId:r,role:d}=V(),{toast:l}=J(),a=W(),[u,m]=T.useState(null),[f,y]=T.useState(""),{data:j,isLoading:M,error:N}=K({queryKey:["notifications",r,t,"threads"],queryFn:()=>_.notifications_list({targetUserId:r,targetAthleteName:t,limit:200,offset:0,type:"message",order:"desc"}),enabled:!!t,refetchInterval:1e4}),{data:b,error:v}=K({queryKey:["capabilities","messaging"],queryFn:()=>_.getCapabilities(),enabled:C.hasSupabase}),i=L({mutationFn:s=>_.notifications_mark_read({targetId:s}),onMutate:async s=>{await a.cancelQueries({queryKey:["notifications"]});const n=a.getQueryData(["notifications",r,t,"threads"]);return a.setQueryData(["notifications",r,t,"threads"],o=>{const p=o;return p?.notifications?{...p,notifications:p.notifications.map(g=>(g.target_id??g.id)===s?{...g,read:!0}:g)}:o}),{previous:n}},onError:(s,n,o)=>{o?.previous&&a.setQueryData(["notifications",r,t,"threads"],o.previous)},onSettled:()=>{a.invalidateQueries({queryKey:["notifications"]})}}),G=L({mutationFn:s=>_.notifications_send({title:"Message",body:s.message,type:"message",targets:[s.targetGroupId?{target_group_id:s.targetGroupId}:{target_user_id:s.targetUserId||null}],reply_to_target_id:s.replyTargetId??void 0}),onMutate:async s=>{if(!s.message.trim())return;await a.cancelQueries({queryKey:["notifications",r,t,"threads"]});const n=a.getQueryData(["notifications",r,t,"threads"]),o=ne({message:s.message,senderId:r,senderLabel:t??"Coach",targetUserId:s.targetUserId,targetGroupId:s.targetGroupId??null});return a.setQueryData(["notifications",r,t,"threads"],p=>{const g=p;return g?.notifications?{...g,notifications:[o,...g.notifications]}:p}),{previous:n}},onSuccess:()=>{y(""),a.invalidateQueries({queryKey:["notifications"]})},onError:(s,n,o)=>{o?.previous&&a.setQueryData(["notifications",r,t,"threads"],o.previous);const p=D(s,"Le message n'a pas pu être envoyé.");l({title:"Envoi impossible",description:p.message,variant:"destructive"})}}),I=j?.notifications??[],S=I.filter(s=>!s.read).length,w=T.useMemo(()=>ie(I,r).sort((s,n)=>n.lastTimestamp-s.lastTimestamp),[I,r]),q=w.filter(s=>!s.targetGroupId),Q=w.filter(s=>s.targetGroupId),c=u?w.find(s=>s.key===u):null,U=!!(c?.counterpartyId||c?.targetGroupId)&&(d!=="athlete"||!C.hasSupabase||!!c?.replyTargetId),B=s=>{m(s.key),ae(s.messages).forEach(o=>i.mutate(o))};if(M)return e.jsx("div",{className:"space-y-4 p-4",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-start gap-3 rounded-xl bg-muted animate-pulse motion-reduce:animate-none p-4",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-muted-foreground/10"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-3/4 rounded bg-muted-foreground/10"}),e.jsx("div",{className:"h-3 w-1/2 rounded bg-muted-foreground/10"})]})]},s))});const R=v?D(v,"Impossible de vérifier la messagerie.").message:b?.mode==="supabase"&&!b.messaging.available?"Messagerie indisponible (tables manquantes côté D1).":null,A=N?D(N,"Impossible de charger les messages.").message:null;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Messagerie"}),S>0&&e.jsxs(k,{variant:"destructive",children:[S," non lus"]})]}),R?e.jsx(x,{className:"border-dashed",children:e.jsx(h,{className:"py-4 text-sm text-muted-foreground",children:R})}):null,A?e.jsx(x,{className:"border-destructive/40",children:e.jsx(h,{className:"py-4 text-sm text-destructive",children:A})}):null,c?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 text-sm text-muted-foreground",onClick:()=>m(null),children:[e.jsx(Z,{className:"h-4 w-4"}),"Retour"]}),e.jsxs(x,{children:[e.jsxs(z,{children:[e.jsx(H,{children:c.senderLabel}),e.jsx(O,{children:"Conversation"})]}),e.jsx(h,{className:"space-y-3",children:c.messages.map(s=>{const n=s.sender_id===r;return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-end gap-2 ${n?"flex-row-reverse":"flex-row"}`,children:[e.jsxs("div",{className:`max-w-[80%] rounded-2xl border px-4 py-3 text-sm shadow-sm ${n?"border-primary/40 bg-primary text-primary-foreground":"border-border bg-muted/50 text-foreground"}`,children:[e.jsx("div",{className:`text-xs ${n?"text-primary-foreground/80":"text-muted-foreground"}`,children:s.sender}),e.jsx("div",{className:"mt-1",children:s.message})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:$(new Date(s.date),"HH:mm",{locale:E})})]})},s.id)})})]}),e.jsxs(x,{children:[e.jsxs(z,{children:[e.jsx(H,{children:U?"Répondre":"Réponse indisponible"}),e.jsx(O,{children:"Répondez à ce fil."})]}),e.jsx(h,{className:"space-y-3",children:U?e.jsxs(e.Fragment,{children:[e.jsx(Y,{value:f,onChange:s=>y(s.target.value),placeholder:"Votre message...",rows:3}),e.jsxs(X,{onClick:()=>{const s=c.counterpartyId,n=c.targetGroupId;if(!s&&!n){l({title:"Envoi impossible",description:"Destinataire introuvable pour ce fil.",variant:"destructive"});return}G.mutate({targetUserId:s??0,targetGroupId:n,message:f,replyTargetId:d==="athlete"&&C.hasSupabase?c.replyTargetId:null})},disabled:!f.trim()||G.isPending,children:[e.jsx(se,{className:"mr-2 h-4 w-4"}),"Envoyer"]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:d==="athlete"?"Réponse possible uniquement sur un fil existant.":"Aucun destinataire disponible pour ce fil."})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-bold uppercase text-muted-foreground tracking-wider ml-1",children:"Discussions"}),e.jsxs("div",{className:"space-y-3",children:[q.map(s=>e.jsx("button",{type:"button",onClick:()=>B(s),className:"w-full text-left",children:e.jsx(x,{className:"group hover:bg-muted/50 transition-colors border-l-4 border-l-transparent hover:border-l-primary",children:e.jsxs(h,{className:"p-4 flex items-start gap-4",children:[e.jsx("div",{className:`p-2 rounded-full ${s.hasUnread?"bg-primary/20":"bg-muted"}`,children:e.jsx(F,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-bold truncate",children:s.senderLabel}),e.jsx("div",{className:"text-xs text-muted-foreground shrink-0 ml-2",children:$(new Date(s.lastMessage.date),"dd MMM",{locale:E})})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1 break-words",children:s.lastMessage.message})]}),s.hasUnread?e.jsx(k,{variant:"secondary",children:"Non lu"}):null]})})},s.key)),q.length===0?e.jsx(x,{className:"border-dashed",children:e.jsx(h,{className:"py-10 text-center text-sm text-muted-foreground",children:"Aucune discussion directe pour le moment."})}):null]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-bold uppercase text-muted-foreground tracking-wider ml-1",children:"Groupes"}),e.jsxs("div",{className:"space-y-3",children:[Q.map(s=>e.jsx("button",{type:"button",onClick:()=>B(s),className:"w-full text-left",children:e.jsx(x,{className:"group hover:bg-muted/50 transition-colors border-l-4 border-l-transparent hover:border-l-primary",children:e.jsxs(h,{className:"p-4 flex items-start gap-4",children:[e.jsx("div",{className:`p-2 rounded-full ${s.hasUnread?"bg-primary/20":"bg-muted"}`,children:e.jsx(F,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-bold truncate",children:s.senderLabel}),e.jsx("div",{className:"text-xs text-muted-foreground shrink-0 ml-2",children:$(new Date(s.lastMessage.date),"dd MMM",{locale:E})})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1 break-words",children:s.lastMessage.message})]}),s.hasUnread?e.jsx(k,{variant:"secondary",children:"Non lu"}):null]})})},s.key)),Q.length===0?e.jsx(x,{className:"border-dashed",children:e.jsx(h,{className:"py-10 text-center text-sm text-muted-foreground",children:"Aucun message de groupe pour le moment."})}):null]})]})]})]})}export{ne as buildOptimisticNotification,ae as collectThreadMarkReadTargets,ye as default,te as getThreadKey,ie as groupNotificationsBySender,re as sortThreadMessages};
