import{c as Y,r as o,u as T,d as R,j as e}from"./vendor-query-BiSH4r2z.js";import{u as Z,b as ee,d as se,B as h,C as te,g as ae,S as w,s as z}from"./index-AQJx-bCr.js";import{B}from"./badge-BmoHRasd.js";import{S as ne}from"./separator-CYwTiH08.js";import{S as ie}from"./SwimSessionTimeline-BT_BuTOb.js";import{a as p}from"./api-CT4965yV.js";import{g as re}from"./swim-C_-X8mId.js";import{C as oe}from"./circle-alert-KbUCFDRW.js";import{C as le}from"./chevron-left-Pr1ZJwwJ.js";import{S as ce}from"./share-2-BU3sLlb0.js";import{L as de}from"./loader-circle-BCrgAsBM.js";import{S as me}from"./save-mGlH2kFH.js";import{f as ue}from"./format-B9mPVj_w.js";import{f as pe}from"./fr-CFyqyHeU.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";import"./chevron-up-BGsP-4NW.js";import"./hash-QQHAbZ0G.js";import"./timer-9DmUOrks.js";import"./eye-WKnicZbo.js";import"./chevron-down-CCJpk06U.js";import"./clock-sKbjSjJn.js";const ge={assigned:"Assignée",pending:"Assignée",in_progress:"En cours",completed:"Terminée",cancelled:"Annulée"},xe=n=>{if(!n)return"-";const l=new Date(n);return Number.isNaN(l.getTime())?n:ue(l,"dd MMM",{locale:pe})};function he(n){const l=new Map;for(const d of n)d.source_item_id!=null&&l.set(d.source_item_id,{exercise_label:d.exercise_label,source_item_id:d.source_item_id,split_times:d.split_times,tempo:d.tempo,stroke_count:d.stroke_count,notes:d.notes});return l}function fe(n){return n&&new Date(n).getHours()>=14?"Soir":"Matin"}function $e(){const{user:n,userId:l}=Z(),[d,L]=ee(),{toast:u}=se(),j=Y(),[F,K]=o.useState(null),[b,Q]=o.useState(null),[P,g]=o.useState(!1),[we,N]=o.useState([]),[k,$]=o.useState(""),[E,O]=o.useState(1),[je,U]=o.useState(null),I=o.useMemo(()=>{const s=window.location.hash||"",t=s.indexOf("?");if(t===-1)return null;const i=new URLSearchParams(s.slice(t)).get("assignmentId"),m=i?Number(i):NaN;return Number.isFinite(m)?m:null},[d]),{data:H,isLoading:M,error:A,refetch:V}=T({queryKey:["assignments",n],queryFn:()=>p.getAssignments(n,l),enabled:!!n}),q=H?.filter(s=>s.session_type==="swim")||[],a=I?q.find(s=>s.id===I):q[0],D=a?.session_id,{data:v}=T({queryKey:["swim-exercise-logs-by-catalog",D,l],queryFn:async()=>{const{data:s}=await z.auth.getSession(),t=s.session?.user?.id;if(!t)return[];const i=(await p.getSessions(n,l)).map(r=>r.id);if(i.length===0)return[];const m=[];for(const r of i.slice(0,10)){const y=await p.getSwimExerciseLogs(r);m.push(...y.filter(_=>_.user_id===t))}const x=new Set((a?.items??[]).map(r=>r.id).filter(Boolean));return m.filter(r=>r.source_item_id!=null&&x.has(r.source_item_id))},enabled:!!D&&!!l&&!!n}),f=o.useMemo(()=>b||(v?he(v):new Map),[b,v]),G=o.useCallback(s=>{K(t=>t===s?null:s)},[]),J=o.useCallback((s,t)=>{Q(c=>{const i=new Map(c??f);return i.set(s,t),i}),g(!0)},[f]);o.useCallback(()=>{const s=k.trim();if(!s)return;const t=Date.now();N(c=>[...c,{id:t,label:s,reps:E,log:{exercise_label:s,split_times:[],stroke_count:[],tempo:null,notes:null}}]),$(""),O(1),U(t),g(!0)},[k,E]),o.useCallback(s=>{N(t=>t.filter(c=>c.id!==s)),g(!0)},[]),o.useCallback((s,t)=>{N(c=>c.map(i=>i.id===s?{...i,log:t}:i)),g(!0)},[]);const S=R({mutationFn:async()=>{const{data:s}=await z.auth.getSession(),t=s.session?.user?.id;if(!t||!n)throw new Error("Non authentifié");const c=a?.assigned_date?new Date(a.assigned_date).toISOString().slice(0,10):new Date().toISOString().slice(0,10),i=fe(a?.assigned_date),m=await p.ensureSwimSession({athleteName:n,athleteId:l,date:c,slot:i}),x=[];for(const[,r]of f){const y=(r.split_times??[]).some(C=>C.time_seconds>0),_=(r.stroke_count??[]).some(C=>C.count>0);(y||_||r.tempo!=null||r.notes?.trim())&&x.push(r)}if(x.length===0)throw new Error("Aucune donnée à sauvegarder");await p.saveSwimExerciseLogs(m,t,x)},onSuccess:()=>{g(!1),j.invalidateQueries({queryKey:["swim-exercise-logs-by-catalog"]}),j.invalidateQueries({queryKey:["swim-exercise-logs-history"]}),u({title:"Notes techniques sauvegardées"})},onError:s=>{u({title:"Erreur",description:s.message,variant:"destructive"})}}),W=R({mutationFn:s=>p.assignments_delete(s),onSuccess:()=>{j.invalidateQueries({queryKey:["assignments"]}),u({title:"Séance retirée",description:"La séance a été retirée de votre feed."}),L("/")},onError:()=>{u({title:"Erreur",description:"Impossible de retirer la séance.",variant:"destructive"})}}),X=async()=>{if(a)try{const s=await re(a.session_id),t=`${window.location.origin}${window.location.pathname}#/s/${s}`;navigator.share?await navigator.share({title:a.title,url:t}):(await navigator.clipboard.writeText(t),u({title:"Lien copié !",description:"Le lien de partage a été copié dans le presse-papier."}))}catch{u({title:"Erreur",description:"Impossible de générer le lien de partage.",variant:"destructive"})}};return A?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(oe,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:A.message}),e.jsx(h,{onClick:()=>V(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(h,{variant:"ghost",size:"icon",onClick:()=>L("/"),"aria-label":"Retour à l'accueil",children:e.jsx(le,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Séance natation"}),e.jsx("h1",{className:"text-2xl font-display font-bold uppercase",children:"Détails"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[a?e.jsx(h,{variant:"ghost",size:"icon",onClick:X,"aria-label":"Partager la séance",children:e.jsx(ce,{className:"h-5 w-5"})}):null,a?e.jsx(B,{variant:"secondary",className:"text-xs",children:ge[a.status]??"Assignée"}):null]})]}),e.jsx(te,{className:"border border-border shadow-sm",children:e.jsxs(ae,{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight",children:a?.title??"Séance natation"}),a?.description?e.jsx("p",{className:"text-sm text-muted-foreground",children:a.description}):null]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx(B,{variant:"outline",className:"text-xs",children:xe(a?.assigned_date)}),a?e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>{window.confirm("Retirer cette séance de votre feed ?")&&W.mutate(a.id)},className:"text-xs text-muted-foreground hover:text-foreground",children:"Retirer de mon feed"}):null]}),e.jsx(ne,{}),a&&!M?e.jsx("div",{className:"rounded-xl bg-muted/50 px-3 py-2 text-xs text-muted-foreground leading-relaxed",children:"Tapez sur un exercice pour ajouter vos temps et détails techniques."}):null,M?e.jsxs("div",{className:"space-y-4","aria-live":"polite","aria-busy":"true",children:[e.jsx("div",{className:"sr-only",children:"Chargement de la séance..."}),e.jsx(w,{className:"h-6 w-48"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,t)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{className:"h-5 w-32"}),e.jsx(w,{className:"h-4 w-full"}),e.jsx(w,{className:"h-4 w-3/4"})]},`skeleton-${t}`))})]}):a?e.jsx(ie,{title:a.title,description:a.description,items:a.items,showHeader:!0,exerciseLogs:f,expandedItemId:F,onToggleExpand:G,onLogChange:J}):e.jsx("div",{className:"rounded-2xl border border-dashed border-muted/70 bg-muted/30 p-6 text-sm text-muted-foreground",children:"Aucune séance de natation assignée pour le moment."})]})}),P&&e.jsx("div",{className:"fixed bottom-6 left-0 right-0 flex justify-center z-50 px-4",children:e.jsxs(h,{onClick:()=>S.mutate(),disabled:S.isPending,className:"gap-2 shadow-lg",children:[S.isPending?e.jsx(de,{className:"h-4 w-4 animate-spin"}):e.jsx(me,{className:"h-4 w-4"}),"Enregistrer"]})})]})}export{$e as default};
