import{r as i,j as e,R as ke}from"./vendor-ui-DJQMR4VV.js";import{u as He,b as Ft,c as Pe}from"./vendor-query-BT4y-huw.js";import{c as le,b as Ot,X as Qe,W as Ve,F as ht,d as ue,u as It,f as Et,s as et,B as Lt}from"./index-wyJVz_R5.js";import{C as Pt}from"./chevron-left-Bz63ZtmK.js";import{C as Fe,A as Ce,B as Kt,I as tt}from"./BottomActionBar-CKxz-Jdi.js";import{C as Ae}from"./circle-CBedjk7A.js";import{m as ae,a as Tt,s as Bt,l as st}from"./animations-BTr26p-C.js";import{d as nt}from"./design-tokens-CGMys_0P.js";import{T as Ge}from"./timer-C7WX_V2S.js";import{P as he,T as Ke}from"./trash-2-Jq2lF36Q.js";import{C as rt}from"./check-DcKIPuZN.js";import{C as Rt}from"./circle-alert-AkN8mS1I.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Db4xOvcx.js";import"./vendor-supabase-D7B1G6YZ.js";import"./loader-circle-D52xyfYR.js";import"./circle-check-DqQMLqN9.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qt=[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]],yt=le("activity",qt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=[["line",{x1:"4",x2:"20",y1:"9",y2:"9",key:"4lhtct"}],["line",{x1:"4",x2:"20",y1:"15",y2:"15",key:"vyu0kd"}],["line",{x1:"10",x2:"8",y1:"3",y2:"21",key:"1ggp8o"}],["line",{x1:"16",x2:"14",y1:"3",y2:"21",key:"weycgp"}]],jt=le("hash",zt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=[["path",{d:"M5 12h14",key:"1ays0h"}]],Nt=le("minus",Jt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401",key:"kfwtm"}]],Ht=le("moon",Yt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qt=[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]],Vt=le("power",Qt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],ot=le("settings-2",Wt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xt=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],Gt=le("sun",Xt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],it=le("user-check",Ut);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zt=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Me=le("user-x",Zt),at={NL:"",DOS:"",BR:"",PAP:"",QN:""};function lt(t){return String(t).padStart(2,"0")}function dt(t){return`${t.getFullYear()}-${lt(t.getMonth()+1)}-${lt(t.getDate())}`}function ct(t){return new Date(t.getFullYear(),t.getMonth(),1)}function ut(t,s){const n=new Date(t);return n.setDate(n.getDate()+s),n}function Te(t){return(t.getDay()+6)%7}function $e(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function es(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}function ts(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(n=>n.trim()).filter(Boolean).flatMap(n=>{const r=n.replace(/^[•\\-–—]\\s*/,"").trim();return r?[r]:[]}):[]}function ss(t){if(!t)return null;const n=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!n)return null;const r=Number(String(n[1]).replace(",","."));return Number.isFinite(r)?n[2].toLowerCase()==="m"?$e(r):r:null}function ns(t,s){const n=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,r=String(n||"").toLowerCase();if(r.includes("mat")||r.includes("morning")||r==="am")return"AM";if(r.includes("soir")||r.includes("evening")||r==="pm")return"PM";const x=`${t?.title??""} ${t?.description??""}`.toLowerCase();return x.includes("matin")||x.includes(" am ")||x.includes("(am)")?"AM":x.includes("soir")||x.includes(" pm ")||x.includes("(pm)")?"PM":s===0?"AM":"PM"}function rs(t){const s=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!s)return null;const n=String(s),r=n.length>=10?n.slice(0,10):n;return/\d{4}-\d{2}-\d{2}/.test(r)?r:null}function os(t){const s=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(s!=null&&Number.isFinite(Number(s))){const x=Number(s);return x>0&&x<=50?x:$e(x)}const n=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(n!=null&&Number.isFinite(Number(n)))return Number(n);const r=ss(`${t?.title??""} ${t?.description??""}`);return r??null}function mt(t){const s=Number(t);if(!Number.isFinite(s))return"—";const n=Math.round(s*100)/100,r=String(n);return r.endsWith(".0")?r.slice(0,-2):r}function is(){const t={};for(let s=0;s<7;s++)t[s]={AM:!0,PM:!0};return t}function Be(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function as({sessions:t,assignments:s,userId:n,user:r}){const x=`swim-dashboard-v2:${n??r??"anon"}`,m=`${x}:presenceDefaults`,h=`${x}:attendanceOverrides`,c=`${x}:stableFields`,[f,k]=i.useState(()=>is()),[w,S]=i.useState({}),[B,R]=i.useState(90);i.useEffect(()=>{if(typeof window>"u")return;const a=Be(window.localStorage.getItem(m));a&&k(a);const l=Be(window.localStorage.getItem(h));l&&S(l);const d=Be(window.localStorage.getItem(c));d?.duration&&Number.isFinite(d.duration)&&d.duration>=30&&d.duration<=240&&R(d.duration)},[m,h,c]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(m,JSON.stringify(f))},[f,m]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(h,JSON.stringify(w))},[w,h]),i.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(c,JSON.stringify({duration:B}))},[B,c]);const p=i.useMemo(()=>new Date,[]),[b,g]=i.useState(()=>ct(new Date)),[y,C]=i.useState(()=>dt(new Date)),[X,me]=i.useState(!1),[q,de]=i.useState(!1),[xe,M]=i.useState(!1),[v,O]=i.useState(null),[A,Q]=i.useState(!1),[L,Z]=i.useState(null),[$,ce]=i.useState(!1),[_,z]=i.useTransition(),G=i.useMemo(()=>(Array.isArray(s)?s:[]).filter(l=>l?.session_type==="swim"),[s]),ee=i.useMemo(()=>{const a=new Map;for(const l of G){const d=rs(l);d&&(a.has(d)||a.set(d,[]),a.get(d).push(l))}for(const[l,d]of a.entries())d.sort((N,D)=>Number(N?.id??0)-Number(D?.id??0)),a.set(l,d);return a},[G]),F=i.useMemo(()=>{const a=Array.isArray(t)?t:[],l={};for(const d of a){const N=String(d?.date??"").slice(0,10),D=d?.slot==="Soir"?"PM":"AM";l[`${N}__${D}`]=d}return l},[t]),te=i.useRef(new Map);i.useEffect(()=>{te.current.clear()},[ee]);const se=i.useCallback(a=>{const l=te.current;if(l.has(a))return l.get(a);const d=[{id:`${a}__AM`,iso:a,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${a}__PM`,iso:a,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],N=ee.get(a)??[],D=new Set;return N.forEach((P,K)=>{const W=P,oe=ns(W,K);if(D.has(oe))return;const ie=oe==="AM"?0:1,Ne=os(W),Oe=Array.isArray(W?.details)?W.details.map(String):ts(P?.description);d[ie]={id:`${a}__${oe}`,iso:a,slotKey:oe,title:String(P?.title??"Séance coach"),km:Ne,details:Oe,assignmentId:typeof P?.id=="number"?P.id:Number(P?.id)||void 0,isEmpty:!1},D.add(oe)}),l.set(a,d),d},[ee]),ne=i.useCallback((a,l)=>{const d=Te(l),N=!!f?.[d]?.[a.slotKey],D=w[a.id];return D==="present"?{status:"present",expected:!0,expectedByDefault:N}:D==="absent"?{status:"absent",expected:!0,expectedByDefault:N}:N?{status:"present",expected:!0,expectedByDefault:N}:{status:"not_expected",expected:!1,expectedByDefault:N}},[w,f]),V=i.useMemo(()=>ct(b),[b]),fe=i.useMemo(()=>{const a=Te(V),l=ut(V,-a),d=[];for(let N=0;N<42;N++)d.push(ut(l,N));return d},[V]),ye=i.useMemo(()=>{const a={};for(const l of fe){const d=dt(l),N=se(d);let D=0,P=0;for(const K of N){const W=ne(K,l);if(!W.expected)continue;D+=1;const oe=!!F[K.id],ie=W.status==="absent";(oe||ie)&&(P+=1)}a[d]={completed:P,total:D}}return a},[fe,se,ne,F]),je=i.useMemo(()=>{const[a,l,d]=y.split("-").map(Number);return new Date(a,l-1,d)},[y]),J=i.useMemo(()=>se(y),[se,y]),Y=ye[y]||{completed:0,total:2},be=i.useMemo(()=>{const a=Array.isArray(t)?t:[];let l=0;for(const d of a){const N=String(d?.date??"").slice(0,10),D=d?.slot==="Soir"?"PM":"AM",P=`${N}__${D}`;if(w[P]==="absent")continue;const K=Te(new Date(N));(f?.[K]?.[D]||w[P]==="present")&&Number.isFinite(Number(d?.distance))&&(l+=Number(d.distance))}return mt($e(l))},[t,w,f]),pe=i.useMemo(()=>{const a=J;let l=0;for(const d of a){const N=ne(d,je);if(!N.expected||N.status==="absent")continue;const D=F[d.id];D&&Number.isFinite(Number(D?.distance))&&(l+=Number(D.distance))}return mt($e(l))},[J,ne,je,F]),ge=i.useMemo(()=>v&&F[v]||null,[v,F]),re=i.useMemo(()=>{const a=ge||{},l=a?.stroke_distances,d=l?{NL:l.NL?String(l.NL):"",DOS:l.DOS?String(l.DOS):"",BR:l.BR?String(l.BR):"",PAP:l.PAP?String(l.PAP):"",QN:l.QN?String(l.QN):""}:at;return{difficulty:a?.effort??null,fatigue_end:a?.fatigue??a?.feeling??null,performance:a?.performance??a?.feeling??null,engagement:a?.engagement??a?.feeling??null,comment:String(a?.comments??""),distanceMeters:Number.isFinite(Number(a?.distance))?Number(a.distance):null,showStrokeDetail:!!(l&&Object.values(l).some(N=>N&&N>0)),strokes:d,exerciseLogs:[]}},[ge]),[H,T]=i.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:at,exerciseLogs:[]}));return i.useEffect(()=>{const a=J.find(l=>l.id===v);if(a){const l=es(a.km??0);T(d=>({...d,...re,distanceMeters:re.distanceMeters==null?l:re.distanceMeters}));return}T(l=>({...l,...re}))},[re,v,J]),i.useEffect(()=>{X&&$&&Y.total>0&&Y.completed>=Y.total&&(me(!1),O(null),Q(!1),ce(!1))},[X,$,Y.completed,Y.total]),{today:p,monthCursor:b,selectedISO:y,drawerOpen:X,settingsOpen:q,infoOpen:xe,activeSessionId:v,detailsOpen:A,selectedDayIndex:L,isPending:_,presenceDefaults:f,attendanceOverrideBySessionId:w,stableDurationMin:B,draftState:H,gridDates:fe,completionByISO:ye,selectedDate:je,sessionsForSelectedDay:J,selectedDayStatus:Y,globalKm:be,dayKm:pe,logsBySessionId:F,setMonthCursor:g,setSelectedISO:C,setDrawerOpen:me,setSettingsOpen:de,setInfoOpen:M,setActiveSessionId:O,setDetailsOpen:Q,setSelectedDayIndex:Z,setPresenceDefaults:k,setAttendanceOverrideBySessionId:S,setStableDurationMin:R,setDraftState:T,setAutoCloseArmed:ce,startTransition:z,getSessionStatus:ne,getSessionsForISO:se}}function We(...t){return t.filter(Boolean).join(" ")}function ls(t){return t.toLocaleDateString("fr-FR",{month:"long",year:"numeric"})}function Re({onClick:t,label:s,children:n,tone:r="neutral",disabled:x}){const m={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:x,className:We("inline-flex items-center justify-center rounded-2xl border p-2 transition",m[r],x&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":s,title:s,children:[n,e.jsx("span",{className:"sr-only",children:s})]})}function ds({monthCursor:t,selectedDayStatus:s,onPrevMonth:n,onNextMonth:r,onJumpToday:x}){return e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(Re,{onClick:n,label:"Mois précédent",children:e.jsx(Pt,{className:"h-5 w-5"})}),e.jsx(Re,{onClick:r,label:"Mois suivant",children:e.jsx(Fe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"min-w-0 text-center",children:[e.jsx("div",{className:"text-base font-semibold text-foreground capitalize truncate",children:ls(t)}),e.jsxs("div",{className:"mt-1 flex items-center justify-center gap-1",children:[e.jsx("span",{className:We("h-1.5 w-1.5 rounded-full",s.total>0&&s.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:We("h-1.5 w-1.5 rounded-full",s.total>0&&s.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]}),e.jsx(Re,{onClick:x,label:"Aller à aujourd'hui",tone:"neutral",children:e.jsx(Ae,{className:"h-5 w-5"})})]})}function _e(...t){return t.filter(Boolean).join(" ")}function cs(t){const s=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())}`}function us({completed:t,total:s}){return s===0?"rest":t>=s?"full":t>0?"half":"none"}const ms=i.memo(function({date:s,inMonth:n,isToday:r,isSelected:x,isFocused:m,status:h,onClick:c,onKeyDown:f}){const{completed:k,total:w}=h,S=us(h),B=S==="full"?"bg-primary":S==="half"?"bg-primary/10":S==="none"?"bg-muted":"bg-muted/50",R=S==="full"?"border-primary":S==="half"?"border-primary/30":S==="none"?"border-muted-foreground/20":"border-border",p=S==="full"?"text-primary-foreground":"text-foreground",b=S==="full"?"bg-primary-foreground/25":"bg-muted-foreground/30",g=S==="full"?"bg-primary-foreground":"bg-primary",y=x?S==="full"?"ring-2 ring-primary-foreground/50":"ring-2 ring-primary/30":"",C=r?S==="full"?"ring-2 ring-primary-foreground/40":"ring-2 ring-primary/50":"",X=m?"ring-2 ring-primary":"";return e.jsx("button",{type:"button",onClick:c,onKeyDown:f,tabIndex:m?0:-1,"data-calendar-cell":"true",className:_e("aspect-square min-w-0 rounded-2xl border p-1 transition",B,R,!n&&"opacity-40","hover:shadow-sm focus:outline-none",y,C,X),"aria-label":`${cs(s)} — ${w===0?"Repos":`${k}/${w}`}`,children:e.jsxs("div",{className:"flex h-full flex-col justify-between",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsx("div",{className:_e("text-[12px] font-semibold",p),children:s.getDate()}),e.jsx("div",{className:"h-[14px] w-[14px]"})]}),e.jsx("div",{className:"flex items-center justify-end",children:w>0&&e.jsx("div",{className:"w-6",children:e.jsxs("div",{className:"flex gap-1",children:[e.jsx("span",{className:_e("h-1.5 flex-1 rounded-full",k>=1?g:b)}),e.jsx("span",{className:_e("h-1.5 flex-1 rounded-full",k>=2?g:b)})]})})})]})})}),xs=["L","M","M","J","V","S","D"],fs=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"];function bs(t){const s=n=>String(n).padStart(2,"0");return`${t.getFullYear()}-${s(t.getMonth()+1)}-${s(t.getDate())}`}function ps(t,s){return t.getFullYear()===s.getFullYear()&&t.getMonth()===s.getMonth()&&t.getDate()===s.getDate()}function gs({monthCursor:t,gridDates:s,completionByISO:n,selectedISO:r,selectedDayIndex:x,today:m,onDayClick:h,onKeyDown:c}){return e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[xs.map((f,k)=>e.jsxs("div",{className:"px-0.5 pb-1 text-[10px] font-semibold text-muted-foreground text-center",children:[e.jsx("span",{className:"sm:hidden",children:f}),e.jsx("span",{className:"hidden sm:inline",children:fs[k]})]},f+k)),s.map((f,k)=>{const w=bs(f),S=f.getMonth()===t.getMonth(),B=w===r,R=n[w]||{completed:0,total:2},p=ps(f,m),b=x===k||x===null&&p;return e.jsx(ms,{date:f,inMonth:S,isToday:p,isSelected:B,isFocused:b,status:R,onClick:()=>h(w),onKeyDown:g=>c(g,k)},w)})]})})}function qe(...t){return t.filter(Boolean).join(" ")}const xt={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function hs({strokes:t,showStrokeDetail:s,disabled:n=!1,onToggle:r,onChange:x}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:n,onClick:r,className:qe("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",n?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(Fe,{className:qe("h-4 w-4 transition-transform",s&&"rotate-90")})]}),s&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(xt).map(m=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:xt[m]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:n,value:t[m],onChange:h=>x({...t,[m]:h.target.value}),placeholder:"0",className:qe("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",n?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},m))})]})}function ze(...t){return t.filter(Boolean).join(" ")}function ys({exerciseLogs:t,assignmentItems:s,disabled:n=!1,onLogsChange:r}){const[x,m]=i.useState(t.length>0),[h,c]=i.useState(""),f=p=>{const b=p.label||`Exercice ${p.ordre??""}`;t.some(g=>g.source_item_id===p.id)||r([...t,{exercise_label:b,source_item_id:p.id??null,split_times:[],tempo:null,stroke_count:[],notes:null}])},k=()=>{const p=h.trim();p&&(r([...t,{exercise_label:p,source_item_id:null,split_times:[],tempo:null,stroke_count:[],notes:null}]),c(""))},w=p=>{r(t.filter((b,g)=>g!==p))},S=(p,b)=>{r(t.map((g,y)=>y===p?{...g,...b}:g))},R=(Array.isArray(s)?s:[]).filter(p=>p.id!=null&&!t.some(b=>b.source_item_id===p.id));return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:n,onClick:()=>m(p=>!p),className:ze("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",n?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ge,{className:"h-4 w-4"}),"Notes techniques",t.length>0&&e.jsx("span",{className:"inline-flex items-center rounded-full bg-primary/10 px-1.5 py-0.5 text-xs font-semibold text-primary",children:t.length})]}),e.jsx(Fe,{className:ze("h-4 w-4 transition-transform",x&&"rotate-90")})]}),x&&!n&&e.jsxs("div",{className:"mt-2 space-y-3",children:[R.length>0&&e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-xs font-medium text-muted-foreground",children:"Exercices de la seance"}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:R.map(p=>e.jsxs("button",{type:"button",onClick:()=>f(p),className:"inline-flex items-center gap-1 rounded-full border border-border bg-card px-2.5 py-1 text-xs font-medium text-foreground hover:bg-muted transition",children:[e.jsx(he,{className:"h-3 w-3"}),p.label||`Ex. ${p.ordre??""}`]},p.id))})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",value:h,onChange:p=>c(p.target.value),onKeyDown:p=>{p.key==="Enter"&&(p.preventDefault(),k())},placeholder:"Exercice libre (ex: 4x50 max)",className:"flex-1 rounded-xl border border-border bg-card px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:k,disabled:!h.trim(),className:ze("rounded-xl border px-3 py-2 text-sm font-semibold transition",h.trim()?"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:e.jsx(he,{className:"h-4 w-4"})})]}),t.map((p,b)=>e.jsx(js,{log:p,onUpdate:g=>S(b,g),onRemove:()=>w(b)},b))]})]})}function js({log:t,onUpdate:s,onRemove:n}){const[r,x]=i.useState((t.split_times?.length??0)>0),[m,h]=i.useState((t.stroke_count?.length??0)>0),c=t.split_times??[],f=t.stroke_count??[],k=()=>{s({split_times:[...c,{rep:c.length+1,time_seconds:0}]}),x(!0)},w=(b,g)=>{s({split_times:c.map((y,C)=>C===b?{...y,time_seconds:g}:y)})},S=b=>{const g=c.filter((y,C)=>C!==b).map((y,C)=>({...y,rep:C+1}));s({split_times:g}),g.length===0&&x(!1)},B=()=>{s({stroke_count:[...f,{rep:f.length+1,count:0}]}),h(!0)},R=(b,g)=>{s({stroke_count:f.map((y,C)=>C===b?{...y,count:g}:y)})},p=b=>{const g=f.filter((y,C)=>C!==b).map((y,C)=>({...y,rep:C+1}));s({stroke_count:g}),g.length===0&&h(!1)};return e.jsxs("div",{className:"rounded-2xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-b border-border bg-muted/50",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground truncate",children:t.exercise_label}),e.jsx("button",{type:"button",onClick:n,className:"p-1 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition","aria-label":"Supprimer",children:e.jsx(Ke,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"p-3 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground min-w-[80px]",children:[e.jsx(yt,{className:"h-3.5 w-3.5"}),"Tempo"]}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:t.tempo??"",onChange:b=>s({tempo:b.target.value?Number(b.target.value):null}),placeholder:"coups/min",className:"w-24 rounded-xl border border-border bg-background px-2 py-1.5 text-sm text-center outline-none focus:ring-2 focus:ring-foreground/10"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(Ge,{className:"h-3.5 w-3.5"}),"Temps"]}),e.jsxs("button",{type:"button",onClick:k,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(he,{className:"h-3 w-3"}),"Rep"]})]}),r&&c.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:c.map((b,g)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:b.rep}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:b.time_seconds||"",onChange:y=>w(g,Number(y.target.value)||0),placeholder:"sec",className:"w-16 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>S(g),className:"p-0.5 text-muted-foreground hover:text-destructive transition","aria-label":`Supprimer rep ${b.rep}`,children:e.jsx(Ke,{className:"h-3 w-3"})})]},g))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(jt,{className:"h-3.5 w-3.5"}),"Coups de bras"]}),e.jsxs("button",{type:"button",onClick:B,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(he,{className:"h-3 w-3"}),"Rep"]})]}),m&&f.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:f.map((b,g)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:b.rep}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,value:b.count||"",onChange:y=>R(g,Number(y.target.value)||0),placeholder:"nb",className:"w-14 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>p(g),className:"p-0.5 text-muted-foreground hover:text-destructive transition","aria-label":`Supprimer rep ${b.rep}`,children:e.jsx(Ke,{className:"h-3 w-3"})})]},g))})]}),e.jsx("div",{children:e.jsx("textarea",{value:t.notes??"",onChange:b=>s({notes:b.target.value||null}),placeholder:"Notes libres...",rows:2,className:"w-full resize-none rounded-xl border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"})})]})]})}function E(...t){return t.filter(Boolean).join(" ")}function Ns(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function Xe(t){const s=Number(t);if(!Number.isFinite(s))return"—";const n=Math.round(s*100)/100,r=String(n);return r.endsWith(".0")?r.slice(0,-2):r}function vs(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function ws(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}const Je=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],ks=[{key:"AM",label:"Matin",Icon:Gt},{key:"PM",label:"Soir",Icon:Ht}];function De({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function we({onClick:t,label:s,children:n,tone:r="neutral",disabled:x}){const m={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:x,className:E("inline-flex items-center justify-center rounded-2xl border p-2 transition",m[r],x&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":s,title:s,children:[n,e.jsx("span",{className:"sr-only",children:s})]})}function Ss(t,s){const n=Number(s);return!Number.isFinite(n)||n<1||n>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[n]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[n]}function Ms({plannedMeters:t,valueMeters:s,onChange:n,disabled:r}){const c=Number.isFinite(Number(s))?Number(s):t,f=c-t;return e.jsxs("div",{className:E("mt-4 rounded-3xl border px-4 py-3",r?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:E("text-xs font-semibold",r?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),e.jsx("div",{className:E("text-xs","text-muted-foreground"),children:f===0?"":f>0?`+${f}m`:`${f}m`})]}),e.jsxs("div",{className:"mt-2 flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:r||c-100<0,onClick:()=>n(c-100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center",r?"bg-muted border-border text-muted-foreground":"bg-card border-border text-foreground hover:bg-muted"),"aria-label":"-100m",children:e.jsx(Nt,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-[120px] text-center",children:[e.jsxs("div",{className:E("text-lg font-semibold",r?"text-muted-foreground":"text-foreground"),children:[c,"m"]}),e.jsxs("div",{className:E("text-xs","text-muted-foreground"),children:["(",Xe(vs(c))," km)"]})]}),e.jsx("button",{type:"button",disabled:r||c+100>3e4,onClick:()=>n(c+100),className:E("h-11 w-11 rounded-2xl border flex items-center justify-center",r?"bg-muted border-border text-muted-foreground":"bg-card border-border text-foreground hover:bg-muted"),"aria-label":"+100m",children:e.jsx(he,{className:"h-5 w-5"})})]})]})}function _s({open:t,selectedDate:s,sessionsForSelectedDay:n,selectedDayStatus:r,dayKm:x,activeSessionId:m,detailsOpen:h,draftState:c,saveState:f,isPending:k,logsBySessionId:w,assignmentItems:S,onClose:B,onDayOffAll:R,onOpenSession:p,onCloseSession:b,onToggleDetails:g,onMarkAbsent:y,onMarkPresent:C,onClearOverride:X,onSaveFeedback:me,onDraftStateChange:q,getSessionStatus:de}){const[,xe]=Ot(),M=i.useMemo(()=>m&&n.find(v=>v.id===m)||null,[m,n]);return e.jsx(Ce,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(ae.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:B}),e.jsx(ae.div,{className:E("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:Tt,initial:"hidden",animate:"visible",exit:"exit",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden",children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b bg-background px-4 sm:px-5 py-3",children:[e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-base font-semibold text-foreground",children:Ns(s)})}),e.jsx(we,{onClick:B,label:"Fermer",children:e.jsx(Qe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl border border-border bg-card flex items-center justify-center",children:e.jsx(Ve,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[x," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:E("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})]}),e.jsx(we,{onClick:R,label:"OFF (absent journée)",tone:"dark",disabled:k,children:e.jsx(Vt,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"mt-4 grid gap-2",children:n.map(v=>{const O=de(v,s),A=!!w[v.id],Q=O.status==="absent",L=O.status==="not_expected",Z=Q||L,$=O.expected&&!A&&!Q,ce=A?"bg-status-success-bg border-status-success/30":Z?"bg-sky-50 border-sky-200":$?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",_=ks.find(z=>z.key===v.slotKey)?.Icon||Ae;return e.jsx("button",{type:"button",onClick:()=>p(v.id),className:E("w-full rounded-3xl border px-3 py-3 text-left transition",ce,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:E("h-10 w-10 rounded-2xl border flex items-center justify-center",A?"border-status-success/30 bg-status-success-bg":Z?"border-sky-200 bg-sky-100":$?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(_,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:v.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[v.isEmpty?e.jsx(De,{children:"Vide"}):e.jsxs(De,{children:[Xe(v.km)," km"]}),A&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(rt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),Z&&!A&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),$&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[L&&e.jsx(we,{onClick:z=>{z.stopPropagation(),C(v.id)},label:"Je suis venu",disabled:k,children:e.jsx(it,{className:"h-5 w-5"})}),O.expected&&!A&&!Q&&e.jsx(we,{onClick:z=>{z.stopPropagation(),y(v.id)},label:"Absent",tone:"sky",disabled:k,children:e.jsx(Me,{className:"h-5 w-5"})})]})]})},v.id)})}),e.jsx(Ce,{children:M&&e.jsx(ae.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:nt.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const v=de(M,s),O=v.status==="absent",A=v.status==="not_expected",Q=!!w[M.id],L=v.expected&&!O,Z=O?"Annuler":A?"Je suis venu":"Absent",$=O?()=>X(M.id):A?()=>C(M.id):()=>y(M.id),ce=ws(M.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:M.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[M.isEmpty?e.jsx(De,{children:"Vide"}):e.jsxs(De,{children:[Xe(M.km)," km"]}),Q?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(rt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):O||A?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Me,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx(we,{onClick:b,label:"Retour",children:e.jsx(Qe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:$,className:E("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",A?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[A?e.jsx(it,{className:"h-4 w-4"}):e.jsx(Me,{className:"h-4 w-4"}),Z]}),e.jsxs("button",{type:"button",onClick:g,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(ht,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(Ce,{children:h&&e.jsxs(ae.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:nt.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:[M.details?.length?e.jsx("ul",{className:"list-disc pl-5 space-y-1 text-sm text-foreground",children:M.details.map((_,z)=>e.jsx("li",{children:_},z))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:M.assignmentId?"Séance coach — détails dans la fiche.":"Aucun détail pour ce créneau."}),M.assignmentId?e.jsx("div",{className:"mt-3",children:e.jsx("button",{type:"button",onClick:()=>xe(`/swim-session?assignmentId=${M.assignmentId}`),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:"Ouvrir la fiche complète"})}):null]})}),e.jsxs("div",{className:"px-4 pb-4",children:[!L&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:O?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(ae.div,{className:"space-y-4",variants:Bt,initial:"hidden",animate:"visible",children:[Je.map(_=>{const z=c[_.key];return e.jsxs(ae.div,{className:"space-y-2",variants:st,children:[e.jsx("div",{className:E("text-sm font-semibold",L?"text-foreground":"text-muted-foreground"),children:_.label}),e.jsx("div",{className:"flex items-center gap-2",children:[1,2,3,4,5].map(G=>{const ee=z===G;return e.jsx("button",{type:"button",disabled:!L,onClick:()=>q({...c,[_.key]:G}),className:E("h-11 w-11 rounded-2xl border text-sm font-semibold transition",L?ee?Ss(_.mode,G):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:G},G)})})]},_.key)}),e.jsxs(ae.div,{className:"space-y-2",variants:st,children:[e.jsx("div",{className:E("text-sm font-semibold",L?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:c.comment,onChange:_=>q({...c,comment:_.target.value}),disabled:!L,rows:3,placeholder:"Sensations, points techniques…",className:E("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",L?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsx(Ms,{plannedMeters:ce,valueMeters:c.distanceMeters,onChange:_=>q({...c,distanceMeters:_}),disabled:!L}),e.jsx(hs,{strokes:c.strokes,showStrokeDetail:c.showStrokeDetail,disabled:!L,onToggle:()=>q({...c,showStrokeDetail:!c.showStrokeDetail}),onChange:_=>q({...c,strokes:_})}),e.jsx(ys,{exerciseLogs:c.exerciseLogs,assignmentItems:S,disabled:!L,onLogsChange:_=>q({...c,exerciseLogs:_})})]})]})})()},M.id)})]}),M&&(()=>{const v=de(M,s),O=v.expected&&v.status!=="absent";return e.jsxs(Kt,{saveState:f,position:"static",children:[e.jsx("button",{type:"button",onClick:me,disabled:k||!O||!Je.every(A=>Number.isInteger(c[A.key])),className:E("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",k||!O?"bg-muted text-muted-foreground cursor-not-allowed":Je.every(A=>Number.isInteger(c[A.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["→"," km"]})]})})()]})})]})})}function Ds(...t){return t.filter(Boolean).join(" ")}function Cs(t){try{return new Date(t).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return t}}function As(t){if(!t||!Number.isFinite(t))return"—";if(t<60)return`${t.toFixed(1)}s`;const s=Math.floor(t/60),n=t%60;return`${s}:${n<10?"0":""}${n.toFixed(1)}`}function $s({userId:t,expanded:s,onToggle:n}){const{data:r,isLoading:x}=He({queryKey:["swim-exercise-logs-history",t],queryFn:()=>ue.getSwimExerciseLogsHistory(t,100),enabled:!!t&&s}),m=ke.useMemo(()=>{if(!r?.length)return[];const h=new Map;for(const c of r){const f=(c.created_at??"").slice(0,10);h.has(f)||h.set(f,[]),h.get(f).push(c)}return Array.from(h.entries()).map(([c,f])=>({date:c,entries:f}))},[r]);return e.jsxs("div",{className:"mt-6",children:[e.jsxs("button",{type:"button",onClick:n,className:"flex w-full items-center justify-between rounded-2xl border border-border px-3 py-2.5 text-sm font-semibold text-foreground hover:bg-muted transition",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(ht,{className:"h-4 w-4"}),"Historique notes techniques"]}),e.jsx(Fe,{className:Ds("h-4 w-4 transition-transform",s&&"rotate-90")})]}),s&&e.jsxs("div",{className:"mt-3 space-y-3",children:[x&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Chargement..."}),!x&&m.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucune note technique enregistree."}),m.map(({date:h,entries:c})=>e.jsxs("div",{className:"rounded-2xl border border-border overflow-hidden",children:[e.jsx("div",{className:"bg-muted/50 px-3 py-2 text-xs font-semibold text-muted-foreground",children:Cs(h)}),e.jsx("div",{className:"divide-y divide-border",children:c.map(f=>e.jsx(Fs,{log:f},f.id))})]},h))]})]})}function Fs({log:t}){return e.jsxs("div",{className:"px-3 py-2.5 space-y-1.5",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground",children:[t.tempo!=null&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(yt,{className:"h-3 w-3"}),t.tempo," c/min"]}),t.split_times.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ge,{className:"h-3 w-3"}),t.split_times.map(s=>As(s.time_seconds)).join(" / ")]}),t.stroke_count.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(jt,{className:"h-3 w-3"}),t.stroke_count.map(s=>s.count).join(" / ")," cps"]})]}),t.notes&&e.jsx("div",{className:"text-xs text-foreground/70 italic",children:t.notes})]})}const Os=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],Is=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],Es=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function ft(...t){return t.filter(Boolean).join(" ")}function bt(t){return String(t).padStart(2,"0")}function Ye(t){return`${t.getFullYear()}-${bt(t.getMonth()+1)}-${bt(t.getDate())}`}function Ls(t){return new Date(t.getFullYear(),t.getMonth(),1)}function Ps(t){const s=String(t).split("__");return{iso:s[0],slotKey:s[1]||""}}function pt(t,s){return Number.isFinite(t)?Math.round(t/s)*s:0}function gt({open:t,title:s,onClose:n,children:r}){return e.jsx(Ce,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(ae.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:n}),e.jsx(ae.div,{className:"fixed inset-0 z-modal flex items-end sm:items-center justify-center p-3 pb-24 sm:p-4 sm:pb-4",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:e.jsxs("div",{className:"w-full max-w-md rounded-3xl border bg-background shadow-2xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[e.jsx("div",{className:"truncate text-base font-semibold text-foreground",children:s}),e.jsxs("button",{type:"button",onClick:n,className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Fermer",children:[e.jsx(Qe,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"Fermer"})]})]}),e.jsx("div",{className:"p-4",children:r})]})})]})})}function tn(){const{user:t,userId:s}=It(),{toast:n}=Et(),r=Ft(),[x,m]=ke.useState("idle"),[h,c]=ke.useState(!1),[f,k]=ke.useState(null);ke.useEffect(()=>{et.auth.getSession().then(({data:o})=>{k(o.session?.user?.id??null)})},[t]);const{data:w,isLoading:S,error:B,refetch:R}=He({queryKey:["sessions",s??t],queryFn:()=>ue.getSessions(t,s),enabled:!!t}),{data:p,isLoading:b,error:g,refetch:y}=He({queryKey:["assignments",t],queryFn:()=>ue.getAssignments(t,s),enabled:!!t}),C=S||b,X=B||g,me=()=>{R(),y()},q=Pe({mutationFn:o=>ue.deleteSession(o),onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),n({title:"Séance supprimée",description:"La saisie a été supprimée."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),de=Pe({mutationFn:async o=>{const{_exerciseLogs:u,...j}=o,I=await ue.syncSession({...j,athlete_name:t,athlete_id:s??void 0});if(u&&u.length>0&&I.sessionId)try{const{data:U}=await et.auth.getSession(),Se=U.session?.user?.id;Se&&await ue.saveSwimExerciseLogs(I.sessionId,Se,u)}catch(U){console.warn("[EAC] Failed to save exercise logs:",U)}return I},onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["assignments"]}),n({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),xe=Pe({mutationFn:o=>ue.updateSession(o),onMutate:()=>{m("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),n({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),m("saved"),setTimeout(()=>m("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),m("error"),setTimeout(()=>m("idle"),3e3)}}),M=as({sessions:w,assignments:p,userId:s,user:t}),{today:v,monthCursor:O,selectedISO:A,drawerOpen:Q,settingsOpen:L,infoOpen:Z,activeSessionId:$,detailsOpen:ce,selectedDayIndex:_,isPending:z,presenceDefaults:G,stableDurationMin:ee,draftState:F,gridDates:te,completionByISO:se,selectedDate:ne,sessionsForSelectedDay:V,selectedDayStatus:fe,globalKm:ye,dayKm:je,logsBySessionId:J,setMonthCursor:Y,setSelectedISO:be,setDrawerOpen:pe,setSettingsOpen:ge,setInfoOpen:re,setActiveSessionId:H,setDetailsOpen:T,setSelectedDayIndex:a,setPresenceDefaults:l,setAttendanceOverrideBySessionId:d,setStableDurationMin:N,setDraftState:D,setAutoCloseArmed:P,startTransition:K,getSessionStatus:W}=M,oe=i.useMemo(()=>{if(!$)return[];const o=V.find(j=>j.id===$);if(!o?.assignmentId)return[];const u=(p??[]).find(j=>j.id===o.assignmentId);return u?.items?u.items.filter(j=>j.label):[]},[$,V,p]),ie=i.useCallback(o=>{be(o),pe(!0),H(null),T(!1);const u=se[o]||{completed:0,total:2};P(u.total>0&&u.completed<u.total)},[se,be,pe,H,T,P]),Ne=i.useCallback(()=>{pe(!1),H(null),T(!1),P(!1),a(null)},[pe,H,T,P,a]),Oe=i.useCallback(()=>{Y(o=>new Date(o.getFullYear(),o.getMonth()-1,1))},[Y]),vt=i.useCallback(()=>{Y(o=>new Date(o.getFullYear(),o.getMonth()+1,1))},[Y]),wt=i.useCallback(()=>{const o=new Date;Y(Ls(o)),ie(Ye(o))},[ie,Y]),Ie=i.useCallback(o=>{H(o),T(!1)},[H,T]),kt=i.useCallback(o=>{K(()=>{d(j=>({...j,[o]:"absent"}))});const u=J[o];u?.id&&q.mutate(Number(u.id))},[q,J,K,d]),St=i.useCallback(o=>{K(()=>{d(u=>({...u,[o]:"present"}))})},[K,d]),Mt=i.useCallback(o=>{K(()=>{d(u=>{const j={...u};return delete j[o],j})})},[K,d]),_t=i.useCallback(()=>{const o=V.map(u=>W(u,ne).expected?u.id:null).filter(Boolean);o.length!==0&&(K(()=>{d(u=>{const j={...u};for(const I of o)j[I]="absent";return j}),H(null),T(!1)}),o.forEach(u=>{const j=J[u];j?.id&&q.mutate(Number(j.id))}))},[V,W,ne,K,J,q,d,H,T]),Dt=i.useCallback(()=>{if(!$||!t||!Es.every(ve=>Number.isInteger(F[ve.key])))return;const{iso:u,slotKey:j}=Ps($),I=j==="PM"?"Soir":"Matin",U=pt(Number(F.distanceMeters??0),100),Se=pt(Number(ee),15),Ee={};for(const[ve,$t]of Object.entries(F.strokes)){const Ze=Number($t);Ze>0&&(Ee[ve]=Ze)}const Ue={date:u,slot:I,distance:U,duration:Se,effort:Number(F.difficulty),feeling:Number(F.fatigue_end),performance:Number(F.performance),engagement:Number(F.engagement),comments:String(F.comment||"").slice(0,400),athlete_name:t,athlete_id:s??void 0,stroke_distances:Object.keys(Ee).length>0?Ee:null},Le=J[$];K(()=>{d(ve=>({...ve,[$]:"present"}))}),Le?.id?xe.mutate({...Ue,id:Le.id,created_at:Le.created_at??new Date().toISOString()}):de.mutate({...Ue,_exerciseLogs:F.exerciseLogs.length>0?F.exerciseLogs:void 0}),H(null),T(!1)},[$,t,s,F,ee,J,K,xe,de,d,H,T]),Ct=i.useCallback((o,u)=>{l(j=>({...j,[o]:{...j[o],[u]:!j[o][u]}}))},[l]);i.useEffect(()=>{if(!Q)return;const o=u=>{if(u.key==="Escape"){u.preventDefault(),Ne();return}(u.key==="Enter"||u.key===" ")&&(u.preventDefault(),V.length>0&&!$&&Ie(V[0].id))};return window.addEventListener("keydown",o),()=>window.removeEventListener("keydown",o)},[Q,Ne,V,$,Ie]);const At=i.useCallback((o,u)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(o.key))return;if(o.preventDefault(),o.key==="Enter"||o.key===" "){const U=Ye(te[u]);ie(U);return}let I=u;o.key==="ArrowLeft"&&(I=Math.max(0,u-1)),o.key==="ArrowRight"&&(I=Math.min(te.length-1,u+1)),o.key==="ArrowUp"&&(I=Math.max(0,u-7)),o.key==="ArrowDown"&&(I=Math.min(te.length-1,u+7)),a(I),be(Ye(te[I])),setTimeout(()=>{const U=document.querySelectorAll('[data-calendar-cell="true"]');U[I]&&U[I].focus()},0)},[te,ie,a,be]);return C?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-border bg-card/90 backdrop-blur",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl bg-muted animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((o,u)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${u}`)),Array.from({length:35}).map((o,u)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${u}`))]})})]})})]}):X?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Rt,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:X.message}),e.jsx(Lt,{onClick:()=>me(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-border bg-card/90 backdrop-blur",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl bg-card border border-border flex items-center justify-center",children:e.jsx(Ve,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Suivi"}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[ye," km"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>re(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Infos",children:e.jsx(tt,{className:"h-5 w-5"})}),e.jsx("button",{type:"button",onClick:()=>ge(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Paramètres",children:e.jsx(ot,{className:"h-5 w-5"})})]})]})}),e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:[e.jsxs("div",{className:"invisible sm:visible flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-10 w-10 rounded-2xl bg-card border border-border flex items-center justify-center",children:e.jsx(Ve,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:"Suivi"}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[ye," km"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>re(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Infos",children:e.jsx(tt,{className:"h-5 w-5"})}),e.jsx("button",{type:"button",onClick:()=>ge(!0),className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Paramètres",children:e.jsx(ot,{className:"h-5 w-5"})})]})]}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(ds,{monthCursor:O,selectedDayStatus:fe,onPrevMonth:Oe,onNextMonth:vt,onJumpToday:wt}),e.jsx(gs,{monthCursor:O,gridDates:te,completionByISO:se,selectedISO:A,selectedDayIndex:_,today:v,onDayClick:ie,onKeyDown:At})]}),f&&e.jsx($s,{userId:f,expanded:h,onToggle:()=>c(o=>!o)}),e.jsx(gt,{open:Z,title:"Codes",onClose:()=>re(!1),children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-orange-200 bg-orange-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Orange"}),e.jsx("span",{className:"text-foreground",children:"À compléter"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Vert"}),e.jsx("span",{className:"text-foreground",children:"Validé → km"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-sky-200 bg-sky-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Bleu"}),e.jsx("span",{className:"text-foreground",children:"Absent / Non prévu"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Les km comptent uniquement après validation."})]})}),e.jsx(gt,{open:L,title:"Présence",onClose:()=>ge(!1),children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Toggle hebdo (séances attendues)."}),e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_110px_110px] bg-muted border-b border-border px-3 py-2 text-xs font-semibold text-muted-foreground",children:[e.jsx("div",{children:"Jour"}),e.jsx("div",{className:"text-center",children:"Matin"}),e.jsx("div",{className:"text-center",children:"Soir"})]}),Os.map((o,u)=>e.jsxs("div",{className:ft("grid grid-cols-[1fr_110px_110px] items-center px-3 py-2",u!==6&&"border-b border-border"),children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:o}),Is.map(j=>{const I=!!G?.[u]?.[j.key];return e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{type:"button",onClick:()=>Ct(u,j.key),className:ft("w-24 rounded-2xl border px-3 py-2 text-sm font-semibold transition",I?"bg-foreground text-background border-foreground":"bg-card text-foreground border-border hover:bg-muted"),"aria-label":`${o} ${j.label}`,children:I?"On":"Off"})},j.key)})]},o))]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>N(o=>Math.max(30,o-15)),"aria-label":"Diminuer la durée",children:e.jsx(Nt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[ee," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>N(o=>Math.min(240,o+15)),"aria-label":"Augmenter la durée",children:e.jsx(he,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-1 text-[11px] text-muted-foreground",children:"Durée envoyée au back-end (non affichée dans la maquette)."})]})]})}),e.jsx(_s,{open:Q,selectedDate:ne,sessionsForSelectedDay:V,selectedDayStatus:fe,dayKm:je,activeSessionId:$,detailsOpen:ce,draftState:F,saveState:x,isPending:z,logsBySessionId:J,onClose:Ne,onDayOffAll:_t,onOpenSession:Ie,onCloseSession:()=>{H(null),T(!1)},onToggleDetails:()=>T(o=>!o),onMarkAbsent:kt,onMarkPresent:St,onClearOverride:Mt,onSaveFeedback:Dt,onDraftStateChange:D,getSessionStatus:W,assignmentItems:oe})]})]})}export{tn as default};
