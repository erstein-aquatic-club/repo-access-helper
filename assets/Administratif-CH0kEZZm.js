import{j as e,a as p,c as bt,R as gt,u as be,r as ge,d as W}from"./vendor-query-BiSH4r2z.js";import{c as Ne,a as vt,B as U,L as X,I as ne,d as jt,u as re,p as yt,T as Nt,q as wt}from"./index-C8Ys7NvK.js";import{a as P}from"./api-R6k1jfwT.js";import{T as Mt,a as Tt}from"./toggle-group-B9uF08tY.js";import{C as kt}from"./checkbox-CG8znl5P.js";import{S as St,a as Dt,b as Ct,c as _t,d as At}from"./select-DsJlP3hw.js";import{f as y,g as B,c as Lt}from"./timesheetHelpers-D9RwANHz.js";import{t as we,c as Be,f as N}from"./format-B9mPVj_w.js";import{s as O}from"./swim-CkD6PybV.js";import{m as A}from"./proxy-Dh0N-Z8G.js";import{C as Et}from"./clock-BEHiY6By.js";import{T as Ft,P as It,a as Rt,B as $t}from"./PieChart-BagPQJoE.js";import{q as Pt,R as Ot,X as qt,Y as Vt,T as zt,B as He}from"./generateCategoricalChart-BolhGFni.js";import{C as Bt}from"./CartesianGrid-yEKVXUwa.js";import{s as Ht}from"./subDays-BHZeCtPl.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";import"./index-CDyVNzIM.js";import"./index-BRt7zf33.js";import"./check-B-52Crui.js";import"./chevron-down-BgKZKOjT.js";import"./chevron-up-Ct0_XNME.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kt=[["path",{d:"M16 20V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16",key:"jecpp"}],["rect",{width:"20",height:"14",x:"2",y:"6",rx:"2",key:"i6l2r4"}]],Gt=Ne("briefcase",Kt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9C18.7 10.6 16 10 16 10s-1.3-1.4-2.2-2.3c-.5-.4-1.1-.7-1.8-.7H5c-.6 0-1.1.4-1.4.9l-1.4 2.9A3.7 3.7 0 0 0 2 12v4c0 .6.4 1 1 1h2",key:"5owen"}],["circle",{cx:"7",cy:"17",r:"2",key:"u2ysq9"}],["path",{d:"M9 17h6",key:"r8uit2"}],["circle",{cx:"17",cy:"17",r:"2",key:"axvx0g"}]],Qt=Ne("car",Yt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]],Ke=Ne("map-pin",Wt);function Ut(r,s){const n=we(r);if(isNaN(s))return Be(r,NaN);const o=n.getDate(),a=Be(r,n.getTime());a.setMonth(n.getMonth()+s+1,0);const c=a.getDate();return o>=c?a:(n.setFullYear(a.getFullYear(),a.getMonth(),o),n)}function Xt(r){const s=we(r),n=s.getMonth();return s.setFullYear(s.getFullYear(),n+1,0),s.setHours(23,59,59,999),s}function oe(r){const s=we(r);return s.setDate(1),s.setHours(0,0,0,0),s}function Jt(r,s){return Ut(r,-1)}function Zt({children:r,className:s,top:n=!1,bottom:o=!1,left:a=!1,right:c=!1}){return e.jsx("div",{className:vt(s),style:{paddingTop:n?"env(safe-area-inset-top)":void 0,paddingBottom:o?"env(safe-area-inset-bottom)":void 0,paddingLeft:a?"env(safe-area-inset-left)":void 0,paddingRight:c?"env(safe-area-inset-right)":void 0},children:r})}const Q=r=>String(r).padStart(2,"0"),ye=(r,s,n)=>Math.max(s,Math.min(n,r)),es=(r,s)=>{const n=Math.round(r/s)*s;return ye(n,0,60-s)},et=(r,s=5)=>{const[n,o]=r.split(":"),a=Number(n),c=Number(o),b=ye(Number.isFinite(a)?a:0,0,23),S=ye(Number.isFinite(c)?c:0,0,59),m=es(S,s);return`${Q(b)}:${Q(m)}`},ts=(r,s)=>{const n=et(r,s),[o,a]=n.split(":").map(c=>Number(c));return{hours:o,minutes:a}};function Ge({value:r,values:s,onChange:n,width:o=68,itemHeight:a=28,visibleCount:c=3,format:b,snapKey:S}){const m=p.useRef(null),g=Math.floor(c/2)*a,[M,C]=p.useState(r),w=p.useRef(r),T=p.useRef(r),f=p.useRef(null),u=p.useRef(null),h=p.useRef(!1);return p.useEffect(()=>{T.current=r,w.current=r,C(r);const x=m.current;if(!x||h.current)return;const D=Math.max(0,s.indexOf(r));x.scrollTo({top:D*a,behavior:"instant"})},[a,r,s]),p.useEffect(()=>{const x=m.current;if(!x)return;const D=Math.max(0,s.indexOf(r));x.scrollTo({top:D*a,behavior:"instant"})},[a,S,r,s]),p.useEffect(()=>{const x=m.current;if(!x)return;const D=()=>{const L=Math.round(x.scrollTop/a),F=s[Math.max(0,Math.min(s.length-1,L))];w.current=F,C(F)},R=()=>{const L=w.current;L!==T.current&&n(L),h.current=!1},V=()=>{h.current=!0,f.current&&cancelAnimationFrame(f.current),f.current=requestAnimationFrame(D),u.current&&window.clearTimeout(u.current),u.current=window.setTimeout(R,140)};return x.addEventListener("scroll",V,{passive:!0}),()=>{x.removeEventListener("scroll",V),f.current&&cancelAnimationFrame(f.current),u.current&&window.clearTimeout(u.current)}},[a,n,s]),e.jsx("div",{style:{width:o,minWidth:0,flex:`0 0 ${o}px`},children:e.jsxs("div",{className:"relative overflow-hidden rounded-xl border border-border bg-card",children:[e.jsx("div",{className:"pointer-events-none absolute left-0 right-0 top-0 z-[2]",style:{height:g,background:"linear-gradient(hsl(var(--background)), transparent)"}}),e.jsx("div",{className:"pointer-events-none absolute left-0 right-0 bottom-0 z-[2]",style:{height:g,background:"linear-gradient(transparent, hsl(var(--background)))"}}),e.jsx("div",{className:"pointer-events-none absolute left-1.5 right-1.5 z-[1] rounded-lg",style:{top:g,height:a,background:"rgba(17,17,17,0.14)",boxShadow:"inset 0 0 0 1px rgba(17,17,17,0.25)"}}),e.jsx("div",{ref:m,style:{height:a*c,overflowY:"auto",overflowX:"hidden",scrollSnapType:"y mandatory",scrollSnapStop:"always",WebkitOverflowScrolling:"touch",paddingTop:g,paddingBottom:g,touchAction:"pan-y",overscrollBehavior:"contain"},children:s.map(x=>{const D=x===M;return e.jsx("div",{className:`flex items-center justify-center text-[15px] font-bold ${D?"text-foreground":"text-muted-foreground"}`,style:{height:a,scrollSnapAlign:"center",fontWeight:D?900:700,userSelect:"none"},children:b?b(x):String(x)},x)})})]})})}function Ye({label:r,value:s,onChange:n,allowEmpty:o=!1,showEmptyButton:a=!0,snapKey:c}){const b=p.useMemo(()=>Array.from({length:24},(u,h)=>h),[]),S=p.useMemo(()=>Array.from({length:12},(u,h)=>h*5),[]),m=s||"00:00",g=p.useMemo(()=>ts(m,5),[m]),[M,C]=p.useState(g.hours),[w,T]=p.useState(g.minutes);p.useEffect(()=>{C(g.hours),T(g.minutes)},[g.hours,g.minutes]),p.useEffect(()=>{if(!s)return;const u=et(s,5),[h,x]=u.split(":");C(Number(h)),T(Number(x))},[s]);const f=p.useCallback((u,h)=>{n(`${Q(u)}:${Q(h)}`)},[n]);return e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-black text-foreground",children:r}),e.jsxs("div",{className:"flex flex-wrap items-end justify-center gap-2",children:[e.jsx(Ge,{value:M,values:b,onChange:u=>{C(u),f(u,w)},format:u=>Q(u),snapKey:c}),e.jsx(Ge,{value:w,values:S,onChange:u=>{T(u),f(M,u)},format:u=>Q(u),snapKey:c})]}),o&&a?e.jsx("button",{type:"button",onClick:()=>n(""),className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-foreground",children:"En cours"}):null]})}const ie=r=>String(r).padStart(2,"0"),ve=()=>{const r=new Date,s=Math.round(r.getMinutes()/5)*5,n=s===60?1:0,o=(r.getHours()+n)%24,a=s===60?0:s;return`${ie(o)}:${ie(a)}`},ss=(r,s)=>{const[n,o]=r.split(":").map(g=>Number(g)),a=Number.isFinite(n)?n:0,c=Number.isFinite(o)?o:0,b=(a*60+c+s+1440)%1440,S=Math.floor(b/60),m=b%60;return`${ie(S)}:${ie(m)}`};function rs({isOpen:r,isEditing:s,isSaving:n,date:o,startTime:a,endTime:c,location:b,isTravel:S,durationLabel:m,locations:g,onClose:M,onSubmit:C,onDateChange:w,onStartTimeChange:T,onEndTimeChange:f,onLocationChange:u,onTravelChange:h,onCreateLocation:x,onDeleteLocation:D}){const R=p.useMemo(()=>r?Date.now():0,[r]),[V,L]=p.useState(!1),[F,H]=p.useState("");return p.useEffect(()=>{if(!r||s||a)return;const v=ve();T(v),c||f(ss(v,60))},[c,s,r,f,T,a]),r?e.jsx("div",{role:"dialog","aria-modal":"true","aria-label":s?"Modifier shift":"Nouveau shift",className:"fixed inset-0 z-modal flex items-end justify-center bg-black/35 px-3 pb-3",onClick:M,children:e.jsxs("div",{className:"w-full max-w-3xl overflow-hidden rounded-2xl bg-card shadow-[0_12px_40px_rgba(0,0,0,0.2)]",onClick:v=>v.stopPropagation(),children:[e.jsx("div",{className:"mx-auto mt-2 h-1.5 w-10 rounded-full bg-muted"}),e.jsxs("div",{className:"grid grid-cols-[1fr_auto] items-center gap-2 px-4 pb-2 pt-3 text-sm font-black",children:[e.jsx("div",{children:s?"Modifier shift":"Nouveau shift"}),e.jsx(U,{type:"button",variant:"outline",size:"sm",onClick:M,children:"Fermer"}),e.jsxs("div",{className:"col-span-2 text-center text-sm font-black text-card-foreground",children:[a||"—"," → ",c||"En cours",m?` • Durée ${m}`:null]})]}),e.jsxs("form",{onSubmit:C,className:"max-h-[72vh] space-y-4 overflow-y-auto px-4 pb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"shift-date",children:"Date"}),e.jsx(ne,{id:"shift-date",type:"date",value:o,onChange:v=>w(v.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ye,{label:"Heure d’arrivée",value:a,onChange:T,snapKey:R}),e.jsx("button",{type:"button","aria-label":"Heure d'arrivée maintenant",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>{const v=ve();T(v)},children:"Maintenant"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(Ye,{label:"Heure de sortie",value:c,onChange:f,allowEmpty:!0,showEmptyButton:!1,snapKey:R}),e.jsx("button",{type:"button","aria-label":"Heure de sortie maintenant",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>{const v=ve();f(v)},children:"Maintenant"}),e.jsx("button",{type:"button","aria-label":"Marquer comme en cours",className:"mx-auto block h-8 min-w-[110px] rounded-full border border-border bg-card px-3 text-xs font-bold text-card-foreground",onClick:()=>f(""),children:"En cours"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(X,{htmlFor:"shift-location",children:"Lieu"}),e.jsxs(St,{value:b||void 0,onValueChange:u,children:[e.jsx(Dt,{id:"shift-location",children:e.jsx(Ct,{placeholder:"Sélectionner un lieu"})}),e.jsx(_t,{children:g.map(v=>e.jsx(At,{value:v.name,children:v.name},v.id))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(kt,{id:"shift-travel",checked:S,onCheckedChange:v=>h(v===!0)}),e.jsx(X,{htmlFor:"shift-travel",children:"Temps de trajet"})]}),e.jsxs("div",{className:"flex gap-3 border-t border-border pt-3",children:[e.jsx(U,{type:"button",variant:"outline",className:"flex-1",onClick:M,children:"Annuler"}),e.jsx(U,{type:"submit",className:"flex-1",disabled:n,children:s?"Enregistrer":"Ajouter"})]})]})]})}):null}const ae=r=>{if(!r)return"—";const s=new Date(r);return Number.isNaN(s.getTime())?"—":N(s,"HH:mm")},as=r=>{const s=new Date(r);return Number.isNaN(s.getTime())?r:new Intl.DateTimeFormat("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"}).format(s)};function ns({groups:r,onEdit:s,onDelete:n}){return e.jsx("div",{className:"rounded-2xl border border-border bg-card shadow-[0_1px_6px_rgba(0,0,0,0.04)]",children:r.length===0?e.jsx("div",{className:"px-4 py-4 text-sm text-muted-foreground",children:"Aucun shift pour l’instant."}):r.map(o=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 border-b border-border bg-muted px-3 py-2 text-xs font-black capitalize text-foreground",children:[e.jsx("span",{children:as(o.date)}),e.jsx("span",{children:y(o.totalMinutes)})]}),e.jsx("div",{children:o.shifts.map(a=>{const c=B(a),b=c===null;return e.jsxs("div",{className:"flex flex-wrap items-start gap-3 border-b border-border/50 px-3 py-3",children:[e.jsx("span",{className:a.is_travel?"rounded-full border border-border bg-status-warning-bg px-2 py-1 text-[11px] font-semibold text-foreground":"rounded-full border border-border bg-tag-swim-bg/10 px-2 py-1 text-[11px] font-semibold text-foreground",children:a.is_travel?"Trajet":"Travail"}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsxs("div",{className:"flex flex-wrap items-baseline justify-between gap-2",children:[e.jsxs("div",{className:"text-sm font-black text-foreground",children:[ae(a.start_time)," → ",a.end_time?ae(a.end_time):"En cours",c!==null?e.jsxs("span",{className:"ml-1 text-xs font-semibold text-muted-foreground",children:["(",y(c),")"]}):null]}),e.jsxs("div",{className:"flex flex-wrap justify-end gap-2",children:[e.jsx("button",{type:"button",className:"rounded-lg border border-border bg-card px-3 py-2.5 text-xs font-bold text-foreground cursor-pointer min-h-[44px] min-w-[44px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",onClick:()=>s(a),"aria-label":`Modifier le shift ${ae(a.start_time)}`,children:"Modifier"}),e.jsx("button",{type:"button",className:"rounded-lg border border-border bg-card px-3 py-2.5 text-xs font-bold text-foreground cursor-pointer min-h-[44px] min-w-[44px] focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",onClick:()=>n(a.id),"aria-label":`Supprimer le shift ${ae(a.start_time)}`,children:"Suppr."})]})]}),e.jsx("div",{className:"mt-1 text-sm text-foreground",children:a.location||"Lieu non précisé"}),b?e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:"En cours"}):null]})]},a.id)})})]},o.date))})}const Qe="hsl(var(--primary))",We="hsl(var(--chart-2))",je={"7d":"7 jours",month:"Ce mois",prevMonth:"Mois préc.",custom:"Dates"},Ue=r=>{if(!r)return"";if(/^\d{2}:\d{2}(:\d{2})?$/.test(r))return r.slice(0,5);const s=new Date(r);return Number.isNaN(s.getTime())?"":N(s,"HH:mm")},q=r=>r.shift_date,Xe=(r,s,n)=>{const o=new Date(r).getTime(),a=new Date(s).getTime(),c=new Date(n).getTime();return o>=Math.min(a,c)&&o<=Math.max(a,c)},Je=r=>r.find(s=>s.name==="Piscine")?.name??r[0]?.name??"Piscine",os=(r,s=new Date)=>{switch(r){case"7d":return[N(Ht(s,6),"yyyy-MM-dd"),N(s,"yyyy-MM-dd")];case"month":return[N(oe(s),"yyyy-MM-dd"),N(s,"yyyy-MM-dd")];case"prevMonth":{const n=Jt(s);return[N(oe(n),"yyyy-MM-dd"),N(Xt(n),"yyyy-MM-dd")]}default:return[N(oe(s),"yyyy-MM-dd"),N(s,"yyyy-MM-dd")]}},Ze={visible:{transition:{staggerChildren:.06}}},E={hidden:{opacity:0,y:14},visible:{opacity:1,y:0,transition:{duration:.28,ease:"easeOut"}}};function Cs({initialTab:r="POINTAGE"}){const{useMemo:s,useState:n}=gt,{toast:o}=jt(),a=bt(),c=typeof window>"u"?re.getState().role:re(t=>t.role),b=typeof window>"u"?re.getState().userId:re(t=>t.userId),S=c==="coach"||c==="admin",[m,g]=n(r),[M,C]=n(()=>N(new Date,"yyyy-MM-dd")),[w,T]=n(""),[f,u]=n(""),[h,x]=n("Piscine"),[D,R]=n(!1),[V,L]=n(!0),[F,H]=n(null),[v,tt]=n(!1),[le,Me]=n(""),[Te,st]=n("month"),[K,ke]=n(()=>N(oe(new Date),"yyyy-MM-dd")),[G,Se]=n(()=>N(new Date,"yyyy-MM-dd")),{data:_=[],error:De}=be({queryKey:["timesheet-shifts",b],queryFn:()=>P.listTimesheetShifts({coachId:b??void 0}),enabled:S}),{data:$=[],error:Ce}=be({queryKey:["timesheet-locations"],queryFn:()=>P.listTimesheetLocations(),enabled:S}),{data:_e,error:Ae}=be({queryKey:["capabilities","timesheet"],queryFn:()=>P.getCapabilities(),enabled:wt.hasSupabase}),J=s(()=>Je($),[$]),de=ge.useCallback(()=>{C(N(new Date,"yyyy-MM-dd")),T(""),u(""),x(J),R(!1)},[J]),Le=W({mutationFn:t=>P.createTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]}),de(),o({title:"Shift enregistré"})},onError:t=>{o({title:"Erreur",description:O(t,"Impossible d'enregistrer le shift.").message})}}),Ee=W({mutationFn:t=>P.updateTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]}),L(!1),H(null),de(),o({title:"Shift mis à jour"})},onError:t=>{o({title:"Erreur",description:O(t,"Impossible de modifier le shift.").message})}}),rt=W({mutationFn:t=>P.deleteTimesheetShift(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-shifts"]})},onError:t=>{o({title:"Erreur",description:O(t,"Impossible de supprimer le shift.").message})}}),ce=W({mutationFn:t=>P.createTimesheetLocation(t),onSuccess:()=>{a.invalidateQueries({queryKey:["timesheet-locations"]})},onError:t=>{o({title:"Erreur",description:O(t,"Impossible d'ajouter le lieu.").message})}}),ue=W({mutationFn:t=>P.deleteTimesheetLocation(t),onSuccess:(t,l)=>{a.invalidateQueries({queryKey:["timesheet-locations"]});const i=$.filter(d=>d.id!==l.id);h&&i.every(d=>d.name!==h)&&x(Je(i))},onError:t=>{o({title:"Erreur",description:O(t,"Impossible de supprimer le lieu.").message})}}),Z=N(new Date,"yyyy-MM-dd"),at=s(()=>_.reduce((t,l)=>{if(q(l)!==Z)return t;const i=B(l);return i?t+i:t},0),[_,Z]),me=s(()=>_.filter(t=>q(t)===Z&&!t.end_time).length,[_,Z]),Y=s(()=>Lt(_),[_]),nt=s(()=>{const t=[..._].sort((i,d)=>i.start_time<d.start_time?1:-1),l=new Map;return t.forEach(i=>{const d=q(i);l.has(d)||l.set(d,[]),l.get(d)?.push(i)}),Array.from(l.entries()).map(([i,d])=>{const k=d.reduce((te,fe)=>{const he=B(fe);return he?te+he:te},0);return{date:i,shifts:d,totalMinutes:k}}).sort((i,d)=>i.date<d.date?1:-1)},[_]),I=s(()=>_.filter(t=>Xe(q(t),K,G)),[_,K,G]),j=s(()=>I.reduce((t,l)=>{const i=B(l)??0;return l.is_travel?t.travel+=i:t.work+=i,t.total+=i,t},{count:I.length,work:0,travel:0,total:0}),[I]),xe=s(()=>new Set(I.map(t=>q(t))).size,[I]),ot=xe>0?j.total/xe:0,z=s(()=>{const t=new Date(K),i=new Date(G).getTime()-t.getTime(),d=new Date(t.getTime()-864e5),k=new Date(d.getTime()-i),te=N(k,"yyyy-MM-dd"),fe=N(d,"yyyy-MM-dd"),se=_.filter(pe=>Xe(q(pe),te,fe)).reduce((pe,pt)=>pe+(B(pt)??0),0),ze=j.total-se,ht=se>0?Math.round(ze/se*100):0;return{prevTotal:se,delta:ze,percent:ht}},[K,G,j.total,_]),Fe=z.prevTotal>0&&z.delta!==0,ee=s(()=>[{name:"Travail",value:j.work,fill:Qe},{name:"Trajet",value:j.travel,fill:We}].filter(t=>t.value>0),[j]),Ie=s(()=>{const t=new Map;return I.forEach(l=>{const i=q(l),d=B(l)??0,k=t.get(i)??{work:0,travel:0};l.is_travel?k.travel+=d:k.work+=d,t.set(i,k)}),Array.from(t.entries()).map(([l,{work:i,travel:d}])=>({date:l,label:N(new Date(l),"dd/MM"),work:Number((i/60).toFixed(2)),travel:Number((d/60).toFixed(2))})).sort((l,i)=>l.date<i.date?-1:1)},[I]),Re=s(()=>{const t=new Map;I.forEach(d=>{const k=d.location||"Non précisé";t.set(k,(t.get(k)??0)+(B(d)??0))});const l=Array.from(t.entries()).map(([d,k])=>({name:d,minutes:k})).sort((d,k)=>k.minutes-d.minutes),i=l[0]?.minutes??0;return l.map(d=>({...d,percent:i>0?d.minutes/i*100:0}))},[I]),$e=s(()=>new Intl.DateTimeFormat("fr-FR",{weekday:"short",day:"numeric",month:"short"}),[]),it=s(()=>{if(!w||!f)return null;const t=new Date(`${M}T${w}`),l=new Date(`${M}T${f}`);if(Number.isNaN(t.getTime())||Number.isNaN(l.getTime()))return null;const i=(l.getTime()-t.getTime())/6e4;return i>0?y(i):null},[M,w,f]),lt=Le.isPending||Ee.isPending,Pe=ce.isPending||ue.isPending,dt=t=>{if(st(t),t!=="custom"){const[l,i]=os(t);ke(l),Se(i)}},ct=t=>{if(t.preventDefault(),!M||!w){o({title:"Champs requis",description:"Date et heure de début obligatoires."});return}if(f&&f<=w){o({title:"Heures invalides",description:"La fin doit être après le début."});return}if(!b){o({title:"Utilisateur manquant"});return}F?Ee.mutate({id:F,coach_id:b,shift_date:M,start_time:w,end_time:f||null,location:h.trim()||null,is_travel:D}):Le.mutate({coach_id:b,shift_date:M,start_time:w,end_time:f||null,location:h.trim()||null,is_travel:D})},ut=()=>{de(),H(null),L(!0)},mt=t=>{H(t.id),C(q(t)),T(Ue(t.start_time)),u(t.end_time?Ue(t.end_time):""),x(t.location??""),R(t.is_travel),L(!0)},xt=()=>{L(!1),H(null)},ft=()=>{const t=le.trim();t&&(ce.mutate({name:t}),Me(""))};if(ge.useEffect(()=>{m==="DASHBOARD"&&(L(!1),H(null))},[m]),ge.useEffect(()=>{!V||F||(!h||$.every(t=>t.name!==h))&&x(J)},[J,F,V,h,$]),!S)return typeof window>"u"?null:e.jsx(yt,{to:"/"});const Oe=Ae?O(Ae,"Impossible de vérifier le module de pointage.").message:_e?.mode==="supabase"&&!_e.timesheet.available?"Pointage heures indisponible (tables manquantes côté D1).":null,qe=De?O(De,"Impossible de charger les shifts.").message:null,Ve=Ce?O(Ce,"Impossible de charger les lieux.").message:null;return e.jsxs(Zt,{top:!0,bottom:!0,className:"min-h-screen bg-background",children:[e.jsxs("div",{className:"mx-auto flex w-full max-w-3xl flex-col gap-4 px-4 pt-4 text-foreground",children:[e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic",children:"Administratif"}),e.jsxs("div",{className:"flex items-center gap-1 rounded-full border border-border bg-card p-1 text-xs font-extrabold",children:[e.jsx("button",{type:"button",className:`rounded-full px-3 py-2 transition-colors ${m==="POINTAGE"?"bg-primary text-primary-foreground":"text-foreground"}`,"aria-current":m==="POINTAGE"?"page":void 0,onClick:()=>g("POINTAGE"),children:"Pointage"}),e.jsx("button",{type:"button",className:`rounded-full px-3 py-2 transition-colors ${m==="DASHBOARD"?"bg-primary text-primary-foreground":"text-foreground"}`,"aria-current":m==="DASHBOARD"?"page":void 0,onClick:()=>g("DASHBOARD"),children:"Dashboard"})]})]}),Oe?e.jsx("div",{className:"rounded-xl border border-dashed border-border bg-card px-4 py-3 text-sm text-muted-foreground",children:Oe}):null,qe?e.jsx("div",{className:"rounded-xl border border-destructive/20 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:qe}):null,Ve?e.jsx("div",{className:"rounded-xl border border-destructive/20 bg-destructive/10 px-4 py-3 text-sm text-destructive",children:Ve}):null,m==="POINTAGE"?e.jsxs(A.div,{initial:"hidden",animate:"visible",variants:Ze,className:"flex flex-col gap-4",children:[e.jsxs(A.div,{variants:E,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 text-[11px] text-muted-foreground",children:[e.jsx(Et,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:"Heures aujourd'hui"})]}),e.jsx("div",{className:"mt-1 text-3xl font-bold tabular-nums text-foreground",children:y(at)}),me>0?e.jsxs("div",{className:"mt-1.5 flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx("span",{className:"inline-block h-1.5 w-1.5 rounded-full bg-primary animate-pulse motion-reduce:animate-none"}),me," shift",me>1?"s":""," en cours"]}):null]}),e.jsxs(A.div,{variants:E,className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Semaine"}),e.jsx("div",{className:"text-lg font-bold tabular-nums",children:y(Y.week.totalMinutes)}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[y(Y.week.workMinutes)," trav. · ",y(Y.week.travelMinutes)," trajet"]})]}),e.jsxs("div",{className:"rounded-xl border bg-muted/30 p-3",children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Mois"}),e.jsx("div",{className:"text-lg font-bold tabular-nums",children:y(Y.month.totalMinutes)}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:[y(Y.month.workMinutes)," trav. · ",y(Y.month.travelMinutes)," trajet"]})]})]}),e.jsxs(A.div,{variants:E,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm font-bold text-foreground",children:[e.jsx(Ke,{className:"h-3.5 w-3.5 text-muted-foreground"}),"Lieux"]}),e.jsx(U,{type:"button",variant:"outline",size:"sm",className:"h-8 text-xs",onClick:()=>tt(t=>!t),children:"Gérer"})]}),v?e.jsxs("div",{className:"mt-3 space-y-3 text-sm text-muted-foreground",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:$.length?$.map(t=>e.jsxs("div",{className:"flex items-center gap-2 rounded-full border border-border bg-muted/30 px-3 py-1 text-xs font-semibold text-foreground",children:[e.jsx("span",{children:t.name}),e.jsx("button",{type:"button",className:"text-muted-foreground transition hover:text-foreground",onClick:()=>ue.mutate({id:t.id}),"aria-label":`Supprimer ${t.name}`,disabled:Pe,children:"✕"})]},t.id)):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Aucun lieu enregistré."})}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(ne,{value:le,onChange:t=>Me(t.target.value),placeholder:"Nouveau lieu",className:"min-w-[160px] flex-1 h-9"}),e.jsx(U,{type:"button",size:"sm",className:"h-9",onClick:ft,disabled:!le.trim()||Pe,children:"Ajouter"})]})]}):null]}),e.jsx(A.div,{variants:E,children:e.jsx(ns,{groups:nt,onEdit:mt,onDelete:t=>rt.mutate({id:t})})}),e.jsx("button",{type:"button",className:"fixed bottom-4 right-4 z-fab flex h-14 w-14 items-center justify-center rounded-full bg-destructive text-2xl font-black text-white shadow-[0_8px_20px_rgba(220,38,38,0.25)]",onClick:ut,"aria-label":"Ajouter un shift",children:"+"})]},"pointage"):null,m==="DASHBOARD"?e.jsxs(A.div,{initial:"hidden",animate:"visible",variants:Ze,className:"flex flex-col gap-4",children:[e.jsxs(A.div,{variants:E,className:"rounded-xl border bg-card p-4",children:[e.jsx("h2",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Période"}),e.jsx(Mt,{type:"single",size:"sm",variant:"outline",value:Te,onValueChange:t=>{t&&dt(t)},className:"flex flex-wrap gap-1",children:Object.keys(je).map(t=>e.jsx(Tt,{value:t,className:"h-8 px-3 text-xs","aria-label":je[t],children:je[t]},t))}),Te==="custom"?e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsxs("div",{className:"min-w-[140px] flex-1 space-y-1",children:[e.jsx(X,{htmlFor:"db-from",className:"text-[11px]",children:"Du"}),e.jsx(ne,{id:"db-from",type:"date",value:K,onChange:t=>ke(t.target.value),className:"h-9 text-sm"})]}),e.jsxs("div",{className:"min-w-[140px] flex-1 space-y-1",children:[e.jsx(X,{htmlFor:"db-to",className:"text-[11px]",children:"Au"}),e.jsx(ne,{id:"db-to",type:"date",value:G,onChange:t=>Se(t.target.value),className:"h-9 text-sm"})]})]}):e.jsxs("div",{className:"mt-2 text-[11px] text-muted-foreground",children:[$e.format(new Date(K))," → ",$e.format(new Date(G))]})]}),e.jsxs(A.div,{variants:E,className:"rounded-xl border bg-card p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Total période"}),e.jsx("div",{className:"text-4xl font-bold tabular-nums",children:y(j.total)})]}),Fe?e.jsxs("div",{className:`flex items-center gap-1 rounded-full px-2.5 py-1 text-xs font-bold ${z.delta>0?"bg-primary/10 text-primary":"bg-muted text-muted-foreground"}`,children:[z.delta>0?e.jsx(Nt,{className:"h-3 w-3"}):e.jsx(Ft,{className:"h-3 w-3"}),z.delta>0?"+":"",z.percent,"%"]}):null]}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[j.count," shift",j.count!==1?"s":"",xe>0?` · Moy. ${y(ot)}/jour`:"",Fe?` · vs ${y(z.prevTotal)} période préc.`:""]})]}),e.jsxs(A.div,{variants:E,className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[e.jsx(Gt,{className:"h-3.5 w-3.5 text-primary"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Travail"})]}),e.jsx("div",{className:"text-xl font-bold tabular-nums",children:y(j.work)}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:j.total>0?`${Math.round(j.work/j.total*100)}%`:"–"})]}),e.jsxs("div",{className:"rounded-xl border p-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 mb-1",children:[e.jsx(Qt,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"Trajet"})]}),e.jsx("div",{className:"text-xl font-bold tabular-nums",children:y(j.travel)}),e.jsx("div",{className:"text-[11px] text-muted-foreground",children:j.total>0?`${Math.round(j.travel/j.total*100)}%`:"–"})]})]}),ee.length>0?e.jsxs(A.div,{variants:E,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Répartition"}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"relative shrink-0",children:[e.jsx(It,{width:140,height:140,children:e.jsx(Rt,{data:ee,cx:70,cy:70,innerRadius:42,outerRadius:65,paddingAngle:3,dataKey:"value",strokeWidth:0,children:ee.map(t=>e.jsx(Pt,{fill:t.fill},t.name))})}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("span",{className:"text-sm font-bold tabular-nums",children:y(j.total)})})]}),e.jsx("div",{className:"flex-1 space-y-3",children:ee.map(t=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"h-3 w-3 rounded-sm shrink-0",style:{backgroundColor:t.fill}}),e.jsx("span",{className:"text-sm text-foreground",children:t.name}),e.jsx("span",{className:"ml-auto text-sm font-semibold tabular-nums",children:y(t.value)})]},t.name))})]})]}):null,e.jsxs(A.div,{variants:E,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Heures par jour"}),Ie.length>0?e.jsx("div",{className:"h-52 w-full",children:e.jsx(Ot,{width:"100%",height:"100%",children:e.jsxs($t,{data:Ie,margin:{top:4,right:8,left:-16,bottom:4},children:[e.jsx(Bt,{strokeDasharray:"3 3",vertical:!1,stroke:"hsl(var(--border))"}),e.jsx(qt,{dataKey:"label",tickLine:!1,axisLine:!1,tick:{fontSize:11}}),e.jsx(Vt,{tickLine:!1,axisLine:!1,tick:{fontSize:11},tickFormatter:t=>`${t}h`}),e.jsx(zt,{formatter:(t,l)=>[`${t.toFixed(1)}h`,l==="work"?"Travail":"Trajet"],labelFormatter:t=>`${t}`,contentStyle:{borderRadius:8,border:"1px solid hsl(var(--border))",fontSize:12}}),e.jsx(He,{dataKey:"work",name:"Travail",stackId:"hours",fill:Qe}),e.jsx(He,{dataKey:"travel",name:"Trajet",stackId:"hours",fill:We,radius:[4,4,0,0]})]})})}):e.jsx("p",{className:"py-6 text-center text-sm text-muted-foreground",children:"Aucune donnée sur la période."})]}),Re.length>0?e.jsxs(A.div,{variants:E,className:"rounded-xl border bg-card p-4",children:[e.jsx("h3",{className:"text-xs font-semibold uppercase tracking-[0.15em] text-muted-foreground mb-3",children:"Top lieux"}),e.jsx("div",{className:"space-y-3",children:Re.map(t=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-sm",children:[e.jsx(Ke,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{children:t.name})]}),e.jsx("span",{className:"text-sm font-semibold tabular-nums",children:y(t.minutes)})]}),e.jsx("div",{className:"h-2 w-full rounded-full bg-muted",children:e.jsx("div",{className:"h-2 rounded-full bg-primary transition-all duration-500",style:{width:`${t.percent}%`}})})]},t.name))})]}):null]},"dashboard"):null]}),m==="POINTAGE"?e.jsx(rs,{isOpen:V,isEditing:!!F,isSaving:lt,date:M,startTime:w,endTime:f,location:h,isTravel:D,durationLabel:it,locations:$,onClose:xt,onSubmit:ct,onDateChange:C,onStartTimeChange:T,onEndTimeChange:u,onLocationChange:x,onTravelChange:R,onCreateLocation:t=>ce.mutate({name:t}),onDeleteLocation:t=>ue.mutate({id:t})}):null]})}export{Cs as default};
