import{r as d,j as e}from"./vendor-ui-C9ymspZo.js";import{b as ae,u as ne,c as p}from"./vendor-query-kM2vrB_e.js";import{u as ce,i as oe,g as l,m as le,B as h,k as D,C as w,b as F,c as E,d as k,f as I,I as f,S as de}from"./index-w265yi4m.js";import{S as ue}from"./switch-CLrVPYjB.js";import{B as Q}from"./badge-BCwtPf2O.js";import{T as H,a as O,b as R,c as n,d as G,e as c}from"./table-TvGfaJBF.js";import{S as J,a as X,b as W,c as Y,d as Z}from"./select-CcqmeYi9.js";import{E as me}from"./eye-3cFBf2Ww.js";import{R as xe}from"./refresh-cw-D8YVP4A7.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-BKveoXUP.js";import"./check-D5KUPjqF.js";const ee=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],pe=i=>i==="user"?"Compte":"Ancien",he=i=>{if(!i)return"-";const t=new Date(i);return Number.isNaN(t.getTime())?i:t.toLocaleDateString("fr-FR")+" "+t.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},je=i=>{if(!i)return"Jamais";const t=new Date(i);return Number.isNaN(t.getTime())?i:t.toLocaleDateString("fr-FR")},ge=(i,t=30)=>{if(!i)return!0;const j=new Date(i);return Number.isNaN(j.getTime())?!0:Date.now()-j.getTime()>t*24*60*60*1e3},fe=i=>{switch(i){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},ve=i=>{switch(i){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return i}};function Le(){const i=ce(s=>s.role),{toast:t}=oe(),j=ae(),[u,v]=d.useState({display_name:"",iuf:"",sex:""}),[g,P]=d.useState([]),[_,M]=d.useState(!1),[b,z]=d.useState(null),[q,se]=d.useState(!1),[m,y]=d.useState(null),N=i==="coach"||i==="admin",$=i==="admin",{data:B=[],refetch:S}=ne({queryKey:["import-logs"],queryFn:()=>l.getImportLogs({limit:20}),enabled:N}),x=d.useCallback(async()=>{if(N){M(!0),z(null);try{await l.syncClubRecordSwimmersFromUsers();const s=await l.getClubRecordSwimmers();P(s)}catch(s){const r=le(s,"Impossible de charger la liste.");z(r.message),P([])}finally{M(!1)}}},[N]);d.useEffect(()=>{x()},[x]),d.useEffect(()=>{$&&l.getAppSettings("import_rate_limits").then(s=>{s&&y(s)})},[$]);const U=p({mutationFn:()=>l.createClubRecordSwimmer({display_name:u.display_name.trim(),iuf:u.iuf.trim()||null,sex:u.sex?u.sex:null,is_active:!0}),onSuccess:()=>{t({title:"Nageur ajouté"}),v({display_name:"",iuf:"",sex:""}),x()},onError:()=>{t({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),re=p({mutationFn:({id:s,payload:r})=>l.updateClubRecordSwimmer(s,r),onSuccess:()=>{x(),t({title:"Sauvegardé"})},onError:()=>{t({title:"Mise à jour impossible",variant:"destructive"})}}),te=p({mutationFn:({userId:s,payload:r})=>l.updateClubRecordSwimmerForUser(s,r),onSuccess:()=>{x(),t({title:"Sauvegardé"})},onError:()=>{t({title:"Mise à jour impossible",variant:"destructive"})}}),A=(s,r)=>{if(s.source_type==="user"&&s.user_id){te.mutate({userId:s.user_id,payload:r});return}s.id&&re.mutate({id:s.id,payload:r})},L=p({mutationFn:()=>l.importClubRecords(),onSuccess:s=>{const r=s?.summary??s,o=s?.recalc_stats;let a=r?`Performances importées: ${r.imported??0}. Erreurs: ${r.errors??0}.`:"";o&&(a+=` Records: ${o.club_records_upserted} (${o.processed} perfs traitées).`,o.skipped_no_age&&(a+=` Ignorées (pas d'âge): ${o.skipped_no_age}.`)),t({title:"Import terminé",description:a}),x(),S(),j.invalidateQueries({queryKey:["club-records"]})},onError:s=>{const r=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:"Import impossible";t({title:r,variant:"destructive"}),S()}}),K=p({mutationFn:({iuf:s,name:r})=>l.importSingleSwimmer(s,r),onSuccess:(s,r)=>{t({title:`Import de ${r.name??r.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),S(),l.recalculateClubRecords().then(()=>{j.invalidateQueries({queryKey:["club-records"]})}),x()},onError:(s,r)=>{const o=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:`Erreur import ${r.name??r.iuf}`;t({title:o,variant:"destructive"}),S()}}),V=p({mutationFn:s=>l.updateAppSettings("import_rate_limits",s),onSuccess:()=>{t({title:"Limites sauvegardées"})},onError:()=>{t({title:"Erreur de sauvegarde",variant:"destructive"})}}),ie=d.useMemo(()=>[...g].sort((s,r)=>s.source_type!==r.source_type?s.source_type.localeCompare(r.source_type):s.display_name.localeCompare(r.display_name)),[g]),C=d.useMemo(()=>g.filter(s=>s.is_active&&(!s.iuf||!s.sex)).length,[g]),T=p({mutationFn:()=>l.recalculateClubRecords(),onSuccess:s=>{const r=s?.recalc_stats,o=r?`${r.swimmers_with_sex} nageur(s), ${r.total_performances} perfs, ${r.processed} traitées, ${r.club_records_upserted} records.${r.skipped_no_swimmer?` Ignorées (pas de nageur): ${r.skipped_no_swimmer}.`:""}${r.skipped_no_event_code?` Ignorées (épreuve inconnue): ${r.skipped_no_event_code}.`:""}${r.skipped_no_age?` Ignorées (pas d'âge): ${r.skipped_no_age}.`:""}${r.unmapped_event_codes?.length?` Épreuves inconnues: ${r.unmapped_event_codes.join(", ")}`:""}`:"";t({title:"Records recalculés",description:o}),j.invalidateQueries({queryKey:["club-records"]})},onError:()=>{t({title:"Erreur de recalcul",variant:"destructive"})}});return N?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gérez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>{window.location.hash="#/records-club"},children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),"Voir les records"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>T.mutate(),disabled:T.isPending,children:[e.jsx(xe,{className:D("h-4 w-4 mr-1",T.isPending&&"animate-spin")}),"Recalculer"]}),e.jsx(h,{onClick:()=>L.mutate(),disabled:L.isPending,children:L.isPending?"Import en cours...":"Mettre à jour les records"})]})]}),e.jsxs(w,{children:[e.jsxs(F,{children:[e.jsx(E,{children:"Ajouter un ancien nageur"}),e.jsx(k,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(I,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_auto]",children:[e.jsx(f,{placeholder:"Nom du nageur",value:u.display_name,onChange:s=>v(r=>({...r,display_name:s.target.value}))}),e.jsx(f,{placeholder:"IUF",value:u.iuf,onChange:s=>v(r=>({...r,iuf:s.target.value}))}),e.jsxs(J,{value:u.sex,onValueChange:s=>v(r=>({...r,sex:s})),children:[e.jsx(X,{children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Y,{children:ee.map(s=>e.jsx(Z,{value:s.value,children:s.label},s.value))})]}),e.jsx(h,{onClick:()=>U.mutate(),disabled:!u.display_name.trim()||U.isPending,children:"Ajouter"})]})]}),e.jsxs(w,{children:[e.jsxs(F,{children:[e.jsx(E,{children:"Liste des nageurs suivis"}),e.jsx(k,{children:"Mettre à jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(I,{children:[!_&&C>0&&e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-300 bg-amber-50 p-3 text-sm text-amber-800 dark:border-amber-700 dark:bg-amber-950/30 dark:text-amber-300",children:[e.jsxs("strong",{children:[C," nageur",C>1?"s":""," incomplet",C>1?"s":""]})," ","— les champs IUF et Sexe sont requis pour le calcul des records."]}),_&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s))}),b&&e.jsx("p",{className:"text-sm text-destructive",children:b}),!_&&!b&&g.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!_&&!b&&g.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(R,{children:[e.jsx(n,{children:"Nageur"}),e.jsx(n,{children:"Source"}),e.jsx(n,{children:"IUF"}),e.jsx(n,{children:"Sexe"}),e.jsx(n,{children:"Dernière maj"}),e.jsx(n,{children:"Actif"}),e.jsx(n,{children:"Actions"})]})}),e.jsx(G,{children:ie.map(s=>{const r=s.id??`user-${s.user_id??"unknown"}`,o=ge(s.last_imported_at);return e.jsxs(R,{className:o?"bg-amber-50/50 dark:bg-amber-950/10":"",children:[e.jsx(c,{className:"font-medium",children:s.display_name}),e.jsx(c,{children:e.jsx(Q,{variant:s.source_type==="manual"?"secondary":"outline",children:pe(s.source_type)})}),e.jsx(c,{children:e.jsx(f,{defaultValue:s.iuf??"",onBlur:a=>A(s,{iuf:a.target.value.trim()||null}),className:D("w-24",s.is_active&&!s.iuf&&"ring-2 ring-destructive/50")},`${r}-${s.iuf??""}`)}),e.jsx(c,{children:e.jsxs(J,{value:s.sex??"",onValueChange:a=>A(s,{sex:a||null}),children:[e.jsx(X,{className:D("w-28",s.is_active&&!s.sex&&"ring-2 ring-destructive/50"),children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Y,{children:ee.map(a=>e.jsx(Z,{value:a.value,children:a.label},a.value))})]})}),e.jsx(c,{children:e.jsx("span",{className:o?"text-amber-600 dark:text-amber-400 text-xs font-medium":"text-xs text-muted-foreground",children:je(s.last_imported_at)})}),e.jsx(c,{children:e.jsx(ue,{checked:!!s.is_active,onCheckedChange:a=>A(s,{is_active:a})})}),e.jsx(c,{children:s.iuf?e.jsx(h,{size:"sm",variant:"outline",disabled:K.isPending,onClick:()=>K.mutate({iuf:s.iuf,name:s.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},r)})})]})})]})]}),e.jsxs(w,{children:[e.jsxs(F,{children:[e.jsx(E,{children:"Historique des imports"}),e.jsx(k,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(I,{children:B.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectué."}):e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(R,{children:[e.jsx(n,{children:"Nageur"}),e.jsx(n,{children:"Statut"}),e.jsx(n,{children:"Trouvées"}),e.jsx(n,{children:"Importées"}),e.jsx(n,{children:"Date"}),e.jsx(n,{children:"Erreur"})]})}),e.jsx(G,{children:B.map(s=>e.jsxs(R,{children:[e.jsx(c,{className:"font-medium",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(c,{children:e.jsx(Q,{variant:fe(s.status),children:ve(s.status)})}),e.jsx(c,{children:s.performances_found??"-"}),e.jsx(c,{children:s.performances_imported??"-"}),e.jsx(c,{className:"text-xs",children:he(s.started_at)}),e.jsx(c,{className:"max-w-[200px] truncate text-xs text-destructive",children:s.error_message??""})]},s.id))})]})})]}),$&&e.jsxs(w,{children:[e.jsxs(F,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(E,{children:"Paramètres d'import"}),e.jsx(k,{children:"Limites mensuelles d'import par rôle."})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>se(!q),children:e.jsx(de,{className:"h-4 w-4"})})]}),q&&m&&e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Coach (par mois)"}),e.jsx(f,{type:"number",value:m.coach_monthly,onChange:s=>y({...m,coach_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Nageur (par mois)"}),e.jsx(f,{type:"number",value:m.athlete_monthly,onChange:s=>y({...m,athlete_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Admin (par mois, -1=illimité)"}),e.jsx(f,{type:"number",value:m.admin_monthly,onChange:s=>y({...m,admin_monthly:Number(s.target.value)}),min:-1})]})]}),e.jsx(h,{size:"sm",onClick:()=>V.mutate(m),disabled:V.isPending,children:"Enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Accès réservé aux coachs."})]})}export{Le as default};
