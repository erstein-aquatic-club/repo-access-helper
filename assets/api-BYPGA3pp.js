import{K as ie,s as o,u as ae}from"./index-4NxNgYqB.js";const oe=()=>typeof navigator>"u"?!0:navigator.onLine,m=()=>ie.hasSupabase&&oe(),d={SESSIONS:"suivi_natation_sessions",EXERCISES:"suivi_natation_exercises",STRENGTH_SESSIONS:"suivi_natation_strength_sessions",SWIM_SESSIONS:"suivi_natation_swim_sessions",ASSIGNMENTS:"suivi_natation_assignments",STRENGTH_RUNS:"suivi_natation_strength_runs",NOTIFICATIONS:"suivi_natation_notifications",ONE_RM:"suivi_natation_1rm",SWIM_RECORDS:"suivi_natation_swim_records",TIMESHEET_SHIFTS:"suivi_natation_timesheet_shifts",TIMESHEET_LOCATIONS:"suivi_natation_timesheet_locations"},v=(e,t=0)=>{const r=Number(e);return Number.isFinite(r)?Math.round(r):t},p=e=>{const t=Number(e);return Number.isFinite(t)?Math.round(t):null},F=e=>{const t=Number(e);return Number.isFinite(t)?t:null},C=e=>{if(e==null)return null;const t=Number(e);return Number.isFinite(t)?t<=5?Math.max(1,Math.round(t)):Math.min(5,Math.max(1,Math.round(t/2))):null},G=e=>{if(e==null)return null;const t=Number(e);return Number.isFinite(t)?t<=5?Math.round(t*2):Math.round(t):null},J=(e,t)=>!Number.isFinite(e)||!Number.isFinite(t)||(e??0)<=0||(t??0)<=0?null:Math.round(t===1?e:e*(1+t/30)),B=new Set,ce=e=>{if(e instanceof Error){const t=e;return{message:t.message||"Erreur inconnue",code:t.code,status:t.status}}return{message:String(e||"Erreur inconnue")}},er=(e,t)=>{const r=ce(e),s=r.status,n=r.code;let i=r.message||t;n==="unknown_action"?i="Action inconnue côté serveur.":n==="table_missing"?i="Base de données non initialisée (table manquante).":s===401?i="Authentification expirée ou manquante.":s===403&&(i="Accès refusé pour ce rôle.");const a=`${n??"none"}:${s??"none"}:${i}`;return B.has(a)||(console.error("[api] error:",r),B.add(a)),{...r,message:i}},P=e=>{const t=String(e??"").trim().toLowerCase();return t==="hypertrophie"||t==="force"||t==="endurance"?t:"endurance"},ue=e=>e==="strength"||e==="warmup",L=e=>ue(e)?e:"strength",Y=(e,t,r)=>({exercise_id:v(e.exercise_id),order_index:p(e.ordre??e.order_index)??t,sets:p(e.sets)??0,reps:p(e.reps)??0,rest_seconds:p(e.rest_series_s??e.rest_seconds)??0,percent_1rm:p(e.pct_1rm??e.percent_1rm)??0,cycle_type:P(e.cycle_type??r),notes:e.notes??"",exercise_name:e.exercise_name??e.nom_exercice,category:e.category??e.exercise_type}),de=e=>{for(let t=0;t<e.length;t+=1){const r=e[t];if(!Number.isFinite(r.sets)||r.sets<0)throw new Error(`Séries invalides pour l'exercice #${t+1}`);if(!Number.isFinite(r.reps)||r.reps<0)throw new Error(`Reps invalides pour l'exercice #${t+1}`);if(!Number.isFinite(r.rest_seconds)||r.rest_seconds<0)throw new Error(`Repos invalide pour l'exercice #${t+1}`)}},_e=e=>({id:v(e.id),numero_exercice:p(e.numero_exercice),nom_exercice:e.nom_exercice??"",description:e.description??null,illustration_gif:e.illustration_gif??null,exercise_type:L(e.exercise_type),warmup_reps:null,warmup_duration:null,Nb_series_endurance:p(e.nb_series_endurance),Nb_reps_endurance:p(e.nb_reps_endurance),pct_1rm_endurance:F(e.pourcentage_charge_1rm_endurance),recup_endurance:p(e.recup_series_endurance),recup_exercices_endurance:p(e.recup_exercices_endurance),Nb_series_hypertrophie:p(e.nb_series_hypertrophie),Nb_reps_hypertrophie:p(e.nb_reps_hypertrophie),pct_1rm_hypertrophie:F(e.pourcentage_charge_1rm_hypertrophie),recup_hypertrophie:p(e.recup_series_hypertrophie),recup_exercices_hypertrophie:p(e.recup_exercices_hypertrophie),Nb_series_force:p(e.nb_series_force),Nb_reps_force:p(e.nb_reps_force),pct_1rm_force:F(e.pourcentage_charge_1rm_force),recup_force:p(e.recup_series_force),recup_exercices_force:p(e.recup_exercices_force),folder_id:p(e.folder_id)}),K=e=>({numero_exercice:e.numero_exercice??null,nom_exercice:e.nom_exercice??e.name??"",description:e.description??null,illustration_gif:e.illustration_gif??null,exercise_type:e.exercise_type??"strength",nb_series_endurance:e.Nb_series_endurance??null,nb_reps_endurance:e.Nb_reps_endurance??null,pourcentage_charge_1rm_endurance:e.pct_1rm_endurance??null,recup_series_endurance:e.recup_endurance??null,recup_exercices_endurance:e.recup_exercices_endurance??null,nb_series_hypertrophie:e.Nb_series_hypertrophie??null,nb_reps_hypertrophie:e.Nb_reps_hypertrophie??null,pourcentage_charge_1rm_hypertrophie:e.pct_1rm_hypertrophie??null,recup_series_hypertrophie:e.recup_hypertrophie??null,recup_exercices_hypertrophie:e.recup_exercices_hypertrophie??null,nb_series_force:e.Nb_series_force??null,nb_reps_force:e.Nb_reps_force??null,pourcentage_charge_1rm_force:e.pct_1rm_force??null,recup_series_force:e.recup_force??null,recup_exercices_force:e.recup_exercices_force??null,folder_id:e.folder_id??null}),q=e=>new Promise(t=>setTimeout(t,e)),z=e=>{if(!e)return null;if(typeof e=="string")try{return JSON.parse(e)}catch{return null}return typeof e=="object"?e:null},le=async e=>{if(!e||!m())return[];const{data:t,error:r}=await o.from("group_members").select("group_id").eq("user_id",e);return r||!t?[]:t.map(s=>s.group_id).filter(s=>s>0)},me=e=>{const t=[],r=new Set;let s=!1;for(const n of e){const i=n.groups;i.is_temporary?i.is_active&&(s=!0,r.add(n.group_id),i.parent_group_id&&r.add(i.parent_group_id)):t.push(n.group_id)}return{permanentGroupIds:t,temporaryGroupIds:Array.from(r),hasActiveTemporary:s}},V=async e=>{const t={permanentGroupIds:[],temporaryGroupIds:[],hasActiveTemporary:!1};if(!e||!m())return t;const{data:r,error:s}=await o.from("group_members").select("group_id, groups!inner(is_temporary, is_active, parent_group_id)").eq("user_id",e);return s||!r?t:me(r)},$=e=>({id:v(e.id),numero_exercice:p(e.numero_exercice??e.numero),nom_exercice:e.nom_exercice??e.name??"",description:e.description??null,illustration_gif:e.illustration_gif??null,exercise_type:L(e.exercise_type??e.type??(e.is_warmup?"warmup":"strength")),warmup_reps:p(e.warmup_reps),warmup_duration:p(e.warmup_duration),Nb_series_endurance:p(e.Nb_series_endurance),Nb_reps_endurance:p(e.Nb_reps_endurance),pct_1rm_endurance:F(e.pct_1rm_endurance),recup_endurance:p(e.recup_endurance),recup_exercices_endurance:p(e.recup_exercices_endurance),Nb_series_hypertrophie:p(e.Nb_series_hypertrophie),Nb_reps_hypertrophie:p(e.Nb_reps_hypertrophie),pct_1rm_hypertrophie:F(e.pct_1rm_hypertrophie),recup_hypertrophie:p(e.recup_hypertrophie),recup_exercices_hypertrophie:p(e.recup_exercices_hypertrophie),Nb_series_force:p(e.Nb_series_force),Nb_reps_force:p(e.Nb_reps_force),pct_1rm_force:F(e.pct_1rm_force),recup_force:p(e.recup_force),recup_exercices_force:p(e.recup_exercices_force)}),fe=e=>{const t={athlete_name:e.athlete_name,session_date:e.date,time_slot:e.slot,distance:e.distance,duration:e.duration,rpe:G(e.effort),performance:G(e.performance??e.feeling),engagement:G(e.engagement??e.feeling),fatigue:G(e.feeling),comments:e.comments};return e.athlete_id!==null&&e.athlete_id!==void 0&&String(e.athlete_id)!==""&&(t.athlete_id=e.athlete_id),e.stroke_distances&&(t.stroke_distances=e.stroke_distances),t},ge=e=>{if(!e)return null;const t=String(e.athlete_name||"").trim(),r=String(e.session_date||e.date||"").trim();if(!t||!r)return null;const s=C(p(e.rpe??e.effort)),n=C(p(e.performance??e.feeling)),i=C(p(e.engagement??e.feeling)),a=C(p(e.fatigue??e.feeling)),c=s??3,u=C(p(e.performance??e.engagement??e.fatigue??e.feeling))??3;return{id:v(e.id,Date.now()),athlete_id:e.athlete_id?v(e.athlete_id):void 0,athlete_name:t,date:r,slot:String(e.time_slot||e.slot||""),effort:c,feeling:u,rpe:s,performance:n,engagement:i,fatigue:a,distance:v(e.distance,0),duration:v(e.duration,0),comments:e.comments||"",stroke_distances:e.stroke_distances??null,created_at:e.created_at||e.updated_at||new Date().toISOString()}},S=e=>{try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch{return null}},N=(e,t)=>{try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.error("[localStorage] Failed to save:",e,r)}};async function pe(e){if(!m())return null;let t=o.from("user_profiles").select("*");e.userId?t=t.eq("user_id",e.userId):e.displayName&&(t=t.eq("display_name",e.displayName));const{data:r,error:s}=await t.maybeSingle();if(s)throw new Error(s.message);return r?{id:r.user_id??null,display_name:r.display_name??null,email:r.email??null,birthdate:r.birthdate??null,group_id:p(r.group_id)??null,group_label:r.group_label??null,objectives:r.objectives??null,bio:r.bio??null,avatar_url:r.avatar_url??null,ffn_iuf:r.ffn_iuf??null}:null}async function he(e){if(!m())return{status:"skipped"};const t=e.userId;if(!t)return{status:"skipped"};const r=e.profile.ffn_iuf?.trim()||null;if(r){const{data:n,error:i}=await o.from("club_record_swimmers").select("id").eq("iuf",r).eq("source_type","manual");if(i)throw new Error(i.message);if(n&&n.length>0){const a=n.map(u=>u.id),{error:c}=await o.from("club_record_swimmers").delete().in("id",a);if(c)throw new Error(c.message)}}const{error:s}=await o.from("user_profiles").upsert({user_id:t,...e.profile},{onConflict:"user_id"});if(s)throw new Error(s.message);return{status:"updated"}}async function we(){if(!m()){const u=new Map,_=(w,I)=>{const T=String(w??"").trim();if(!T)return;const x=I!=null?p(I):null,R=x!==null?`id:${x}`:`name:${T.toLowerCase()}`;u.has(R)||u.set(R,{id:x,display_name:T})};return(S(d.SESSIONS)??[]).forEach(w=>_(w.athlete_name,w.athlete_id)),(S(d.STRENGTH_RUNS)??[]).forEach(w=>_(w.athlete_name,w.athlete_id)),(S(d.ASSIGNMENTS)??[]).forEach(w=>_(w.target_athlete,w.target_user_id)),Array.from(u.values()).sort((w,I)=>w.display_name.localeCompare(I.display_name,"fr"))}const{data:e,error:t}=await o.from("groups").select("id, name");if(t)throw new Error(t.message);const{data:r}=await o.from("user_profiles").select("user_id, ffn_iuf"),s=new Map((r??[]).map(u=>[u.user_id,u]));if(!e?.length){const{data:u,error:_}=await o.from("users").select("id, display_name, email").eq("role","athlete").eq("is_active",!0);if(_)throw new Error(_.message);return(u??[]).map(l=>({id:l.id,display_name:l.display_name,email:l.email??null,ffn_iuf:s.get(l.id)?.ffn_iuf??null})).filter(l=>l.display_name).sort((l,y)=>l.display_name.localeCompare(y.display_name,"fr"))}const{data:n,error:i}=await o.from("group_members").select("user_id, group_id, users!inner(display_name, role, email)").eq("users.role","athlete");if(i)throw new Error(i.message);const a=new Map(e.map(u=>[u.id,u.name])),c=new Map;return(n??[]).forEach(u=>{const _=u.user_id;c.has(_)||c.set(_,{id:_,display_name:u.users?.display_name??"",email:u.users?.email??null,group_id:u.group_id??null,group_label:a.get(u.group_id)??null,ffn_iuf:s.get(_)?.ffn_iuf??null})}),Array.from(c.values()).filter(u=>u.display_name).sort((u,_)=>u.display_name.localeCompare(_.display_name,"fr"))}async function Se(){if(!m())return[];const{data:e,error:t}=await o.from("groups").select("id, name, description, is_temporary, is_active, parent_group_id");if(t)throw new Error(t.message);return(e??[]).filter(r=>r.is_temporary?r.is_active===!0:!0).map(r=>({id:v(r.id,0),name:String(r.name??`Groupe ${r.id??""}`).trim(),member_count:null,is_temporary:r.is_temporary??!1,is_active:r.is_active??!0,parent_group_id:r.parent_group_id??null})).filter(r=>r.id>0&&r.name).sort((r,s)=>r.is_temporary&&!s.is_temporary?-1:!r.is_temporary&&s.is_temporary?1:r.name.localeCompare(s.name,"fr"))}async function ye(e){if(!m())return[];const t=e?.days??30,{data:r,error:s}=await o.rpc("get_upcoming_birthdays",{p_days:t});if(s)throw new Error(s.message);return Array.isArray(r)?r:[]}async function Ee(e){if(!m())return[];let t=o.from("users").select("id, display_name, role, email, is_active");e?.role&&(t=t.eq("role",e.role)),e?.includeInactive||(t=t.eq("is_active",!0));const{data:r,error:s}=await t.order("display_name");if(s)throw new Error(s.message);return(r??[]).map(n=>({id:n.id,display_name:n.display_name??"",role:n.role??"",email:n.email??null,is_active:n.is_active??null,group_label:null}))}async function be(e){if(!m())return{status:"skipped",user:null,initialPassword:null};const{data:t,error:r}=await o.functions.invoke("admin-user",{body:{action:"create_coach",display_name:e.display_name,email:e.email,password:e.password}});if(r)throw new Error(r.message);return{status:"created",user:t?.user??null,initialPassword:t?.initial_password??null}}async function Ie(e){if(!m())return{status:"skipped"};const{error:t}=await o.functions.invoke("admin-user",{body:{action:"update_role",user_id:e.userId,role:e.role}});if(t)throw new Error(t.message);return{status:"updated"}}async function Ne(e){if(!m())return{status:"skipped"};const{error:t}=await o.functions.invoke("admin-user",{body:{action:"disable_user",user_id:e.userId}});if(t)throw new Error(t.message);return{status:"disabled"}}async function ve(){if(!m())return[];const{data:e,error:t}=await o.from("user_profiles").select("user_id, display_name, email, users!user_profiles_user_id_fkey(created_at)").eq("is_approved",!1);if(t)throw new Error(t.message);return(e??[]).map(r=>({user_id:r.user_id,display_name:r.display_name,email:r.email,created_at:r.users?.created_at??new Date().toISOString()}))}async function Te(e){if(!m())return;const{error:t}=await o.from("user_profiles").update({is_approved:!0,approved_at:new Date().toISOString()}).eq("user_id",e);if(t)throw new Error(t.message)}async function xe(e){if(!m())return;const{error:t}=await o.from("users").delete().eq("id",e);if(t)throw new Error(t.message)}async function qe(e){if(!m())return{status:"skipped"};const{data:{user:t}}=await o.auth.getUser();if(!e.userId||e.userId===t?.user_metadata?.app_user_id){const{error:s}=await o.auth.updateUser({password:e.password});if(s)throw new Error(s.message);return{status:"updated"}}const{error:r}=await o.functions.invoke("admin-user",{body:{action:"update_password",user_id:e.userId,password:e.password}});if(r)throw new Error(r.message);return{status:"updated"}}const Q=["Piscine","Compétition"];async function Re(e){if(m()){let r=o.from("timesheet_shifts").select("*").order("shift_date",{ascending:!1});e?.coachId&&(r=r.eq("coach_id",e.coachId)),e?.from&&(r=r.gte("shift_date",e.from)),e?.to&&(r=r.lte("shift_date",e.to));const{data:s,error:n}=await r;if(n)throw new Error(n.message);return s??[]}return await q(200),(S(d.TIMESHEET_SHIFTS)||[]).filter(r=>!(e?.coachId&&r.coach_id!==e.coachId||e?.from&&r.shift_date<e.from||e?.to&&r.shift_date>e.to)).sort((r,s)=>r.shift_date!==s.shift_date?r.shift_date<s.shift_date?1:-1:r.start_time<s.start_time?1:-1)}async function Oe(){if(m()){const{data:s,error:n}=await o.from("timesheet_locations").select("*").order("name");if(n)throw new Error(n.message);return s??[]}await q(120);const e=S(d.TIMESHEET_LOCATIONS);if(Array.isArray(e)&&e.length)return e;const t=new Date().toISOString(),r=Q.map((s,n)=>({id:n+1,name:s,created_at:t,updated_at:t}));return N(d.TIMESHEET_LOCATIONS,r),r}async function Ae(e){if(m()){const{error:u}=await o.from("timesheet_locations").insert({name:e.name.trim()});if(u)throw new Error(u.message);return{status:"created"}}await q(120);const t=e.name.trim();if(!t)throw new Error("Missing location name");const r=S(d.TIMESHEET_LOCATIONS),s=new Date().toISOString(),n=Array.isArray(r)&&r.length?r:Q.map((u,_)=>({id:_+1,name:u,created_at:s,updated_at:s}));if(n.some(u=>u.name.toLowerCase()===t.toLowerCase()))return{status:"exists"};const a=new Date().toISOString(),c={id:Date.now(),name:t,created_at:a,updated_at:a};return N(d.TIMESHEET_LOCATIONS,[...n,c]),{status:"created"}}async function Me(e){if(m()){const{error:s}=await o.from("timesheet_locations").delete().eq("id",e.id);if(s)throw new Error(s.message);return{status:"deleted"}}await q(120);const r=(S(d.TIMESHEET_LOCATIONS)||[]).filter(s=>s.id!==e.id);return N(d.TIMESHEET_LOCATIONS,r),{status:"deleted"}}async function Ce(){if(m()){const{data:e,error:t}=await o.from("users").select("id, display_name").eq("role","coach").eq("is_active",!0);if(t)throw new Error(t.message);return(e??[]).map(r=>({id:r.id,display_name:r.display_name}))}return[]}async function De(e){if(m()){const{error:s}=await o.from("timesheet_shifts").insert({coach_id:e.coach_id,shift_date:e.shift_date,start_time:e.start_time,end_time:e.end_time??null,location:e.location??null,is_travel:e.is_travel});if(s)throw new Error(s.message);return{status:"created"}}await q(200);const t=S(d.TIMESHEET_SHIFTS)||[],r={...e,id:Date.now(),created_at:new Date().toISOString()};return N(d.TIMESHEET_SHIFTS,[...t,r]),{status:"created"}}async function Ge(e){if(m()){const{id:n,...i}=e,{error:a}=await o.from("timesheet_shifts").update(i).eq("id",n);if(a)throw new Error(a.message);return{status:"updated"}}await q(200);const t=S(d.TIMESHEET_SHIFTS)||[],r=t.findIndex(n=>n.id===e.id);if(r===-1)return{status:"missing"};const s=[...t];return s[r]={...s[r],...e,updated_at:new Date().toISOString()},N(d.TIMESHEET_SHIFTS,s),{status:"updated"}}async function Fe(e){if(m()){const{error:s}=await o.from("timesheet_shifts").delete().eq("id",e.id);if(s)throw new Error(s.message);return{status:"deleted"}}await q(200);const r=(S(d.TIMESHEET_SHIFTS)||[]).filter(s=>s.id!==e.id);return N(d.TIMESHEET_SHIFTS,r),{status:"deleted"}}async function Ue(e){return await q(200),(S(d.NOTIFICATIONS)||[]).filter(r=>r.target_athlete===e||r.target_athlete==="All").reverse()}async function ke(e){if(m()){const{data:n,error:i}=await o.from("notifications").insert({title:e.title,body:e.body??null,type:e.type}).select("id").single();if(i)throw new Error(i.message);if(n&&e.targets.length>0){const{error:a}=await o.from("notification_targets").insert(e.targets.map(c=>({notification_id:n.id,target_user_id:c.target_user_id??null,target_group_id:c.target_group_id??null})));if(a)throw new Error(a.message)}return{status:"sent"}}const t=S(d.NOTIFICATIONS)||[],r={sender:"Coach",title:e.title,message:e.body||"",type:e.type},s=e.targets.map((n,i)=>({...r,id:Date.now()+i,read:!1,date:new Date().toISOString(),sender_id:null,sender_email:null,target_user_id:n.target_user_id??null,target_group_id:n.target_group_id??null}));return N(d.NOTIFICATIONS,[...t,...s]),{status:"sent"}}async function He(e){const r=(S(d.NOTIFICATIONS)||[]).map(s=>s.id===e?{...s,read:!0}:s);N(d.NOTIFICATIONS,r)}async function Le(e){const t=e.limit??20,r=Number.isFinite(t)?Math.min(Math.max(Number(t),1),200):20,s=e.offset??0,n=Number.isFinite(s)?Math.max(Number(s),0):0,i=e.order==="asc"?"asc":"desc";if(m()){const f=await le(e.targetUserId??null),w=[];if(e.targetUserId&&w.push(`target_user_id.eq.${e.targetUserId}`),f.forEach(g=>w.push(`target_group_id.eq.${g}`)),!w.length)return{notifications:[],pagination:{limit:r,offset:n,total:0}};let I=o.from("notification_targets").select("*, notifications!inner(*)").or(w.join(",")).order("notifications(created_at)",{ascending:i==="asc"});e.status==="read"?I=I.not("read_at","is",null):e.status==="unread"&&(I=I.is("read_at",null)),e.type&&(I=I.eq("notifications.type",e.type)),e.from&&(I=I.gte("notifications.created_at",e.from)),e.to&&(I=I.lte("notifications.created_at",e.to+"T23:59:59"));const{data:T,error:x}=await I;if(x)throw new Error(x.message);const R=(T??[]).map(g=>{const b=g.notifications||{};return{id:v(g.id,Date.now()),target_id:p(g.id)??void 0,target_user_id:p(g.target_user_id)??null,sender_id:p(b.created_by)??null,sender_email:null,target_group_id:p(g.target_group_id)??null,target_group_name:null,sender_name:null,sender_role:null,counterparty_id:null,counterparty_name:null,counterparty_role:null,sender:b.created_by?"Coach":"Système",title:String(b.title||""),message:String(b.body||""),type:String(b.type||"message"),read:!!g.read_at,date:b.created_at||new Date().toISOString()}}),h=R.length;return{notifications:R.slice(n,n+r),pagination:{limit:r,offset:n,total:h}}}await q(200);const u=(S(d.NOTIFICATIONS)||[]).filter(f=>!(e.targetUserId&&f.target_user_id!==e.targetUserId||e.targetAthleteName&&!(f.target_athlete===e.targetAthleteName||f.target_athlete==="All")||e.type&&f.type!==e.type||e.status==="read"&&!f.read||e.status==="unread"&&f.read)).sort((f,w)=>{const I=new Date(f.date||f.created_at||0).getTime(),T=new Date(w.date||w.created_at||0).getTime();return i==="asc"?I-T:T-I}),_=u.length;return{notifications:u.slice(n,n+r).map(f=>({id:v(f.id,Date.now()),target_user_id:p(f.target_user_id)??null,sender_id:p(f.sender_id)??null,sender_email:f.sender_email?String(f.sender_email):null,sender:String(f.sender||"Coach"),title:String(f.title||""),message:String(f.message||""),type:String(f.type||"message"),read:!!f.read,date:f.date||new Date().toISOString(),related_id:f.related_id??void 0})),pagination:{limit:r,offset:n,total:_}}}async function Pe(e){const t=e.targetId??e.id;if(!t)throw new Error("Missing target id");if(m()){const{error:n}=await o.from("notification_targets").update({read_at:new Date().toISOString()}).eq("id",t);if(n)throw new Error(n.message);return}const s=(S(d.NOTIFICATIONS)||[]).map(n=>n.id===t?{...n,read:!0}:n);N(d.NOTIFICATIONS,s)}async function W(){if(m()){const{data:t,error:r}=await o.from("swim_sessions_catalog").select("*, swim_session_items(*)").order("created_at",{ascending:!1});if(r)throw new Error(r.message);return(t??[]).map(s=>({id:v(s.id,Date.now()),name:String(s.name||""),description:s.description??null,created_by:p(s.created_by)??null,created_at:s.created_at??null,updated_at:s.updated_at??null,folder:s.folder??null,is_archived:s.is_archived??!1,items:Array.isArray(s.swim_session_items)?s.swim_session_items.sort((n,i)=>(n.ordre??0)-(i.ordre??0)).map((n,i)=>({id:p(n.id)??void 0,catalog_id:p(n.catalog_id)??void 0,ordre:p(n.ordre)??i,label:n.label??null,distance:p(n.distance)??null,duration:p(n.duration)??null,intensity:n.intensity??null,notes:n.notes??null,raw_payload:z(n.raw_payload)})):[]}))}return(S(d.SWIM_SESSIONS)||[]).map(t=>({id:v(t.id,Date.now()),name:String(t.name||t.title||""),description:t.description??null,created_by:p(t.created_by)??null,created_at:t.created_at??null,updated_at:t.updated_at??null,folder:t.folder??null,is_archived:t.is_archived??!1,items:Array.isArray(t.items)?t.items.map((r,s)=>({id:p(r.id)??void 0,catalog_id:p(r.catalog_id)??void 0,ordre:p(r.ordre)??s,label:r.label??r.section??null,distance:p(r.distance)??null,duration:p(r.duration)??null,intensity:r.intensity??null,notes:r.notes??r.instruction??null,raw_payload:z(r.raw_payload)??(r.section||r.stroke||r.instruction||r.rest?{section:r.section,stroke:r.stroke,instruction:r.instruction,rest:r.rest}:null)})):[]}))}async function $e(e){if(m()){const r=Array.isArray(e.items)?e.items.map((i,a)=>({ordre:i.ordre??a,label:i.label??null,distance:i.distance??null,duration:i.duration??null,intensity:i.intensity??null,notes:i.notes??null,raw_payload:i.raw_payload??null})):[];if(e.id){const{error:i}=await o.from("swim_sessions_catalog").update({name:e.name,description:e.description??null,folder:e.folder??null}).eq("id",e.id);if(i)throw new Error(i.message);const{error:a}=await o.from("swim_session_items").delete().eq("catalog_id",e.id);if(a)throw new Error(a.message);if(r.length>0){const{error:c}=await o.from("swim_session_items").insert(r.map(u=>({...u,catalog_id:e.id})));if(c)throw new Error(c.message)}return{status:"updated"}}const{data:s,error:n}=await o.from("swim_sessions_catalog").insert({name:e.name,description:e.description??null,folder:e.folder??null}).select("id").single();if(n)throw new Error(n.message);if(r.length>0){const{error:i}=await o.from("swim_session_items").insert(r.map(a=>({...a,catalog_id:s.id})));if(i)throw new Error(i.message)}return{status:"created"}}const t=S(d.SWIM_SESSIONS)||[];if(e.id){const r=t.some(n=>n.id===e.id),s=r?t.map(n=>n.id===e.id?{...n,...e}:n):[...t,{...e,id:e.id}];return N(d.SWIM_SESSIONS,s),{status:r?"updated":"created"}}return N(d.SWIM_SESSIONS,[...t,{...e,id:Date.now()}]),{status:"created"}}async function We(e){if(m()){const{error:s}=await o.from("swim_sessions_catalog").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}const r=(S(d.SWIM_SESSIONS)||[]).filter(s=>s.id!==e);return N(d.SWIM_SESSIONS,r),{status:"deleted"}}async function je(e,t){if(m()){const{error:n}=await o.from("swim_sessions_catalog").update({is_archived:t}).eq("id",e);if(n)throw new Error(n.message);return{status:t?"archived":"restored"}}const s=(S(d.SWIM_SESSIONS)||[]).map(n=>n.id===e?{...n,is_archived:t}:n);return N(d.SWIM_SESSIONS,s),{status:t?"archived":"restored"}}async function Be(e,t){if(m()){const{error:n}=await o.from("swim_sessions_catalog").update({folder:t}).eq("id",e);if(n)throw new Error(n.message);return{status:"moved"}}const s=(S(d.SWIM_SESSIONS)||[]).map(n=>n.id===e?{...n,folder:t}:n);return N(d.SWIM_SESSIONS,s),{status:"moved"}}async function ze(e){if(!m()||e.length===0)return;const{error:t}=await o.from("swim_sessions_catalog").update({is_archived:!0}).in("id",e);if(t)throw new Error(t.message)}const Z=e=>{const t=P(e?.cycle??e?.cycle_type),s=(Array.isArray(e?.items)?e.items:[]).map((i,a)=>Y(i,a,t));de(s);const n=s.sort((i,a)=>i.order_index-a.order_index).map(i=>({ordre:i.order_index,exercise_id:i.exercise_id,cycle_type:i.cycle_type,sets:i.sets,reps:i.reps,pct_1rm:i.percent_1rm,rest_series_s:i.rest_seconds,notes:i.notes}));return{cycle:t,normalizedItems:s,itemsPayload:n}},ee=(e,t,r)=>e.map(s=>({session_id:t,ordre:s.ordre,exercise_id:s.exercise_id,block:"main",cycle_type:s.cycle_type??r,sets:s.sets,reps:s.reps,pct_1rm:s.pct_1rm,rest_series_s:s.rest_series_s,notes:s.notes})),Xe=(e,t)=>({id:t,assignment_id:e.assignment_id,athlete_id:e.athlete_id??null,athlete_name:e.athleteName??null,session_id:e.session_id??null,cycle_type:e.cycle_type??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString(),logs:[]}),Je=e=>({run_id:e.run_id,exercise_id:e.exercise_id,set_index:e.set_index??null,reps:e.reps??null,weight:e.weight??null,pct_1rm_suggested:e.pct_1rm_suggested??null,rest_seconds:e.rest_seconds??null,rpe:e.rpe??null,notes:e.notes??null,completed_at:new Date().toISOString()}),Ye=(e,t)=>e.map((r,s)=>({run_id:t,exercise_id:r.exercise_id,set_index:r.set_index??r.set_number??s,reps:r.reps??null,weight:r.weight??null,rpe:r.rpe??null,notes:r.notes??null,completed_at:new Date().toISOString()})),Ke=e=>{const t={};return e.progress_pct!==void 0&&(t.progress_pct=e.progress_pct),e.status&&(t.status=e.status),e.status==="completed"&&(t.completed_at=new Date().toISOString()),e.fatigue!==void 0&&(t.raw_payload={fatigue:e.fatigue,comments:e.comments}),t},te=(e,t)=>e.map(r=>{const s=t.find(n=>n.id===r.exercise_id);return{...r,exercise_name:s?.nom_exercice,category:s?.exercise_type}}),X=e=>{const t=new Map;for(const r of e){const s=J(Number(r.weight),Number(r.reps));if(!s)continue;const n=Number(r.exercise_id);if(!Number.isFinite(n))continue;const i=t.get(n)??0;s>i&&t.set(n,s)}return t};async function Ve(){if(m()){const{data:r,error:s}=await o.from("dim_exercices").select("*");if(s)throw new Error(s.message);return(r??[]).map(_e)}const e=S(d.EXERCISES)||[];return(Array.isArray(e)?e:[]).map(r=>$(r))}async function Qe(e){const t=L(e.exercise_type);if(m()){const n=K({...e,exercise_type:t}),{error:i}=await o.from("dim_exercices").insert(n);if(i)throw new Error(i.message);return{status:"created"}}const r=S(d.EXERCISES)||[],s=$({...e,exercise_type:t,id:Date.now()});return N(d.EXERCISES,[...r,s]),{status:"created"}}async function Ze(e){const t=L(e.exercise_type);if(m()){const a=K({...e,exercise_type:t}),{error:c}=await o.from("dim_exercices").update(a).eq("id",e.id);if(c)throw new Error(c.message);return{status:"updated"}}const r=S(d.EXERCISES)||[],s=r.findIndex(a=>a.id===e.id);if(s===-1)throw new Error("Exercice introuvable");const n=$({...r[s],...e,exercise_type:t}),i=[...r];return i[s]=n,N(d.EXERCISES,i),{status:"updated"}}async function et(e){if(m()){const{error:i}=await o.from("dim_exercices").delete().eq("id",e);if(i)throw new Error(i.message);return{status:"deleted"}}const r=(S(d.EXERCISES)||[]).filter(i=>i.id!==e);N(d.EXERCISES,r);const n=(S(d.STRENGTH_SESSIONS)||[]).map(i=>({...i,items:Array.isArray(i.items)?i.items.filter(a=>a.exercise_id!==e):i.items}));return N(d.STRENGTH_SESSIONS,n),{status:"deleted"}}async function j(){if(m()){const{data:e,error:t}=await o.from("strength_sessions").select("*, strength_session_items(*, dim_exercices(nom_exercice, exercise_type))").order("created_at",{ascending:!1});if(t)throw new Error(t.message);return(e??[]).map(r=>{const s=Array.isArray(r.strength_session_items)?r.strength_session_items:[],n=P(s[0]?.cycle_type);return{id:v(r.id,Date.now()),title:String(r.name||""),description:r.description??"",cycle:n,folder_id:p(r.folder_id),items:s.sort((i,a)=>(i.ordre??0)-(a.ordre??0)).map((i,a)=>({...Y(i,a,n),exercise_name:i.dim_exercices?.nom_exercice??void 0,category:i.dim_exercices?.exercise_type??void 0}))}})}return S(d.STRENGTH_SESSIONS)||[]}async function tt(e){const{cycle:t,normalizedItems:r,itemsPayload:s}=Z(e);if(m()){const{data:c,error:u}=await o.from("strength_sessions").insert({name:e?.title??e?.name??"",description:e?.description??"",folder_id:e?.folder_id??null}).select("id").single();if(u)throw new Error(u.message);const _=c.id;if(s.length>0){const{error:l}=await o.from("strength_session_items").insert(ee(s,_,t));if(l)throw new Error(l.message)}return{status:"created",id:_}}const n=S(d.STRENGTH_SESSIONS)||[],i=Date.now(),a=te(r,S(d.EXERCISES)||[]);return N(d.STRENGTH_SESSIONS,[...n,{...e,title:e?.title??e?.name??"",cycle:t,items:a,id:i}]),{status:"created",id:i}}async function re(e){if(!e?.id)throw new Error("Session id manquant");const{cycle:t,normalizedItems:r,itemsPayload:s}=Z(e);if(m()){const{error:_}=await o.from("strength_sessions").update({name:e?.title??e?.name??"",description:e?.description??"",folder_id:e?.folder_id??null}).eq("id",e.id);if(_)throw new Error(_.message);if(await o.from("strength_session_items").delete().eq("session_id",e.id),s.length>0){const{error:l}=await o.from("strength_session_items").insert(ee(s,e.id,t));if(l)throw new Error(l.message)}return{status:"updated"}}const n=S(d.STRENGTH_SESSIONS)||[],i=n.findIndex(_=>_.id===e.id);if(i===-1)throw new Error("Séance introuvable");const a=te(r,S(d.EXERCISES)||[]),c={...n[i],...e,title:e?.title??e?.name??"",cycle:t,items:a},u=[...n];return u[i]=c,N(d.STRENGTH_SESSIONS,u),{status:"updated"}}async function rt(e){return re(e)}async function st(e){if(m()){const{error:s}=await o.from("strength_sessions").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}const r=(S(d.STRENGTH_SESSIONS)||[]).filter(s=>s.id!==e);return N(d.STRENGTH_SESSIONS,r),{status:"deleted"}}async function nt(e){if(m()){const{data:n,error:i}=await o.from("strength_session_runs").insert({assignment_id:e.assignment_id??null,athlete_id:e.athlete_id??null,session_id:e.session_id??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString()}).select("id").single();if(i)throw new Error(i.message);return e.assignment_id&&await o.from("session_assignments").update({status:"in_progress"}).eq("id",e.assignment_id),{run_id:n.id}}const t=S(d.STRENGTH_RUNS)||[],r=Date.now(),s=Xe(e,r);if(N(d.STRENGTH_RUNS,[...t,s]),e.assignment_id){const i=(S(d.ASSIGNMENTS)||[]).map(a=>a.id===e.assignment_id?{...a,status:"in_progress"}:a);N(d.ASSIGNMENTS,i)}return{run_id:r}}async function it(e){const t=async y=>{const f=J(Number(e.weight),Number(e.reps));if(!f)return null;const w=y?.athleteId??null,I=y?.athleteName??null;if(w===null&&!I)return null;const T=await k({athleteName:I,athleteId:w}),R=new Map((T||[]).map(h=>[h.exercise_id,Number(h.weight??0)])).get(e.exercise_id)??0;return f<=R||m()&&(w==null||w==="")?null:(await H({athlete_id:w??void 0,athlete_name:I??void 0,exercise_id:e.exercise_id,one_rm:f}),f)},r=y=>{const f=e.athlete_id??e.athleteId??null,w=e.athlete_name??e.athleteName??null;if(f!==null||w)return{athleteId:f,athleteName:w};if(!y)return{athleteId:null,athleteName:null};const I=y.find(T=>T.id===e.run_id);return{athleteId:I?.athlete_id??null,athleteName:I?.athlete_name??null}};if(m()){const{error:y}=await o.from("strength_set_logs").insert(Je(e));if(y)throw new Error(y.message);const f=r(),w=await t(f);return{status:"ok",one_rm_updated:!!w,one_rm:w??void 0}}const s=S(d.STRENGTH_RUNS)||[],n=s.findIndex(y=>y.id===e.run_id),i=n>=0?s[n]:{id:e.run_id,logs:[]},a=[...i.logs||[],{...e,completed_at:new Date().toISOString()}],c={...i,logs:a},u=n>=0?[...s.slice(0,n),c,...s.slice(n+1)]:[...s,c];N(d.STRENGTH_RUNS,u);const _=r(u),l=await t(_);return{status:"ok",one_rm_updated:!!l,one_rm:l??void 0}}async function at(e){if(m()){const c=Ke(e),{error:u}=await o.from("strength_session_runs").update(c).eq("id",e.run_id);if(u)throw new Error(u.message);return e.status==="completed"&&e.assignment_id&&await o.from("session_assignments").update({status:"completed"}).eq("id",e.assignment_id),{status:"ok"}}const t=S(d.STRENGTH_RUNS)||[],r=t.findIndex(c=>c.id===e.run_id),s=new Date().toISOString(),n=r>=0?t[r]:{id:e.run_id,started_at:s},i={...n,...e,id:e.run_id,updated_at:s};if(e.status==="completed"&&!i.completed_at&&(i.completed_at=s),e.status==="completed"){const c=e.assignment_id??n.assignment_id;if(c){const _=(S(d.ASSIGNMENTS)||[]).map(l=>l.id===c?{...l,status:"completed"}:l);N(d.ASSIGNMENTS,_)}}const a=r>=0?[...t.slice(0,r),i,...t.slice(r+1)]:[...t,i];return N(d.STRENGTH_RUNS,a),{status:"ok"}}async function ot(e){if(m()){const{error:n}=await o.from("strength_session_runs").delete().eq("id",e);if(n)throw new Error(n.message);return{status:"deleted",source:"remote"}}const t=S(d.STRENGTH_RUNS)||[],r=t.find(n=>n.id===e),s=t.filter(n=>n.id!==e);if(N(d.STRENGTH_RUNS,s),r?.assignment_id){const i=(S(d.ASSIGNMENTS)||[]).map(a=>a.id===r.assignment_id?{...a,status:"assigned"}:a);N(d.ASSIGNMENTS,i)}return{status:"deleted",source:"local"}}async function ct(e){if(m()){let a=e.run_id;if(!a){const{data:u,error:_}=await o.from("strength_session_runs").insert({assignment_id:e.assignment_id??null,athlete_id:e.athlete_id??null,status:"in_progress",progress_pct:e.progress_pct??0,started_at:new Date().toISOString()}).select("id").single();if(_)throw new Error(_.message);a=u.id}if(a&&Array.isArray(e.logs)&&e.logs.length>0){const{error:u}=await o.from("strength_set_logs").insert(Ye(e.logs,a));if(u)throw new Error(u.message)}const c=X(Array.isArray(e.logs)?e.logs:[]);if(c.size>0){const u=e.athlete_id??null,_=e.athlete_name??null;if(u!=null&&u!==""){const l=await k({athleteName:_,athleteId:u}),y=new Map((l||[]).map(f=>[f.exercise_id,Number(f.weight??0)]));await Promise.all(Array.from(c.entries()).filter(([f,w])=>w>(y.get(f)??0)).map(([f,w])=>H({athlete_id:u??void 0,athlete_name:_??void 0,exercise_id:f,one_rm:w})))}}return a&&await o.from("strength_session_runs").update({progress_pct:e.progress_pct??100,status:"completed",completed_at:new Date().toISOString()}).eq("id",a),e.assignment_id&&await o.from("session_assignments").update({status:"completed"}).eq("id",e.assignment_id),{status:"ok",run_id:a??null}}const t=S(d.STRENGTH_RUNS)||[],r=e.run_id??Date.now(),s=t.find(a=>a.id===r)||{},n={...s,...e,id:r,status:"completed",started_at:s.started_at??e.started_at??e.date??new Date().toISOString(),completed_at:new Date().toISOString()};if(N(d.STRENGTH_RUNS,[...t.filter(a=>a.id!==r),n]),e.assignment_id){const c=(S(d.ASSIGNMENTS)||[]).map(u=>u.id===e.assignment_id?{...u,status:"completed"}:u);N(d.ASSIGNMENTS,c)}const i=X(Array.isArray(e.logs)?e.logs:[]);if(i.size>0){const a=e.athlete_id??null,c=e.athlete_name??null,u=await k({athleteName:c,athleteId:a}),_=new Map((u||[]).map(l=>[l.exercise_id,Number(l.weight??0)]));await Promise.all(Array.from(i.entries()).filter(([l,y])=>y>(_.get(l)??0)).map(([l,y])=>H({athlete_id:a??void 0,athlete_name:c??void 0,exercise_id:l,one_rm:y})))}return{status:"ok",run_id:r}}async function ut(e,t){const r=t?.limit??50,s=Number.isFinite(r)?Math.min(Math.max(Number(r),1),200):50,n=t?.offset??0,i=Number.isFinite(n)?Math.max(Number(n),0):0,a=t?.order==="asc"?"asc":"desc",c=t?.athleteId,u=c!=null&&c!=="";if(m()){let h=o.from("strength_session_runs").select("*, strength_set_logs(*)").order("started_at",{ascending:a==="asc"}).range(i,i+s-1);u&&(h=h.eq("athlete_id",Number(c))),t?.status&&(h=h.eq("status",t.status)),t?.from&&(h=h.gte("started_at",t.from)),t?.to&&(h=h.lte("started_at",t.to+"T23:59:59"));const{data:E,error:g,count:b}=await h;if(g)throw new Error(g.message);return{runs:E??[],pagination:{limit:s,offset:i,total:b??(E??[]).length},exercise_summary:[]}}const y=(S(d.STRENGTH_RUNS)||[]).filter(h=>{if(u&&String(h.athlete_id)!==String(c)||!u&&e&&h.athlete_name!==e||t?.status&&h.status!==t.status)return!1;if(t?.from||t?.to){const E=new Date(h.date||h.started_at||h.created_at||0).getTime();if(t?.from){const g=new Date(t.from).getTime();if(Number.isFinite(g)&&E<g)return!1}if(t?.to){const g=new Date(t.to);g.setHours(23,59,59,999);const b=g.getTime();if(Number.isFinite(b)&&E>b)return!1}}return!0}).sort((h,E)=>{const g=new Date(h.date||h.started_at||h.created_at||0).getTime(),b=new Date(E.date||E.started_at||E.created_at||0).getTime();return a==="asc"?g-b:b-g}),f=S(d.EXERCISES)||[],w=new Map((Array.isArray(f)?f:[]).map(h=>[v(h.id),h.nom_exercice||h.name||`Exercice ${h.id}`])),I=new Map;y.forEach(h=>{(h.logs||[]).forEach(E=>{const g=v(E.exercise_id);if(!g)return;const b=I.get(g)||{exercise_id:g,exercise_name:w.get(g)||`Exercice ${g}`,total_sets:0,total_reps:0,total_volume:0,max_weight:null,last_performed_at:null},A=Number(E.reps??0)||0,O=Number(E.weight??0)||0;b.total_sets+=1,b.total_reps+=A,b.total_volume+=A*O,b.max_weight=Math.max(b.max_weight??0,O)||b.max_weight;const M=E.completed_at||h.completed_at||h.started_at||null;if(M){const D=new Date(M).getTime(),U=b.last_performed_at?new Date(b.last_performed_at).getTime():0;(!b.last_performed_at||D>U)&&(b.last_performed_at=M)}I.set(g,b)})});const T=y.length,x=y.slice(i,i+s),R=Array.from(I.values()).sort((h,E)=>E.total_volume-h.total_volume);return{runs:x,pagination:{limit:s,offset:i,total:T},exercise_summary:R}}async function dt(e,t){const r=t?.limit??200,s=Number.isFinite(r)?Math.min(Math.max(Number(r),1),200):200,n=t?.offset??0,i=Number.isFinite(n)?Math.max(Number(n),0):0,a=t?.order==="asc"?"asc":"desc",c=t?.athleteId,u=c!=null&&c!=="",_=t?.period??"day";if(m()){const E={p_period:_};u&&(E.p_athlete_id=Number(c)),t?.from&&(E.p_from=t.from),t?.to&&(E.p_to=t.to);const{data:g,error:b}=await o.rpc("get_strength_history_aggregate",E);if(b)throw new Error(b.message);const A=Array.isArray(g)?g:[];return{periods:A,pagination:{limit:s,offset:i,total:A.length}}}const y=(S(d.STRENGTH_RUNS)||[]).filter(E=>u?E.athlete_id?String(E.athlete_id)===String(c):!1:E.athlete_name===e),f=t?.from?new Date(t.from):null,w=t?.to?new Date(t.to):null,I=new Map,T=E=>{if(_==="month")return`${E.getUTCFullYear()}-${String(E.getUTCMonth()+1).padStart(2,"0")}`;if(_==="week"){const g=new Date(Date.UTC(E.getUTCFullYear(),E.getUTCMonth(),E.getUTCDate())),b=g.getUTCDay()||7;g.setUTCDate(g.getUTCDate()+4-b);const A=new Date(Date.UTC(g.getUTCFullYear(),0,1)),O=Math.ceil(((g.getTime()-A.getTime())/864e5+1)/7);return`${g.getUTCFullYear()}-W${String(O).padStart(2,"0")}`}return E.toISOString().split("T")[0]};y.forEach(E=>{(Array.isArray(E.logs)?E.logs:[]).forEach(b=>{const A=b.completed_at||E.started_at||E.date||E.created_at;if(!A)return;const O=new Date(A);if(Number.isNaN(O.getTime())||f&&O<f||w&&O>w)return;const M=T(O),D=I.get(M)||{period:M,tonnage:0,volume:0},U=Number(b.reps)||0,ne=Number(b.weight)||0;D.volume+=U,D.tonnage+=U*ne,I.set(M,D)})});const x=Array.from(I.values()).sort((E,g)=>a==="asc"?E.period.localeCompare(g.period):g.period.localeCompare(E.period)),R=x.length;return{periods:x.slice(i,i+s),pagination:{limit:s,offset:i,total:R}}}async function k(e){const t=typeof e=="string"?e:e?.athleteName??null,r=typeof e=="string"?null:e?.athleteId??null;if(m()){let n=o.from("one_rm_records").select("*");r!=null&&String(r)!==""&&(n=n.eq("athlete_id",Number(r)));const{data:i,error:a}=await n;if(a)throw new Error(a.message);return(i??[]).map(c=>({id:p(c.id),athlete_id:p(c.athlete_id),exercise_id:v(c.exercise_id),weight:Number(c.one_rm??0),recorded_at:c.recorded_at??null,notes:c.notes??null}))}return(S(d.ONE_RM)||[]).filter(n=>n.athlete_name===t)}async function H(e){if(m()){const n=e.athlete_id??e.athleteId,i=e.one_rm??e.weight;if(n==null||n===""||i===null||i===void 0)throw new Error("athlete_id et one_rm sont requis");const a={athlete_id:Number(n),exercise_id:e.exercise_id,one_rm:i,recorded_at:new Date().toISOString()};e.notes!==void 0&&(a.notes=e.notes);const{error:c}=await o.from("one_rm_records").upsert(a,{onConflict:"athlete_id,exercise_id"});if(c)throw new Error(c.message);return{status:"ok"}}const t=S(d.ONE_RM)||[],r=e.athlete_name??e.athleteName,s=t.filter(n=>!(n.athlete_name===r&&n.exercise_id===e.exercise_id));return N(d.ONE_RM,[...s,{...e,athlete_name:r,id:Date.now(),date:new Date().toISOString()}]),{status:"ok"}}async function _t(e){if(m()){const{data:s,error:n}=await o.from("one_rm_records").update({notes:e.notes}).eq("athlete_id",Number(e.athlete_id)).eq("exercise_id",e.exercise_id).select("id");if(n)throw new Error(n.message);if(!s||s.length===0){const{error:i}=await o.from("one_rm_records").insert({athlete_id:Number(e.athlete_id),exercise_id:e.exercise_id,notes:e.notes,one_rm:0,recorded_at:new Date().toISOString()});if(i)throw new Error(i.message)}return{status:"ok"}}const t=S(d.ONE_RM)||[],r=t.findIndex(s=>String(s.athlete_id)===String(e.athlete_id)&&s.exercise_id===e.exercise_id);return r>=0?t[r].notes=e.notes:t.push({athlete_id:Number(e.athlete_id),exercise_id:e.exercise_id,one_rm:0,notes:e.notes,id:Date.now(),date:new Date().toISOString()}),N(d.ONE_RM,t),{status:"ok"}}async function lt(e){if(m()){const{data:t,error:r}=await o.from("strength_folders").select("*").eq("type",e).order("sort_order",{ascending:!0});if(r)throw new Error(r.message);return(t??[]).map(s=>({id:v(s.id),name:String(s.name||""),type:s.type,sort_order:v(s.sort_order)}))}return[]}async function mt(e,t){if(!m())throw new Error("Supabase requis");const{data:r,error:s}=await o.from("strength_folders").insert({name:e,type:t}).select("*").single();if(s)throw new Error(s.message);return{id:v(r.id),name:String(r.name),type:r.type,sort_order:v(r.sort_order)}}async function ft(e,t){if(!m())throw new Error("Supabase requis");const{error:r}=await o.from("strength_folders").update({name:t}).eq("id",e);if(r)throw new Error(r.message)}async function gt(e){if(!m())throw new Error("Supabase requis");const{error:t}=await o.from("strength_folders").delete().eq("id",e);if(t)throw new Error(t.message)}async function pt(e,t,r){if(!m())throw new Error("Supabase requis");const{error:s}=await o.from(r).update({folder_id:t}).eq("id",e);if(s)throw new Error(s.message)}async function ht(){return m()?null:(await q(100),S(d.ASSIGNMENTS)||[])}async function wt(e,t,r){if(m()){const{permanentGroupIds:n,temporaryGroupIds:i,hasActiveTemporary:a}=await V(t??null),c=[];if(t!=null&&c.push(`target_user_id.eq.${t}`),(a?i:n).forEach(h=>c.push(`target_group_id.eq.${h}`)),!c.length)return[];let _=o.from("session_assignments").select("*").or(c.join(","));r?.assignmentType&&(_=_.eq("assignment_type",r.assignmentType)),r?.status?_=_.eq("status",r.status):_=_.neq("status","completed");const{data:l,error:y}=await _;if(y)throw new Error(y.message);if(!l?.length)return[];const[f,w]=await Promise.all([W(),j()]),I=new Map(f.map(h=>[h.id,h])),T=new Map(w.map(h=>[h.id,h])),x=l.map(h=>{const E=h.assignment_type==="strength"?"strength":"swim",g=p(E==="swim"?h.swim_catalog_id:h.strength_session_id)??0,b=h.scheduled_date||h.created_at||"",A=String(h.status||"assigned"),O=E==="swim"?I.get(g):void 0,M=E==="strength"?T.get(g):void 0,D={id:v(h.id,Date.now()),session_id:g,session_type:E,title:E==="swim"?O?.name??"Séance natation":M?.title??"Séance musculation",description:O?.description??M?.description??"",assigned_date:b||new Date().toISOString(),assigned_slot:h.scheduled_slot??null,status:A,items:M?.items??O?.items};return E==="strength"&&(D.cycle=M?.cycle??"endurance"),D}),R=new Map(x.map(h=>[h.id,h]));return Array.from(R.values())}return await q(200),(S(d.ASSIGNMENTS)||[]).filter(n=>!(t!=null&&String(t)!==""&&String(n.target_user_id)===String(t)||n.target_athlete===e)||r?.assignmentType&&n.session_type!==r.assignmentType?!1:r?.status?n.status===r.status:n.status!=="completed")}async function St(e,t){const r=e.assignment_type??e.session_type;if(!r)return{status:"error"};const s=e.scheduled_date??e.assigned_date??new Date().toISOString();if(m()){const u={assignment_type:r,scheduled_date:s,scheduled_slot:e.scheduled_slot??null,assigned_by:t??null,status:"assigned"};r==="swim"?u.swim_catalog_id=e.session_id:u.strength_session_id=e.session_id,e.target_user_id!==null&&e.target_user_id!==void 0?u.target_user_id=e.target_user_id:e.target_group_id!==null&&e.target_group_id!==void 0&&(u.target_group_id=e.target_group_id);const{data:_,error:l}=await o.from("session_assignments").insert(u).select("id").single();if(l)throw new Error(l.message);const{data:y,error:f}=await o.from("notifications").insert({title:"Nouvelle séance assignée",body:`Séance prévue le ${s}.`,type:"assignment"}).select("id").single();if(!f&&y){const w={notification_id:y.id};e.target_user_id&&(w.target_user_id=e.target_user_id),e.target_group_id&&(w.target_group_id=e.target_group_id),await o.from("notification_targets").insert(w)}return{status:"assigned"}}let n;if(r==="swim"?n=(S(d.SWIM_SESSIONS)||[]).find(u=>u.id===e.session_id):n=(S(d.STRENGTH_SESSIONS)||[]).find(u=>u.id===e.session_id),!n)return{status:"error"};const i={id:Date.now(),session_id:e.session_id,session_type:r,target_athlete:e.target_athlete??"",target_user_id:e.target_user_id??null,target_group_id:e.target_group_id??null,assigned_date:s,title:n.name??n.title,description:n.description,items:n.items,status:"assigned"},a=S(d.ASSIGNMENTS)||[];N(d.ASSIGNMENTS,[...a,i]);const c=S(d.NOTIFICATIONS)||[];return N(d.NOTIFICATIONS,[...c,{id:Date.now()+1,sender:"Coach",target_athlete:e.target_athlete,target_user_id:e.target_user_id??null,target_group_id:e.target_group_id??null,title:"Nouvelle séance assignée",message:`Séance ${n.title??n.name} prévue le ${s}.`,type:"assignment",related_id:i.id,read:!1,date:new Date().toISOString()}]),{status:"assigned"}}async function yt(e){if(m()){const{error:s}=await o.from("session_assignments").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}const r=(S(d.ASSIGNMENTS)||[]).filter(s=>s.id!==e);return N(d.ASSIGNMENTS,r),{status:"deleted"}}async function Et(e){if(!m())return[];let t=o.from("session_assignments").select("*").gte("scheduled_date",e.from).lte("scheduled_date",e.to);if(e.groupId)t=t.eq("target_group_id",e.groupId);else if(e.userId){const{permanentGroupIds:u,temporaryGroupIds:_,hasActiveTemporary:l}=await V(e.userId),y=[`target_user_id.eq.${e.userId}`];(l?_:u).forEach(w=>y.push(`target_group_id.eq.${w}`)),t=t.or(y.join(","))}else return[];const{data:r,error:s}=await t;if(s)throw new Error(s.message);if(!r?.length)return[];const[n,i]=await Promise.all([W(),j()]),a=new Map(n.map(u=>[u.id,u])),c=new Map(i.map(u=>[u.id,u]));return r.map(u=>{const _=u.assignment_type==="strength"?"strength":"swim",l=p(_==="swim"?u.swim_catalog_id:u.strength_session_id)??0,y=_==="swim"?a.get(l):void 0,f=_==="strength"?c.get(l):void 0;return{id:v(u.id,0),title:_==="swim"?y?.name??"Séance natation":f?.title??"Séance musculation",type:_,scheduledDate:u.scheduled_date??"",scheduledSlot:u.scheduled_slot??null,targetLabel:"",targetType:u.target_group_id?"group":"user",status:u.status??"assigned"}})}async function bt(e){if(m()){const _=e?{from_date:e}:{},{data:l,error:y}=await o.rpc("get_hall_of_fame",_);if(!y&&l){const f=Array.isArray(l)?l:[],w=[...f].map(g=>({athlete_name:g.athlete_name,total_distance:Number(g.total_distance??0)})).sort((g,b)=>b.total_distance-g.total_distance).slice(0,5),I=[...f].map(g=>({athlete_name:g.athlete_name,avg_effort:Number(g.avg_performance??g.avg_engagement??0)})).sort((g,b)=>b.avg_effort-g.avg_effort).slice(0,5),T=[...f].map(g=>({athlete_name:g.athlete_name,avg_engagement:Number(g.avg_engagement??0)})).sort((g,b)=>b.avg_engagement-g.avg_engagement).slice(0,5);let x=[];const R=e?{from_date:e}:{},{data:h,error:E}=await o.rpc("get_hall_of_fame_strength",R);return!E&&h&&(x=(Array.isArray(h)?h:[]).map(g=>({athlete_name:g.athlete_name??"Inconnu",total_volume:Number(g.total_volume??0),total_reps:Number(g.total_reps??0),total_sets:Number(g.total_sets??0),max_weight:Number(g.max_weight??0)}))),{distance:w,performance:I,engagement:T,strength:x}}}await q(300);const t=S(d.SESSIONS)||[],r=S(d.STRENGTH_RUNS)||[],s=e?t.filter(_=>_.session_date>=e||_.date>=e):t,n=e?r.filter(_=>(_.started_at??_.date??"")>=e):r,i=new Map;s.forEach(_=>{i.has(_.athlete_name)||i.set(_.athlete_name,{distance:0,effortSum:0,count:0,engagementSum:0,engagementCount:0});const l=i.get(_.athlete_name);l.distance+=_.distance,l.effortSum+=_.effort,l.count+=1,_.engagement!==null&&_.engagement!==void 0&&Number.isFinite(_.engagement)&&(l.engagementSum+=_.engagement,l.engagementCount+=1)});const a=Array.from(i.entries()).map(([_,l])=>({athlete_name:_,total_distance:l.distance,avg_effort:l.effortSum/l.count,avg_engagement:l.engagementCount?l.engagementSum/l.engagementCount:0})),c=new Map;n.forEach(_=>{c.has(_.athlete_name)||c.set(_.athlete_name,{volume:0,reps:0,sets:0,maxWeight:0});const l=c.get(_.athlete_name);_.logs&&_.logs.forEach(y=>{const f=Number(y.reps??0),w=Number(y.weight??0);l.volume+=f*w,l.reps+=f,l.sets+=1,w>l.maxWeight&&(l.maxWeight=w)})});const u=Array.from(c.entries()).map(([_,l])=>({athlete_name:_,total_volume:l.volume,total_reps:l.reps,total_sets:l.sets,max_weight:l.maxWeight}));return{distance:[...a].sort((_,l)=>l.total_distance-_.total_distance).slice(0,5),performance:[...a].sort((_,l)=>l.avg_effort-_.avg_effort).slice(0,5),engagement:[...a].sort((_,l)=>l.avg_engagement-_.avg_engagement).slice(0,5),strength:[...u].sort((_,l)=>l.total_volume-_.total_volume).slice(0,5)}}async function It(e){if(!m())return[];let t=o.from("club_records").select("*");e.pool_m&&(t=t.eq("pool_m",e.pool_m)),e.sex&&(t=t.eq("sex",e.sex)),e.age&&(t=t.eq("age",e.age)),e.event_code&&(t=t.eq("event_code",e.event_code));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Nt(){if(!m())return[];const{data:e,error:t}=await o.from("club_record_swimmers").select("*");if(t)throw new Error(t.message);return(e??[]).map(r=>({...r,is_active:r.is_active?1:0}))}async function vt(e){if(!m())return null;const t=e.iuf?.trim()||null;if(t){const{data:n,error:i}=await o.from("club_record_swimmers").select("id, display_name, source_type").eq("iuf",t).limit(1);if(i)throw new Error(i.message);if(n&&n.length>0){const a=n[0],c=a.source_type==="user"?"inscrit":"déjà ajouté";throw new Error(`Un nageur avec cet IUF existe déjà : ${a.display_name} (${c})`)}}const{data:r,error:s}=await o.from("club_record_swimmers").insert({source_type:"manual",display_name:e.display_name,iuf:t,sex:e.sex??null,birthdate:e.birthdate??null,is_active:e.is_active!==!1}).select().single();if(s)throw new Error(s.message);return r?{...r,is_active:r.is_active?1:0}:null}async function Tt(e,t){if(!m())return null;let r;if(t.iuf!==void 0&&(r=typeof t.iuf=="string"&&t.iuf.trim()||null,r)){const{data:a,error:c}=await o.from("club_record_swimmers").select("id, display_name, source_type").eq("iuf",r).neq("id",e).limit(1);if(c)throw new Error(c.message);if(a&&a.length>0){const u=a[0],_=u.source_type==="user"?"inscrit":"déjà ajouté";throw new Error(`Un nageur avec cet IUF existe déjà : ${u.display_name} (${_})`)}}const s={};t.iuf!==void 0&&(s.iuf=r??null),t.is_active!==void 0&&(s.is_active=t.is_active),t.sex!==void 0&&(s.sex=t.sex),t.birthdate!==void 0&&(s.birthdate=t.birthdate);const{data:n,error:i}=await o.from("club_record_swimmers").update(s).eq("id",e).select().single();if(i)throw new Error(i.message);return n?{...n,is_active:n.is_active?1:0}:null}async function xt(e,t){if(!m())return null;const r={};t.iuf!==void 0&&(r.iuf=t.iuf),t.is_active!==void 0&&(r.is_active=t.is_active),t.sex!==void 0&&(r.sex=t.sex),t.birthdate!==void 0&&(r.birthdate=t.birthdate);const{data:s,error:n}=await o.from("club_record_swimmers").update(r).eq("user_id",e).eq("source_type","user").select().single();if(n)throw new Error(n.message);return s?{...s,is_active:s.is_active?1:0}:null}async function qt(){if(!m())return null;const{data:e,error:t}=await o.functions.invoke("import-club-records");if(t){const r=e?.error??t.message;throw new Error(String(r))}return e}async function Rt(e){if(!m())return[];let t=o.from("import_logs").select("*").order("started_at",{ascending:!1});e?.swimmerIuf&&(t=t.eq("swimmer_iuf",e.swimmerIuf)),e?.limit&&(t=t.limit(e.limit));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Ot(e,t){if(!m())throw new Error("Supabase not configured");const{data:r,error:s}=await o.functions.invoke("ffn-performances",{body:{swimmer_iuf:e,swimmer_name:t??null}});if(s){const n=r?.error??s.message;throw new Error(String(n))}return r??{total_found:0,new_imported:0,already_existed:0}}async function At(e){if(m()){let s=o.from("swim_records").select("*").order("record_date",{ascending:!1});e.athleteId&&(s=s.eq("athlete_id",e.athleteId));const{data:n,error:i}=await s;if(i)throw new Error(i.message);const a=n??[];return{records:a,pagination:{limit:a.length,offset:0,total:a.length}}}const r=(S(d.SWIM_RECORDS)||[]).filter(s=>e.athleteId?s.athlete_id===e.athleteId:e.athleteName?s.athlete_name===e.athleteName:!1);return{records:r,pagination:{limit:r.length,offset:0,total:r.length}}}async function Mt(e){if(m()){const s={athlete_id:e.athlete_id??null,event_name:e.event_name,pool_length:e.pool_length??null,time_seconds:e.time_seconds??null,record_date:e.record_date??null,notes:e.notes??null};if(e.id){const{error:n}=await o.from("swim_records").update(s).eq("id",e.id);if(n)throw new Error(n.message)}else{const{error:n}=await o.from("swim_records").insert(s);if(n)throw new Error(n.message)}return{status:"ok"}}const t=S(d.SWIM_RECORDS)||[];if(e.id){const s=t.map(n=>n.id===e.id?{...n,...e,athlete_id:e.athlete_id??n.athlete_id}:n);return N(d.SWIM_RECORDS,s),{status:"ok"}}const r={...e,id:Date.now(),athlete_id:e.athlete_id??-1,athlete_name:e.athleteName??null};return N(d.SWIM_RECORDS,[...t,r]),{status:"created"}}async function Ct(e){if(!m())return[];let t=o.from("swimmer_performances").select("*").order("competition_date",{ascending:!1});e.userId&&(t=t.eq("user_id",e.userId)),e.iuf&&(t=t.eq("swimmer_iuf",e.iuf)),e.eventCode&&(t=t.eq("event_code",e.eventCode)),e.poolLength&&(t=t.eq("pool_length",e.poolLength)),e.fromDate&&(t=t.gte("competition_date",e.fromDate)),e.toDate&&(t=t.lte("competition_date",e.toDate)),e.limit&&(t=t.limit(e.limit));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function Dt(e){if(!m())throw new Error("Supabase not configured");const{data:t,error:r}=await o.functions.invoke("ffn-performances",{body:{swimmer_iuf:e.iuf,user_id:e.userId??null}});if(r){const s=t?.error??r.message;throw new Error(String(s))}return t??{total_found:0,new_imported:0,already_existed:0}}async function Gt(){if(!m())return null;const{data:e,error:t}=await o.functions.invoke("import-club-records",{body:{mode:"recalculate"}});if(t){const r=e?.error??t.message;throw new Error(String(r))}return e}async function Ft(){if(!m())return;const{data:e,error:t}=await o.from("users").select("id, display_name, role, birthdate").eq("role","athlete").eq("is_active",!0);if(t)throw new Error(t.message);if(!e||e.length===0)return;const{data:r}=await o.from("club_record_swimmers").select("id, user_id, iuf, sex, birthdate, display_name").eq("source_type","user"),s=new Map((r??[]).map(a=>[a.user_id,a])),{data:n}=await o.from("user_profiles").select("user_id, ffn_iuf, birthdate, sex"),i=new Map((n??[]).map(a=>[a.user_id,a]));for(const a of e){const c=i.get(a.id),u=c?.ffn_iuf??null,_=c?.sex??null,l=c?.birthdate??a.birthdate??null,y=s.get(a.id);if(!y)await o.from("club_record_swimmers").insert({source_type:"user",user_id:a.id,display_name:a.display_name,iuf:u,sex:_,birthdate:l,is_active:!0});else{const f={};u&&u!==y.iuf&&(f.iuf=u),_&&_!==y.sex&&(f.sex=_),l&&l!==y.birthdate&&(f.birthdate=l),a.display_name&&a.display_name!==y.display_name&&(f.display_name=a.display_name),Object.keys(f).length>0&&await o.from("club_record_swimmers").update(f).eq("id",y.id)}}}async function Ut(e){if(!m())return[];let t=o.from("club_performances").select("*").eq("event_code",e.event_code).eq("pool_m",e.pool_m).eq("sex",e.sex).order("time_ms",{ascending:!0});e.age!=null&&(t=t.eq("age",e.age));const{data:r,error:s}=await t;if(s)throw new Error(s.message);return r??[]}async function kt(e){if(!m())return null;const{data:t,error:r}=await o.from("app_settings").select("value").eq("key",e).single();return r?null:t?.value??null}async function Ht(e,t){if(!m())return;const{error:r}=await o.from("app_settings").upsert({key:e,value:t,updated_at:new Date().toISOString()},{onConflict:"key"});if(r)throw new Error(r.message)}async function Lt(e){if(!m())return[];const{data:t,error:r}=await o.from("swim_exercise_logs").select("*").eq("session_id",e).order("created_at",{ascending:!0});if(r)throw new Error(r.message);return(t??[]).map(se)}async function Pt(e,t=50){if(!m())return[];const{data:r,error:s}=await o.from("swim_exercise_logs").select("*").eq("user_id",e).order("created_at",{ascending:!1}).limit(t);if(s)throw new Error(s.message);return(r??[]).map(se)}async function $t(e,t,r){if(!m())return;const{error:s}=await o.from("swim_exercise_logs").delete().eq("session_id",e).eq("user_id",t);if(s)throw new Error(s.message);if(r.length===0)return;const n=r.map(a=>({session_id:e,user_id:t,exercise_label:a.exercise_label,source_item_id:a.source_item_id??null,split_times:a.split_times??[],tempo:a.tempo??null,stroke_count:a.stroke_count??[],notes:a.notes??null})),{error:i}=await o.from("swim_exercise_logs").insert(n);if(i)throw new Error(i.message)}async function Wt(e,t){if(!m())return;const r={updated_at:new Date().toISOString()};t.exercise_label!==void 0&&(r.exercise_label=t.exercise_label),t.split_times!==void 0&&(r.split_times=t.split_times),t.tempo!==void 0&&(r.tempo=t.tempo),t.stroke_count!==void 0&&(r.stroke_count=t.stroke_count),t.notes!==void 0&&(r.notes=t.notes);const{error:s}=await o.from("swim_exercise_logs").update(r).eq("id",e);if(s)throw new Error(s.message)}async function jt(e){if(!m())return;const{error:t}=await o.from("swim_exercise_logs").delete().eq("id",e);if(t)throw new Error(t.message)}function se(e){return{id:String(e.id),session_id:Number(e.session_id),user_id:String(e.user_id),exercise_label:String(e.exercise_label??""),source_item_id:e.source_item_id!=null?Number(e.source_item_id):null,split_times:Array.isArray(e.split_times)?e.split_times:[],tempo:e.tempo!=null?Number(e.tempo):null,stroke_count:Array.isArray(e.stroke_count)?e.stroke_count:[],notes:e.notes!=null?String(e.notes):null,created_at:String(e.created_at??""),updated_at:String(e.updated_at??"")}}async function Bt(){if(!m())return[];const{data:e,error:t}=await o.from("groups").select("id, name, is_active, parent_group_id, created_by, created_at").eq("is_temporary",!0).is("parent_group_id",null).order("created_at",{ascending:!1});if(t)throw new Error(t.message);if(!e?.length)return[];const r=e.map(c=>c.id),{data:s}=await o.from("groups").select("parent_group_id").eq("is_temporary",!0).in("parent_group_id",r),n=new Map;(s??[]).forEach(c=>{n.set(c.parent_group_id,(n.get(c.parent_group_id)??0)+1)});const{data:i}=await o.from("group_members").select("group_id").in("group_id",r),a=new Map;return(i??[]).forEach(c=>{a.set(c.group_id,(a.get(c.group_id)??0)+1)}),e.map(c=>({id:v(c.id,0),name:c.name,is_active:c.is_active??!0,parent_group_id:c.parent_group_id??null,member_count:a.get(c.id)??0,subgroup_count:n.get(c.id)??0,created_at:c.created_at??"",created_by:c.created_by??0}))}async function zt(e){if(!m())return null;const{data:t,error:r}=await o.from("groups").select("id, name, is_active").eq("id",e).eq("is_temporary",!0).single();if(r||!t)return null;const{data:s}=await o.from("group_members").select("user_id, users!inner(display_name)").eq("group_id",e),n=(s??[]).map(l=>l.user_id),{data:i}=n.length?await o.from("group_members").select("user_id, group_id, groups!inner(name, is_temporary)").in("user_id",n).eq("groups.is_temporary",!1):{data:[]},a=new Map;(i??[]).forEach(l=>{a.has(l.user_id)||a.set(l.user_id,l.groups?.name??null)});const c=(s??[]).map(l=>({user_id:l.user_id,display_name:l.users?.display_name??"",permanent_group_label:a.get(l.user_id)??null})),{data:u}=await o.from("groups").select("id, name").eq("parent_group_id",e).eq("is_temporary",!0),_=await Promise.all((u??[]).map(async l=>{const{data:y}=await o.from("group_members").select("user_id, users!inner(display_name)").eq("group_id",l.id);return{id:l.id,name:l.name,members:(y??[]).map(f=>({user_id:f.user_id,display_name:f.users?.display_name??""}))}}));return{id:t.id,name:t.name,is_active:t.is_active,members:c,subgroups:_}}async function Xt(e){if(!m())throw new Error("Supabase required");if(e.member_user_ids.length>0){const{data:n}=await o.from("group_members").select("user_id, group_id, groups!inner(is_temporary, is_active, parent_group_id)").in("user_id",e.member_user_ids).eq("groups.is_temporary",!0).eq("groups.is_active",!0),i=(n??[]).filter(a=>{const c=a.groups;return!(e.parent_group_id&&(a.group_id===e.parent_group_id||c.parent_group_id===e.parent_group_id))});if(i.length>0){const a=[...new Set(i.map(c=>c.user_id))];throw new Error(`Nageurs déjà dans un groupe temporaire actif: IDs ${a.join(", ")}`)}}if(e.parent_group_id&&e.member_user_ids.length>0){const{data:n}=await o.from("group_members").select("user_id").eq("group_id",e.parent_group_id),i=new Set((n??[]).map(c=>c.user_id)),a=e.member_user_ids.filter(c=>!i.has(c));if(a.length>0)throw new Error(`Nageurs non membres du groupe parent: IDs ${a.join(", ")}`)}const{data:t,error:r}=await o.from("groups").insert({name:e.name.trim(),is_temporary:!0,is_active:!0,parent_group_id:e.parent_group_id??null}).select("id").single();if(r)throw new Error(r.message);const s=t.id;if(e.member_user_ids.length>0){const n=e.member_user_ids.map(a=>({group_id:s,user_id:a})),{error:i}=await o.from("group_members").insert(n);if(i)throw new Error(i.message)}return{id:s}}async function Jt(e,t){if(!m())throw new Error("Supabase required");if(!t.length)return;const{data:r}=await o.from("group_members").select("user_id, group_id, groups!inner(is_temporary, is_active, parent_group_id)").in("user_id",t).eq("groups.is_temporary",!0).eq("groups.is_active",!0),s=(r??[]).filter(a=>!(a.group_id===e||a.groups.parent_group_id===e));if(s.length>0){const a=[...new Set(s.map(c=>c.user_id))];throw new Error(`Nageurs déjà dans un groupe temporaire actif: IDs ${a.join(", ")}`)}const n=t.map(a=>({group_id:e,user_id:a})),{error:i}=await o.from("group_members").insert(n);if(i)throw new Error(i.message)}async function Yt(e,t){if(!m())throw new Error("Supabase required");const{data:r}=await o.from("groups").select("id").eq("parent_group_id",e).eq("is_temporary",!0),s=[e,...(r??[]).map(i=>i.id)],{error:n}=await o.from("group_members").delete().eq("user_id",t).in("group_id",s);if(n)throw new Error(n.message)}async function Kt(e){if(!m())throw new Error("Supabase required");const{error:t}=await o.from("groups").update({is_active:!1}).or(`id.eq.${e},parent_group_id.eq.${e}`).eq("is_temporary",!0);if(t)throw new Error(t.message)}async function Vt(e){if(!m())throw new Error("Supabase required");const{data:t}=await o.from("group_members").select("user_id").eq("group_id",e),r=(t??[]).map(n=>n.user_id);if(r.length>0){const{data:n}=await o.from("group_members").select("user_id, groups!inner(is_temporary, is_active)").in("user_id",r).eq("groups.is_temporary",!0).eq("groups.is_active",!0);if(n&&n.length>0)throw new Error("Certains nageurs sont déjà dans un autre groupe temporaire actif.")}const{error:s}=await o.from("groups").update({is_active:!0}).or(`id.eq.${e},parent_group_id.eq.${e}`).eq("is_temporary",!0);if(s)throw new Error(s.message)}async function Qt(e){if(!m())throw new Error("Supabase required");const{data:t}=await o.from("groups").select("is_active").eq("id",e).single();if(t?.is_active)throw new Error("Impossible de supprimer un groupe temporaire actif. Désactivez-le d'abord.");await o.from("groups").delete().eq("parent_group_id",e).eq("is_temporary",!0);const{error:r}=await o.from("groups").delete().eq("id",e).eq("is_temporary",!0);if(r)throw new Error(r.message)}const tr={async getCapabilities(){return m()?{mode:"supabase",version:null,timesheet:{available:!0},messaging:{available:!0}}:{mode:"local",version:null,timesheet:{available:!0},messaging:{available:!0}}},async syncFfnSwimRecords(e){if(!m())throw new Error("Supabase not configured");const{data:t,error:r}=await o.functions.invoke("ffn-sync",{body:{athlete_id:e.athleteId??null,athlete_name:e.athleteName??null,iuf:e.iuf}});if(r)throw new Error(r.message);return t??{inserted:0,updated:0,skipped:0}},async syncSession(e){if(m()){const n=fe(e),{data:i,error:a}=await o.from("dim_sessions").insert(n).select("id").single();if(a)throw new Error(a.message);return{status:"ok",sessionId:i.id}}await q(300);const t=this._get(d.SESSIONS)||[],r=Date.now(),s={...e,id:r,created_at:new Date().toISOString()};return this._save(d.SESSIONS,[...t,s]),{status:"ok",sessionId:r}},async getSessions(e,t){const r=t!=null&&String(t)!=="";if(m()){let n=o.from("dim_sessions").select("*").order("session_date",{ascending:!1});r?n=n.eq("athlete_id",Number(t)):n=n.eq("athlete_name",e);const{data:i,error:a}=await n;if(a)throw new Error(a.message);return(i??[]).map(ge).filter(c=>!!c)}return await q(200),(this._get(d.SESSIONS)||[]).filter(n=>r&&n.athlete_id?String(n.athlete_id)===String(t):n.athlete_name.toLowerCase()===e.toLowerCase()).map(n=>({...n,effort:C(n.effort)??n.effort,feeling:C(n.feeling)??n.feeling,rpe:C(n.rpe??null),performance:C(n.performance??null),engagement:C(n.engagement??null),fatigue:C(n.fatigue??null)})).sort((n,i)=>new Date(i.date).getTime()-new Date(n.date).getTime())},async updateSession(e){if(m()){const n={athlete_name:e.athlete_name,session_date:e.date,time_slot:e.slot,distance:e.distance,duration:e.duration,rpe:G(e.effort),performance:G(e.performance??e.feeling),engagement:G(e.engagement??e.feeling),fatigue:G(e.feeling),comments:e.comments},{error:i}=await o.from("dim_sessions").update(n).eq("id",e.id);if(i)throw new Error(i.message);return{status:"updated"}}await q(200);const t=this._get(d.SESSIONS)||[],r=t.findIndex(n=>n.id===e.id);if(r===-1)return{status:"missing"};const s=[...t];return s[r]={...s[r],...e},this._save(d.SESSIONS,s),{status:"updated"}},async deleteSession(e){if(m()){const{error:s}=await o.from("dim_sessions").delete().eq("id",e);if(s)throw new Error(s.message);return{status:"deleted"}}await q(200);const r=(this._get(d.SESSIONS)||[]).filter(s=>s.id!==e);return this._save(d.SESSIONS,r),{status:"deleted"}},async seedDemoData(){const e=[{id:1,nom_exercice:"Squat",description:"Flexion des jambes",exercise_type:"strength"},{id:2,nom_exercice:"Développé Couché",description:"Poussée horizontale",exercise_type:"strength"},{id:3,nom_exercice:"Tractions",description:"Tirage vertical",exercise_type:"strength"},{id:4,nom_exercice:"Rotations Élastique",description:"Coiffe des rotateurs",exercise_type:"warmup"}];this._save(d.EXERCISES,e);const t={id:101,title:"Full Body A",description:"Séance globale",cycle:"Endurance",items:[{exercise_id:4,exercise_name:"Rotations Élastique",category:"warmup",order_index:0,sets:2,reps:15,rest_seconds:30,percent_1rm:0},{exercise_id:1,exercise_name:"Squat",category:"strength",order_index:1,sets:4,reps:10,rest_seconds:90,percent_1rm:70},{exercise_id:2,exercise_name:"Développé Couché",category:"strength",order_index:2,sets:4,reps:10,rest_seconds:90,percent_1rm:70}]};this._save(d.STRENGTH_SESSIONS,[t]);const r={id:201,name:"VMA 100",description:"Travail de vitesse",created_by:1,items:[{label:"Échauffement 4N",distance:400,intensity:"Souple",notes:"Progressif"},{label:"Corps NL",distance:1e3,intensity:"Max",notes:"10x100 départ 1:30"}]};this._save(d.SWIM_SESSIONS,[r]);const s=new Date().toISOString().split("T")[0];return await this.assignments_create({session_id:101,assignment_type:"strength",target_athlete:"Camille",assigned_date:s}),{status:"seeded"}},_get(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null},_save(e,t){localStorage.setItem(e,JSON.stringify(t))},resetCache(){Object.values(d).forEach(e=>localStorage.removeItem(e)),window.location.reload()},async getHallOfFame(e){return bt(e)},async getClubRecords(e){return It(e)},async getClubRecordSwimmers(){return Nt()},async createClubRecordSwimmer(e){return vt(e)},async updateClubRecordSwimmer(e,t){return Tt(e,t)},async updateClubRecordSwimmerForUser(e,t){return xt(e,t)},async importClubRecords(){return qt()},async getImportLogs(e){return Rt(e)},async importSingleSwimmer(e,t){return Ot(e,t)},async getSwimRecords(e){return At(e)},async upsertSwimRecord(e){return Mt(e)},async getSwimmerPerformances(e){return Ct(e)},async importSwimmerPerformances(e){return Dt(e)},async recalculateClubRecords(){return Gt()},async getClubRanking(e){return Ut(e)},async syncClubRecordSwimmersFromUsers(){return Ft()},async getAppSettings(e){return kt(e)},async updateAppSettings(e,t){return Ht(e,t)},async getExercises(){return Ve()},async createExercise(e){return Qe(e)},async updateExercise(e){return Ze(e)},async deleteExercise(e){return et(e)},async getStrengthSessions(){return j()},async createStrengthSession(e){return tt(e)},async updateStrengthSession(e){return re(e)},async persistStrengthSessionOrder(e){return rt(e)},async deleteStrengthSession(e){return st(e)},async startStrengthRun(e){return nt(e)},async logStrengthSet(e){return it(e)},async updateStrengthRun(e){return at(e)},async deleteStrengthRun(e){return ot(e)},async saveStrengthRun(e){return ct(e)},async getStrengthHistory(e,t){return ut(e,t)},async getStrengthHistoryAggregate(e,t){return dt(e,t)},async get1RM(e){return k(e)},async update1RM(e){return H(e)},async updateExerciseNote(e){return _t(e)},async getStrengthFolders(e){return lt(e)},async createStrengthFolder(e,t){return mt(e,t)},async renameStrengthFolder(e,t){return ft(e,t)},async deleteStrengthFolder(e){return gt(e)},async moveToFolder(e,t,r){return pt(e,t,r)},async getSwimExerciseLogs(e){return Lt(e)},async getSwimExerciseLogsHistory(e,t){return Pt(e,t)},async saveSwimExerciseLogs(e,t,r){return $t(e,t,r)},async updateSwimExerciseLog(e,t){return Wt(e,t)},async deleteSwimExerciseLog(e){return jt(e)},async getSwimCatalog(){return W()},async createSwimSession(e){return $e(e)},async deleteSwimSession(e){return We(e)},async archiveSwimSession(e,t){return je(e,t)},async moveSwimSession(e,t){return Be(e,t)},async migrateLocalStorageArchive(e){return ze(e)},async getAssignmentsForCoach(){return ht()},async getCoachAssignments(e){return Et(e)},async getAssignments(e,t,r){return wt(e,t,r)},async assignments_create(e){const t=ae.getState().userId;return St(e,t)},async assignments_delete(e){return yt(e)},async getNotifications(e){return Ue(e)},async notifications_send(e){return ke(e)},async markNotificationRead(e){return He(e)},async notifications_list(e){return Le(e)},async notifications_mark_read(e){return Pe(e)},async listTimesheetShifts(e){return Re(e)},async listTimesheetLocations(){return Oe()},async createTimesheetLocation(e){return Ae(e)},async deleteTimesheetLocation(e){return Me(e)},async listTimesheetCoaches(){return Ce()},async createTimesheetShift(e){return De(e)},async updateTimesheetShift(e){return Ge(e)},async deleteTimesheetShift(e){return Fe(e)},async getTemporaryGroups(){return Bt()},async getTemporaryGroupDetail(e){return zt(e)},async createTemporaryGroup(e){return Xt(e)},async addTemporaryGroupMembers(e,t){return Jt(e,t)},async removeTemporaryGroupMember(e,t){return Yt(e,t)},async deactivateTemporaryGroup(e){return Kt(e)},async reactivateTemporaryGroup(e){return Vt(e)},async deleteTemporaryGroup(e){return Qt(e)},async getProfile(e){return pe(e)},async updateProfile(e){return he(e)},async getAthletes(){return we()},async getGroups(){return Se()},async getUpcomingBirthdays(e){return ye(e)},async listUsers(e){return Ee(e)},async createCoach(e){return be(e)},async updateUserRole(e){return Ie(e)},async disableUser(e){return Ne(e)},async getPendingApprovals(){return ve()},async approveUser(e){return Te(e)},async rejectUser(e){return xe(e)},async authPasswordUpdate(e){return qe(e)}};export{tr as a,er as s};
