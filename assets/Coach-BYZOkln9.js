import{r as c,b as us,h as ms,l as ps,m as dt,j as e,d as xs,n as ut,o as be,u as Be,I as mt,p as Ss,q as or,R as ge,c as cr,s as pt,t as dr,v as ur,A as xt,w as mr,x as pr,y as xr,z as hr,F as fr,D as gr,B as jr,E as vr}from"./vendor-ui-C9ymspZo.js";import{h as ve,k as U,i as Ue,L as k,I as F,B as C,C as V,b as H,f as K,c as Y,d as ee,s as Is,g as $,u as Ye,l as yr,M as hs,a as br,U as Ze,W as qs,D as Nr,T as wr}from"./index-CMwkteNF.js";import{b as ks,u as je,c as de}from"./vendor-query-kM2vrB_e.js";import{u as _r,S as pe,a as xe,b as he,c as fe,d as G}from"./select-DnkUOUCr.js";import{C as Cr,P as ye}from"./plus-BXYF0I3t.js";import{T as Ve}from"./textarea-zH7tUr7L.js";import{S as T}from"./skeleton-BPWQVQTV.js";import{D as Ie,a as qe,b as vs,c as ys}from"./dialog-_DZ8mMli.js";import{C as Ns}from"./checkbox-CytUJTR_.js";import{L as Os,A as ts,a as rs,b as ns,c as as,d as is,e as ls,f as os,g as cs,P as zs}from"./alert-dialog-DGyPdOMM.js";import{T as Sr,a as kr,b as Er,c as Rr}from"./tabs-g3XwtasH.js";import{S as es,P as Gs}from"./save-C0duJB2F.js";import{C as ws}from"./circle-alert-CxTvPpY0.js";import{E as Ar}from"./eye-BaT-z4Lk.js";import{c as ht,R as Pr,i as Ls,g as Dr,S as Bs,a as Mr,L as Tr}from"./SwimSessionConsultation-CkbBYuON.js";import{f as Fr}from"./vendor-date-cQbdWov0.js";import{C as $r}from"./chevron-left-CDvOfBB3.js";import{S as Vr}from"./search-Dy7qrnyY.js";import{T as Ir}from"./timer-CIX_87Hk.js";import{T as qr,a as Or,b as Us,c as Qe,d as zr,e as Je}from"./table-DIyt31jY.js";import{B as Gr}from"./badge-sCkYel0L.js";import{A as Lr}from"./arrow-left-Dy-xkyk3.js";import{C as Br}from"./chevron-up-BonayVPE.js";import{D as Ur}from"./download-DMcMp29E.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./check-BrYunlGc.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Kr=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],Hr=ve("archive",Kr);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wr=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],Ks=ve("arrow-down",Wr);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qr=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],Hs=ve("arrow-up",Qr);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jr=[["path",{d:"M10.268 21a2 2 0 0 0 3.464 0",key:"vwvbt9"}],["path",{d:"M3.262 15.326A1 1 0 0 0 4 17h16a1 1 0 0 0 .74-1.673C19.41 13.956 18 12.499 18 8A6 6 0 0 0 6 8c0 4.499-1.411 5.956-2.738 7.326",key:"11g9vi"}]],Ge=ve("bell",Jr);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Xr=[["path",{d:"M10 20a1 1 0 0 0 .553.895l2 1A1 1 0 0 0 14 21v-7a2 2 0 0 1 .517-1.341L21.74 4.67A1 1 0 0 0 21 3H3a1 1 0 0 0-.742 1.67l7.225 7.989A2 2 0 0 1 10 14z",key:"sc7q7i"}]],Yr=ve("funnel",Xr);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Zr=[["circle",{cx:"9",cy:"12",r:"1",key:"1vctgf"}],["circle",{cx:"9",cy:"5",r:"1",key:"hp0tcf"}],["circle",{cx:"9",cy:"19",r:"1",key:"fkjjf6"}],["circle",{cx:"15",cy:"12",r:"1",key:"1tmaij"}],["circle",{cx:"15",cy:"5",r:"1",key:"19l28e"}],["circle",{cx:"15",cy:"19",r:"1",key:"f4zoj3"}]],ft=ve("grip-vertical",Zr);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const en=[["path",{d:"M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5",key:"mvr1a0"}],["path",{d:"M3.22 13H9.5l.5-1 2 4.5 2-7 1.5 3.5h5.27",key:"auskq0"}]],Ws=ve("heart-pulse",en);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const sn=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],tn=ve("pencil",sn);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rn=[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]],we=ve("trash-2",rn);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nn=[["path",{d:"M12 3v12",key:"1x0j5s"}],["path",{d:"m17 8-5-5-5 5",key:"7q97r8"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}]],Qs=ve("upload",nn);function _s(s,a,{checkForDefaultPrevented:r=!0}={}){return function(t){if(s?.(t),r===!1||!t.defaultPrevented)return a?.(t)}}var an=us[" useInsertionEffect ".trim().toString()]||ms;function ln({prop:s,defaultProp:a,onChange:r=()=>{},caller:n}){const[t,i,o]=on({defaultProp:a,onChange:r}),d=s!==void 0,v=d?s:t;{const x=c.useRef(s!==void 0);c.useEffect(()=>{const p=x.current;p!==d&&console.warn(`${n} is changing from ${p?"controlled":"uncontrolled"} to ${d?"controlled":"uncontrolled"}. Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.`),x.current=d},[d,n])}const h=c.useCallback(x=>{if(d){const p=cn(x)?x(s):x;p!==s&&o.current?.(p)}else i(x)},[d,s,i,o]);return[v,h]}function on({defaultProp:s,onChange:a}){const[r,n]=c.useState(s),t=c.useRef(r),i=c.useRef(a);return an(()=>{i.current=a},[a]),c.useEffect(()=>{t.current!==r&&(i.current?.(r),t.current=r)},[r,t]),[r,n,i]}function cn(s){return typeof s=="function"}var Es="Radio",[dn,gt]=xs(Es),[un,mn]=dn(Es),jt=c.forwardRef((s,a)=>{const{__scopeRadio:r,name:n,checked:t=!1,required:i,disabled:o,value:d="on",onCheck:v,form:h,...x}=s,[p,f]=c.useState(null),S=Be(a,y=>f(y)),N=c.useRef(!1),I=p?h||!!p.closest("form"):!0;return e.jsxs(un,{scope:r,checked:t,disabled:o,children:[e.jsx(be.button,{type:"button",role:"radio","aria-checked":t,"data-state":Nt(t),"data-disabled":o?"":void 0,disabled:o,value:d,...x,ref:S,onClick:_s(s.onClick,y=>{t||v?.(),I&&(N.current=y.isPropagationStopped(),N.current||y.stopPropagation())})}),I&&e.jsx(bt,{control:p,bubbles:!N.current,name:n,value:d,checked:t,required:i,disabled:o,form:h,style:{transform:"translateX(-100%)"}})]})});jt.displayName=Es;var vt="RadioIndicator",yt=c.forwardRef((s,a)=>{const{__scopeRadio:r,forceMount:n,...t}=s,i=mn(vt,r);return e.jsx(Ss,{present:n||i.checked,children:e.jsx(be.span,{"data-state":Nt(i.checked),"data-disabled":i.disabled?"":void 0,...t,ref:a})})});yt.displayName=vt;var pn="RadioBubbleInput",bt=c.forwardRef(({__scopeRadio:s,control:a,checked:r,bubbles:n=!0,...t},i)=>{const o=c.useRef(null),d=Be(o,i),v=_r(r),h=or(a);return c.useEffect(()=>{const x=o.current;if(!x)return;const p=window.HTMLInputElement.prototype,S=Object.getOwnPropertyDescriptor(p,"checked").set;if(v!==r&&S){const N=new Event("click",{bubbles:n});S.call(x,r),x.dispatchEvent(N)}},[v,r,n]),e.jsx(be.input,{type:"radio","aria-hidden":!0,defaultChecked:r,...t,tabIndex:-1,ref:d,style:{...t.style,...h,position:"absolute",pointerEvents:"none",opacity:0,margin:0}})});bt.displayName=pn;function Nt(s){return s?"checked":"unchecked"}var xn=["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"],fs="RadioGroup",[hn]=xs(fs,[ps,gt]),wt=ps(),_t=gt(),[fn,gn]=hn(fs),Ct=c.forwardRef((s,a)=>{const{__scopeRadioGroup:r,name:n,defaultValue:t,value:i,required:o=!1,disabled:d=!1,orientation:v,dir:h,loop:x=!0,onValueChange:p,...f}=s,S=wt(r),N=dt(h),[I,y]=ln({prop:i,defaultProp:t??null,onChange:p,caller:fs});return e.jsx(fn,{scope:r,name:n,required:o,disabled:d,value:I,onValueChange:y,children:e.jsx(ut,{asChild:!0,...S,orientation:v,dir:N,loop:x,children:e.jsx(be.div,{role:"radiogroup","aria-required":o,"aria-orientation":v,"data-disabled":d?"":void 0,dir:N,...f,ref:a})})})});Ct.displayName=fs;var St="RadioGroupItem",kt=c.forwardRef((s,a)=>{const{__scopeRadioGroup:r,disabled:n,...t}=s,i=gn(St,r),o=i.disabled||n,d=wt(r),v=_t(r),h=c.useRef(null),x=Be(a,h),p=i.value===t.value,f=c.useRef(!1);return c.useEffect(()=>{const S=I=>{xn.includes(I.key)&&(f.current=!0)},N=()=>f.current=!1;return document.addEventListener("keydown",S),document.addEventListener("keyup",N),()=>{document.removeEventListener("keydown",S),document.removeEventListener("keyup",N)}},[]),e.jsx(mt,{asChild:!0,...d,focusable:!o,active:p,children:e.jsx(jt,{disabled:o,required:i.required,checked:p,...v,...t,name:i.name,ref:x,onCheck:()=>i.onValueChange(t.value),onKeyDown:_s(S=>{S.key==="Enter"&&S.preventDefault()}),onFocus:_s(t.onFocus,()=>{f.current&&h.current?.click()})})})});kt.displayName=St;var jn="RadioGroupIndicator",Et=c.forwardRef((s,a)=>{const{__scopeRadioGroup:r,...n}=s,t=_t(r);return e.jsx(yt,{...t,...n,ref:a})});Et.displayName=jn;var Rt=Ct,At=kt,vn=Et;const Pt=c.forwardRef(({className:s,...a},r)=>e.jsx(Rt,{className:U("grid gap-2",s),...a,ref:r}));Pt.displayName=Rt.displayName;const Cs=c.forwardRef(({className:s,...a},r)=>e.jsx(At,{ref:r,className:U("aspect-square h-4 w-4 rounded-full border border-primary text-primary shadow focus:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:cursor-not-allowed disabled:opacity-50",s),...a,children:e.jsx(vn,{className:"flex items-center justify-center",children:e.jsx(Cr,{className:"h-3.5 w-3.5 fill-primary"})})}));Cs.displayName=At.displayName;const Js=[{key:"endurance",label:"Endurance",fieldSuffix:"endurance"},{key:"hypertrophie",label:"Hypertrophie",fieldSuffix:"hypertrophie"},{key:"force",label:"Force",fieldSuffix:"force"}],Xs=s=>s==="endurance"||s==="hypertrophie"||s==="force"?s:"endurance",Ys=({exercise:s,onChange:a,disabled:r=!1})=>e.jsxs(Sr,{defaultValue:"endurance",className:"w-full",children:[e.jsx(kr,{className:"grid w-full grid-cols-3",children:Js.map(n=>e.jsx(Er,{value:n.key,children:n.label},n.key))}),Js.map(n=>{const t=`pct_1rm_${n.fieldSuffix}`,i=`Nb_series_${n.fieldSuffix}`,o=`Nb_reps_${n.fieldSuffix}`,d=`recup_${n.fieldSuffix}`,v=`recup_exercices_${n.fieldSuffix}`;return e.jsxs(Rr,{value:n.key,className:`space-y-3 rounded-lg border p-3 ${r?"opacity-60":""}`,children:[e.jsx("p",{className:"text-sm font-semibold",children:n.label}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"% 1RM"}),e.jsx(F,{type:"number",value:s[t]??"",disabled:r,onChange:h=>a({[t]:h.target.value===""?null:Number(h.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Nb séries"}),e.jsx(F,{type:"number",value:s[i]??"",disabled:r,onChange:h=>a({[i]:h.target.value===""?null:Number(h.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Nb reps"}),e.jsx(F,{type:"number",value:s[o]??"",disabled:r,onChange:h=>a({[o]:h.target.value===""?null:Number(h.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Récup. séries (s)"}),e.jsx(F,{type:"number",value:s[d]??"",disabled:r,onChange:h=>a({[d]:h.target.value===""?null:Number(h.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Récup. exercices (s)"}),e.jsx(F,{type:"number",value:s[v]??"",disabled:r,onChange:h=>a({[v]:h.target.value===""?null:Number(h.target.value)})})]})]})]},n.key)})]}),yn={pct_1rm_endurance:60,pct_1rm_hypertrophie:75,pct_1rm_force:85,Nb_series_endurance:4,Nb_series_hypertrophie:3,Nb_series_force:3,Nb_reps_endurance:16,Nb_reps_hypertrophie:8,Nb_reps_force:3,recup_endurance:120,recup_hypertrophie:200,recup_force:300,recup_exercices_endurance:300,recup_exercices_hypertrophie:400,recup_exercices_force:500},Xe=s=>{const a=Number(s);return Number.isFinite(a)?a:0},Zs=(s,a,r,n)=>{const t=a==="force"?"force":a==="hypertrophie"?"hypertrophie":"endurance",i=`Nb_series_${t}`,o=`Nb_reps_${t}`,d=`pct_1rm_${t}`,v=`recup_${t}`;return{exercise_id:s.id,order_index:r,sets:Xe(s[i]),reps:Xe(s[o]),rest_seconds:Xe(s[v]),percent_1rm:Xe(s[d]),cycle_type:a,notes:n?.notes??""}},bn=()=>({nom_exercice:"",description:null,illustration_gif:null,exercise_type:"strength",warmup_reps:null,warmup_duration:null,...yn}),et=({exercise:s,warmupMode:a,onChange:r,onWarmupModeChange:n,idPrefix:t})=>e.jsxs("div",{className:"space-y-3 rounded-lg border p-3",children:[e.jsx("p",{className:"text-sm font-semibold",children:"Paramètres d’échauffement"}),e.jsxs(Pt,{value:a,onValueChange:i=>{n(i==="duration"?"duration":"reps"),r(i==="duration"?{warmup_reps:null,warmup_duration:s.warmup_duration??0}:{warmup_duration:null,warmup_reps:s.warmup_reps??0})},className:"grid gap-2",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:"reps",id:`${t}-warmup-reps`}),e.jsx(k,{htmlFor:`${t}-warmup-reps`,children:"Nombre de répétitions"})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Cs,{value:"duration",id:`${t}-warmup-duration`}),e.jsx(k,{htmlFor:`${t}-warmup-duration`,children:"Durée (secondes)"})]})]}),a==="duration"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Durée (s)"}),e.jsx(F,{type:"number",value:s.warmup_duration??"",onChange:i=>r({warmup_duration:i.target.value===""?null:Number(i.target.value)})})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Nombre de répétitions"}),e.jsx(F,{type:"number",value:s.warmup_reps??"",onChange:i=>r({warmup_reps:i.target.value===""?null:Number(i.target.value)})})]})]});function Nn(){const{toast:s}=Ue(),a=ks(),[r,n]=c.useState(!1),[t,i]=c.useState(null),[o,d]=c.useState("all"),[v,h]=c.useState(!1),[x,p]=c.useState(!1),[f,S]=c.useState(null),[N,I]=c.useState(null),[y,re]=c.useState(!1),[se,w]=c.useState(null),[P,ue]=c.useState(null),[ne,me]=c.useState(null),[Ne,u]=c.useState(null),[E,Z]=c.useState("reps"),[J,W]=c.useState("reps"),[Q,le]=c.useState(!1),q=async(l,g)=>{if(l.size>10485760){s({title:"Fichier trop volumineux",description:"La taille maximale est de 10 Mo.",variant:"destructive"});return}le(!0);try{const L=l.name.split(".").pop()??"gif",X=`exercises/${Date.now()}-${Math.random().toString(36).slice(2)}.${L}`,{error:We}=await Is.storage.from("exercise-gifs").upload(X,l,{upsert:!1});if(We)throw We;const{data:lr}=Is.storage.from("exercise-gifs").getPublicUrl(X);g(lr.publicUrl),s({title:"Image uploadée"})}catch(L){const X=L instanceof Error?L.message:"Réessayez.";s({title:"Erreur d'upload",description:X,variant:"destructive"})}finally{le(!1)}},[R,B]=c.useState({title:"",description:"",cycle:"endurance",items:[]}),[O,ae]=c.useState({...bn()});c.useEffect(()=>{f&&W(f.warmup_duration!=null?"duration":"reps")},[f]);const{data:ie,isLoading:Me,error:te,refetch:Te}=je({queryKey:["exercises"],queryFn:()=>$.getExercises()}),{data:Fe,isLoading:ke,error:D,refetch:oe}=je({queryKey:["strength_catalog"],queryFn:()=>$.getStrengthSessions()}),Ee=c.useMemo(()=>new Map((ie??[]).map(l=>[l.id,l])),[ie]),Re=de({mutationFn:l=>$.createExercise(l),onSuccess:()=>{a.invalidateQueries({queryKey:["exercises"]}),h(!1),s({title:"Exercice ajouté"})}}),Ae=de({mutationFn:l=>$.createStrengthSession(l),onSuccess:()=>{a.invalidateQueries({queryKey:["strength_catalog"]}),n(!1),B({title:"",description:"",cycle:"endurance",items:[]}),s({title:"Séance créée avec succès"})}}),He=de({mutationFn:l=>$.updateExercise(l),onSuccess:()=>{a.invalidateQueries({queryKey:["exercises"]}),a.invalidateQueries({queryKey:["strength_catalog"]}),p(!1),S(null),s({title:"Exercice mis à jour"})}}),m=de({mutationFn:l=>$.deleteExercise(l),onSuccess:()=>{a.invalidateQueries({queryKey:["exercises"]}),a.invalidateQueries({queryKey:["strength_catalog"]}),ue(null),s({title:"Exercice supprimé"})}}),j=de({mutationFn:l=>$.deleteStrengthSession(l),onSuccess:()=>{a.invalidateQueries({queryKey:["strength_catalog"]}),w(null),s({title:"Séance supprimée"})}}),b=de({mutationFn:l=>$.updateStrengthSession(l),onSuccess:()=>{a.invalidateQueries({queryKey:["strength_catalog"]}),n(!1),i(null),B({title:"",description:"",cycle:"endurance",items:[]}),s({title:"Séance mise à jour"})}}),M=de({mutationFn:l=>$.persistStrengthSessionOrder(l)}),z=()=>{n(!1),i(null),B({title:"",description:"",cycle:"endurance",items:[]})},ce=l=>{i(l.id),B({title:l.title??"",description:l.description??"",cycle:Xs(l.cycle),items:l.items?.map(g=>({exercise_id:g.exercise_id,order_index:g.order_index??0,sets:g.sets,reps:g.reps,rest_seconds:g.rest_seconds,percent_1rm:g.percent_1rm,cycle_type:g.cycle_type,notes:g.notes??""}))??[]}),n(!0)},A=l=>{S(l),p(!0)},$e=()=>{const l={...R,items:Pe(R.items)};t?b.mutate({...l,id:t}):Ae.mutate(l)},Pe=l=>l.map((g,_)=>({...g,order_index:_})),js=()=>{const l=ie?.[0];B(g=>({...g,items:[...g.items,l?Zs(l,g.cycle,g.items.length):{exercise_id:1,order_index:g.items.length,sets:0,reps:0,rest_seconds:0,percent_1rm:0}]}))},Se=(l,g,_)=>{const L=[...R.items];if(g==="exercise_id"){const X=ie?.find(We=>We.id===_);X?L[l]=Zs(X,R.cycle,L[l].order_index??l,L[l]):L[l]={...L[l],exercise_id:Number(_)}}else L[l]={...L[l],[g]:_};B({...R,items:L})},nr=l=>{const g=Pe(R.items.filter((_,L)=>L!==l));B({...R,items:g})},ar=(l,g)=>{if(l===g)return;const _=[...R.items],[L]=_.splice(l,1);_.splice(g,0,L);const X=Pe(_);B({...R,items:X}),t&&M.mutate({id:t,title:R.title,description:R.description,cycle:R.cycle,items:X})},ir=new Set(R.items.map(l=>l.exercise_id)),Ds=ie?.filter(l=>o==="all"||ir.has(l.id)?!0:l.exercise_type===o)??[],Ms=e.jsx(Ie,{open:x,onOpenChange:p,children:e.jsxs(qe,{className:"sm:max-w-3xl max-h-[85vh] overflow-y-auto pb-safe",children:[e.jsx(vs,{children:e.jsx(ys,{children:"Modifier l’exercice"})}),f&&e.jsxs("div",{className:"space-y-4",children:[f.exercise_type==="warmup"?e.jsx(et,{exercise:f,warmupMode:J,onChange:l=>S(g=>g&&{...g,...l}),onWarmupModeChange:W,idPrefix:"edit"}):null,e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Nom"}),e.jsx(F,{value:f.nom_exercice,onChange:l=>S({...f,nom_exercice:l.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Description"}),e.jsx(Ve,{value:f.description??"",onChange:l=>S({...f,description:l.target.value===""?null:l.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Illustration (GIF)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{value:f.illustration_gif??"",onChange:l=>S({...f,illustration_gif:l.target.value===""?null:l.target.value}),placeholder:"https://...",className:"flex-1"}),e.jsx(C,{type:"button",variant:"outline",size:"icon",disabled:Q,onClick:()=>{const l=document.createElement("input");l.type="file",l.accept="image/*,.gif",l.onchange=g=>{const _=g.target.files?.[0];_&&q(_,L=>S(X=>X&&{...X,illustration_gif:L}))},l.click()},"aria-label":"Uploader une image",children:Q?e.jsx(Os,{className:"h-4 w-4 animate-spin"}):e.jsx(Qs,{className:"h-4 w-4"})})]}),f.illustration_gif&&e.jsx("img",{src:f.illustration_gif,alt:"Aperçu",className:"mt-2 h-20 w-20 rounded-lg object-cover border"})]}),f.exercise_type!=="warmup"?e.jsx(Ys,{exercise:f,onChange:l=>S(g=>g&&{...g,...l})}):null,e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ns,{id:"warmup-flag-edit",checked:f.exercise_type==="warmup",onCheckedChange:l=>S({...f,exercise_type:l===!0?"warmup":"strength"})}),e.jsx(k,{htmlFor:"warmup-flag-edit",children:"Exercice d’échauffement (warmup)"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(C,{variant:"outline",onClick:()=>{p(!1),S(null)},children:"Annuler"}),e.jsxs(C,{onClick:()=>{f?.id&&He.mutate(f)},disabled:!f.nom_exercice.trim(),children:[e.jsx(es,{className:"mr-2 h-4 w-4"})," Enregistrer"]})]})]})]})}),Ts=e.jsx(Ie,{open:v,onOpenChange:h,children:e.jsxs(qe,{className:"sm:max-w-3xl max-h-[85vh] overflow-y-auto pb-safe",children:[e.jsx(vs,{children:e.jsx(ys,{children:"Créer un exercice"})}),e.jsxs("div",{className:"space-y-4",children:[O.exercise_type==="warmup"?e.jsx(et,{exercise:O,warmupMode:E,onChange:l=>ae(g=>({...g,...l})),onWarmupModeChange:Z,idPrefix:"create"}):null,e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Nom"}),e.jsx(F,{value:O.nom_exercice,onChange:l=>ae({...O,nom_exercice:l.target.value}),placeholder:"ex: Rotations Élastique"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Description"}),e.jsx(Ve,{value:O.description??"",onChange:l=>ae({...O,description:l.target.value===""?null:l.target.value}),placeholder:"Détails, consignes..."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Illustration (GIF)"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(F,{value:O.illustration_gif??"",onChange:l=>ae({...O,illustration_gif:l.target.value===""?null:l.target.value}),placeholder:"https://...",className:"flex-1"}),e.jsx(C,{type:"button",variant:"outline",size:"icon",disabled:Q,onClick:()=>{const l=document.createElement("input");l.type="file",l.accept="image/*,.gif",l.onchange=g=>{const _=g.target.files?.[0];_&&q(_,L=>ae(X=>({...X,illustration_gif:L})))},l.click()},"aria-label":"Uploader une image",children:Q?e.jsx(Os,{className:"h-4 w-4 animate-spin"}):e.jsx(Qs,{className:"h-4 w-4"})})]}),O.illustration_gif&&e.jsx("img",{src:O.illustration_gif,alt:"Aperçu",className:"mt-2 h-20 w-20 rounded-lg object-cover border"})]}),O.exercise_type!=="warmup"?e.jsx(Ys,{exercise:O,onChange:l=>ae(g=>({...g,...l}))}):null,e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ns,{id:"warmup-flag",checked:O.exercise_type==="warmup",onCheckedChange:l=>ae({...O,exercise_type:l===!0?"warmup":"strength"})}),e.jsx(k,{htmlFor:"warmup-flag",children:"Exercice d’échauffement (warmup)"})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(C,{variant:"outline",onClick:()=>h(!1),children:"Annuler"}),e.jsxs(C,{onClick:()=>Re.mutate(O),disabled:!O.nom_exercice.trim(),children:[e.jsx(es,{className:"mr-2 h-4 w-4"})," Enregistrer"]})]})]})]})}),Fs=e.jsx(Ie,{open:y,onOpenChange:l=>{re(l),l||I(null)},children:e.jsxs(qe,{className:"sm:max-w-3xl",children:[e.jsx(vs,{children:e.jsx(ys,{children:"Détails de la séance"})}),N&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-lg font-semibold",children:N.title}),e.jsx("p",{className:"text-sm text-muted-foreground",children:N.description||"—"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Cycle : ",N.cycle]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-semibold",children:"Exercices"}),e.jsx("div",{className:"space-y-2",children:(N.items??[]).slice().sort((l,g)=>(l.order_index??0)-(g.order_index??0)).map((l,g)=>{const _=Ee.get(l.exercise_id);return e.jsxs("div",{className:"rounded-md border px-3 py-2 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("span",{className:"font-medium",children:[g+1,". ",_?.nom_exercice??l.exercise_name??"Exercice"]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:_?.exercise_type==="warmup"||l.category==="warmup"?"Échauffement":"Travail"})]}),e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:[l.sets," séries • ",l.reps," reps • ",l.percent_1rm,"% 1RM • ",l.rest_seconds,"s"]})]},`${l.exercise_id}-${g}`)})})]})]})]})}),$s=e.jsx(ts,{open:!!se,onOpenChange:l=>{l||w(null)},children:e.jsxs(rs,{children:[e.jsxs(ns,{children:[e.jsx(as,{children:"Supprimer la séance ?"}),e.jsxs(is,{children:['Cette action est définitive. La séance "',se?.title,'" sera supprimée.']})]}),e.jsxs(ls,{children:[e.jsx(os,{children:"Annuler"}),e.jsx(cs,{onClick:()=>{se?.id&&j.mutate(se.id)},children:"Supprimer"})]})]})}),Vs=e.jsx(ts,{open:!!P,onOpenChange:l=>{l||ue(null)},children:e.jsxs(rs,{children:[e.jsxs(ns,{children:[e.jsx(as,{children:"Supprimer l’exercice ?"}),e.jsxs(is,{children:['Cette action est définitive. L’exercice "',P?.nom_exercice,'" sera supprimé.']})]}),e.jsxs(ls,{children:[e.jsx(os,{children:"Annuler"}),e.jsx(cs,{onClick:()=>{P?.id&&m.mutate(P.id)},children:"Supprimer"})]})]})});return Me||ke?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(T,{className:"h-7 w-64"}),e.jsx(T,{className:"h-10 w-24"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(T,{className:"h-6 w-48"}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:Array.from({length:4}).map((l,g)=>e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(T,{className:"h-6 w-3/4"}),e.jsx(T,{className:"h-4 w-1/2 mt-2"})]}),e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-10 w-10"}),e.jsx(T,{className:"h-10 w-10"}),e.jsx(T,{className:"h-10 w-10"})]})})]},`skeleton-session-${g}`))})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(T,{className:"h-6 w-48"}),e.jsx(T,{className:"h-10 w-48"})]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-2",children:Array.from({length:6}).map((l,g)=>e.jsx(V,{children:e.jsxs(K,{className:"flex flex-col gap-3 py-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(T,{className:"h-14 w-14 rounded-md"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(T,{className:"h-5 w-32"}),e.jsx(T,{className:"h-4 w-24"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{className:"h-10 w-10"}),e.jsx(T,{className:"h-10 w-10"})]})]})},`skeleton-exercise-${g}`))})]})]}):te||D?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(ws,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:te instanceof Error?te.message:D instanceof Error?D.message:"Une erreur s'est produite"}),e.jsx(C,{onClick:()=>{Te(),oe()},className:"mt-4",children:"Réessayer"})]}):r?e.jsxs("div",{className:"space-y-6 animate-in slide-in-from-bottom-4",children:[Ts,Ms,Fs,$s,Vs,e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-xl font-bold uppercase",children:t?"Modifier Séance Muscu":"Nouvelle Séance Muscu"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{variant:"outline",onClick:z,children:"Annuler"}),e.jsxs(C,{onClick:$e,children:[e.jsx(es,{className:"mr-2 h-4 w-4"})," Enregistrer"]})]})]}),e.jsxs(V,{children:[e.jsx(H,{children:e.jsx(Y,{children:"Informations Générales"})}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Titre"}),e.jsx(F,{value:R.title,onChange:l=>B({...R,title:l.target.value}),placeholder:"ex: Full Body A"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Cycle"}),e.jsxs(pe,{value:R.cycle,onValueChange:l=>B({...R,cycle:Xs(l)}),children:[e.jsx(xe,{children:e.jsx(he,{})}),e.jsxs(fe,{children:[e.jsx(G,{value:"endurance",children:"Endurance"}),e.jsx(G,{value:"hypertrophie",children:"Hypertrophie"}),e.jsx(G,{value:"force",children:"Force"})]})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Description"}),e.jsx(Ve,{value:R.description,onChange:l=>B({...R,description:l.target.value})})]})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-bold",children:"Exercices"}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(C,{size:"sm",variant:"outline",onClick:()=>h(!0),children:[e.jsx(ye,{className:"mr-2 h-4 w-4"})," Nouvel exercice"]}),e.jsxs(C,{size:"sm",onClick:js,children:[e.jsx(ye,{className:"mr-2 h-4 w-4"})," Ajouter"]})]})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-[220px_1fr] items-end",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(Yr,{className:"h-4 w-4"})," Filtre exercices"]}),e.jsxs(pe,{value:o,onValueChange:l=>d(l),children:[e.jsx(xe,{children:e.jsx(he,{})}),e.jsxs(fe,{children:[e.jsx(G,{value:"all",children:"Tous"}),e.jsx(G,{value:"strength",children:"Séries de travail"}),e.jsx(G,{value:"warmup",children:"Échauffement"})]})]})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Les exercices marqués warmup sont affichés dans les séances avec le badge « Échauffement »."})]}),R.items.map((l,g)=>e.jsxs(V,{className:U("relative transition-all",Ne===g&&ne!==null&&ne!==g&&"ring-2 ring-primary bg-accent/30"),onDragOver:_=>_.preventDefault(),onDragEnter:()=>u(g),onDragLeave:()=>u(_=>_===g?null:_),onDrop:()=>{ne!==null&&(ar(ne,g),me(null),u(null))},children:[e.jsx(C,{variant:"ghost",size:"icon",className:"absolute top-2 right-2 text-destructive",onClick:()=>nr(g),"aria-label":"Supprimer l'exercice",children:e.jsx(we,{className:"h-4 w-4"})}),e.jsxs(K,{className:"pt-6 grid md:grid-cols-12 gap-4 items-end",children:[e.jsx("div",{className:"md:col-span-1 flex items-center justify-center",children:e.jsx("button",{type:"button",className:"cursor-grab rounded-md border p-1 text-muted-foreground hover:text-foreground",draggable:!0,onDragStart:()=>me(g),onDragEnd:()=>{me(null),u(null)},"aria-label":"Réordonner",children:e.jsx(ft,{className:"h-4 w-4"})})}),e.jsxs("div",{className:"md:col-span-3 space-y-2",children:[e.jsx(k,{children:"Exercice"}),e.jsxs(pe,{value:l.exercise_id.toString(),onValueChange:_=>Se(g,"exercise_id",parseInt(_)),children:[e.jsx(xe,{children:e.jsx(he,{})}),e.jsx(fe,{children:Ds.length?Ds.map(_=>e.jsxs(G,{value:_.id.toString(),children:[_.nom_exercice,_.exercise_type==="warmup"?" • Échauffement":""]},_.id)):e.jsx(G,{value:"no-exercise",disabled:!0,children:"Aucun exercice disponible"})})]})]}),e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(k,{children:"Séries"}),e.jsx(F,{type:"number",value:l.sets===0?"":l.sets,onChange:_=>Se(g,"sets",_.target.value===""?0:Number(_.target.value))})]}),e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(k,{children:"Reps"}),e.jsx(F,{type:"number",value:l.reps===0?"":l.reps,onChange:_=>Se(g,"reps",_.target.value===""?0:Number(_.target.value))})]}),e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(k,{children:"% 1RM"}),e.jsx(F,{type:"number",value:l.percent_1rm===0?"":l.percent_1rm,onChange:_=>Se(g,"percent_1rm",_.target.value===""?0:Number(_.target.value))})]}),e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(k,{children:"Repos (s)"}),e.jsx(F,{type:"number",value:l.rest_seconds===0?"":l.rest_seconds,onChange:_=>Se(g,"rest_seconds",_.target.value===""?0:Number(_.target.value))})]})]})]},`${l.exercise_id}-${g}`))]})]}):e.jsxs("div",{className:"space-y-4",children:[Ts,Ms,Fs,$s,Vs,e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Catalogue Séances Musculation"}),e.jsxs(C,{onClick:()=>{i(null),B({title:"",description:"",cycle:"endurance",items:[]}),n(!0)},children:[e.jsx(ye,{className:"mr-2 h-4 w-4"})," Créer"]})]}),e.jsx("div",{className:"grid gap-4 md:grid-cols-2",children:Fe?.map(l=>e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:l.title}),e.jsxs(ee,{children:[l.items?.length||0," exercices • ",l.cycle]})]}),e.jsx(K,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(C,{variant:"outline",size:"icon","aria-label":"Voir détails",onClick:()=>{I(l),re(!0)},children:e.jsx(Ar,{className:"h-4 w-4"})}),e.jsx(C,{variant:"secondary",size:"icon","aria-label":"Modifier",onClick:()=>ce(l),children:e.jsx(Gs,{className:"h-4 w-4"})}),e.jsx(C,{variant:"destructive",size:"icon","aria-label":"Supprimer",onClick:()=>w(l),children:e.jsx(we,{className:"h-4 w-4"})})]})})]},l.id))}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Catalogue Exercices"}),e.jsxs(C,{variant:"outline",onClick:()=>h(!0),children:[e.jsx(ye,{className:"mr-2 h-4 w-4"})," Ajouter un exercice"]})]}),e.jsx("div",{className:"grid gap-3 md:grid-cols-2",children:ie?.map(l=>e.jsx(V,{children:e.jsxs(K,{className:"flex flex-col gap-3 py-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[l.illustration_gif?e.jsx("img",{src:l.illustration_gif,alt:`Illustration ${l.nom_exercice}`,className:"h-14 w-14 rounded-md object-cover",loading:"lazy",decoding:"async"}):null,e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:l.nom_exercice}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l.exercise_type==="warmup"?"Échauffement":"Séries de travail"})]})]}),e.jsxs("div",{className:"flex w-full gap-2 sm:w-auto",children:[e.jsx(C,{variant:"outline",size:"icon","aria-label":"Modifier",onClick:()=>A(l),children:e.jsx(Gs,{className:"h-4 w-4"})}),e.jsx(C,{variant:"destructive",size:"icon","aria-label":"Supprimer",onClick:()=>ue(l),children:e.jsx(we,{className:"h-4 w-4"})})]})]})},l.id))})]})]})}const st=["V0","V1","V2","V3","Max"],wn={V0:"bg-intensity-1",V1:"bg-intensity-2",V2:"bg-intensity-3",V3:"bg-intensity-4",Max:"bg-intensity-5"},tt={souple:"V0",facile:"V0",relache:"V0",relâché:"V0"},_n=s=>{if(!s)return"V0";const a=s.trim();if(!a)return"V0";const r=a.toLowerCase();if(tt[r])return tt[r];const n=a.toUpperCase();if(n==="MAX")return"Max";if(n.startsWith("V")){const t=n.replace("V","V");return t==="V4"||t==="V5"?"Max":t}return a};function Cn({value:s,onChange:a,className:r,ariaLabel:n="Sélection d'intensité"}){const t=_n(s),i=st.includes(t)?t:"Max";return e.jsx("div",{role:"radiogroup","aria-label":n,className:U("flex flex-wrap items-center gap-2",r),children:st.map(o=>{const d=i===o;return e.jsxs("button",{type:"button",role:"radio","aria-checked":d,"aria-label":`Intensité ${o==="Max"?"MAX":o}`,onClick:()=>a(o),className:U("flex flex-col items-center gap-1 rounded-full px-2 py-1 text-[10px] font-semibold text-muted-foreground transition","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",d?"text-foreground":"hover:text-foreground"),children:[e.jsx("span",{className:U("h-3 w-3 rounded-full",d?wn[o]??"bg-primary":"bg-muted")}),e.jsx("span",{children:o==="Max"?"MAX":o})]},o)})})}function Sn(s){c.useEffect(()=>{if(!s)return;const a=r=>{r.preventDefault()};return window.addEventListener("beforeunload",a),()=>window.removeEventListener("beforeunload",a)},[s])}function rt(s){return`Séance du ${Fr(s,"dd/MM/yyyy")} - Soir - Matin`}const nt={souple:"V0",facile:"V0",relache:"V0",relâché:"V0"},kn=["V0","V1","V2","V3","Max"],Le=s=>{if(!s)return"V0";const a=s.trim();if(!a)return"V0";const r=a.toLowerCase();if(nt[r])return nt[r];const n=a.toUpperCase();if(n==="MAX")return"Max";if(n.startsWith("V")){const t=Number.parseInt(n.slice(1),10);if(Number.isFinite(t)&&t>=4)return"Max";if(kn.includes(n))return n}return a},at=s=>s==="Max"?"MAX":s,bs=s=>{let a=0;return s.flatMap((r,n)=>r.exercises.map((t,i)=>{const o={block_title:r.title,block_description:r.description||null,block_order:n,block_repetitions:r.repetitions??null,block_modalities:r.modalities||null,block_equipment:r.equipment??[],exercise_repetitions:t.repetitions??null,exercise_rest:t.rest??null,exercise_stroke:t.stroke||null,exercise_stroke_type:t.strokeType||null,exercise_intensity:t.intensity?Le(t.intensity):null,exercise_modalities:t.modalities||null,exercise_equipment:t.equipment??[],exercise_order:i},d=t.repetitions&&t.distance?`${t.repetitions}x${t.distance}m`:t.distance?`${t.distance}m`:null;return{ordre:a++,label:d,distance:t.distance??null,duration:null,intensity:t.intensity?Le(t.intensity):null,notes:t.modalities||null,raw_payload:o}}))},En=(s=[])=>{const a=new Map;return s.forEach(r=>{const n=r.raw_payload??{},t=n.block_title||n.section||"Bloc",i=Number(n.block_order??0),o=`${i}-${t}`,d=n.block_equipment??n.equipment??[],v=(Array.isArray(d)?d:String(d).split(",")).map(f=>String(f)).map(f=>it(f)).filter(Boolean);a.has(o)||a.set(o,{title:t,repetitions:n.block_repetitions??null,description:n.block_description??"",modalities:n.block_modalities??n.modalities??"",equipment:v,exercises:[],order:Number.isFinite(i)?i:0,exerciseOrder:new Map});const h=a.get(o),x=Number(n.exercise_order??r.ordre??h.exercises.length),p=Le(n.exercise_intensity??r.intensity??"V1");h.exerciseOrder.set(x,{repetitions:n.exercise_repetitions??null,distance:r.distance??null,rest:n.exercise_rest??null,stroke:n.exercise_stroke??n.stroke??"crawl",strokeType:n.exercise_stroke_type??n.stroke_type??"nc",intensity:p,modalities:n.exercise_modalities??r.notes??"",equipment:Array.isArray(n.exercise_equipment)?n.exercise_equipment.map(f=>it(f)):[]})}),Array.from(a.values()).sort((r,n)=>r.order-n.order).map(r=>({title:r.title,repetitions:r.repetitions,description:r.description,modalities:r.modalities,equipment:r.equipment,exercises:Array.from(r.exerciseOrder.entries()).sort(([n],[t])=>n-t).map(([,n])=>n)}))},Rn=s=>s?s.length>48?`${s.slice(0,45).trim()}…`:s:"",it=s=>{const a=s.trim().toLowerCase();return a&&(a.startsWith("plaquette")?"plaquettes":a.startsWith("palm")?"palmes":a.startsWith("tuba")?"tuba":a.startsWith("pull")?"pull":a.startsWith("elas")?"elastique":a)},An=(s=[])=>new Set(s.map(r=>{const n=r.raw_payload;return n?.block_title||n?.section||"Bloc"})).size,Pn=s=>{const a=ht(s.items??[]),n=s.items?.some(i=>i.duration!=null)??!1?s.items?.reduce((i,o)=>i+(o.duration??0),0)??0:null,t=An(s.items??[]);return{totalDistance:a,totalDuration:n,blockCount:t}},lt="swim_catalog_archived_ids",Dn=(s,a)=>a===null?!1:!a.some(r=>r.session_type==="swim"&&r.session_id===s);function Mn(){const{toast:s}=Ue(),a=ks(),{userId:r,role:n}=Ye(),[t,i]=c.useState(!1);Sn(t);const[o,d]=c.useState(null),[v,h]=c.useState(null),[x,p]=c.useState(null),[f,S]=c.useState(""),[N,I]=c.useState("compact"),[y,re]=c.useState(new Set),se=()=>({id:null,name:rt(new Date),description:"",estimatedDuration:0,blocks:[]}),[w,P]=c.useState(se),{data:ue,isLoading:ne,error:me,refetch:Ne}=je({queryKey:["swim_catalog"],queryFn:()=>$.getSwimCatalog()}),{data:u,isLoading:E,isError:Z,error:J,refetch:W}=je({queryKey:["coach-assignments"],queryFn:()=>$.getAssignmentsForCoach(),enabled:n==="coach"||n==="admin"});c.useEffect(()=>{if(typeof window>"u")return;const m=window.localStorage.getItem(lt);if(m)try{const j=JSON.parse(m);Array.isArray(j)&&re(new Set(j.map(b=>Number(b)).filter(b=>Number.isFinite(b))))}catch{return}},[]),c.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(lt,JSON.stringify(Array.from(y.values())))},[y]);const le=c.useMemo(()=>{const m=f.trim().toLowerCase();return m?(ue??[]).filter(j=>j.name.toLowerCase().includes(m)):ue??[]},[ue,f]).filter(m=>!y.has(m.id)),q=de({mutationFn:m=>$.createSwimSession(m),onSuccess:(m,j)=>{a.invalidateQueries({queryKey:["swim_catalog"]}),i(!1),P(se()),s({title:j?.id?"Séance natation mise à jour":"Séance natation créée"})}}),R=de({mutationFn:m=>$.deleteSwimSession(m),onSuccess:()=>{a.invalidateQueries({queryKey:["swim_catalog"]}),h(null),s({title:"Séance supprimée"})},onError:()=>{s({title:"Suppression impossible",description:"Cette séance est utilisée dans une assignation.",variant:"destructive"})}}),B=()=>{P(m=>({...m,blocks:[...m.blocks,{title:"Nouveau bloc",repetitions:1,description:"",modalities:"",equipment:[],exercises:[{repetitions:4,distance:50,rest:null,stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}]}]}))},O=(m,j,b)=>{const M=[...w.blocks];M[m]={...M[m],[j]:b},P({...w,blocks:M})},ae=m=>{const j=w.blocks.filter((b,M)=>M!==m);P({...w,blocks:j})},ie=(m,j)=>{const b=j==="up"?m-1:m+1;if(b<0||b>=w.blocks.length)return;const M=[...w.blocks],[z]=M.splice(m,1);M.splice(b,0,z),P({...w,blocks:M})},Me=m=>{const j=[...w.blocks];j[m].exercises.push({repetitions:4,distance:50,rest:null,stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}),P({...w,blocks:j})},te=(m,j,b,M)=>{const z=[...w.blocks],ce=[...z[m].exercises];ce[j]={...ce[j],[b]:M},z[m]={...z[m],exercises:ce},P({...w,blocks:z})},Te=(m,j)=>{const b=[...w.blocks];b[m].exercises=b[m].exercises.filter((M,z)=>z!==j),P({...w,blocks:b})},Fe=[{value:"palmes",label:"Palmes"},{value:"tuba",label:"Tuba"},{value:"plaquettes",label:"Plaquettes"},{value:"pull",label:"Pull"},{value:"elastique",label:"Élastique"}],ke=[{value:"pap",label:"Papillon"},{value:"dos",label:"Dos"},{value:"brasse",label:"Brasse"},{value:"crawl",label:"Crawl"},{value:"4n",label:"4 nages"},{value:"spe",label:"Spé"}],D=[{value:"nc",label:"NC"},{value:"educ",label:"Educ"},{value:"jambes",label:"Jambes"}];ke.reduce((m,j)=>(m[j.value]=j.label,m),{});const oe=D.reduce((m,j)=>(m[j.value]=j.label,m),{});w.id;const Ee=c.useMemo(()=>ht(bs(w.blocks)),[w.blocks]),Re={nc:"bg-sky-100 text-sky-900 ring-sky-200",educ:"bg-violet-100 text-violet-900 ring-violet-200",jambes:"bg-teal-100 text-teal-900 ring-teal-200"},Ae={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5"},He={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30"};return t?e.jsxs("div",{className:"animate-in slide-in-from-bottom-4 motion-reduce:animate-none",children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{type:"button",onClick:()=>{i(!1),P(se())},className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Retour",children:e.jsx($r,{className:"h-4 w-4"})}),e.jsx("div",{className:"text-base font-semibold",children:"Édition"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>d({id:w.id??Date.now(),name:w.name,description:w.description,created_by:r??null,items:bs(w.blocks)}),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Aperçu nageur",title:"Aperçu nageur",children:e.jsx(zs,{className:"h-4 w-4"})}),e.jsxs("button",{type:"button",onClick:()=>{if(!w.name.trim()){s({title:"Titre requis",description:"Ajoutez un nom de séance avant d'enregistrer.",variant:"destructive"});return}q.mutate({id:w.id??void 0,name:w.name,description:w.description,estimated_duration:w.estimatedDuration||null,items:bs(w.blocks),created_by:r})},className:"inline-flex items-center gap-2 rounded-full bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground",children:[e.jsx(es,{className:"h-4 w-4"})," Sauver"]})]})]}),e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(V,{className:"rounded-2xl border-border",children:e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Infos séance"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Nom"}),e.jsx("div",{className:"mt-1",children:e.jsx(F,{value:w.name,onChange:m=>P({...w,name:m.target.value}),placeholder:"Nom de la séance",className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Durée estimée (min)"}),e.jsx("div",{className:"mt-1",children:e.jsx(F,{type:"number",min:0,value:w.estimatedDuration||"",onChange:m=>P({...w,estimatedDuration:m.target.value===""?0:Number(m.target.value)}),placeholder:"55",className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Distance totale"}),e.jsxs("div",{className:"mt-1 rounded-2xl border border-border bg-muted px-3 py-2 text-sm font-semibold",children:[Ee,"m"]})]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Vue coach"}),e.jsxs("div",{className:"inline-flex rounded-full border border-border bg-card p-1 text-xs font-semibold",children:[e.jsx("button",{type:"button",onClick:()=>I("compact"),className:U("rounded-full px-3 py-1",N==="compact"?"bg-primary text-primary-foreground":"text-muted-foreground"),children:"Condensé"}),e.jsx("button",{type:"button",onClick:()=>I("detailed"),className:U("rounded-full px-3 py-1",N==="detailed"?"bg-primary text-primary-foreground":"text-muted-foreground"),children:"Détail"})]})]}),N==="compact"?e.jsx(V,{className:"rounded-2xl border-border",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:"Plan (ultra compact)"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:"Manipule les blocs vite. Passe en “Détail” pour éditer."})]}),e.jsxs(C,{variant:"secondary",size:"sm",onClick:B,className:"h-9 rounded-full px-3 text-xs",children:[e.jsx(ye,{className:"h-4 w-4"})," Bloc"]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[w.blocks.map((m,j)=>e.jsx("div",{className:"rounded-2xl border border-border bg-card px-3 py-2",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-primary px-2 py-0.5 text-[11px] font-semibold text-primary-foreground",children:[e.jsx(Pr,{className:"inline h-3 w-3"})," ",m.repetitions??1,"x"]}),e.jsx("div",{className:"truncate text-xs font-semibold",children:m.title?m.title:`Bloc ${j+1}`}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:["· ",m.exercises.length," ex"]})]}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1",children:[m.exercises.slice(0,4).map((b,M)=>{const z=Le(b.intensity),ce=oe[b.strokeType]??b.strokeType;return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-muted px-2 py-0.5 text-[11px] font-semibold text-muted-foreground",title:b.modalities?Rn(b.modalities):"",children:[b.repetitions&&b.distance?`${b.repetitions}x`:"",b.distance?`${b.distance}m`:"—",e.jsx("span",{className:U("ml-1 inline-flex items-center rounded-full px-2 py-0.5 ring-1",Re[b.strokeType]??"bg-muted text-muted-foreground ring-border"),children:ce}),e.jsxs("span",{className:U("ml-1 inline-flex items-center gap-1 rounded-full bg-card px-2 py-0.5 ring-1",He[z],Ae[z]),children:[e.jsx("span",{className:U("h-2 w-2 rounded-full",Ls[z]??"bg-muted")}),at(z)]})]},`${j}-${M}`)}),m.exercises.length>4?e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:["+",m.exercises.length-4]}):null]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>ie(j,"up"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Monter",title:"Monter",disabled:j===0,children:e.jsx(Hs,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>ie(j,"down"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Descendre",title:"Descendre",disabled:j===w.blocks.length-1,children:e.jsx(Ks,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>ae(j),className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer bloc",title:"Supprimer bloc",children:e.jsx(we,{className:"h-4 w-4"})})]})]})},j)),w.blocks.length?null:e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-muted px-3 py-6 text-center text-sm text-muted-foreground",children:"Aucun bloc. Ajoute un bloc pour commencer."})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Édition détaillée"}),e.jsxs(C,{variant:"secondary",size:"sm",onClick:B,className:"h-9 rounded-full px-3 text-xs",children:[e.jsx(ye,{className:"h-4 w-4"})," Ajouter bloc"]})]}),e.jsx("div",{className:"space-y-4",children:w.blocks.map((m,j)=>e.jsx(V,{className:"rounded-2xl border-border",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"mt-1 inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-muted text-muted-foreground",children:e.jsx(ft,{className:"h-4 w-4"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Titre bloc"}),e.jsx(F,{value:m.title,onChange:b=>O(j,"title",b.target.value),placeholder:`Bloc ${j+1}`,className:"rounded-2xl"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>ie(j,"up"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Monter",title:"Monter",disabled:j===0,children:e.jsx(Hs,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>ie(j,"down"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Descendre",title:"Descendre",disabled:j===w.blocks.length-1,children:e.jsx(Ks,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>ae(j),className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer bloc",title:"Supprimer bloc",children:e.jsx(we,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Répétitions du bloc"}),e.jsx("div",{className:"mt-1",children:e.jsx(F,{type:"number",min:1,value:m.repetitions??"",onChange:b=>O(j,"repetitions",b.target.value===""?null:Number(b.target.value)),placeholder:"1",className:"rounded-2xl"})})]}),e.jsx("div",{className:"flex items-end justify-end",children:e.jsxs(C,{variant:"secondary",size:"sm",onClick:()=>Me(j),className:"h-9 rounded-full px-3 text-xs",children:[e.jsx(ye,{className:"h-4 w-4"})," Exercice"]})})]}),e.jsx("div",{className:"mt-4 space-y-3",children:m.exercises.map((b,M)=>{const z=Le(b.intensity),ce=b.modalities??"";return e.jsx("div",{className:"rounded-2xl border border-border bg-card p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"grid flex-1 grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Répétitions"}),e.jsx("div",{className:"mt-1",children:e.jsx(F,{type:"number",min:1,value:b.repetitions??"",onChange:A=>te(j,M,"repetitions",A.target.value===""?null:Number(A.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Distance (m)"}),e.jsx("div",{className:"mt-1",children:e.jsx(F,{type:"number",min:0,value:b.distance??"",onChange:A=>te(j,M,"distance",A.target.value===""?null:Number(A.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Nage"}),e.jsx("div",{className:"mt-1",children:e.jsxs(pe,{value:b.stroke,onValueChange:A=>te(j,M,"stroke",A),children:[e.jsx(xe,{className:"rounded-2xl",children:e.jsx(he,{})}),e.jsx(fe,{children:ke.map(A=>e.jsx(G,{value:A.value,children:A.label},A.value))})]})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Type"}),e.jsx("div",{className:"mt-1",children:e.jsxs(pe,{value:b.strokeType,onValueChange:A=>te(j,M,"strokeType",A),children:[e.jsx(xe,{className:"rounded-2xl",children:e.jsx(he,{})}),e.jsx(fe,{children:D.map(A=>e.jsx(G,{value:A.value,children:A.label},A.value))})]})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Intensité (clic sur points)"}),e.jsxs("span",{className:U("inline-flex items-center gap-2 rounded-full bg-card px-2.5 py-1 text-xs font-semibold ring-1",He[z],Ae[z]),children:[e.jsx("span",{className:U("h-2 w-2 rounded-full",Ls[z]??"bg-muted")}),at(z)]})]}),e.jsx("div",{className:"mt-2 flex items-center justify-between gap-2",children:e.jsx(Cn,{value:b.intensity,onChange:A=>te(j,M,"intensity",A)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Équipements"}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:Fe.map(A=>{const $e=b.equipment.includes(A.value),Pe=Dr(A.value);return e.jsxs("button",{type:"button",onClick:()=>{const js=$e?b.equipment.filter(Se=>Se!==A.value):[...b.equipment,A.value];te(j,M,"equipment",js)},className:U("inline-flex items-center gap-2 rounded-full border px-3 py-2 text-xs font-semibold",$e?"border-primary bg-primary text-primary-foreground":"border-border bg-card text-muted-foreground hover:bg-muted"),children:[e.jsx("span",{className:U("inline-flex h-7 w-7 items-center justify-center rounded-full",$e?"bg-white/10":"bg-muted"),children:Pe?e.jsx("img",{src:Pe,alt:"",className:"h-4 w-4","aria-hidden":"true",loading:"lazy"}):null}),A.label]},A.value)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Modalités"}),e.jsx("div",{className:"mt-1",children:e.jsx(Ve,{value:ce,onChange:A=>te(j,M,"modalities",A.target.value),placeholder:"Une modalité par ligne",rows:3,className:"rounded-2xl"})})]})]}),e.jsx("button",{type:"button",onClick:()=>Te(j,M),className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer exercice",title:"Supprimer exercice",children:e.jsx(we,{className:"h-4 w-4"})})]})},M)})}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs(C,{variant:"secondary",size:"sm",onClick:()=>Me(j),className:"h-9 rounded-full px-3 text-xs",children:[e.jsx(ye,{className:"h-4 w-4"})," Ajouter exercice"]}),e.jsxs(C,{variant:"destructive",size:"sm",onClick:()=>ae(j),className:"h-9 rounded-full px-3 text-xs",children:[e.jsx(we,{className:"h-4 w-4"})," Supprimer bloc"]})]})]})},j))})]}),e.jsx("div",{className:"h-8"})]}),e.jsx(Ie,{open:!!o,onOpenChange:m=>{m||d(null)},children:e.jsx(qe,{className:"max-w-4xl",children:e.jsx(Bs,{title:o?.name??"",description:o?.description??void 0,items:o?.items})})})]}):ne||E?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx(T,{className:"h-5 w-16 mb-1"}),e.jsx(T,{className:"h-3 w-20"})]}),e.jsx(T,{className:"h-9 w-24 rounded-full"})]}),e.jsxs("div",{className:"p-4",children:[e.jsx(T,{className:"h-10 w-full rounded-2xl mb-4"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:4}).map((m,j)=>e.jsx(V,{className:"rounded-2xl border-border",children:e.jsx(H,{children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(T,{className:"h-5 w-3/4 mb-2"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-4 w-16"}),e.jsx(T,{className:"h-4 w-16"}),e.jsx(T,{className:"h-4 w-12"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(T,{className:"h-9 w-9 rounded-full"}),e.jsx(T,{className:"h-9 w-9 rounded-full"}),e.jsx(T,{className:"h-9 w-9 rounded-full"}),e.jsx(T,{className:"h-9 w-9 rounded-full"})]})]})})},`skeleton-${j}`))})]})]}):me?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(ws,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:me instanceof Error?me.message:"Une erreur s'est produite"}),e.jsx(C,{onClick:()=>Ne(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:"Coach"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Création"})]}),e.jsxs("button",{type:"button",onClick:()=>{P(se()),I("compact"),i(!0)},className:"inline-flex items-center gap-2 rounded-full bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground",children:[e.jsx(ye,{className:"h-4 w-4"})," Nouvelle"]})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-2xl border border-border bg-card px-3 py-2",children:[e.jsx(Vr,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{className:"w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground",placeholder:"Rechercher une séance",value:f,onChange:m=>S(m.target.value)})]}),Z&&e.jsxs("div",{className:"mt-4 flex flex-col items-center rounded-lg border border-destructive/20 bg-destructive/10 p-4",children:[e.jsx(ws,{className:"h-8 w-8 text-destructive mb-2"}),e.jsx("p",{className:"text-sm text-destructive font-semibold",children:"Impossible de charger les assignations"}),e.jsx("p",{className:"text-xs text-destructive/80 mt-1",children:J instanceof Error?J.message:"Une erreur s'est produite"}),e.jsx(C,{variant:"outline",size:"sm",onClick:()=>W(),className:"mt-2",children:"Réessayer"})]}),e.jsx("div",{className:"mt-4 space-y-3",children:le.map(m=>{const{totalDistance:j,totalDuration:b,blockCount:M}=Pn(m),z=Dn(m.id,u??null),ce=!z||R.isPending;return e.jsx(V,{className:"rounded-2xl border-border",children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold tracking-tight",children:m.name}),e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Mr,{className:"h-3.5 w-3.5"}),j,"m"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ir,{className:"h-3.5 w-3.5"}),"~",b??"—"," min"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Tr,{className:"h-3.5 w-3.5"}),M]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>d(m),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Aperçu nageur",title:"Aperçu nageur",children:e.jsx(zs,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>{P({id:m.id??null,name:m.name??rt(new Date),description:m.description??"",estimatedDuration:Number(m.estimated_duration??0),blocks:En(m.items??[])}),I("compact"),i(!0)},className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Modifier",title:"Modifier",children:e.jsx(tn,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>p(m),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Archiver",title:"Archiver",children:e.jsx(Hr,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>{ce||h(m)},className:U("inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted",ce&&"cursor-not-allowed text-muted-foreground"),"aria-label":"Supprimer",title:u===null?"Suppression désactivée":z?"Supprimer":"Séance déjà assignée",children:e.jsx(we,{className:"h-4 w-4"})})]})]})})},m.id)})}),e.jsx("div",{className:"h-8"})]}),e.jsx(Ie,{open:!!o,onOpenChange:m=>{m||d(null)},children:e.jsx(qe,{className:"max-w-4xl",children:e.jsx(Bs,{title:o?.name??"",description:o?.description??void 0,items:o?.items})})}),e.jsx(ts,{open:!!x,onOpenChange:m=>{m||p(null)},children:e.jsxs(rs,{children:[e.jsxs(ns,{children:[e.jsx(as,{children:"Archiver la séance ?"}),e.jsx(is,{children:"La séance sera masquée du catalogue (sans suppression)."})]}),e.jsxs(ls,{children:[e.jsx(os,{children:"Annuler"}),e.jsx(cs,{onClick:()=>{x&&(re(m=>new Set([...Array.from(m),x.id])),p(null),s({title:"Séance archivée"}))},children:"Archiver"})]})]})}),e.jsx(ts,{open:!!v,onOpenChange:m=>{m||h(null)},children:e.jsxs(rs,{children:[e.jsxs(ns,{children:[e.jsx(as,{children:"Supprimer la séance ?"}),e.jsx(is,{children:"Cette action est définitive. La séance sera supprimée du catalogue."})]}),e.jsxs(ls,{children:[e.jsx(os,{children:"Annuler"}),e.jsx(cs,{onClick:()=>{v&&R.mutate(v.id)},children:"Supprimer"})]})]})})]})}function Tn(s,a,{checkForDefaultPrevented:r=!0}={}){return function(t){if(s?.(t),r===!1||!t.defaultPrevented)return a?.(t)}}var Fn=us[" useInsertionEffect ".trim().toString()]||ms;function $n({prop:s,defaultProp:a,onChange:r=()=>{},caller:n}){const[t,i,o]=Vn({defaultProp:a,onChange:r}),d=s!==void 0,v=d?s:t;{const x=c.useRef(s!==void 0);c.useEffect(()=>{const p=x.current;p!==d&&console.warn(`${n} is changing from ${p?"controlled":"uncontrolled"} to ${d?"controlled":"uncontrolled"}. Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.`),x.current=d},[d,n])}const h=c.useCallback(x=>{if(d){const p=In(x)?x(s):x;p!==s&&o.current?.(p)}else i(x)},[d,s,i,o]);return[v,h]}function Vn({defaultProp:s,onChange:a}){const[r,n]=c.useState(s),t=c.useRef(r),i=c.useRef(a);return Fn(()=>{i.current=a},[a]),c.useEffect(()=>{t.current!==r&&(i.current?.(r),t.current=r)},[r,t]),[r,n,i]}function In(s){return typeof s=="function"}var Dt="Toggle",Rs=c.forwardRef((s,a)=>{const{pressed:r,defaultPressed:n,onPressedChange:t,...i}=s,[o,d]=$n({prop:r,onChange:t,defaultProp:n??!1,caller:Dt});return e.jsx(be.button,{type:"button","aria-pressed":o,"data-state":o?"on":"off","data-disabled":s.disabled?"":void 0,...i,ref:a,onClick:Tn(s.onClick,()=>{s.disabled||d(!o)})})});Rs.displayName=Dt;var Mt=Rs,qn=us[" useInsertionEffect ".trim().toString()]||ms;function Tt({prop:s,defaultProp:a,onChange:r=()=>{},caller:n}){const[t,i,o]=On({defaultProp:a,onChange:r}),d=s!==void 0,v=d?s:t;{const x=c.useRef(s!==void 0);c.useEffect(()=>{const p=x.current;p!==d&&console.warn(`${n} is changing from ${p?"controlled":"uncontrolled"} to ${d?"controlled":"uncontrolled"}. Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.`),x.current=d},[d,n])}const h=c.useCallback(x=>{if(d){const p=zn(x)?x(s):x;p!==s&&o.current?.(p)}else i(x)},[d,s,i,o]);return[v,h]}function On({defaultProp:s,onChange:a}){const[r,n]=c.useState(s),t=c.useRef(r),i=c.useRef(a);return qn(()=>{i.current=a},[a]),c.useEffect(()=>{t.current!==r&&(i.current?.(r),t.current=r)},[r,t]),[r,n,i]}function zn(s){return typeof s=="function"}var _e="ToggleGroup",[Ft]=xs(_e,[ps]),$t=ps(),As=ge.forwardRef((s,a)=>{const{type:r,...n}=s;if(r==="single"){const t=n;return e.jsx(Gn,{...t,ref:a})}if(r==="multiple"){const t=n;return e.jsx(Ln,{...t,ref:a})}throw new Error(`Missing prop \`type\` expected on \`${_e}\``)});As.displayName=_e;var[Vt,It]=Ft(_e),Gn=ge.forwardRef((s,a)=>{const{value:r,defaultValue:n,onValueChange:t=()=>{},...i}=s,[o,d]=Tt({prop:r,defaultProp:n??"",onChange:t,caller:_e});return e.jsx(Vt,{scope:s.__scopeToggleGroup,type:"single",value:ge.useMemo(()=>o?[o]:[],[o]),onItemActivate:d,onItemDeactivate:ge.useCallback(()=>d(""),[d]),children:e.jsx(qt,{...i,ref:a})})}),Ln=ge.forwardRef((s,a)=>{const{value:r,defaultValue:n,onValueChange:t=()=>{},...i}=s,[o,d]=Tt({prop:r,defaultProp:n??[],onChange:t,caller:_e}),v=ge.useCallback(x=>d((p=[])=>[...p,x]),[d]),h=ge.useCallback(x=>d((p=[])=>p.filter(f=>f!==x)),[d]);return e.jsx(Vt,{scope:s.__scopeToggleGroup,type:"multiple",value:o,onItemActivate:v,onItemDeactivate:h,children:e.jsx(qt,{...i,ref:a})})});As.displayName=_e;var[Bn,Un]=Ft(_e),qt=ge.forwardRef((s,a)=>{const{__scopeToggleGroup:r,disabled:n=!1,rovingFocus:t=!0,orientation:i,dir:o,loop:d=!0,...v}=s,h=$t(r),x=dt(o),p={role:"group",dir:x,...v};return e.jsx(Bn,{scope:r,rovingFocus:t,disabled:n,children:t?e.jsx(ut,{asChild:!0,...h,orientation:i,dir:x,loop:d,children:e.jsx(be.div,{...p,ref:a})}):e.jsx(be.div,{...p,ref:a})})}),ds="ToggleGroupItem",Ot=ge.forwardRef((s,a)=>{const r=It(ds,s.__scopeToggleGroup),n=Un(ds,s.__scopeToggleGroup),t=$t(s.__scopeToggleGroup),i=r.value.includes(s.value),o=n.disabled||s.disabled,d={...s,pressed:i,disabled:o},v=ge.useRef(null);return n.rovingFocus?e.jsx(mt,{asChild:!0,...t,focusable:!o,active:i,ref:v,children:e.jsx(ot,{...d,ref:a})}):e.jsx(ot,{...d,ref:a})});Ot.displayName=ds;var ot=ge.forwardRef((s,a)=>{const{__scopeToggleGroup:r,value:n,...t}=s,i=It(ds,r),o={role:"radio","aria-checked":s.pressed,"aria-pressed":void 0},d=i.type==="single"?o:void 0;return e.jsx(Rs,{...d,...t,ref:a,onPressedChange:v=>{v?i.onItemActivate(n):i.onItemDeactivate(n)}})}),zt=As,Gt=Ot;const Lt=yr("inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",{variants:{variant:{default:"bg-transparent",outline:"border border-input bg-transparent shadow-sm hover:bg-accent hover:text-accent-foreground"},size:{default:"h-9 px-2 min-w-9",sm:"h-8 px-1.5 min-w-8",lg:"h-10 px-2.5 min-w-10"}},defaultVariants:{variant:"default",size:"default"}}),Kn=c.forwardRef(({className:s,variant:a,size:r,...n},t)=>e.jsx(Mt,{ref:t,className:U(Lt({variant:a,size:r,className:s})),...n}));Kn.displayName=Mt.displayName;const Bt=c.createContext({size:"default",variant:"default"}),Ut=c.forwardRef(({className:s,variant:a,size:r,children:n,...t},i)=>e.jsx(zt,{ref:i,className:U("flex items-center justify-center gap-1",s),...t,children:e.jsx(Bt.Provider,{value:{variant:a,size:r},children:n})}));Ut.displayName=zt.displayName;const ss=c.forwardRef(({className:s,children:a,variant:r,size:n,...t},i)=>{const o=c.useContext(Bt);return e.jsx(Gt,{ref:i,className:U(Lt({variant:o.variant||r,size:o.size||n}),s),...t,children:a})});ss.displayName=Gt.displayName;const Oe=({title:s,description:a,onBack:r,actions:n})=>e.jsxs("div",{className:"flex flex-wrap items-start justify-between gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs(C,{variant:"ghost",size:"sm",className:"-ml-2",onClick:r,children:[e.jsx(Lr,{className:"mr-2 h-4 w-4"}),"Retour à l'accueil"]}),e.jsx("h2",{className:"text-2xl font-display font-semibold uppercase italic text-primary",children:s}),a?e.jsx("p",{className:"text-sm text-muted-foreground",children:a}):null]}),n?e.jsx("div",{className:"flex items-center gap-2",children:n}):null]});function ze(s,a,{checkForDefaultPrevented:r=!0}={}){return function(t){if(s?.(t),r===!1||!t.defaultPrevented)return a?.(t)}}function Hn(s){const a=Wn(s),r=c.forwardRef((n,t)=>{const{children:i,...o}=n,d=c.Children.toArray(i),v=d.find(Jn);if(v){const h=v.props.children,x=d.map(p=>p===v?c.Children.count(h)>1?c.Children.only(null):c.isValidElement(h)?h.props.children:null:p);return e.jsx(a,{...o,ref:t,children:c.isValidElement(h)?c.cloneElement(h,void 0,x):null})}return e.jsx(a,{...o,ref:t,children:i})});return r.displayName=`${s}.Slot`,r}function Wn(s){const a=c.forwardRef((r,n)=>{const{children:t,...i}=r;if(c.isValidElement(t)){const o=Yn(t),d=Xn(i,t.props);return t.type!==c.Fragment&&(d.ref=n?cr(n,o):o),c.cloneElement(t,d)}return c.Children.count(t)>1?c.Children.only(null):null});return a.displayName=`${s}.SlotClone`,a}var Qn=Symbol("radix.slottable");function Jn(s){return c.isValidElement(s)&&typeof s.type=="function"&&"__radixId"in s.type&&s.type.__radixId===Qn}function Xn(s,a){const r={...a};for(const n in a){const t=s[n],i=a[n];/^on[A-Z]/.test(n)?t&&i?r[n]=(...d)=>{const v=i(...d);return t(...d),v}:t&&(r[n]=t):n==="style"?r[n]={...t,...i}:n==="className"&&(r[n]=[t,i].filter(Boolean).join(" "))}return{...s,...r}}function Yn(s){let a=Object.getOwnPropertyDescriptor(s.props,"ref")?.get,r=a&&"isReactWarning"in a&&a.isReactWarning;return r?s.ref:(a=Object.getOwnPropertyDescriptor(s,"ref")?.get,r=a&&"isReactWarning"in a&&a.isReactWarning,r?s.props.ref:s.props.ref||s.ref)}var Zn=us[" useInsertionEffect ".trim().toString()]||ms;function ea({prop:s,defaultProp:a,onChange:r=()=>{},caller:n}){const[t,i,o]=sa({defaultProp:a,onChange:r}),d=s!==void 0,v=d?s:t;{const x=c.useRef(s!==void 0);c.useEffect(()=>{const p=x.current;p!==d&&console.warn(`${n} is changing from ${p?"controlled":"uncontrolled"} to ${d?"controlled":"uncontrolled"}. Components should not switch from controlled to uncontrolled (or vice versa). Decide between using a controlled or uncontrolled value for the lifetime of the component.`),x.current=d},[d,n])}const h=c.useCallback(x=>{if(d){const p=ta(x)?x(s):x;p!==s&&o.current?.(p)}else i(x)},[d,s,i,o]);return[v,h]}function sa({defaultProp:s,onChange:a}){const[r,n]=c.useState(s),t=c.useRef(r),i=c.useRef(a);return Zn(()=>{i.current=a},[a]),c.useEffect(()=>{t.current!==r&&(i.current?.(r),t.current=r)},[r,t]),[r,n,i]}function ta(s){return typeof s=="function"}var gs="Popover",[Kt]=xs(gs,[pt]),Ke=pt(),[ra,Ce]=Kt(gs),Ht=s=>{const{__scopePopover:a,children:r,open:n,defaultOpen:t,onOpenChange:i,modal:o=!1}=s,d=Ke(a),v=c.useRef(null),[h,x]=c.useState(!1),[p,f]=ea({prop:n,defaultProp:t??!1,onChange:i,caller:gs});return e.jsx(dr,{...d,children:e.jsx(ra,{scope:a,contentId:ur(),triggerRef:v,open:p,onOpenChange:f,onOpenToggle:c.useCallback(()=>f(S=>!S),[f]),hasCustomAnchor:h,onCustomAnchorAdd:c.useCallback(()=>x(!0),[]),onCustomAnchorRemove:c.useCallback(()=>x(!1),[]),modal:o,children:r})})};Ht.displayName=gs;var Wt="PopoverAnchor",na=c.forwardRef((s,a)=>{const{__scopePopover:r,...n}=s,t=Ce(Wt,r),i=Ke(r),{onCustomAnchorAdd:o,onCustomAnchorRemove:d}=t;return c.useEffect(()=>(o(),()=>d()),[o,d]),e.jsx(xt,{...i,...n,ref:a})});na.displayName=Wt;var Qt="PopoverTrigger",Jt=c.forwardRef((s,a)=>{const{__scopePopover:r,...n}=s,t=Ce(Qt,r),i=Ke(r),o=Be(a,t.triggerRef),d=e.jsx(be.button,{type:"button","aria-haspopup":"dialog","aria-expanded":t.open,"aria-controls":t.contentId,"data-state":sr(t.open),...n,ref:o,onClick:ze(s.onClick,t.onOpenToggle)});return t.hasCustomAnchor?d:e.jsx(xt,{asChild:!0,...i,children:d})});Jt.displayName=Qt;var Ps="PopoverPortal",[aa,ia]=Kt(Ps,{forceMount:void 0}),Xt=s=>{const{__scopePopover:a,forceMount:r,children:n,container:t}=s,i=Ce(Ps,a);return e.jsx(aa,{scope:a,forceMount:r,children:e.jsx(Ss,{present:r||i.open,children:e.jsx(mr,{asChild:!0,container:t,children:n})})})};Xt.displayName=Ps;var De="PopoverContent",Yt=c.forwardRef((s,a)=>{const r=ia(De,s.__scopePopover),{forceMount:n=r.forceMount,...t}=s,i=Ce(De,s.__scopePopover);return e.jsx(Ss,{present:n||i.open,children:i.modal?e.jsx(oa,{...t,ref:a}):e.jsx(ca,{...t,ref:a})})});Yt.displayName=De;var la=Hn("PopoverContent.RemoveScroll"),oa=c.forwardRef((s,a)=>{const r=Ce(De,s.__scopePopover),n=c.useRef(null),t=Be(a,n),i=c.useRef(!1);return c.useEffect(()=>{const o=n.current;if(o)return pr(o)},[]),e.jsx(xr,{as:la,allowPinchZoom:!0,children:e.jsx(Zt,{...s,ref:t,trapFocus:r.open,disableOutsidePointerEvents:!0,onCloseAutoFocus:ze(s.onCloseAutoFocus,o=>{o.preventDefault(),i.current||r.triggerRef.current?.focus()}),onPointerDownOutside:ze(s.onPointerDownOutside,o=>{const d=o.detail.originalEvent,v=d.button===0&&d.ctrlKey===!0,h=d.button===2||v;i.current=h},{checkForDefaultPrevented:!1}),onFocusOutside:ze(s.onFocusOutside,o=>o.preventDefault(),{checkForDefaultPrevented:!1})})})}),ca=c.forwardRef((s,a)=>{const r=Ce(De,s.__scopePopover),n=c.useRef(!1),t=c.useRef(!1);return e.jsx(Zt,{...s,ref:a,trapFocus:!1,disableOutsidePointerEvents:!1,onCloseAutoFocus:i=>{s.onCloseAutoFocus?.(i),i.defaultPrevented||(n.current||r.triggerRef.current?.focus(),i.preventDefault()),n.current=!1,t.current=!1},onInteractOutside:i=>{s.onInteractOutside?.(i),i.defaultPrevented||(n.current=!0,i.detail.originalEvent.type==="pointerdown"&&(t.current=!0));const o=i.target;r.triggerRef.current?.contains(o)&&i.preventDefault(),i.detail.originalEvent.type==="focusin"&&t.current&&i.preventDefault()}})}),Zt=c.forwardRef((s,a)=>{const{__scopePopover:r,trapFocus:n,onOpenAutoFocus:t,onCloseAutoFocus:i,disableOutsidePointerEvents:o,onEscapeKeyDown:d,onPointerDownOutside:v,onFocusOutside:h,onInteractOutside:x,...p}=s,f=Ce(De,r),S=Ke(r);return hr(),e.jsx(fr,{asChild:!0,loop:!0,trapped:n,onMountAutoFocus:t,onUnmountAutoFocus:i,children:e.jsx(gr,{asChild:!0,disableOutsidePointerEvents:o,onInteractOutside:x,onEscapeKeyDown:d,onPointerDownOutside:v,onFocusOutside:h,onDismiss:()=>f.onOpenChange(!1),children:e.jsx(jr,{"data-state":sr(f.open),role:"dialog",id:f.contentId,...S,...p,ref:a,style:{...p.style,"--radix-popover-content-transform-origin":"var(--radix-popper-transform-origin)","--radix-popover-content-available-width":"var(--radix-popper-available-width)","--radix-popover-content-available-height":"var(--radix-popper-available-height)","--radix-popover-trigger-width":"var(--radix-popper-anchor-width)","--radix-popover-trigger-height":"var(--radix-popper-anchor-height)"}})})})}),er="PopoverClose",da=c.forwardRef((s,a)=>{const{__scopePopover:r,...n}=s,t=Ce(er,r);return e.jsx(be.button,{type:"button",...n,ref:a,onClick:ze(s.onClick,()=>t.onOpenChange(!1))})});da.displayName=er;var ua="PopoverArrow",ma=c.forwardRef((s,a)=>{const{__scopePopover:r,...n}=s,t=Ke(r);return e.jsx(vr,{...t,...n,ref:a})});ma.displayName=ua;function sr(s){return s?"open":"closed"}var pa=Ht,xa=Jt,ha=Xt,tr=Yt;const fa=pa,ga=xa,rr=c.forwardRef(({className:s,align:a="center",sideOffset:r=4,...n},t)=>e.jsx(ha,{children:e.jsx(tr,{ref:t,align:a,sideOffset:r,className:U("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]",s),...n})}));rr.displayName=tr.displayName;const ja=({onBack:s,swimSessions:a,strengthSessions:r,athletes:n,groups:t})=>{const{toast:i}=Ue(),[o,d]=c.useState({session_type:"swim",session_id:"",assigned_date:new Date().toISOString().split("T")[0],assigned_slot:"morning"}),[v,h]=c.useState(!1),[x,p]=c.useState("user"),[f,S]=c.useState(""),[N,I]=c.useState([]),y=u=>{const E=typeof u=="number"?u:Number(u);return Number.isFinite(E)&&E>0?E:null},re=c.useMemo(()=>n.map(u=>({value:u.id?`id:${u.id}`:`name:${u.display_name}`,label:u.group_label?`${u.display_name} · ${u.group_label}`:u.display_name,id:u.id,name:u.display_name})),[n]),se=c.useMemo(()=>new Map(re.map(u=>[u.value,u])),[re]),w=c.useMemo(()=>t.map(u=>{const E=y(u.id);return E?{...u,gid:E}:null}).filter(u=>!!u),[t]),P=c.useMemo(()=>w.filter(u=>N.includes(u.gid)),[w,N]),ue=c.useMemo(()=>{if(P.length===0)return"Choisir des groupes";const u=P.slice(0,2).map(Z=>Z.name).join(", "),E=P.length>2?` +${P.length-2}`:"";return`${u}${E}`},[P]),ne=de({mutationFn:async u=>$.assignments_create(u),onSuccess:()=>{i({title:"Séance assignée & notifiée"})},onError:u=>{const E="Impossible d'assigner la séance. Vérifiez les champs et réessayez.",Z=u instanceof Error?u.message:typeof u=="string"?u:E;let J=Z;const W=Z.match(/HTTP \d+:\s*(\{.*\})/);if(W)try{J=JSON.parse(W[1])?.error||E}catch{J=E}i({title:"Erreur d'assignation",description:J})}}),me=async()=>{const u=Number(o.session_id);if(!Number.isInteger(u)||u<=0){i({title:"Séance invalide",description:"Sélectionnez une séance valide."});return}if(x==="group"){if(N.length===0){i({title:"Groupe manquant",description:"Sélectionnez au moins un groupe."});return}h(!0);try{const Q={assignment_type:o.session_type,session_id:u,scheduled_date:o.assigned_date,scheduled_slot:o.assigned_slot},le=Array.from(new Set(N));await Promise.all(le.map(q=>$.assignments_create({...Q,target_group_id:q}))),i({title:"Séance assignée & notifiée"})}catch(Q){const le="Impossible d'assigner la séance. Vérifiez les champs et réessayez.",q=Q instanceof Error?Q.message:typeof Q=="string"?Q:le;let R=q;const B=q.match(/HTTP \d+:\s*(\{.*\})/);if(B)try{R=JSON.parse(B[1])?.error||le}catch{R=le}i({title:"Erreur d'assignation",description:R})}finally{h(!1)}return}const E=f.trim();if(!E){i({title:"Nageur manquant",description:"Sélectionnez un nageur."});return}const Z=se.get(E),J=Z?.id??(Number.isFinite(Number(E))&&Number(E)>0?Number(E):void 0);if(!Number.isFinite(J)||Number(J)<=0){i({title:"Nageur invalide",description:"Sélectionnez un nageur avec un identifiant valide."});return}const W=Z?.name??E.replace(/^name:/,"");ne.mutate({assignment_type:o.session_type,session_id:u,target_athlete:W,target_user_id:J,scheduled_date:o.assigned_date,scheduled_slot:o.assigned_slot})},Ne=!o.session_id||(x==="group"?N.length===0:!f.trim())||ne.isPending||v;return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(Oe,{title:"Assigner une séance",description:"Planifiez une séance pour un nageur ou un ou plusieurs groupes.",onBack:s}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs(V,{className:"border-l-4 border-l-primary",children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Séance"}),e.jsx(ee,{children:"Choisissez le type et la séance à envoyer."})]}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Type"}),e.jsxs(pe,{value:o.session_type,onValueChange:u=>d({...o,session_type:u,session_id:""}),children:[e.jsx(xe,{children:e.jsx(he,{})}),e.jsxs(fe,{children:[e.jsx(G,{value:"swim",children:"Natation"}),e.jsx(G,{value:"strength",children:"Musculation"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Séance"}),e.jsxs(pe,{value:o.session_id,onValueChange:u=>d({...o,session_id:u}),children:[e.jsx(xe,{children:e.jsx(he,{placeholder:"Choisir..."})}),e.jsx(fe,{children:o.session_type==="swim"?a?.map(u=>e.jsx(G,{value:u.id.toString(),children:u.name},u.id)):r?.map(u=>e.jsx(G,{value:u.id.toString(),children:u.title},u.id))})]})]})]})]}),e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Cible & planification"}),e.jsx(ee,{children:"Définissez le destinataire, la date et le créneau."})]}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Cible"}),e.jsxs(pe,{value:x,onValueChange:u=>{p(u),S(""),I([])},children:[e.jsx(xe,{children:e.jsx(he,{})}),e.jsxs(fe,{children:[e.jsx(G,{value:"user",children:"Nageur"}),e.jsx(G,{value:"group",children:"Groupe(s)"})]})]})]}),x==="user"?e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Nageur"}),re.length>0?e.jsxs(pe,{value:f,onValueChange:S,children:[e.jsx(xe,{children:e.jsx(he,{placeholder:"Choisir un nageur"})}),e.jsx(fe,{children:re.map(u=>e.jsx(G,{value:u.value,children:u.label},u.value))})]}):e.jsx(F,{value:f,onChange:u=>S(u.target.value),placeholder:"ex: Camille"})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Groupes"}),t.length>0?e.jsxs(fa,{children:[e.jsx(ga,{asChild:!0,children:e.jsxs(C,{type:"button",variant:"outline",className:"w-full justify-between","aria-label":"Sélection des groupes",children:[e.jsx("span",{className:"truncate",children:ue}),e.jsx(Br,{className:"ml-2 h-4 w-4 opacity-50"})]})}),e.jsxs(rr,{className:"w-[--radix-popover-trigger-width] p-2",align:"start",children:[e.jsx("div",{className:"max-h-64 overflow-auto",children:e.jsx("div",{className:"space-y-1",children:w.map(u=>{const E=N.includes(u.gid);return e.jsxs("label",{className:"flex cursor-pointer items-center gap-2 rounded-md px-2 py-1.5 hover:bg-muted",children:[e.jsx(Ns,{checked:E,onCheckedChange:Z=>{const J=Z===!0;I(W=>J?W.includes(u.gid)?W:[...W,u.gid]:W.filter(Q=>Q!==u.gid))}}),e.jsx("span",{className:"text-sm",children:u.name})]},u.gid)})})}),N.length>0?e.jsx(C,{type:"button",variant:"ghost",size:"sm",className:"mt-2 w-full",onClick:()=>I([]),children:"Tout désélectionner"}):null]})]}):e.jsx("div",{className:"text-xs text-muted-foreground",children:"Aucun groupe disponible."}),N.length>0?e.jsxs("div",{className:"text-xs text-muted-foreground",children:[N.length," groupe",N.length>1?"s":""," sélectionné",N.length>1?"s":"","."]}):null]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Date"}),e.jsx(F,{type:"date",value:o.assigned_date,onChange:u=>d({...o,assigned_date:u.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Créneau"}),e.jsxs(pe,{value:o.assigned_slot,onValueChange:u=>d({...o,assigned_slot:u}),children:[e.jsx(xe,{children:e.jsx(he,{placeholder:"Choisir..."})}),e.jsxs(fe,{children:[e.jsx(G,{value:"morning",children:"Matin"}),e.jsx(G,{value:"evening",children:"Soir"})]})]})]})]})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsxs(C,{className:"w-full sm:w-auto",onClick:me,disabled:Ne,children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"}),ne.isPending||v?"Assignation...":"Assigner & notifier"]})})]})},va=({onBack:s,athletes:a,groups:r,athletesLoading:n})=>{const{toast:t}=Ue(),[i,o]=c.useState(""),[d,v]=c.useState("Message Coach"),[h,x]=c.useState(""),p=c.useMemo(()=>a.filter(y=>y.id).map(y=>({value:`user:${y.id}`,label:y.group_label?`${y.display_name} · ${y.group_label}`:y.display_name,id:y.id})),[a]),f=c.useMemo(()=>r.map(y=>({value:`group:${y.id}`,label:y.name,id:y.id})),[r]),S=c.useMemo(()=>new Map([...p,...f].map(y=>[y.value,y])),[p,f]),N=de({mutationFn:y=>$.notifications_send({...y,type:"message"}),onSuccess:()=>{t({title:"Message envoyé"}),o("")}}),I=()=>{if(!d.trim()||!i.trim()){t({title:"Message incomplet",description:"Ajoutez un titre et un contenu."});return}if(!h){t({title:"Destinataire manquant",description:"Sélectionnez un nageur ou un groupe."});return}const y=S.get(h);if(!y?.id){t({title:"Destinataire invalide",description:"Sélectionnez un destinataire valide."});return}if(h.startsWith("group:")){N.mutate({title:d,body:i,targets:[{target_group_id:y.id}]});return}N.mutate({title:d,body:i,targets:[{target_user_id:y.id}]})};return e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx(Oe,{title:"Messagerie rapide",description:"Envoyez un message ciblé à vos nageurs.",onBack:s}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs(V,{className:"border-l-4 border-l-primary",children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Destinataire"}),e.jsx(ee,{children:"Sélectionnez un nageur ou un groupe à prévenir."})]}),e.jsx(K,{className:"space-y-4",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{children:"Destinataire"}),e.jsxs(pe,{value:h,onValueChange:x,children:[e.jsx(xe,{children:e.jsx(he,{placeholder:n?"Chargement...":"Choisir un nageur ou un groupe"})}),e.jsxs(fe,{children:[f.length?e.jsxs(e.Fragment,{children:[e.jsx(G,{value:"section-group",disabled:!0,children:"Groupes"}),f.map(y=>e.jsx(G,{value:y.value,children:y.label},y.value))]}):null,p.length?e.jsxs(e.Fragment,{children:[e.jsx(G,{value:"section-athlete",disabled:!0,children:"Nageurs"}),p.map(y=>e.jsx(G,{value:y.value,children:y.label},y.value))]}):null]})]})]})})]}),e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Contenu"}),e.jsx(ee,{children:"Rédigez votre message en quelques lignes."})]}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"msg-title",children:"Titre"}),e.jsx(F,{id:"msg-title",value:d,onChange:y=>v(y.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(k,{htmlFor:"msg-body",children:"Message"}),e.jsx(Ve,{id:"msg-body",placeholder:"Message...",value:i,onChange:y=>o(y.target.value),rows:5,maxLength:500}),e.jsxs("div",{className:"text-xs text-muted-foreground text-right",children:[i.length,"/500"]})]})]})]})]}),e.jsx("div",{className:"sticky bottom-0 z-10 -mx-4 border-t bg-background/95 p-4 backdrop-blur sm:static sm:mx-0 sm:border-0 sm:p-0",children:e.jsxs(C,{className:"w-full sm:w-auto",onClick:I,disabled:N.isPending,children:[e.jsx(hs,{className:"mr-2 h-4 w-4"}),N.isPending?"Envoi...":"Envoyer"]})})]})},ya=({onNavigate:s})=>e.jsxs(V,{className:"border-l-4 border-l-primary",children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Actions rapides"}),e.jsx(ee,{children:"Accélérez vos tâches les plus fréquentes."})]}),e.jsxs(K,{className:"grid gap-3 sm:grid-cols-2",children:[e.jsxs(C,{className:"justify-start",variant:"outline",onClick:()=>s("assignments"),children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"}),"Assigner une séance"]}),e.jsxs(C,{className:"justify-start",variant:"outline",onClick:()=>s("messaging"),children:[e.jsx(hs,{className:"mr-2 h-4 w-4"}),"Message rapide"]})]})]}),ba=({onNavigate:s,onOpenRecordsAdmin:a,athletes:r,athletesLoading:n,upcomingBirthdays:t,birthdaysLoading:i,kpiLoading:o,kpiPeriod:d,onKpiPeriodChange:v,fatigueAlerts:h,mostLoadedAthlete:x})=>e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Espace Coach"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Votre tableau de bord pour gérer les séances, les nageurs et la communication."})]}),e.jsxs("div",{className:"space-y-3 sm:hidden",children:[e.jsx("div",{children:e.jsx("h2",{className:"text-sm font-semibold uppercase tracking-[0.2em] text-muted-foreground",children:"Par où commencer"})}),e.jsxs("div",{className:"grid gap-3",children:[e.jsx("button",{type:"button",onClick:()=>s("swim"),className:"rounded-xl border bg-white p-4 text-left shadow-sm transition hover:border-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:"Créer une séance natation"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Structurer un nouveau plan."})]}),e.jsx(qs,{className:"h-5 w-5 text-primary"})]})}),e.jsx("button",{type:"button",onClick:()=>s("assignments"),className:"rounded-xl border bg-white p-4 text-left shadow-sm transition hover:border-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:"Assigner une séance"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Envoyer une séance à un nageur."})]}),e.jsx(Ge,{className:"h-5 w-5 text-primary"})]})}),e.jsx("button",{type:"button",onClick:()=>s("messaging"),className:"rounded-xl border bg-white p-4 text-left shadow-sm transition hover:border-primary focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold",children:"Envoyer un message"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Relancer ou féliciter un nageur."})]}),e.jsx(hs,{className:"h-5 w-5 text-primary"})]})})]})]}),e.jsx("div",{className:"hidden sm:block",children:e.jsx(ya,{onNavigate:s})}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs(V,{className:"shadow-sm",children:[e.jsxs(H,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(qs,{className:"h-5 w-5 text-primary"}),"Natation"]}),e.jsx(ee,{children:"Consultez et créez des séances natation."})]}),e.jsx(K,{children:e.jsx(C,{className:"w-full",onClick:()=>s("swim"),children:"Accéder à la bibliothèque"})})]}),e.jsxs(V,{className:"shadow-sm",children:[e.jsxs(H,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(Nr,{className:"h-5 w-5 text-primary"}),"Musculation"]}),e.jsx(ee,{children:"Préparez les plans muscu et les suivis."})]}),e.jsx(K,{children:e.jsx(C,{className:"w-full",onClick:()=>s("strength"),children:"Accéder à la bibliothèque"})})]}),e.jsxs(V,{className:"shadow-sm",children:[e.jsxs(H,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"h-5 w-5 text-primary"}),"Mes nageurs"]}),e.jsx(ee,{children:"Accédez aux fiches individuelles et aux groupes."})]}),e.jsx(K,{children:e.jsx(C,{className:"w-full",onClick:()=>s("swimmers"),children:"Voir les nageurs"})})]}),e.jsxs(V,{className:"shadow-sm",children:[e.jsxs(H,{children:[e.jsxs(Y,{className:"flex items-center gap-2",children:[e.jsx(wr,{className:"h-5 w-5 text-primary"}),"Records club"]}),e.jsx(ee,{children:"Importer les performances FFN et reconstruire les records."})]}),e.jsxs(K,{children:[e.jsx(C,{className:"w-full",variant:"outline",onClick:a,children:"Administration des records"}),e.jsx(C,{className:"w-full mt-2",variant:"outline",onClick:()=>{window.location.hash="#/records-club"},children:"Voir les records du club"})]})]})]}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[e.jsxs(V,{className:"sm:hidden bg-primary text-primary-foreground",children:[e.jsxs(H,{className:"space-y-1",children:[e.jsx(Y,{className:"text-base",children:"Indicateurs clés"}),e.jsx(ee,{className:"text-primary-foreground/70",children:"Synthèse rapide pour aujourd'hui."})]}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-lg border border-primary-foreground/10 bg-primary-foreground/5 p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-primary-foreground/70",children:"Fatigue 5/5"}),e.jsx("p",{className:"text-2xl font-semibold",children:o?"…":h.length}),e.jsx("p",{className:"text-xs text-primary-foreground/70",children:o?"Chargement...":h.length?h.slice(0,2).map(p=>p.athleteName).join(", "):"Aucune alerte"})]}),e.jsx(Ws,{className:"h-5 w-5 text-primary-foreground/70"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-lg border border-primary-foreground/10 bg-primary-foreground/5 p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.2em] text-primary-foreground/70",children:"Nageur le plus chargé"}),e.jsx("p",{className:"text-lg font-semibold",children:o?"…":x?.athleteName??"-"}),e.jsx("p",{className:"text-xs text-primary-foreground/70",children:o?"Calcul en cours":x?`Charge ${Math.round(x.loadScore)}`:"Pas de données récentes"})]}),e.jsx(Ze,{className:"h-5 w-5 text-primary-foreground/70"})]})]})]}),e.jsxs(V,{className:"hidden sm:block",children:[e.jsx(H,{className:"space-y-2",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Y,{children:"Signaux clés"}),e.jsx(ee,{children:"Vue d'ensemble rapide de votre groupe."})]}),e.jsxs(Ut,{type:"single",size:"sm",variant:"outline",value:String(d),onValueChange:p=>{p&&v(Number(p))},children:[e.jsx(ss,{value:"7","aria-label":"Période 7 jours","aria-pressed":d===7,children:"7j"}),e.jsx(ss,{value:"30","aria-label":"Période 30 jours","aria-pressed":d===30,children:"30j"}),e.jsx(ss,{value:"365","aria-label":"Période 365 jours","aria-pressed":d===365,children:"365j"})]})]})}),e.jsxs(K,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-lg border bg-muted/30 p-3",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Fatigue 5/5 (",d,"j)"]}),e.jsx("p",{className:"text-xl font-semibold",children:o?"…":h.length}),e.jsx("p",{className:"text-xs text-muted-foreground",children:o?"Chargement...":h.length?h.slice(0,2).map(p=>p.athleteName).join(", "):"Aucune alerte"})]}),e.jsx(Ws,{className:"h-5 w-5 text-muted-foreground"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-lg border bg-muted/30 p-3",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Nageur le plus chargé (",d,"j)"]}),e.jsx("p",{className:"text-xl font-semibold",children:o?"…":x?.athleteName??"-"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:o?"Calcul en cours":x?`Charge ${Math.round(x.loadScore)}`:"Pas de données récentes"})]}),e.jsx(Ze,{className:"h-5 w-5 text-muted-foreground"})]})]})]}),e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Anniversaires à venir"}),e.jsx(ee,{children:"Les 30 prochains jours."})]}),e.jsxs(K,{className:"space-y-3",children:[i?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Chargement..."}):t&&t.length>0?t.slice(0,3).map(p=>e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:p.display_name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:Na(p.next_birthday)})]}),e.jsxs("span",{className:"text-xs font-semibold text-primary",children:["J-",p.days_until]})]},p.id)):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun anniversaire dans les 30 prochains jours."}),e.jsx(C,{variant:"outline",className:"w-full",onClick:()=>s("swimmers"),children:"Voir tous les nageurs"})]})]})]})]}),Na=s=>{if(!s)return"-";const a=new Date(s);return Number.isNaN(a.getTime())?s:a.toLocaleDateString("fr-FR")},ct=s=>s.toISOString().split("T")[0],wa=s=>new Date(s.completed_at||s.started_at||s.date||s.created_at||0).getTime(),_a=s=>{if(!s.length)return null;const a=s.reduce((n,t)=>n+t,0)/s.length,r=Math.min(5,Math.max(1,Math.round(a/10*5)));return{average:a,rating:r}};function ei(){const s=Ye(u=>u.role);Ye(u=>u.selectedAthleteId);const a=Ye(u=>u.setSelectedAthlete),[,r]=br(),[n,t]=c.useState("home"),[i,o]=c.useState(7),d=s==="coach"||s==="admin",v=n==="assignments",h=n==="home"||n==="assignments"||n==="messaging"||n==="swimmers",x=n==="assignments"||n==="messaging",p=n==="home"||n==="swimmers",{data:f}=je({queryKey:["swim_catalog"],queryFn:()=>$.getSwimCatalog(),enabled:d&&v}),{data:S}=je({queryKey:["strength_catalog"],queryFn:()=>$.getStrengthSessions(),enabled:d&&v}),{data:N=[],isLoading:I}=je({queryKey:["athletes"],queryFn:()=>$.getAthletes(),enabled:d&&h}),y=c.useMemo(()=>N.slice(0,5),[N]),{data:re=[]}=je({queryKey:["groups"],queryFn:()=>$.getGroups(),enabled:d&&x}),se=je({queryKey:["upcoming-birthdays"],queryFn:()=>$.getUpcomingBirthdays({days:30}),enabled:d&&p}),w=se.data,P=je({queryKey:["coach-kpis",i,y.map(u=>u.id??u.display_name)],enabled:d&&n==="home"&&y.length>0,queryFn:async()=>{const u=i,E=new Date;E.setDate(E.getDate()-u);const Z=ct(E),J=ct(new Date),W=await Promise.all(y.map(async q=>{const[R,B]=await Promise.all([$.getSessions(q.display_name,q.id),$.getStrengthHistory(q.display_name,{athleteId:q.id,limit:50,from:Z,to:J})]),O=R.filter(D=>new Date(D.date).getTime()>=E.getTime()),ae=O.map(D=>D.fatigue??D.feeling).filter(D=>Number.isFinite(D)),ie=O.reduce((D,oe)=>D+(Number(oe.duration)||0)*(Number(oe.effort)||0),0),te=(B?.runs??[]).filter(D=>wa(D)>=E.getTime()),Te=te.map(D=>D.fatigue??D.feeling??D.rpe).filter(D=>Number.isFinite(Number(D))).map(D=>Number(D)),Fe=te.reduce((D,oe)=>{const Ee=Number(oe.feeling??oe.rpe??0),Re=Number(oe.duration??0);if(Re>0&&Ee>0)return D+Re*Ee;const Ae=Array.isArray(oe.logs)?oe.logs.length:0;return D+Ae*5},0),ke=_a([...ae,...Te]);return{athleteName:q.display_name,loadScore:ie+Fe,fatigueRating:ke}})),Q=W.filter(q=>q.fatigueRating?.rating===5).map(q=>({athleteName:q.athleteName,rating:q.fatigueRating?.rating??0})),le=W.filter(q=>q.loadScore>0).sort((q,R)=>R.loadScore-q.loadScore)[0];return{fatigueAlerts:Q,mostLoadedAthlete:le??null}}}),ue=u=>{a({id:u.id??null,name:u.display_name}),r("/progress")},{toast:ne}=Ue(),me=ks(),Ne=de({mutationFn:async u=>{const E=await $.importSingleSwimmer(u.iuf,u.name);return await $.recalculateClubRecords(),E},onSuccess:u=>{ne({title:"Import terminé",description:`${u.total_found} trouvées, ${u.new_imported} nouvelles.`}),me.invalidateQueries({queryKey:["club-records"]})},onError:u=>{ne({title:"Erreur import",description:u.message,variant:"destructive"})}});return d?e.jsxs("div",{className:"space-y-6",children:[n==="home"?e.jsx(ba,{onNavigate:t,onOpenRecordsAdmin:()=>r("/records-admin"),athletes:N,athletesLoading:I,upcomingBirthdays:w,birthdaysLoading:se.isLoading,kpiLoading:P.isLoading,kpiPeriod:i,onKpiPeriodChange:o,fatigueAlerts:P.data?.fatigueAlerts??[],mostLoadedAthlete:P.data?.mostLoadedAthlete??null}):null,n==="assignments"?e.jsx(ja,{onBack:()=>t("home"),swimSessions:f,strengthSessions:S,athletes:N,groups:re}):null,n==="swim"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Oe,{title:"Bibliothèque natation",description:"Accédez aux séances et aux templates natation.",onBack:()=>t("home"),actions:e.jsxs(C,{variant:"outline",onClick:()=>t("assignments"),children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"}),"Nouvelle assignation"]})}),e.jsx(Mn,{})]}):null,n==="strength"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Oe,{title:"Bibliothèque musculation",description:"Consultez et créez des séances musculation.",onBack:()=>t("home"),actions:e.jsxs(C,{variant:"outline",onClick:()=>t("assignments"),children:[e.jsx(Ge,{className:"mr-2 h-4 w-4"}),"Nouvelle assignation"]})}),e.jsx(Nn,{})]}):null,n==="swimmers"?e.jsxs("div",{className:"space-y-6",children:[e.jsx(Oe,{title:"Nageurs",description:"Accédez aux fiches individuelles des nageurs.",onBack:()=>t("home"),actions:e.jsxs(C,{variant:"outline",onClick:()=>t("messaging"),children:[e.jsx(hs,{className:"mr-2 h-4 w-4"}),"Message rapide"]})}),e.jsxs(V,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Suivi des Nageurs"}),e.jsx(ee,{children:"Accédez aux fiches individuelles des nageurs."})]}),e.jsx(K,{children:I?e.jsx("div",{className:"space-y-3 p-2",children:[1,2,3,4,5].map(u=>e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-4 w-1/3 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-1/4 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"ml-auto h-8 w-16 rounded-lg bg-muted animate-pulse motion-reduce:animate-none"})]},u))}):N.length?e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(qr,{children:[e.jsx(Or,{children:e.jsxs(Us,{children:[e.jsx(Qe,{children:"Nageur"}),e.jsx(Qe,{children:"Groupe"}),e.jsx(Qe,{children:"IUF"}),e.jsx(Qe,{className:"text-right",children:"Actions"})]})}),e.jsx(zr,{children:N.map(u=>e.jsxs(Us,{children:[e.jsx(Je,{className:"font-medium",children:u.display_name}),e.jsx(Je,{children:u.group_label?e.jsx(Gr,{variant:"secondary",children:u.group_label}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Sans groupe"})}),e.jsx(Je,{children:u.ffn_iuf?e.jsx("span",{className:"text-xs font-mono text-muted-foreground",children:u.ffn_iuf}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"-"})}),e.jsx(Je,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[u.ffn_iuf?e.jsx(C,{size:"sm",variant:"ghost",disabled:Ne.isPending,onClick:()=>Ne.mutate({iuf:u.ffn_iuf,name:u.display_name}),title:"Importer performances FFN",children:e.jsx(Ur,{className:"h-4 w-4"})}):null,e.jsx(C,{size:"sm",variant:"outline",onClick:()=>ue(u),children:"Voir la fiche"})]})})]},u.id??u.display_name))})]})}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."})})]})]}):null,n==="messaging"?e.jsx(va,{onBack:()=>t("home"),athletes:N,groups:re,athletesLoading:I}):null]}):e.jsx("div",{className:"flex items-center justify-center min-h-[60vh] animate-in fade-in motion-reduce:animate-none",children:e.jsxs(V,{className:"w-full max-w-sm shadow-xl border-t-4 border-t-primary",children:[e.jsxs(H,{children:[e.jsxs(Y,{className:"flex items-center gap-2 uppercase italic",children:[e.jsx(Ze,{className:"h-5 w-5 text-primary"}),"Accès Coach"]}),e.jsx(ee,{children:"Cette section est réservée aux coachs et administrateurs."})]}),e.jsx(K,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connectez-vous avec un compte autorisé pour accéder aux outils de gestion."})})]})})}export{ei as default};
