import{b as pe,j as e}from"./vendor-ui-C9ymspZo.js";import{h as y,u as $,i as je,R as fe,B as u,C as E,b as S,c as I,d as _,f as U,L as h,I as R,g as o,m as ve}from"./index-CMwkteNF.js";import{b as ge,u as te,c as p}from"./vendor-query-kM2vrB_e.js";import{S as B,a as H,b as G,c as O,d as a}from"./select-DnkUOUCr.js";import{S as ye}from"./switch-rHLhurB6.js";import{B as j}from"./badge-sCkYel0L.js";import{T as Ne,a as Ce,b as ne,c as f,d as be,e as v}from"./table-DIyt31jY.js";import{S as we}from"./skeleton-BPWQVQTV.js";import{C as ke}from"./circle-alert-CxTvPpY0.js";import{C as Ae}from"./clock-MwQkAaqt.js";import{S as Ee}from"./search-Dy7qrnyY.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-BonayVPE.js";import"./check-BrYunlGc.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Ie=y("circle-check-big",Se);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const _e=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Ue=y("circle-x",_e);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Re=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],qe=y("shield-check",Re);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Fe=y("user-minus",Pe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ze=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Le=y("user-plus",ze),le=["athlete","coach","comite","admin"],X=l=>!(l===!1||l===0),Me=(l,i,q)=>l.map(x=>x.id===i?{...x,role:q}:x),g=(l,i)=>ve(l,i).message;function ss(){const{useMemo:l,useState:i}=pe,q=typeof window>"u"?$.getState().role:$(s=>s.role),x=$(s=>s.userId),{toast:n}=je(),c=ge(),[P,ce]=i(""),[N,de]=i("all"),[C,oe]=i(!1),[b,me]=i(null),[F,J]=i(""),[W,Y]=i(""),[Z,ee]=i(""),[se,re]=i(null),z=q==="admin",{data:m=[],isLoading:ue,error:L,refetch:he}=te({queryKey:["admin-users",C],queryFn:()=>o.listUsers({includeInactive:C}),enabled:z}),M=p({mutationFn:s=>o.createCoach(s),onMutate:()=>{re(null)},onSuccess:s=>{c.invalidateQueries({queryKey:["admin-users"]}),J(""),Y(""),ee(""),re(s.initialPassword??null),n({title:"Coach créé"})},onError:s=>{n({title:"Erreur création coach",description:g(s,"Impossible de créer le coach.")})}}),w=p({mutationFn:s=>o.updateUserRole(s),onSuccess:(s,r)=>{c.setQueryData(["admin-users",C],d=>d&&Me(d,r.userId,r.role)),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Rôle mis à jour"})},onError:s=>{n({title:"Erreur mise à jour rôle",description:g(s,"Impossible de mettre à jour le rôle.")})}}),ae=p({mutationFn:s=>o.disableUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Compte désactivé"})},onError:s=>{n({title:"Erreur désactivation",description:g(s,"Impossible de désactiver le compte.")})}}),{data:T=[],error:Q,refetch:xe}=te({queryKey:["pending-approvals"],queryFn:()=>o.getPendingApprovals(),enabled:z}),K=p({mutationFn:s=>o.approveUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription validée"})},onError:s=>{n({title:"Erreur validation",description:g(s,"Impossible de valider l'inscription.")})}}),D=p({mutationFn:s=>o.rejectUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription rejetée"})},onError:s=>{n({title:"Erreur rejet",description:g(s,"Impossible de rejeter l'inscription.")})}}),k=l(()=>m.find(r=>r.role==="admin")?.id??null,[m]),ie=l(()=>{const s=P.trim().toLowerCase();return m.filter(r=>{if(N!=="all"&&r.role!==N)return!1;const d=r.display_name?.toLowerCase()??"",V=r.email?.toLowerCase()??"";return!(s&&!d.includes(s)&&!V.includes(s))})},[m,N,P]),t=l(()=>b?m.find(s=>s.id===b)??null:null,[b,m]);return z?L||Q?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(ke,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:L instanceof Error?L.message:Q instanceof Error?Q.message:"Une erreur s'est produite"}),e.jsx(u,{onClick:()=>{he(),xe()},className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(qe,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:"Accès admin"})]})]}),T.length>0?e.jsxs(E,{className:"border-status-warning/30 bg-status-warning-bg dark:border-status-warning/30 dark:bg-status-warning-bg",children:[e.jsxs(S,{children:[e.jsxs(I,{className:"flex items-center gap-2",children:[e.jsx(Ae,{className:"h-5 w-5 text-status-warning"}),"Inscriptions en attente",e.jsx(j,{variant:"secondary",className:"ml-2",children:T.length})]}),e.jsx(_,{children:"Ces utilisateurs ont créé un compte et attendent votre validation."})]}),e.jsx(U,{children:e.jsx("div",{className:"space-y-3",children:T.map(s=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-lg border bg-background p-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email||"Pas d'email"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Inscrit le ",new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(u,{size:"sm",className:"bg-status-success hover:opacity-90 text-white",onClick:()=>K.mutate(s.user_id),disabled:K.isPending||D.isPending,children:[e.jsx(Ie,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(u,{size:"sm",variant:"destructive",onClick:()=>{window.confirm(`Rejeter l'inscription de "${s.display_name}" ? Le compte sera désactivé.`)&&D.mutate(s.user_id)},disabled:K.isPending||D.isPending,children:[e.jsx(Ue,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]},s.user_id))})})]}):null,e.jsxs(E,{children:[e.jsxs(S,{children:[e.jsx(I,{children:"Créer un coach"}),e.jsx(_,{children:"Laissez le mot de passe vide pour en générer un automatiquement (affiché une seule fois)."})]}),e.jsx(U,{children:e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault();const r=F.trim();r&&M.mutate({display_name:r,email:W.trim()||void 0,password:Z||void 0})},children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"coach-create-name",children:"Nom affiché"}),e.jsx(R,{id:"coach-create-name",value:F,onChange:s=>J(s.target.value),placeholder:"Ex: Coach Martin",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"coach-create-email",children:"Email"}),e.jsx(R,{id:"coach-create-email",type:"email",value:W,onChange:s=>Y(s.target.value),placeholder:"coach@email.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{htmlFor:"coach-create-password",children:"Mot de passe (optionnel)"}),e.jsx(R,{id:"coach-create-password",type:"text",value:Z,onChange:s=>ee(s.target.value),placeholder:"Laisser vide pour auto"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(u,{type:"submit",disabled:!F.trim()||M.isPending,children:M.isPending?"Création...":"Créer le coach"}),se?e.jsxs("div",{className:"rounded-md border border-primary/30 bg-primary/5 px-4 py-2 text-sm",children:[e.jsx("p",{className:"font-medium text-primary",children:"Mot de passe initial (à copier)"}),e.jsx("p",{className:"font-mono",children:se})]}):null]})]})})]}),e.jsxs(E,{children:[e.jsxs(S,{children:[e.jsx(I,{children:"Gestion des comptes"}),e.jsx(_,{children:"Mettre à jour les rôles, filtrer et désactiver les comptes."})]}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(h,{htmlFor:"admin-search",children:"Recherche"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ee,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(R,{id:"admin-search",value:P,onChange:s=>ce(s.target.value),placeholder:"Nom ou email",className:"pl-9"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(h,{children:"Rôle"}),e.jsxs(B,{value:N,onValueChange:s=>de(s),children:[e.jsx(H,{children:e.jsx(G,{placeholder:"Tous"})}),e.jsxs(O,{children:[e.jsx(a,{value:"all",children:"Tous"}),e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ye,{checked:C,onCheckedChange:oe,id:"inactive-toggle"}),e.jsx(h,{htmlFor:"inactive-toggle",className:"text-sm",children:"Inclure désactivés"})]})]}),ue?e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((s,r)=>e.jsx("div",{className:"flex items-center gap-4 p-3 rounded-lg border",children:e.jsx(we,{className:"h-10 w-full"})},`skeleton-${r}`))}):ie.length?e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(Ne,{children:[e.jsx(Ce,{children:e.jsxs(ne,{children:[e.jsx(f,{children:"Utilisateur"}),e.jsx(f,{children:"Email"}),e.jsx(f,{children:"Rôle"}),e.jsx(f,{children:"Statut"}),e.jsx(f,{className:"text-right",children:"Actions"})]})}),e.jsx(be,{children:ie.map(s=>{const r=X(s.is_active),d=x===s.id,V=k!==null&&k!==s.id;return e.jsxs(ne,{"data-selected":b===s.id,children:[e.jsx(v,{className:"font-medium",children:e.jsx(u,{variant:"ghost",size:"sm",className:"px-2",onClick:()=>me(s.id),children:s.display_name})}),e.jsx(v,{className:"text-sm text-muted-foreground",children:s.email||"-"}),e.jsx(v,{children:e.jsxs(B,{value:s.role,onValueChange:A=>{le.includes(A)&&s.id&&A!==s.role&&w.mutate({userId:s.id,role:A})},disabled:!r||w.isPending,children:[e.jsx(H,{className:"w-[140px]",children:e.jsx(G,{})}),e.jsxs(O,{children:[e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",disabled:V,children:"Admin"})]})]})}),e.jsx(v,{children:r?e.jsx(j,{variant:"secondary",children:"Actif"}):e.jsx(j,{variant:"outline",children:"Désactivé"})}),e.jsx(v,{className:"text-right",children:e.jsxs(u,{variant:"destructive",size:"sm",onClick:()=>{if(!s.id)return;if(d){n({title:"Action impossible",description:"Vous ne pouvez pas désactiver votre propre compte."});return}window.confirm(`Confirmer la désactivation du compte "${s.display_name}" ?`)&&ae.mutate({userId:s.id})},disabled:!r||ae.isPending||d,children:[e.jsx(Fe,{className:"mr-2 h-4 w-4"}),"Désactiver"]})})]},s.id)})})]})}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Le,{className:"h-4 w-4"}),"Aucun utilisateur ne correspond à votre recherche."]})]})]}),e.jsxs(E,{children:[e.jsxs(S,{children:[e.jsx(I,{children:"Fiche utilisateur"}),e.jsx(_,{children:"Sélectionnez un compte pour afficher les détails."})]}),e.jsx(U,{children:t?e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nom affiché"}),e.jsx("p",{className:"text-lg font-semibold",children:t.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Email"}),e.jsx("p",{children:t.email||"-"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Rôle"}),e.jsxs(B,{value:t.role,onValueChange:s=>{le.includes(s)&&t.id&&s!==t.role&&w.mutate({userId:t.id,role:s})},disabled:!X(t.is_active)||w.isPending,children:[e.jsx(H,{className:"w-[180px]",children:e.jsx(G,{})}),e.jsxs(O,{children:[e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",disabled:k!==null&&k!==t.id,children:"Admin"})]})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Statut"}),X(t.is_active)?e.jsx(j,{variant:"secondary",children:"Actif"}):e.jsx(j,{variant:"outline",children:"Désactivé"})]}),t.group_label?e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Groupe"}),e.jsx("p",{children:t.group_label})]}):null]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun utilisateur sélectionné."})})]})]}):typeof window>"u"?null:e.jsx(fe,{to:"/"})}export{ss as default,Me as updateUserRoleInList};
