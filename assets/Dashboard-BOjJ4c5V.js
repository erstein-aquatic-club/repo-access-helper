import{r as l,j as e,c as gt,u as Ue,d as Me,a as ke}from"./vendor-query-BiSH4r2z.js";import{a as se}from"./api-CT4965yV.js";import{c as ge,b as ht,W as He,X as Fe,F as yt,u as Dt,d as Ft,s as $e,B as Lt}from"./index-AQJx-bCr.js";import{P as Ot,C as Ke,M as Et,T as Be,a as It,b as Pt}from"./CalendarGrid-DJZVj2b9.js";import{A as Se,B as $t}from"./BottomActionBar-CsIr3aqp.js";import{a as Kt,s as Bt,l as Ze}from"./animations-CrcLFysI.js";import{d as et}from"./design-tokens-CKgCpdH6.js";import{C as We}from"./chevron-right-BrtQbrlZ.js";import{T as Ve}from"./timer-9DmUOrks.js";import{C as Tt}from"./circle-check-CTEsrCNO.js";import{m as te}from"./proxy-Dh0N-Z8G.js";import{C as Rt}from"./chevron-down-CCJpk06U.js";import{C as Ye}from"./check-Bfd-iumc.js";import{P as Le}from"./plus-C4DSZtoG.js";import{A as tt,H as st}from"./hash-QQHAbZ0G.js";import{P as qt}from"./pencil-Te3KMPVI.js";import{C as Qt}from"./circle-alert-KbUCFDRW.js";import"./vendor-react-BzrpNAyj.js";import"./swim-C_-X8mId.js";import"./vendor-supabase-6k692oZB.js";import"./chevron-left-Pr1ZJwwJ.js";import"./loader-circle-BCrgAsBM.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const zt=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],nt=ge("info",zt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Jt=[["path",{d:"M5 12h14",key:"1ays0h"}]],Nt=ge("minus",Jt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ut=[["path",{d:"M14 17H5",key:"gfn3mx"}],["path",{d:"M19 7h-9",key:"6i9tg"}],["circle",{cx:"17",cy:"17",r:"3",key:"18b49y"}],["circle",{cx:"7",cy:"7",r:"3",key:"dfmy0x"}]],rt=ge("settings-2",Ut);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ht=[["circle",{cx:"12",cy:"12",r:"4",key:"4exip2"}],["path",{d:"M12 2v2",key:"tus03m"}],["path",{d:"M12 20v2",key:"1lh1kg"}],["path",{d:"m4.93 4.93 1.41 1.41",key:"149t6j"}],["path",{d:"m17.66 17.66 1.41 1.41",key:"ptbguv"}],["path",{d:"M2 12h2",key:"1t8f8n"}],["path",{d:"M20 12h2",key:"1q8mjw"}],["path",{d:"m6.34 17.66-1.41 1.41",key:"1m8zz5"}],["path",{d:"m19.07 4.93-1.41 1.41",key:"1shlcs"}]],Vt=ge("sun",Ht);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Yt=[["path",{d:"m16 11 2 2 4-4",key:"9rsbq5"}],["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}]],it=ge("user-check",Yt);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Wt=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"17",x2:"22",y1:"8",y2:"13",key:"3nzzx3"}],["line",{x1:"22",x2:"17",y1:"8",y2:"13",key:"1swrse"}]],Ae=ge("user-x",Wt),Te={NL:"",DOS:"",BR:"",PAP:"",QN:""};function ot(t){return String(t).padStart(2,"0")}function at(t){return`${t.getFullYear()}-${ot(t.getMonth()+1)}-${ot(t.getDate())}`}function lt(t){return new Date(t.getFullYear(),t.getMonth(),1)}function ct(t,s){const n=new Date(t);return n.setDate(n.getDate()+s),n}function Re(t){return(t.getDay()+6)%7}function _e(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function Xt(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}function Gt(t){return t?String(t).replaceAll(`\r
`,`
`).split(`
`).map(n=>n.trim()).filter(Boolean).flatMap(n=>{const r=n.replace(/^[•\\-–—]\\s*/,"").trim();return r?[r]:[]}):[]}function Zt(t){if(!t)return null;const n=String(t).match(/(\\d+(?:[\\.,]\\d+)?)\\s*(km|m)\\b/i);if(!n)return null;const r=Number(String(n[1]).replace(",","."));return Number.isFinite(r)?n[2].toLowerCase()==="m"?_e(r):r:null}function es(t,s){const n=t?.slot??t?.session_slot??t?.assigned_slot??t?.time_slot??t?.timeOfDay??t?.slot_key??t?.slotKey,r=String(n||"").toLowerCase();if(r.includes("mat")||r.includes("morning")||r==="am")return"AM";if(r.includes("soir")||r.includes("evening")||r==="pm")return"PM";const x=`${t?.title??""} ${t?.description??""}`.toLowerCase();return x.includes("matin")||x.includes(" am ")||x.includes("(am)")?"AM":x.includes("soir")||x.includes(" pm ")||x.includes("(pm)")?"PM":s===0?"AM":"PM"}function ts(t){const s=t?.assigned_date??t?.date??t?.day??t?.scheduled_for??t?.scheduledAt??null;if(!s)return null;const n=String(s),r=n.length>=10?n.slice(0,10):n;return/\d{4}-\d{2}-\d{2}/.test(r)?r:null}function ss(t){if(Array.isArray(t?.items)){let x=0;for(const u of t.items){const f=Number(u?.distance);if(!Number.isFinite(f)||f<=0)continue;const m=u?.raw_payload,b=Number(m?.exercise_repetitions),h=Number(m?.block_repetitions),v=Number.isFinite(b)&&b>0?b:1,M=Number.isFinite(h)&&h>0?h:1;x+=f*v*M}if(x>0)return _e(x)}const s=t?.distance_meters??t?.distanceMeters??t?.meters??t?.planned_meters??t?.plannedMeters??t?.distance??null;if(s!=null&&Number.isFinite(Number(s))){const x=Number(s);return x>0&&x<=50?x:_e(x)}const n=t?.km??t?.distance_km??t?.distanceKm??t?.planned_km??t?.plannedKm??null;if(n!=null&&Number.isFinite(Number(n)))return Number(n);const r=Zt(`${t?.title??""} ${t?.description??""}`);return r??null}function ns(t){if(!Array.isArray(t)||t.length===0)return null;const s={crawl:"NL",dos:"DOS",brasse:"BR",pap:"PAP","4n":"QN"},n={NL:0,DOS:0,BR:0,PAP:0,QN:0};for(const x of t){const u=Number(x?.distance);if(!Number.isFinite(u)||u<=0)continue;const f=x?.raw_payload,m=Number(f?.exercise_repetitions),b=Number(f?.block_repetitions),h=Number.isFinite(m)&&m>0?m:1,v=Number.isFinite(b)&&b>0?b:1,M=u*h*v,U=f?.exercise_stroke??f?.stroke??"crawl",X=s[String(U).toLowerCase()];X?n[X]+=M:n.NL+=M}return Object.values(n).some(x=>x>0)?n:null}function dt(t){const s=Number(t);if(!Number.isFinite(s))return"—";const n=Math.round(s*100)/100,r=String(n);return r.endsWith(".0")?r.slice(0,-2):r}function rs(){const t={};for(let s=0;s<7;s++)t[s]={AM:!0,PM:!0};return t}function qe(t){if(!t)return null;try{return JSON.parse(t)}catch{return null}}function is({sessions:t,assignments:s,userId:n,user:r}){const x=`swim-dashboard-v2:${n??r??"anon"}`,u=`${x}:presenceDefaults`,f=`${x}:attendanceOverrides`,m=`${x}:stableFields`,[b,h]=l.useState(()=>rs()),[v,M]=l.useState({}),[U,X]=l.useState(90);l.useEffect(()=>{if(typeof window>"u")return;const o=qe(window.localStorage.getItem(u));o&&h(o);const c=qe(window.localStorage.getItem(f));c&&M(c);const a=qe(window.localStorage.getItem(m));a?.duration&&Number.isFinite(a.duration)&&a.duration>=30&&a.duration<=240&&X(a.duration)},[u,f,m]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(u,JSON.stringify(b))},[b,u]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(f,JSON.stringify(v))},[v,f]),l.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(m,JSON.stringify({duration:U}))},[U,m]);const de=l.useMemo(()=>new Date,[]),[ne,oe]=l.useState(()=>lt(new Date)),[p,k]=l.useState(()=>at(new Date)),[C,_]=l.useState(!1),[T,me]=l.useState(!1),[ue,he]=l.useState(!1),[w,$]=l.useState(null),[K,I]=l.useState(!1),[D,O]=l.useState(null),[E,Z]=l.useState(!1),[ae,A]=l.useTransition(),W=l.useMemo(()=>(Array.isArray(s)?s:[]).filter(c=>c?.session_type==="swim"),[s]),R=l.useMemo(()=>{const o=new Map;for(const c of W){const a=ts(c);a&&(o.has(a)||o.set(a,[]),o.get(a).push(c))}for(const[c,a]of o.entries())a.sort((g,y)=>Number(g?.id??0)-Number(y?.id??0)),o.set(c,a);return o},[W]),S=l.useMemo(()=>{const o=Array.isArray(t)?t:[],c={};for(const a of o){const g=String(a?.date??"").slice(0,10),y=a?.slot==="Soir"?"PM":"AM";c[`${g}__${y}`]=a}return c},[t]),q=l.useRef(new Map);l.useEffect(()=>{q.current.clear()},[R]);const re=l.useCallback(o=>{const c=q.current;if(c.has(o))return c.get(o);const a=[{id:`${o}__AM`,iso:o,slotKey:"AM",title:"Séance vide",km:null,details:[],isEmpty:!0},{id:`${o}__PM`,iso:o,slotKey:"PM",title:"Séance vide",km:null,details:[],isEmpty:!0}],g=R.get(o)??[],y=new Set;return g.forEach((N,P)=>{const z=N,J=es(z,P);if(y.has(J))return;const le=J==="AM"?0:1,je=ss(z),Ee=Array.isArray(z?.details)?z.details.map(String):Gt(N?.description);a[le]={id:`${o}__${J}`,iso:o,slotKey:J,title:String(N?.title??"Séance coach"),km:je,details:Ee,assignmentId:typeof N?.id=="number"?N.id:Number(N?.id)||void 0,isEmpty:!1},y.add(J)}),c.set(o,a),a},[R]),ie=l.useCallback((o,c)=>{const a=Re(c),g=!!b?.[a]?.[o.slotKey],y=v[o.id];return y==="present"?{status:"present",expected:!0,expectedByDefault:g}:y==="absent"?{status:"absent",expected:!0,expectedByDefault:g}:g?{status:"present",expected:!0,expectedByDefault:g}:{status:"not_expected",expected:!1,expectedByDefault:g}},[v,b]),ee=l.useMemo(()=>lt(ne),[ne]),xe=l.useMemo(()=>{const o=Re(ee),c=ct(ee,-o),a=[];for(let g=0;g<42;g++)a.push(ct(c,g));return a},[ee]),ye=l.useMemo(()=>{const o={};for(const c of xe){const a=at(c),g=re(a);let y=0,N=0;const P=[];for(const z of g){const J=ie(z,c);if(!J.expected){P.push({slotKey:z.slotKey,expected:!1,completed:!1,absent:!1});continue}y+=1;const le=!!S[z.id],je=J.status==="absent";le&&(N+=1),P.push({slotKey:z.slotKey,expected:!0,completed:le,absent:je})}o[a]={completed:N,total:y,slots:P}}return o},[xe,re,ie,S]),Ne=l.useMemo(()=>{const[o,c,a]=p.split("-").map(Number);return new Date(o,c-1,a)},[p]),H=l.useMemo(()=>re(p),[re,p]),V=ye[p]||{completed:0,total:2,slots:[{slotKey:"AM",expected:!0,completed:!1,absent:!1},{slotKey:"PM",expected:!0,completed:!1,absent:!1}]},pe=l.useMemo(()=>{const o=Array.isArray(t)?t:[];let c=0;for(const a of o){const g=String(a?.date??"").slice(0,10),y=a?.slot==="Soir"?"PM":"AM",N=`${g}__${y}`;if(v[N]==="absent")continue;const P=Re(new Date(g));(b?.[P]?.[y]||v[N]==="present")&&Number.isFinite(Number(a?.distance))&&(c+=Number(a.distance))}return dt(_e(c))},[t,v,b]),fe=l.useMemo(()=>{const o=H;let c=0;for(const a of o){const g=ie(a,Ne);if(!g.expected||g.status==="absent")continue;const y=S[a.id];y&&Number.isFinite(Number(y?.distance))&&(c+=Number(y.distance))}return dt(_e(c))},[H,ie,Ne,S]),be=l.useMemo(()=>w&&S[w]||null,[w,S]),G=l.useMemo(()=>{const o=be||{},c=o?.stroke_distances,a=c?{NL:c.NL?String(c.NL):"",DOS:c.DOS?String(c.DOS):"",BR:c.BR?String(c.BR):"",PAP:c.PAP?String(c.PAP):"",QN:c.QN?String(c.QN):""}:Te;return{difficulty:o?.effort??null,fatigue_end:o?.fatigue??o?.feeling??null,performance:o?.performance??o?.feeling??null,engagement:o?.engagement??o?.feeling??null,comment:String(o?.comments??""),distanceMeters:Number.isFinite(Number(o?.distance))?Number(o.distance):null,showStrokeDetail:!!(c&&Object.values(c).some(g=>g&&g>0)),strokes:a,exerciseLogs:[]}},[be]),[Y,B]=l.useState(()=>({difficulty:null,fatigue_end:null,performance:null,engagement:null,comment:"",distanceMeters:null,showStrokeDetail:!1,strokes:Te,exerciseLogs:[]}));return l.useEffect(()=>{const o=H.find(c=>c.id===w);if(o){const c=o.km!=null?Xt(o.km):5e3;let a=Te;if(o.assignmentId){const y=(s??[]).find(N=>N.id===o.assignmentId);if(y?.items){const N=ns(y.items);N&&(a={NL:String(N.NL||""),DOS:String(N.DOS||""),BR:String(N.BR||""),PAP:String(N.PAP||""),QN:String(N.QN||"")})}}const g=Object.values(G.strokes).some(y=>y&&Number(y)>0);B(y=>({...y,...G,distanceMeters:G.distanceMeters==null?c:G.distanceMeters,strokes:g?G.strokes:a,showStrokeDetail:g||Object.values(a).some(N=>N&&Number(N)>0)}));return}B(c=>({...c,...G}))},[G,w,H,s]),l.useEffect(()=>{C&&E&&V.total>0&&V.completed>=V.total&&(_(!1),$(null),I(!1),Z(!1))},[C,E,V.completed,V.total]),{today:de,monthCursor:ne,selectedISO:p,drawerOpen:C,settingsOpen:T,infoOpen:ue,activeSessionId:w,detailsOpen:K,selectedDayIndex:D,isPending:ae,presenceDefaults:b,attendanceOverrideBySessionId:v,stableDurationMin:U,draftState:Y,gridDates:xe,completionByISO:ye,selectedDate:Ne,sessionsForSelectedDay:H,selectedDayStatus:V,globalKm:pe,dayKm:fe,logsBySessionId:S,setMonthCursor:oe,setSelectedISO:k,setDrawerOpen:_,setSettingsOpen:me,setInfoOpen:he,setActiveSessionId:$,setDetailsOpen:I,setSelectedDayIndex:O,setPresenceDefaults:h,setAttendanceOverrideBySessionId:M,setStableDurationMin:X,setDraftState:B,setAutoCloseArmed:Z,startTransition:A,getSessionStatus:ie,getSessionsForISO:re}}function Qe(...t){return t.filter(Boolean).join(" ")}const ut={NL:"NL",DOS:"Dos",BR:"Brasse",PAP:"Pap",QN:"4N"};function os({strokes:t,showStrokeDetail:s,disabled:n=!1,onToggle:r,onChange:x}){return e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",disabled:n,onClick:r,className:Qe("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",n?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsx("span",{children:"Détail par nage"}),e.jsx(We,{className:Qe("h-4 w-4 transition-transform",s&&"rotate-90")})]}),s&&e.jsx("div",{className:"mt-2 grid grid-cols-5 gap-2",children:Object.keys(ut).map(u=>e.jsxs("div",{className:"space-y-1",children:[e.jsx("label",{className:"block text-center text-xs font-medium text-muted-foreground",children:ut[u]}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,step:100,disabled:n,value:t[u],onChange:f=>x({...t,[u]:f.target.value}),placeholder:"0",className:Qe("w-full rounded-xl border px-1 py-2 text-center text-sm outline-none",n?"bg-muted text-muted-foreground":"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10")}),e.jsx("div",{className:"text-center text-[10px] text-muted-foreground",children:"m"})]},u))})]})}function as(...t){return t.filter(Boolean).join(" ")}function ls({exerciseLogs:t,assignmentId:s,disabled:n=!1}){const[,r]=ht(),x=t.filter(u=>{const f=(u.split_times??[]).some(b=>b.time_seconds>0),m=(u.stroke_count??[]).some(b=>b.count>0);return f||m||u.tempo!=null||u.notes?.trim()}).length;return e.jsx("div",{className:"mt-3",children:e.jsxs("button",{type:"button",disabled:n||!s,onClick:()=>{s&&r(`/swim-session?assignmentId=${s}`)},className:as("flex w-full items-center justify-between rounded-2xl border px-3 py-2 text-sm font-semibold transition",n||!s?"text-muted-foreground border-border cursor-not-allowed":"text-foreground border-border hover:bg-muted"),children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"h-4 w-4"}),"Notes techniques",x>0&&e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-primary/10 px-1.5 py-0.5 text-xs font-semibold text-primary",children:[e.jsx(Tt,{className:"h-3 w-3"}),x]})]}),e.jsx(We,{className:"h-4 w-4"})]})})}function L(...t){return t.filter(Boolean).join(" ")}function cs(t){return t.toLocaleDateString("fr-FR",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}function Oe(t){const s=Number(t);if(!Number.isFinite(s))return"—";const n=Math.round(s*100)/100,r=String(n);return r.endsWith(".0")?r.slice(0,-2):r}function mt(t){const s=Number(t);return Number.isFinite(s)?Math.round(s/1e3*100)/100:0}function ds(t){const s=Number(t);return Number.isFinite(s)?Math.round(s*1e3):0}const ze=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}],us=[{key:"AM",label:"Matin",Icon:Vt},{key:"PM",label:"Soir",Icon:Et}];function De({children:t}){return e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs font-semibold text-muted-foreground",children:t})}function we({onClick:t,label:s,children:n,tone:r="neutral",disabled:x}){const u={neutral:"bg-background border-border text-foreground hover:bg-muted",dark:"bg-foreground border-foreground text-background hover:opacity-90",sky:"bg-primary/10 border-primary/30 text-primary hover:bg-primary/20"};return e.jsxs("button",{type:"button",onClick:t,disabled:x,className:L("inline-flex items-center justify-center rounded-2xl border p-2 transition",u[r],x&&"opacity-50 cursor-not-allowed hover:bg-background"),"aria-label":s,title:s,children:[n,e.jsx("span",{className:"sr-only",children:s})]})}function ms(t,s){const n=Number(s);return!Number.isFinite(n)||n<1||n>5?"neutral":t==="hard"?{1:"bg-intensity-1 border-intensity-1 text-white",2:"bg-intensity-2 border-intensity-2 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-4 border-intensity-4 text-white",5:"bg-intensity-5 border-intensity-5 text-white"}[n]:{1:"bg-intensity-5 border-intensity-5 text-white",2:"bg-intensity-4 border-intensity-4 text-white",3:"bg-intensity-3 border-intensity-3 text-white",4:"bg-intensity-2 border-intensity-2 text-white",5:"bg-intensity-1 border-intensity-1 text-white"}[n]}function xs({plannedMeters:t,valueMeters:s,onChange:n,disabled:r}){const m=Number.isFinite(Number(s))?Number(s):t,b=m-t;return e.jsxs("div",{className:L("mt-4 rounded-3xl border px-4 py-3",r?"bg-muted border-border":"bg-card border-border"),children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("div",{className:L("text-xs font-semibold",r?"text-muted-foreground":"text-foreground"),children:"Ajuster kilométrage"}),b!==0&&e.jsx("div",{className:L("text-xs font-semibold px-2 py-0.5 rounded-full",b>0?"bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400":"bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"),children:b>0?`+${b}m`:`${b}m`})]}),e.jsx("div",{className:"text-center mb-3",children:e.jsxs("div",{className:L("text-xs","text-muted-foreground"),children:["Planifié : ",t,"m (",Oe(mt(t))," km)"]})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx("button",{type:"button",disabled:r||m-100<0,onClick:()=>n(m-100),className:L("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",r?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"-100m",children:e.jsx(Nt,{className:"h-5 w-5"})}),e.jsxs("div",{className:"min-w-[140px] text-center",children:[e.jsxs("div",{className:L("text-2xl font-bold",r?"text-muted-foreground":"text-foreground"),children:[m,"m"]}),e.jsxs("div",{className:L("text-sm font-medium mt-0.5",r?"text-muted-foreground":"text-primary"),children:[Oe(mt(m))," km"]})]}),e.jsx("button",{type:"button",disabled:r||m+100>3e4,onClick:()=>n(m+100),className:L("h-11 w-11 rounded-2xl border flex items-center justify-center transition-colors",r?"bg-muted border-border text-muted-foreground cursor-not-allowed":"bg-card border-border text-foreground hover:bg-muted active:scale-95"),"aria-label":"+100m",children:e.jsx(Le,{className:"h-5 w-5"})})]})]})}function ps({open:t,selectedDate:s,sessionsForSelectedDay:n,selectedDayStatus:r,dayKm:x,activeSessionId:u,detailsOpen:f,draftState:m,saveState:b,isPending:h,logsBySessionId:v,onClose:M,onDayOffAll:U,onOpenSession:X,onCloseSession:de,onToggleDetails:ne,onMarkAbsent:oe,onMarkPresent:p,onClearOverride:k,onSaveFeedback:C,onDraftStateChange:_,getSessionStatus:T}){const[,me]=ht(),[ue,he]=l.useState(!1),w=l.useMemo(()=>u&&n.find($=>$.id===u)||null,[u,n]);return e.jsx(Se,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(te.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:M}),e.jsx(te.div,{className:L("fixed z-modal bg-background shadow-2xl","left-0 right-0 bottom-0 top-auto max-h-[calc(100dvh-env(safe-area-inset-top))] h-[88dvh] rounded-t-3xl","sm:right-0 sm:top-0 sm:left-auto sm:bottom-auto sm:h-full sm:w-full sm:max-w-xl sm:rounded-none"),variants:Kt,initial:"hidden",animate:"visible",exit:"exit",role:"dialog","aria-modal":"true",children:e.jsxs("div",{className:"flex h-full flex-col",children:[e.jsx("div",{className:"px-5 pt-3 sm:hidden",children:e.jsx("div",{className:"mx-auto h-1.5 w-12 rounded-full bg-muted"})}),e.jsxs("div",{className:"sticky top-0 z-10 flex items-center justify-between border-b border-primary/15 bg-background px-4 sm:px-5 py-2.5",children:[e.jsxs("div",{className:"flex items-center gap-2.5 min-w-0",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground shrink-0",children:e.jsx(He,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"min-w-0",children:e.jsx("div",{className:"truncate text-sm font-display font-bold uppercase italic tracking-tight text-primary",children:cs(s)})})]}),e.jsx(we,{onClick:M,label:"Fermer",children:e.jsx(Fe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-auto p-4 sm:p-5",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"flex items-center gap-2.5",children:e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"text-lg font-bold text-foreground",children:[x," km"]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:L("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=1?"bg-status-success":"bg-muted-foreground/30")}),e.jsx("span",{className:L("h-1.5 w-1.5 rounded-full",r.total>0&&r.completed>=2?"bg-status-success":"bg-muted-foreground/30")})]})]})}),e.jsx(we,{onClick:U,label:"OFF (absent journée)",tone:"dark",disabled:h,children:e.jsx(Ot,{className:"h-5 w-5"})})]}),(()=>{const $=[],K=[];for(const D of n)T(D,s).status==="not_expected"?K.push(D):$.push(D);const I=D=>{const O=T(D,s),E=!!v[D.id],Z=O.status==="absent",ae=O.status==="not_expected",A=Z||ae,W=O.expected&&!E&&!Z,R=E?"bg-status-success-bg border-status-success/30":A?"bg-sky-50 border-sky-200":W?"bg-status-warning-bg border-status-warning/30":"bg-card border-border",S=us.find(q=>q.key===D.slotKey)?.Icon||Ke;return e.jsx("button",{type:"button",onClick:()=>X(D.id),className:L("w-full rounded-3xl border px-3 py-3 text-left transition",R,"hover:shadow-sm"),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsx("div",{className:L("h-10 w-10 rounded-2xl border flex items-center justify-center",E?"border-status-success/30 bg-status-success-bg":A?"border-sky-200 bg-sky-100":W?"border-status-warning/30 bg-status-warning-bg":"border-border bg-muted"),children:e.jsx(S,{className:"h-5 w-5 text-foreground"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:D.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[D.isEmpty?e.jsx(De,{children:"Vide"}):e.jsxs(De,{children:[Oe(D.km)," km"]}),E&&e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}),A&&!E&&e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}),W&&e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[ae&&e.jsx(we,{onClick:q=>{q.stopPropagation(),p(D.id)},label:"Je suis venu",disabled:h,children:e.jsx(it,{className:"h-5 w-5"})}),O.expected&&!E&&!Z&&e.jsx(we,{onClick:q=>{q.stopPropagation(),oe(D.id)},label:"Absent",tone:"sky",disabled:h,children:e.jsx(Ae,{className:"h-5 w-5"})})]})]})},D.id)};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-4 grid gap-2",children:$.map(I)}),K.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsxs("button",{type:"button",onClick:()=>he(D=>!D),className:"flex w-full items-center gap-2 rounded-2xl px-3 py-2 text-xs font-semibold text-muted-foreground hover:bg-muted transition",children:[e.jsx(Rt,{className:L("h-4 w-4 transition-transform",ue&&"rotate-180")}),"Autres séances (",K.length,")"]}),e.jsx(Se,{children:ue&&e.jsx(te.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"overflow-hidden",children:e.jsx("div",{className:"mt-1 grid gap-2",children:K.map(I)})})})]})]})})(),e.jsx(Se,{children:w&&e.jsx(te.div,{initial:{opacity:0,y:8},animate:{opacity:1,y:0},exit:{opacity:0,y:8},transition:{duration:et.normal},className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:(()=>{const $=T(w,s),K=$.status==="absent",I=$.status==="not_expected",D=!!v[w.id],O=$.expected&&!K,E=K?"Annuler":I?"Je suis venu":"Absent",Z=K?()=>k(w.id):I?()=>p(w.id):()=>oe(w.id),ae=ds(w.km??0);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("div",{className:"truncate text-sm font-semibold text-foreground",children:w.title}),e.jsxs("div",{className:"mt-1 flex items-center gap-2",children:[w.isEmpty?e.jsx(De,{children:"Vide"}):e.jsxs(De,{children:[Oe(w.km)," km"]}),D?e.jsxs("span",{className:"inline-flex items-center text-emerald-800",children:[e.jsx(Ye,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Présent"})]}):K||I?e.jsxs("span",{className:"inline-flex items-center text-sky-800",children:[e.jsx(Ae,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Absent"})]}):e.jsxs("span",{className:"inline-flex items-center text-orange-900",children:[e.jsx(Ke,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"En attente"})]})]})]}),e.jsx(we,{onClick:de,label:"Retour",children:e.jsx(Fe,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 p-3",children:[e.jsxs("button",{type:"button",onClick:Z,className:L("rounded-2xl px-3 py-3 text-sm font-semibold border transition inline-flex items-center justify-center gap-2",I?"bg-foreground text-background border-foreground hover:opacity-90":"bg-card text-foreground border-border hover:bg-muted"),children:[I?e.jsx(it,{className:"h-4 w-4"}):e.jsx(Ae,{className:"h-4 w-4"}),E]}),e.jsxs("button",{type:"button",onClick:ne,className:"rounded-2xl px-3 py-3 text-sm font-semibold border border-border bg-card hover:bg-muted inline-flex items-center justify-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4"}),"Fiche"]})]}),e.jsx(Se,{children:f&&e.jsxs(te.div,{initial:{opacity:0,y:6},animate:{opacity:1,y:0},exit:{opacity:0,y:6},transition:{duration:et.normal},className:"mx-3 mb-3 rounded-2xl border border-border bg-muted p-3",children:[w.details?.length?e.jsx("ul",{className:"list-disc pl-5 space-y-1 text-sm text-foreground",children:w.details.map((A,W)=>e.jsx("li",{children:A},W))}):e.jsx("div",{className:"text-sm text-muted-foreground",children:w.assignmentId?"Séance coach — détails dans la fiche.":"Aucun détail pour ce créneau."}),w.assignmentId?e.jsx("div",{className:"mt-3",children:e.jsx("button",{type:"button",onClick:()=>me(`/swim-session?assignmentId=${w.assignmentId}`),className:"w-full rounded-2xl border border-border bg-card px-3 py-2 text-sm font-semibold text-foreground hover:bg-muted",children:"Ouvrir la fiche complète"})}):null]})}),e.jsxs("div",{className:"px-4 pb-4",children:[!O&&e.jsx("div",{className:"mb-3 rounded-2xl bg-sky-50 text-sky-900 px-3 py-2 text-xs",children:K?"Absent: aucun ressenti.":'Non prévu: appuyez "Je suis venu".'}),e.jsxs(te.div,{className:"space-y-4",variants:Bt,initial:"hidden",animate:"visible",children:[ze.map(A=>{const W=m[A.key];return e.jsxs(te.div,{className:"space-y-2",variants:Ze,children:[e.jsx("div",{className:L("text-sm font-semibold",O?"text-foreground":"text-muted-foreground"),children:A.label}),e.jsx("div",{className:"flex items-center gap-2",children:[1,2,3,4,5].map(R=>{const S=W===R;return e.jsx("button",{type:"button",disabled:!O,onClick:()=>_({...m,[A.key]:R}),className:L("h-11 w-11 rounded-2xl border text-sm font-semibold transition",O?S?ms(A.mode,R):"bg-card text-foreground border-border hover:bg-muted":"bg-muted text-muted-foreground border-border cursor-not-allowed"),children:R},R)})})]},A.key)}),e.jsxs(te.div,{className:"space-y-2",variants:Ze,children:[e.jsx("div",{className:L("text-sm font-semibold",O?"text-foreground":"text-muted-foreground"),children:"Commentaire"}),e.jsx("textarea",{value:m.comment,onChange:A=>_({...m,comment:A.target.value}),disabled:!O,rows:3,placeholder:"Sensations, points techniques…",className:L("w-full resize-none rounded-3xl border px-4 py-3 text-sm outline-none",O?"bg-card text-foreground border-border focus:ring-2 focus:ring-foreground/10":"bg-muted text-muted-foreground border-border")})]})]}),e.jsx(xs,{plannedMeters:ae,valueMeters:m.distanceMeters,onChange:A=>_({...m,distanceMeters:A}),disabled:!O}),e.jsx(os,{strokes:m.strokes,showStrokeDetail:m.showStrokeDetail,disabled:!O,onToggle:()=>_({...m,showStrokeDetail:!m.showStrokeDetail}),onChange:A=>_({...m,strokes:A})}),e.jsx(ls,{exerciseLogs:m.exerciseLogs,assignmentId:w?.assignmentId,disabled:!O,onLogsChange:A=>_({...m,exerciseLogs:A})})]})]})})()},w.id)})]}),w&&(()=>{const $=T(w,s),K=$.expected&&$.status!=="absent";return e.jsxs($t,{saveState:b,position:"static",children:[e.jsx("button",{type:"button",onClick:C,disabled:h||!K||!ze.every(I=>Number.isInteger(m[I.key])),className:L("rounded-2xl px-4 py-3 text-sm font-semibold transition flex-1",h||!K?"bg-muted text-muted-foreground cursor-not-allowed":ze.every(I=>Number.isInteger(m[I.key]))?"bg-status-success text-white hover:opacity-90":"bg-status-success-bg text-status-success cursor-not-allowed"),children:"Valider"}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:["→"," km"]})]})})()]})})]})})}function fs(...t){return t.filter(Boolean).join(" ")}function bs(t){try{return new Date(t).toLocaleDateString("fr-FR",{weekday:"short",day:"numeric",month:"short"})}catch{return t}}function gs(t){if(!t||!Number.isFinite(t))return"—";if(t<60)return`${t.toFixed(1)}s`;const s=Math.floor(t/60),n=t%60;return`${s}:${n<10?"0":""}${n.toFixed(1)}`}function hs({userId:t,expanded:s,onToggle:n}){const r=gt(),{data:x,isLoading:u}=Ue({queryKey:["swim-exercise-logs-history",t],queryFn:()=>se.getSwimExerciseLogsHistory(t,100),enabled:!!t&&s}),f=Me({mutationFn:({logId:h,patch:v})=>se.updateSwimExerciseLog(h,v),onSuccess:()=>{r.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),m=Me({mutationFn:h=>se.deleteSwimExerciseLog(h),onSuccess:()=>{r.invalidateQueries({queryKey:["swim-exercise-logs-history",t]})}}),b=ke.useMemo(()=>{if(!x?.length)return[];const h=new Map;for(const v of x){const M=(v.created_at??"").slice(0,10);h.has(M)||h.set(M,[]),h.get(M).push(v)}return Array.from(h.entries()).map(([v,M])=>({date:v,entries:M}))},[x]);return e.jsxs("div",{className:"mt-6",children:[e.jsxs("button",{type:"button",onClick:n,className:"flex w-full items-center justify-between rounded-2xl border border-border px-3 py-2.5 text-sm font-semibold text-foreground hover:bg-muted transition",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(yt,{className:"h-4 w-4"}),"Historique notes techniques"]}),e.jsx(We,{className:fs("h-4 w-4 transition-transform",s&&"rotate-90")})]}),s&&e.jsxs("div",{className:"mt-3 space-y-3",children:[u&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Chargement..."}),!u&&b.length===0&&e.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"Aucune note technique enregistree."}),b.map(({date:h,entries:v})=>e.jsxs("div",{className:"rounded-2xl border border-border overflow-hidden",children:[e.jsx("div",{className:"bg-muted/50 px-3 py-2 text-xs font-semibold text-muted-foreground",children:bs(h)}),e.jsx("div",{className:"divide-y divide-border",children:v.map(M=>e.jsx(ys,{log:M,onSave:U=>f.mutate({logId:M.id,patch:U}),onDelete:()=>m.mutate(M.id),saving:f.isPending},M.id))})]},h))]})]})}function ys({log:t,onSave:s,onDelete:n,saving:r}){const[x,u]=l.useState(!1),[f,m]=l.useState({notes:t.notes??"",tempo:t.tempo,split_times:t.split_times,stroke_count:t.stroke_count}),b=()=>{m({notes:t.notes??"",tempo:t.tempo,split_times:[...t.split_times],stroke_count:[...t.stroke_count]}),u(!0)},h=()=>u(!1),v=()=>{s({notes:f.notes.trim()||null,tempo:f.tempo,split_times:f.split_times,stroke_count:f.stroke_count}),u(!1)},M=()=>{m(p=>({...p,split_times:[...p.split_times,{rep:p.split_times.length+1,time_seconds:0}]}))},U=(p,k)=>{m(C=>({...C,split_times:C.split_times.map((_,T)=>T===p?{..._,time_seconds:k}:_)}))},X=p=>{m(k=>({...k,split_times:k.split_times.filter((C,_)=>_!==p).map((C,_)=>({...C,rep:_+1}))}))},de=()=>{m(p=>({...p,stroke_count:[...p.stroke_count,{rep:p.stroke_count.length+1,count:0}]}))},ne=(p,k)=>{m(C=>({...C,stroke_count:C.stroke_count.map((_,T)=>T===p?{..._,count:k}:_)}))},oe=p=>{m(k=>({...k,stroke_count:k.stroke_count.filter((C,_)=>_!==p).map((C,_)=>({...C,rep:_+1}))}))};return x?e.jsxs("div",{className:"px-3 py-2.5 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:v,disabled:r,className:"p-1.5 rounded-lg text-primary hover:bg-primary/10 transition","aria-label":"Enregistrer",children:e.jsx(Ye,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:h,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Annuler",children:e.jsx(Fe,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:n,className:"p-1.5 rounded-lg text-muted-foreground hover:text-destructive hover:bg-destructive/10 transition","aria-label":"Supprimer",children:e.jsx(Be,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground min-w-[80px]",children:[e.jsx(tt,{className:"h-3.5 w-3.5"}),"Tempo"]}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:f.tempo??"",onChange:p=>m(k=>({...k,tempo:p.target.value?Number(p.target.value):null})),placeholder:"coups/min",className:"w-24 rounded-xl border border-border bg-background px-2 py-1.5 text-sm text-center outline-none focus:ring-2 focus:ring-foreground/10"})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(Ve,{className:"h-3.5 w-3.5"}),"Temps"]}),e.jsxs("button",{type:"button",onClick:M,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Le,{className:"h-3 w-3"}),"Rep"]})]}),f.split_times.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:f.split_times.map((p,k)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:p.rep}),e.jsx("input",{type:"number",inputMode:"decimal",step:"0.1",min:0,value:p.time_seconds||"",onChange:C=>U(k,Number(C.target.value)||0),placeholder:"sec",className:"w-16 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>X(k),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx(Be,{className:"h-3 w-3"})})]},k))})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5 text-xs font-medium text-muted-foreground",children:[e.jsx(st,{className:"h-3.5 w-3.5"}),"Coups de bras"]}),e.jsxs("button",{type:"button",onClick:de,className:"inline-flex items-center gap-1 text-xs text-primary hover:text-primary/80 transition",children:[e.jsx(Le,{className:"h-3 w-3"}),"Rep"]})]}),f.stroke_count.length>0&&e.jsx("div",{className:"mt-1.5 flex flex-wrap gap-1.5",children:f.stroke_count.map((p,k)=>e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"text-[10px] text-muted-foreground w-4 text-right",children:p.rep}),e.jsx("input",{type:"number",inputMode:"numeric",min:0,value:p.count||"",onChange:C=>ne(k,Number(C.target.value)||0),placeholder:"nb",className:"w-14 rounded-lg border border-border bg-background px-1.5 py-1 text-xs text-center outline-none focus:ring-2 focus:ring-foreground/10"}),e.jsx("button",{type:"button",onClick:()=>oe(k),className:"p-0.5 text-muted-foreground hover:text-destructive transition",children:e.jsx(Be,{className:"h-3 w-3"})})]},k))})]}),e.jsx("textarea",{value:f.notes,onChange:p=>m(k=>({...k,notes:p.target.value})),placeholder:"Notes libres...",rows:2,className:"w-full resize-none rounded-xl border border-border bg-background px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-foreground/10"})]}):e.jsxs("div",{className:"px-3 py-2.5 space-y-1.5 group",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold text-foreground",children:t.exercise_label}),e.jsx("button",{type:"button",onClick:b,className:"p-1.5 rounded-lg text-muted-foreground hover:bg-muted transition","aria-label":"Modifier",children:e.jsx(qt,{className:"h-3.5 w-3.5"})})]}),e.jsxs("div",{className:"flex flex-wrap gap-x-4 gap-y-1 text-xs text-muted-foreground",children:[t.tempo!=null&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(tt,{className:"h-3 w-3"}),t.tempo," c/min"]}),t.split_times.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ve,{className:"h-3 w-3"}),t.split_times.map(p=>gs(p.time_seconds)).join(" / ")]}),t.stroke_count.length>0&&e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(st,{className:"h-3 w-3"}),t.stroke_count.map(p=>p.count).join(" / ")," cps"]})]}),t.notes&&e.jsx("div",{className:"text-xs text-foreground/70 italic",children:t.notes})]})}const Ns=["Lun","Mar","Mer","Jeu","Ven","Sam","Dim"],js=[{key:"AM",label:"Matin"},{key:"PM",label:"Soir"}],vs=[{key:"difficulty",label:"Difficulté",mode:"hard"},{key:"fatigue_end",label:"Fatigue fin",mode:"hard"},{key:"performance",label:"Perf perçue",mode:"good"},{key:"engagement",label:"Engagement",mode:"good"}];function xt(...t){return t.filter(Boolean).join(" ")}function pt(t){return String(t).padStart(2,"0")}function Je(t){return`${t.getFullYear()}-${pt(t.getMonth()+1)}-${pt(t.getDate())}`}function ws(t){return new Date(t.getFullYear(),t.getMonth(),1)}function ks(t){const s=String(t).split("__");return{iso:s[0],slotKey:s[1]||""}}function ft(t,s){return Number.isFinite(t)?Math.round(t/s)*s:0}function bt({open:t,title:s,onClose:n,children:r}){return e.jsx(Se,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(te.div,{className:"fixed inset-0 z-overlay bg-black/30",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onClick:n}),e.jsx(te.div,{className:"fixed inset-0 z-modal flex items-end sm:items-center justify-center p-3 pb-24 sm:p-4 sm:pb-4",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:e.jsxs("div",{className:"w-full max-w-md rounded-3xl border bg-background shadow-2xl overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between border-b px-4 py-3",children:[e.jsx("div",{className:"truncate text-base font-semibold text-foreground",children:s}),e.jsxs("button",{type:"button",onClick:n,className:"inline-flex items-center justify-center rounded-2xl border border-border bg-background p-2 transition hover:bg-muted","aria-label":"Fermer",children:[e.jsx(Fe,{className:"h-5 w-5"}),e.jsx("span",{className:"sr-only",children:"Fermer"})]})]}),e.jsx("div",{className:"p-4",children:r})]})})]})})}function Hs(){const{user:t,userId:s}=Dt(),{toast:n}=Ft(),r=gt(),[x,u]=ke.useState("idle"),[f,m]=ke.useState(!1),[b,h]=ke.useState(null);ke.useEffect(()=>{$e.auth.getSession().then(({data:i})=>{h(i.session?.user?.id??null)})},[t]);const{data:v,isLoading:M,error:U,refetch:X}=Ue({queryKey:["sessions",s??t],queryFn:()=>se.getSessions(t,s),enabled:!!t}),{data:de,isLoading:ne,error:oe,refetch:p}=Ue({queryKey:["assignments",t],queryFn:()=>se.getAssignments(t,s),enabled:!!t}),k=M||ne,C=U||oe,_=()=>{X(),p()},T=Me({mutationFn:i=>se.deleteSession(i),onMutate:()=>{u("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),n({title:"Séance supprimée",description:"La saisie a été supprimée."}),u("saved"),setTimeout(()=>u("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible de supprimer la séance.",variant:"destructive"}),u("error"),setTimeout(()=>u("idle"),3e3)}}),me=Me({mutationFn:async i=>{const{_exerciseLogs:d,...j}=i,F=await se.syncSession({...j,athlete_name:t,athlete_id:s??void 0});if(d&&d.length>0&&F.sessionId)try{const{data:Q}=await $e.auth.getSession(),ce=Q.session?.user?.id;ce&&await se.saveSwimExerciseLogs(F.sessionId,ce,d)}catch(Q){console.warn("[EAC] Failed to save exercise logs:",Q)}return F},onMutate:()=>{u("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["assignments"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),n({title:"Séance enregistrée",description:"Vos données ont été synchronisées."}),u("saved"),setTimeout(()=>u("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible d'enregistrer la séance.",variant:"destructive"}),u("error"),setTimeout(()=>u("idle"),3e3)}}),ue=Me({mutationFn:async i=>{const{_exerciseLogs:d,...j}=i,F=await se.updateSession(j);if(console.log("[EAC] updateMutation - exerciseLogs:",d),d&&j.id)try{const{data:Q}=await $e.auth.getSession(),ce=Q.session?.user?.id;console.log("[EAC] updateMutation - authUid:",ce,"sessionId:",j.id),ce?(console.log("[EAC] updateMutation - calling saveSwimExerciseLogs with logs:",d),await se.saveSwimExerciseLogs(j.id,ce,d),console.log("[EAC] updateMutation - saveSwimExerciseLogs completed successfully")):console.warn("[EAC] updateMutation - No authUid found, skipping exercise logs save")}catch(Q){throw console.error("[EAC] Failed to save exercise logs:",Q),Q}else console.log("[EAC] updateMutation - skipping exercise logs (empty or no session ID)");return F},onMutate:()=>{u("saving")},onSuccess:()=>{r.invalidateQueries({queryKey:["sessions"]}),r.invalidateQueries({queryKey:["hall-of-fame"]}),n({title:"Séance mise à jour",description:"Votre saisie a été mise à jour."}),u("saved"),setTimeout(()=>u("idle"),2e3)},onError:()=>{n({title:"Erreur",description:"Impossible de mettre à jour la séance.",variant:"destructive"}),u("error"),setTimeout(()=>u("idle"),3e3)}}),he=is({sessions:v,assignments:de,userId:s,user:t}),{today:w,monthCursor:$,selectedISO:K,drawerOpen:I,settingsOpen:D,infoOpen:O,activeSessionId:E,detailsOpen:Z,selectedDayIndex:ae,isPending:A,presenceDefaults:W,stableDurationMin:R,draftState:S,gridDates:q,completionByISO:re,selectedDate:ie,sessionsForSelectedDay:ee,selectedDayStatus:xe,globalKm:ye,dayKm:Ne,logsBySessionId:H,setMonthCursor:V,setSelectedISO:pe,setDrawerOpen:fe,setSettingsOpen:be,setInfoOpen:G,setActiveSessionId:Y,setDetailsOpen:B,setSelectedDayIndex:o,setPresenceDefaults:c,setAttendanceOverrideBySessionId:a,setStableDurationMin:g,setDraftState:y,setAutoCloseArmed:N,startTransition:P,getSessionStatus:z}=he,J=l.useCallback(i=>{pe(i),fe(!0),Y(null),B(!1);const d=re[i]||{completed:0,total:2};N(d.total>0&&d.completed<d.total)},[re,pe,fe,Y,B,N]),le=l.useCallback(()=>{fe(!1),Y(null),B(!1),N(!1),o(null)},[fe,Y,B,N,o]),je=l.useCallback(()=>{V(i=>new Date(i.getFullYear(),i.getMonth()-1,1))},[V]),Ee=l.useCallback(()=>{V(i=>new Date(i.getFullYear(),i.getMonth()+1,1))},[V]),jt=l.useCallback(()=>{const i=new Date;V(ws(i)),J(Je(i))},[J,V]),Ie=l.useCallback(i=>{Y(i),B(!1)},[Y,B]),vt=l.useCallback(i=>{P(()=>{a(j=>({...j,[i]:"absent"}))});const d=H[i];d?.id&&T.mutate(Number(d.id))},[T,H,P,a]),wt=l.useCallback(i=>{P(()=>{a(d=>({...d,[i]:"present"}))})},[P,a]),kt=l.useCallback(i=>{P(()=>{a(d=>{const j={...d};return delete j[i],j})})},[P,a]),St=l.useCallback(()=>{const i=ee.map(d=>z(d,ie).expected?d.id:null).filter(Boolean);i.length!==0&&(P(()=>{a(d=>{const j={...d};for(const F of i)j[F]="absent";return j}),Y(null),B(!1)}),i.forEach(d=>{const j=H[d];j?.id&&T.mutate(Number(j.id))}))},[ee,z,ie,P,H,T,a,Y,B]),Mt=l.useCallback(()=>{if(!E||!t||!vs.every(ve=>Number.isInteger(S[ve.key])))return;const{iso:d,slotKey:j}=ks(E),F=j==="PM"?"Soir":"Matin",Q=ft(Number(S.distanceMeters??0),100),ce=ft(Number(R),15),Pe={};for(const[ve,At]of Object.entries(S.strokes)){const Ge=Number(At);Ge>0&&(Pe[ve]=Ge)}const Xe={date:d,slot:F,distance:Q,duration:ce,effort:Number(S.difficulty),feeling:Number(S.fatigue_end),performance:Number(S.performance),engagement:Number(S.engagement),comments:String(S.comment||"").slice(0,400),athlete_name:t,athlete_id:s??void 0,stroke_distances:Object.keys(Pe).length>0?Pe:null},Ce=H[E];console.log("[EAC] saveFeedback - draftState.exerciseLogs:",S.exerciseLogs),P(()=>{a(ve=>({...ve,[E]:"present"}))}),Ce?.id?(console.log("[EAC] saveFeedback - updating existing session:",Ce.id),ue.mutate({...Xe,id:Ce.id,created_at:Ce.created_at??new Date().toISOString(),_exerciseLogs:S.exerciseLogs.length>0?S.exerciseLogs:[]})):(console.log("[EAC] saveFeedback - creating new session"),me.mutate({...Xe,_exerciseLogs:S.exerciseLogs.length>0?S.exerciseLogs:void 0})),Y(null),B(!1)},[E,t,s,S,R,H,P,ue,me,a,Y,B]),_t=l.useCallback((i,d)=>{c(j=>({...j,[i]:{...j[i],[d]:!j[i][d]}}))},[c]);l.useEffect(()=>{if(!I)return;const i=d=>{if(d.key==="Escape"){d.preventDefault(),le();return}(d.key==="Enter"||d.key===" ")&&(d.preventDefault(),ee.length>0&&!E&&Ie(ee[0].id))};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[I,le,ee,E,Ie]);const Ct=l.useCallback((i,d)=>{if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Enter"," "].includes(i.key))return;if(i.preventDefault(),i.key==="Enter"||i.key===" "){const Q=Je(q[d]);J(Q);return}let F=d;i.key==="ArrowLeft"&&(F=Math.max(0,d-1)),i.key==="ArrowRight"&&(F=Math.min(q.length-1,d+1)),i.key==="ArrowUp"&&(F=Math.max(0,d-7)),i.key==="ArrowDown"&&(F=Math.min(q.length-1,d+7)),o(F),pe(Je(q[F])),setTimeout(()=>{const Q=document.querySelectorAll('[data-calendar-cell="true"]');Q[F]&&Q[F].focus()},0)},[q,J,o,pe]);return k?e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"mx-auto max-w-6xl px-3 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"h-7 w-7 rounded-lg bg-primary/20 animate-pulse"}),e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("div",{className:"h-4 w-12 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-3 w-16 rounded bg-muted animate-pulse"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-xl bg-primary/5 animate-pulse"})]})]})}),e.jsx("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between px-3 sm:px-5 py-3 border-b border-border",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"h-6 w-32 rounded bg-muted animate-pulse"}),e.jsx("div",{className:"h-9 w-9 rounded-2xl bg-muted animate-pulse"})]}),e.jsx("div",{className:"p-3 sm:p-5",children:e.jsxs("div",{className:"grid grid-cols-7 gap-1.5 sm:gap-2",children:[Array.from({length:7}).map((i,d)=>e.jsx("div",{className:"px-0.5 pb-1 flex justify-center",children:e.jsx("div",{className:"h-3 w-4 rounded bg-muted animate-pulse"})},`wh-${d}`)),Array.from({length:35}).map((i,d)=>e.jsx("div",{className:"aspect-square rounded-2xl bg-muted/50 animate-pulse"},`cs-${d}`))]})})]})})]}):C?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Qt,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:C.message}),e.jsx(Lt,{onClick:()=>_(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"min-h-screen bg-muted",children:[e.jsx("div",{className:"sm:hidden fixed top-0 left-0 right-0 z-overlay border-b border-primary/15 bg-background/90 backdrop-blur-md",children:e.jsxs("div",{className:"px-4 py-2.5 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(He,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Suivi"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[ye," km"]}),e.jsx("button",{type:"button",onClick:()=>G(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Infos",children:e.jsx(nt,{className:"h-5 w-5 text-primary"})}),e.jsx("button",{type:"button",onClick:()=>be(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Paramètres",children:e.jsx(rt,{className:"h-5 w-5 text-primary"})})]})]})}),e.jsxs("div",{className:"mx-auto max-w-6xl px-3 sm:px-4 pt-20 pb-5 sm:py-8",children:[e.jsxs("div",{className:"invisible sm:visible flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2.5",children:[e.jsx("div",{className:"flex items-center justify-center h-7 w-7 rounded-lg bg-primary text-primary-foreground",children:e.jsx(He,{className:"h-3.5 w-3.5"})}),e.jsx("h1",{className:"text-lg font-display font-bold uppercase italic tracking-tight text-primary",children:"Suivi"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs font-mono font-semibold text-muted-foreground tabular-nums",children:[ye," km"]}),e.jsx("button",{type:"button",onClick:()=>G(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Infos",children:e.jsx(nt,{className:"h-5 w-5 text-primary"})}),e.jsx("button",{type:"button",onClick:()=>be(!0),className:"inline-flex items-center justify-center rounded-xl border border-primary/20 bg-primary/5 p-2 transition hover:bg-primary/10","aria-label":"Paramètres",children:e.jsx(rt,{className:"h-5 w-5 text-primary"})})]})]}),e.jsxs("div",{className:"mt-4 rounded-3xl border border-border bg-card overflow-hidden",children:[e.jsx(It,{monthCursor:$,selectedDayStatus:xe,onPrevMonth:je,onNextMonth:Ee,onJumpToday:jt}),e.jsx(Pt,{monthCursor:$,gridDates:q,completionByISO:re,selectedISO:K,selectedDayIndex:ae,today:w,onDayClick:J,onKeyDown:Ct})]}),b&&e.jsx(hs,{userId:b,expanded:f,onToggle:()=>m(i=>!i)}),e.jsx(bt,{open:O,title:"Codes",onClose:()=>G(!1),children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-orange-200 bg-orange-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Orange"}),e.jsx("span",{className:"text-foreground",children:"À compléter"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-emerald-200 bg-emerald-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Vert"}),e.jsx("span",{className:"text-foreground",children:"Validé → km"})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border border-sky-200 bg-sky-50 px-3 py-2",children:[e.jsx("span",{className:"font-semibold",children:"Bleu"}),e.jsx("span",{className:"text-foreground",children:"Absent / Non prévu"})]}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Les km comptent uniquement après validation."})]})}),e.jsx(bt,{open:D,title:"Présence",onClose:()=>be(!1),children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Toggle hebdo (séances attendues)."}),e.jsxs("div",{className:"overflow-hidden rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_110px_110px] bg-muted border-b border-border px-3 py-2 text-xs font-semibold text-muted-foreground",children:[e.jsx("div",{children:"Jour"}),e.jsx("div",{className:"text-center",children:"Matin"}),e.jsx("div",{className:"text-center",children:"Soir"})]}),Ns.map((i,d)=>e.jsxs("div",{className:xt("grid grid-cols-[1fr_110px_110px] items-center px-3 py-2",d!==6&&"border-b border-border"),children:[e.jsx("div",{className:"text-sm font-medium text-foreground",children:i}),js.map(j=>{const F=!!W?.[d]?.[j.key];return e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{type:"button",onClick:()=>_t(d,j.key),className:xt("w-24 rounded-2xl border px-3 py-2 text-sm font-semibold transition",F?"bg-foreground text-background border-foreground":"bg-card text-foreground border-border hover:bg-muted"),"aria-label":`${i} ${j.label}`,children:F?"On":"Off"})},j.key)})]},i))]}),e.jsxs("div",{className:"rounded-2xl border border-border bg-muted px-3 py-2",children:[e.jsx("div",{className:"text-xs font-semibold text-foreground",children:"Durée (valeur par défaut)"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>g(i=>Math.max(30,i-15)),"aria-label":"Diminuer la durée",children:e.jsx(Nt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-sm font-semibold text-foreground",children:[R," min"]}),e.jsx("button",{type:"button",className:"h-9 w-9 rounded-2xl border border-border bg-card hover:bg-muted flex items-center justify-center",onClick:()=>g(i=>Math.min(240,i+15)),"aria-label":"Augmenter la durée",children:e.jsx(Le,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"mt-1 text-[11px] text-muted-foreground",children:"Durée envoyée au back-end (non affichée dans la maquette)."})]})]})}),e.jsx(ps,{open:I,selectedDate:ie,sessionsForSelectedDay:ee,selectedDayStatus:xe,dayKm:Ne,activeSessionId:E,detailsOpen:Z,draftState:S,saveState:x,isPending:A,logsBySessionId:H,onClose:le,onDayOffAll:St,onOpenSession:Ie,onCloseSession:()=>{Y(null),B(!1)},onToggleDetails:()=>B(i=>!i),onMarkAbsent:vt,onMarkPresent:wt,onClearOverride:kt,onSaveFeedback:Mt,onDraftStateChange:y,getSessionStatus:z})]})]})}export{Hs as default};
