import{l as O,u as W,M as P,N as V,r as w,a as A,Q as K,am as T,j as e,al as C,C as g,i as x,ah as L,g as F,h as z,a0 as H,B as J,k as v}from"./index-DqxBy9a5.js";import{B as D}from"./badge-CiNZkEw9.js";import{T as X}from"./textarea-DAeIa66o.js";import{A as Y}from"./arrow-left-AyLXC9Wt.js";import{f as k}from"./format-B9mPVj_w.js";import{f as $}from"./fr-CFyqyHeU.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Z=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],ee=O("send",Z),se=(t,r)=>t.target_group_id?`group:${t.target_group_id}`:r&&t.sender_id!==null&&t.sender_id!==void 0&&t.sender_id!==r?`user:${t.sender_id}`:r&&t.counterparty_id!==null&&t.counterparty_id!==void 0?`user:${t.counterparty_id}`:r&&t.target_user_id?`user:${t.target_user_id}`:t.counterparty_id!==null&&t.counterparty_id!==void 0?`user:${t.counterparty_id}`:t.sender_id!==null&&t.sender_id!==void 0?`user:${t.sender_id}`:t.sender_email?`email:${t.sender_email}`:`sender:${t.sender}`,te=t=>[...t].sort((r,l)=>new Date(r.date).getTime()-new Date(l.date).getTime()),re=t=>t.filter(r=>!r.read).map(r=>r.target_id??r.id).filter(r=>Number.isFinite(r)),ae=({message:t,senderId:r,senderLabel:l,targetUserId:o,targetGroupId:a,title:m="Message"})=>({id:Date.now(),sender:l||"Coach",sender_name:l||null,sender_id:r??null,sender_email:null,target_user_id:o??null,target_group_id:a??null,title:m,message:t,type:"message",read:!0,date:new Date().toISOString()}),ne=(t,r)=>{const l=new Map;return t.forEach(o=>{const a=se(o,r);l.has(a)||l.set(a,[]),l.get(a)?.push(o)}),Array.from(l.entries()).map(([o,a])=>{const m=te(a),p=m[m.length-1],h=a.some(i=>!i.read),f=o.startsWith("user:")?Number(o.split(":")[1]):null,j=o.startsWith("group:")?Number(o.split(":")[1]):null,_=r?a.find(i=>i.sender_id&&i.sender_id!==r)??p:p,b=a.find(i=>i.counterparty_name)?.counterparty_name,y=a.find(i=>i.target_group_name)?.target_group_name??null,N=r?a.find(i=>i.target_id)?.target_id??null:a.find(i=>i.target_id)?.target_id??null;return{key:o,senderId:p.sender_id??null,senderLabel:y??b??_.sender,messages:m,lastMessage:p,lastTimestamp:new Date(p.date).getTime(),hasUnread:h,counterpartyId:Number.isFinite(f)?f:null,targetGroupId:Number.isFinite(j)?j:null,targetGroupName:y,replyTargetId:N}})};function me(){const{user:t,userId:r,role:l}=W(),{toast:o}=P(),a=V(),[m,p]=w.useState(null),[h,f]=w.useState(""),{data:j,isLoading:_,error:b}=A({queryKey:["notifications",r,t,"threads"],queryFn:()=>v.notifications_list({targetUserId:r,targetAthleteName:t,limit:200,offset:0,type:"message",order:"desc"}),enabled:!!t,refetchInterval:1e4}),{data:y,error:N}=A({queryKey:["capabilities","messaging"],queryFn:()=>v.getCapabilities(),enabled:T.hasSupabase}),i=K({mutationFn:s=>v.notifications_mark_read({targetId:s}),onMutate:async s=>{await a.cancelQueries({queryKey:["notifications"]});const n=a.getQueryData(["notifications",r,t,"threads"]);return a.setQueryData(["notifications",r,t,"threads"],d=>d?.notifications?{...d,notifications:d.notifications.map(c=>(c.target_id??c.id)===s?{...c,read:!0}:c)}:d),{previous:n}},onError:(s,n,d)=>{d?.previous&&a.setQueryData(["notifications",r,t,"threads"],d.previous)},onSettled:()=>{a.invalidateQueries({queryKey:["notifications"]})}}),E=K({mutationFn:s=>v.notifications_send({title:"Message",body:s.message,type:"message",targets:[s.targetGroupId?{target_group_id:s.targetGroupId}:{target_user_id:s.targetUserId||null}],reply_to_target_id:s.replyTargetId??void 0}),onMutate:async s=>{if(!s.message.trim())return;await a.cancelQueries({queryKey:["notifications",r,t,"threads"]});const n=a.getQueryData(["notifications",r,t,"threads"]),d=ae({message:s.message,senderId:r,senderLabel:t??"Coach",targetUserId:s.targetUserId,targetGroupId:s.targetGroupId??null});return a.setQueryData(["notifications",r,t,"threads"],c=>c?.notifications?{...c,notifications:[d,...c.notifications]}:c),{previous:n}},onSuccess:()=>{f(""),a.invalidateQueries({queryKey:["notifications"]})},onError:(s,n,d)=>{d?.previous&&a.setQueryData(["notifications",r,t,"threads"],d.previous);const c=C(s,"Le message n'a pas pu être envoyé.");o({title:"Envoi impossible",description:c.message,variant:"destructive"})}}),M=j?.notifications??[],G=M.filter(s=>!s.read).length,I=w.useMemo(()=>ne(M,r).sort((s,n)=>n.lastTimestamp-s.lastTimestamp),[M,r]),Q=I.filter(s=>!s.targetGroupId),S=I.filter(s=>s.targetGroupId),u=m?I.find(s=>s.key===m):null,q=!!(u?.counterpartyId||u?.targetGroupId)&&(l!=="athlete"||!T.hasSupabase||!!u?.replyTargetId),U=s=>{p(s.key),re(s.messages).forEach(d=>i.mutate(d))};if(_)return e.jsx("div",{className:"space-y-4 p-4",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-start gap-3 rounded-xl bg-muted animate-pulse motion-reduce:animate-none p-4",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-muted-foreground/10"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 w-3/4 rounded bg-muted-foreground/10"}),e.jsx("div",{className:"h-3 w-1/2 rounded bg-muted-foreground/10"})]})]},s))});const B=N?C(N,"Impossible de vérifier la messagerie.").message:y?.mode==="supabase"&&!y.messaging.available?"Messagerie indisponible (tables manquantes côté D1).":null,R=b?C(b,"Impossible de charger les messages.").message:null;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Messagerie"}),G>0&&e.jsxs(D,{variant:"destructive",children:[G," non lus"]})]}),B?e.jsx(g,{className:"border-dashed",children:e.jsx(x,{className:"py-4 text-sm text-muted-foreground",children:B})}):null,R?e.jsx(g,{className:"border-destructive/40",children:e.jsx(x,{className:"py-4 text-sm text-destructive",children:R})}):null,u?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center gap-2 text-sm text-muted-foreground",onClick:()=>p(null),children:[e.jsx(Y,{className:"h-4 w-4"}),"Retour"]}),e.jsxs(g,{children:[e.jsxs(F,{children:[e.jsx(z,{children:u.senderLabel}),e.jsx(H,{children:"Conversation"})]}),e.jsx(x,{className:"space-y-3",children:u.messages.map(s=>{const n=s.sender_id===r;return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`flex items-end gap-2 ${n?"flex-row-reverse":"flex-row"}`,children:[e.jsxs("div",{className:`max-w-[80%] rounded-2xl border px-4 py-3 text-sm shadow-sm ${n?"border-primary/40 bg-primary text-primary-foreground":"border-border bg-muted/50 text-foreground"}`,children:[e.jsx("div",{className:`text-xs ${n?"text-primary-foreground/80":"text-muted-foreground"}`,children:s.sender}),e.jsx("div",{className:"mt-1",children:s.message})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:k(new Date(s.date),"HH:mm",{locale:$})})]})},s.id)})})]}),e.jsxs(g,{children:[e.jsxs(F,{children:[e.jsx(z,{children:q?"Répondre":"Réponse indisponible"}),e.jsx(H,{children:"Répondez à ce fil."})]}),e.jsx(x,{className:"space-y-3",children:q?e.jsxs(e.Fragment,{children:[e.jsx(X,{value:h,onChange:s=>f(s.target.value),placeholder:"Votre message...",rows:3}),e.jsxs(J,{onClick:()=>{const s=u.counterpartyId,n=u.targetGroupId;if(!s&&!n){o({title:"Envoi impossible",description:"Destinataire introuvable pour ce fil.",variant:"destructive"});return}E.mutate({targetUserId:s??0,targetGroupId:n,message:h,replyTargetId:l==="athlete"&&T.hasSupabase?u.replyTargetId:null})},disabled:!h.trim()||E.isPending,children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),"Envoyer"]})]}):e.jsx("div",{className:"text-sm text-muted-foreground",children:l==="athlete"?"Réponse possible uniquement sur un fil existant.":"Aucun destinataire disponible pour ce fil."})})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-bold uppercase text-muted-foreground tracking-wider ml-1",children:"Discussions"}),e.jsxs("div",{className:"space-y-3",children:[Q.map(s=>e.jsx("button",{type:"button",onClick:()=>U(s),className:"w-full text-left",children:e.jsx(g,{className:"group hover:bg-muted/50 transition-colors border-l-4 border-l-transparent hover:border-l-primary",children:e.jsxs(x,{className:"p-4 flex items-start gap-4",children:[e.jsx("div",{className:`p-2 rounded-full ${s.hasUnread?"bg-primary/20":"bg-muted"}`,children:e.jsx(L,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-bold truncate",children:s.senderLabel}),e.jsx("div",{className:"text-xs text-muted-foreground shrink-0 ml-2",children:k(new Date(s.lastMessage.date),"dd MMM",{locale:$})})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1 break-words",children:s.lastMessage.message})]}),s.hasUnread?e.jsx(D,{variant:"secondary",children:"Non lu"}):null]})})},s.key)),Q.length===0?e.jsx(g,{className:"border-dashed",children:e.jsx(x,{className:"py-10 text-center text-sm text-muted-foreground",children:"Aucune discussion directe pour le moment."})}):null]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-bold uppercase text-muted-foreground tracking-wider ml-1",children:"Groupes"}),e.jsxs("div",{className:"space-y-3",children:[S.map(s=>e.jsx("button",{type:"button",onClick:()=>U(s),className:"w-full text-left",children:e.jsx(g,{className:"group hover:bg-muted/50 transition-colors border-l-4 border-l-transparent hover:border-l-primary",children:e.jsxs(x,{className:"p-4 flex items-start gap-4",children:[e.jsx("div",{className:`p-2 rounded-full ${s.hasUnread?"bg-primary/20":"bg-muted"}`,children:e.jsx(L,{className:"h-4 w-4 text-primary"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"font-bold truncate",children:s.senderLabel}),e.jsx("div",{className:"text-xs text-muted-foreground shrink-0 ml-2",children:k(new Date(s.lastMessage.date),"dd MMM",{locale:$})})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-1 break-words",children:s.lastMessage.message})]}),s.hasUnread?e.jsx(D,{variant:"secondary",children:"Non lu"}):null]})})},s.key)),S.length===0?e.jsx(g,{className:"border-dashed",children:e.jsx(x,{className:"py-10 text-center text-sm text-muted-foreground",children:"Aucun message de groupe pour le moment."})}):null]})]})]})]})}export{ae as buildOptimisticNotification,re as collectThreadMarkReadTargets,me as default,se as getThreadKey,ne as groupNotificationsBySender,te as sortThreadMessages};
