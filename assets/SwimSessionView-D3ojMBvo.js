import{c as O,r as d,u as A,d as q,j as e}from"./vendor-query-BiSH4r2z.js";import{u as V,b as G,d as J,B as g,C as W,g as X,S as f,s as D}from"./index-C8Ys7NvK.js";import{B as T}from"./badge-DJWnxWLy.js";import{S as Y}from"./separator-CT1vy_z9.js";import{S as Z}from"./SwimSessionTimeline-DiakJr61.js";import{a as u}from"./api-R6k1jfwT.js";import{g as ee}from"./swim-CkD6PybV.js";import{C as se}from"./circle-alert-Cg7m_XSV.js";import{C as te}from"./chevron-left-DMUmdAzT.js";import{S as ae}from"./share-2-BF5GJL3a.js";import{L as ie}from"./loader-circle-D0udGttj.js";import{S as ne}from"./save-Ww2aBx5r.js";import{f as re}from"./format-B9mPVj_w.js";import{f as oe}from"./fr-CFyqyHeU.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";import"./chevron-up-Ct0_XNME.js";import"./hash-C1ISu5Xm.js";import"./timer-B1SGIBEM.js";import"./eye-rTkmdiOu.js";import"./chevron-down-BgKZKOjT.js";import"./clock-BEHiY6By.js";const ce={assigned:"Assignée",pending:"Assignée",in_progress:"En cours",completed:"Terminée",cancelled:"Annulée"},le=a=>{if(!a)return"-";const r=new Date(a);return Number.isNaN(r.getTime())?a:re(r,"dd MMM",{locale:oe})};function de(a){const r=new Map;for(const o of a)o.source_item_id!=null&&r.set(o.source_item_id,{exercise_label:o.exercise_label,source_item_id:o.source_item_id,split_times:o.split_times,tempo:o.tempo,stroke_count:o.stroke_count,notes:o.notes});return r}function me(a){return a&&new Date(a).getHours()>=14?"Soir":"Matin"}function Te(){const{user:a,userId:r}=V(),[o,_]=G(),{toast:m}=J(),w=O(),[R,z]=d.useState(null),[j,B]=d.useState(null),[F,L]=d.useState(!1),C=d.useMemo(()=>{const[,s]=o.split("?");if(!s)return null;const l=new URLSearchParams(s).get("assignmentId"),c=l?Number(l):NaN;return Number.isFinite(c)?c:null},[o]),{data:K,isLoading:k,error:E,refetch:Q}=A({queryKey:["assignments",a],queryFn:()=>u.getAssignments(a,r),enabled:!!a}),I=K?.filter(s=>s.session_type==="swim")||[],t=C?I.find(s=>s.id===C):I[0],M=t?.session_id,{data:N}=A({queryKey:["swim-exercise-logs-by-catalog",M,r],queryFn:async()=>{const{data:s}=await D.auth.getSession(),i=s.session?.user?.id;if(!i)return[];const c=(await u.getSessions(a,r)).map(n=>n.id);if(c.length===0)return[];const h=[];for(const n of c.slice(0,10)){const y=await u.getSwimExerciseLogs(n);h.push(...y.filter(S=>S.user_id===i))}const p=new Set((t?.items??[]).map(n=>n.id).filter(Boolean));return h.filter(n=>n.source_item_id!=null&&p.has(n.source_item_id))},enabled:!!M&&!!r&&!!a}),x=d.useMemo(()=>j||(N?de(N):new Map),[j,N]),P=d.useCallback(s=>{z(i=>i===s?null:s)},[]),$=d.useCallback((s,i)=>{B(l=>{const c=new Map(l??x);return c.set(s,i),c}),L(!0)},[x]),v=q({mutationFn:async()=>{const{data:s}=await D.auth.getSession(),i=s.session?.user?.id;if(!i||!a)throw new Error("Non authentifié");const l=t?.assigned_date?new Date(t.assigned_date).toISOString().slice(0,10):new Date().toISOString().slice(0,10),c=me(t?.assigned_date),h=await u.ensureSwimSession({athleteName:a,athleteId:r,date:l,slot:c}),p=[];for(const[,n]of x){const y=(n.split_times??[]).some(b=>b.time_seconds>0),S=(n.stroke_count??[]).some(b=>b.count>0);(y||S||n.tempo!=null||n.notes?.trim())&&p.push(n)}if(p.length===0)throw new Error("Aucune donnée à sauvegarder");await u.saveSwimExerciseLogs(h,i,p)},onSuccess:()=>{L(!1),w.invalidateQueries({queryKey:["swim-exercise-logs-by-catalog"]}),w.invalidateQueries({queryKey:["swim-exercise-logs-history"]}),m({title:"Notes techniques sauvegardées"})},onError:s=>{m({title:"Erreur",description:s.message,variant:"destructive"})}}),U=q({mutationFn:s=>u.assignments_delete(s),onSuccess:()=>{w.invalidateQueries({queryKey:["assignments"]}),m({title:"Séance retirée",description:"La séance a été retirée de votre feed."}),_("/")},onError:()=>{m({title:"Erreur",description:"Impossible de retirer la séance.",variant:"destructive"})}}),H=async()=>{if(t)try{const s=await ee(t.session_id),i=`${window.location.origin}${window.location.pathname}#/s/${s}`;navigator.share?await navigator.share({title:t.title,url:i}):(await navigator.clipboard.writeText(i),m({title:"Lien copié !",description:"Le lien de partage a été copié dans le presse-papier."}))}catch{m({title:"Erreur",description:"Impossible de générer le lien de partage.",variant:"destructive"})}};return E?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(se,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:E.message}),e.jsx(g,{onClick:()=>Q(),className:"mt-4",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(g,{variant:"ghost",size:"icon",onClick:()=>_("/"),"aria-label":"Retour à l'accueil",children:e.jsx(te,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs uppercase tracking-[0.2em] text-muted-foreground",children:"Séance natation"}),e.jsx("h1",{className:"text-2xl font-display font-bold uppercase",children:"Détails"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t?e.jsx(g,{variant:"ghost",size:"icon",onClick:H,"aria-label":"Partager la séance",children:e.jsx(ae,{className:"h-5 w-5"})}):null,t?e.jsx(T,{variant:"secondary",className:"text-xs",children:ce[t.status]??"Assignée"}):null]})]}),e.jsx(W,{className:"border border-border shadow-sm",children:e.jsxs(X,{className:"space-y-4 p-5",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("div",{className:"text-lg font-semibold tracking-tight",children:t?.title??"Séance natation"}),t?.description?e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description}):null]}),e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx(T,{variant:"outline",className:"text-xs",children:le(t?.assigned_date)}),t?e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>{window.confirm("Retirer cette séance de votre feed ?")&&U.mutate(t.id)},className:"text-xs text-muted-foreground hover:text-foreground",children:"Retirer de mon feed"}):null]}),e.jsx(Y,{}),t&&!k?e.jsx("div",{className:"rounded-xl bg-muted/50 px-3 py-2 text-xs text-muted-foreground leading-relaxed",children:"Tapez sur un exercice pour ajouter vos temps et détails techniques."}):null,k?e.jsxs("div",{className:"space-y-4","aria-live":"polite","aria-busy":"true",children:[e.jsx("div",{className:"sr-only",children:"Chargement de la séance..."}),e.jsx(f,{className:"h-6 w-48"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((s,i)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-5 w-32"}),e.jsx(f,{className:"h-4 w-full"}),e.jsx(f,{className:"h-4 w-3/4"})]},`skeleton-${i}`))})]}):t?e.jsx(Z,{title:t.title,description:t.description,items:t.items,showHeader:!0,exerciseLogs:x,expandedItemId:R,onToggleExpand:P,onLogChange:$}):e.jsx("div",{className:"rounded-2xl border border-dashed border-muted/70 bg-muted/30 p-6 text-sm text-muted-foreground",children:"Aucune séance de natation assignée pour le moment."})]})}),F&&e.jsx("div",{className:"fixed bottom-6 left-0 right-0 flex justify-center z-50 px-4",children:e.jsxs(g,{onClick:()=>v.mutate(),disabled:v.isPending,className:"gap-2 shadow-lg",children:[v.isPending?e.jsx(ie,{className:"h-4 w-4 animate-spin"}):e.jsx(ne,{className:"h-4 w-4"}),"Enregistrer"]})})]})}export{Te as default};
