import{j as e,R as W,r as g}from"./vendor-ui-DJQMR4VV.js";import{b as $e,u as X,c as K}from"./vendor-query-BT4y-huw.js";import{c as Le,a as b,I as C,B as F,f as Be,u as Fe,d as q,S as E}from"./index-Dyae1WSo.js";import{D as ye,a as ge}from"./dialog-DjPZW-Ir.js";import{A as Q,a as J,b as H,c as Y,d as G,e as Z,f as ee,g as te}from"./alert-dialog-CsqA_DN1.js";import{i as je,g as Re,c as ve,b as ze,a as Ne,R as Oe,L as Pe}from"./SwimSessionConsultation-Dd9UlKUN.js";import{F as Ue,S as Ie,A as We,a as Xe,b as se}from"./SessionListView-D4MgI1Av.js";import{T as Ke}from"./textarea-CzJAa6oU.js";import{S as ne,a as re,b as ie,c as le,d as ae}from"./select-D6RXW32l.js";import{T as R,P as z}from"./trash-2-Br0HBeec.js";import{f as Qe}from"./vendor-date-cQbdWov0.js";import{C as oe}from"./circle-alert-CJjyTAV2.js";import{S as Je}from"./search-BdFXoBi_.js";import{T as He}from"./timer-BBSE03PN.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Db4xOvcx.js";import"./vendor-supabase-D7B1G6YZ.js";import"./badge-AL0P0Psw.js";import"./chevron-left-Yt11NKF_.js";import"./save-CxueBLCZ.js";import"./chevron-up-DYGqpyYs.js";import"./check-C_sojMmi.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Ge=Le("copy",Ye),ce=["V0","V1","V2","V3","Max"],Ze={V0:"bg-intensity-1",V1:"bg-intensity-2",V2:"bg-intensity-3",V3:"bg-intensity-4",Max:"bg-intensity-5"},de={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},et=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const i=s.toLowerCase();if(de[i])return de[i];const r=s.toUpperCase();if(r==="MAX")return"Max";if(r.startsWith("V")){const n=r.replace("V","V");return n==="V4"||n==="V5"?"Max":n}return s};function tt({value:t,onChange:s,className:i,ariaLabel:r="S√©lection d'intensit√©"}){const n=et(t),p=ce.includes(n)?n:"Max";return e.jsx("div",{role:"radiogroup","aria-label":r,className:b("flex flex-wrap items-center gap-2",i),children:ce.map(u=>{const l=p===u;return e.jsxs("button",{type:"button",role:"radio","aria-checked":l,"aria-label":`Intensit√© ${u==="Max"?"MAX":u}`,onClick:()=>s(u),className:b("flex flex-col items-center gap-1 rounded-full px-2 py-1 text-[10px] font-semibold text-muted-foreground transition","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",l?"text-foreground":"hover:text-foreground"),children:[e.jsx("span",{className:b("h-3 w-3 rounded-full",l?Ze[u]??"bg-primary":"bg-muted")}),e.jsx("span",{children:u==="Max"?"MAX":u})]},u)})})}const $=t=>t?{min:Math.floor(t/60),sec:t%60}:{min:0,sec:0},st=[{value:"palmes",label:"Palmes"},{value:"tuba",label:"Tuba"},{value:"plaquettes",label:"Plaquettes"},{value:"pull",label:"Pull"},{value:"elastique",label:"√âlastique"}],nt=[{value:"pap",label:"Papillon"},{value:"dos",label:"Dos"},{value:"brasse",label:"Brasse"},{value:"crawl",label:"Crawl"},{value:"4n",label:"4 nages"},{value:"spe",label:"Sp√©"}],rt=[{value:"nc",label:"NC"},{value:"educ",label:"Educ"},{value:"jambes",label:"Jambes"}],ue={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},it=["V0","V1","V2","V3","Max"],lt=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const i=s.toLowerCase();if(ue[i])return ue[i];const r=s.toUpperCase();if(r==="MAX")return"Max";if(r.startsWith("V")){const n=Number.parseInt(r.slice(1),10);if(Number.isFinite(n)&&n>=4)return"Max";if(it.includes(r))return r}return s},at=t=>t==="Max"?"MAX":t,ot={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5"},ct={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30"};function dt({exercise:t,onChange:s,onDelete:i,onDuplicate:r,showDelete:n=!0}){const p=lt(t.intensity),u=t.modalities??"";return e.jsx("div",{className:"rounded-2xl border border-border bg-card p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"grid flex-1 grid-cols-2 sm:grid-cols-4 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"R√©p."}),e.jsx("div",{className:"mt-1",children:e.jsx(C,{type:"number",min:1,value:t.repetitions??"",onChange:l=>s("repetitions",l.target.value===""?null:Number(l.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Dist. (m)"}),e.jsx("div",{className:"mt-1",children:e.jsx(C,{type:"number",min:0,value:t.distance??"",onChange:l=>s("distance",l.target.value===""?null:Number(l.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Nage"}),e.jsx("div",{className:"mt-1",children:e.jsxs(ne,{value:t.stroke,onValueChange:l=>s("stroke",l),children:[e.jsx(re,{className:"rounded-2xl",children:e.jsx(ie,{})}),e.jsx(le,{children:nt.map(l=>e.jsx(ae,{value:l.value,children:l.label},l.value))})]})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Type"}),e.jsx("div",{className:"mt-1",children:e.jsxs(ne,{value:t.strokeType,onValueChange:l=>s("strokeType",l),children:[e.jsx(re,{className:"rounded-2xl",children:e.jsx(ie,{})}),e.jsx(le,{children:rt.map(l=>e.jsx(ae,{value:l.value,children:l.label},l.value))})]})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Intensit√© (clic sur points)"}),e.jsxs("span",{className:b("inline-flex items-center gap-2 rounded-full bg-card px-2.5 py-1 text-xs font-semibold ring-1",ct[p],ot[p]),children:[e.jsx("span",{className:b("h-2 w-2 rounded-full",je[p]??"bg-muted")}),at(p)]})]}),e.jsx("div",{className:"mt-2 flex items-center justify-between gap-2",children:e.jsx(tt,{value:t.intensity,onChange:l=>s("intensity",l)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"R√©cup√©ration"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsxs("div",{className:"inline-flex rounded-full border border-border bg-card p-0.5 text-xs font-semibold",children:[e.jsx("button",{type:"button",onClick:()=>s("restType","departure"),className:b("rounded-full px-3 py-1.5 transition-colors",t.restType==="departure"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:"D√©part"}),e.jsx("button",{type:"button",onClick:()=>s("restType","rest"),className:b("rounded-full px-3 py-1.5 transition-colors",t.restType==="rest"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:"Repos"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(C,{type:"number",min:0,max:59,value:$(t.rest).min||"",onChange:l=>{const x=l.target.value===""?0:Number(l.target.value),f=$(t.rest).sec;s("rest",x*60+f||null)},placeholder:"0",className:"w-14 rounded-2xl text-center"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"min"}),e.jsx(C,{type:"number",min:0,max:59,value:$(t.rest).sec||"",onChange:l=>{const x=l.target.value===""?0:Number(l.target.value),f=$(t.rest).min;s("rest",f*60+x||null)},placeholder:"0",className:"w-14 rounded-2xl text-center"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"sec"})]}),t.rest?e.jsx("button",{type:"button",onClick:()=>s("rest",null),className:"text-xs text-muted-foreground hover:text-foreground",children:"Effacer"}):null]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"√âquipements"}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:st.map(l=>{const x=t.equipment.includes(l.value),f=Re(l.value);return e.jsxs("button",{type:"button",onClick:()=>{const N=x?t.equipment.filter(w=>w!==l.value):[...t.equipment,l.value];s("equipment",N)},className:b("inline-flex items-center gap-2 rounded-full border px-3 py-2 text-xs font-semibold",x?"border-primary bg-primary text-primary-foreground":"border-border bg-card text-muted-foreground hover:bg-muted"),children:[e.jsx("span",{className:b("inline-flex h-7 w-7 items-center justify-center rounded-full",x?"bg-white/10":"bg-muted"),children:f?e.jsx("img",{src:f,alt:"",className:"h-4 w-4","aria-hidden":"true",loading:"lazy"}):null}),l.label]},l.value)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Modalit√©s"}),e.jsx("div",{className:"mt-1",children:e.jsx(Ke,{value:u,onChange:l=>s("modalities",l.target.value),placeholder:"Une modalit√© par ligne",rows:3,className:"rounded-2xl"})})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[r&&e.jsx("button",{type:"button",onClick:r,className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-muted-foreground hover:bg-muted","aria-label":"Dupliquer exercice",title:"Dupliquer exercice",children:e.jsx(Ge,{className:"h-4 w-4"})}),n&&i&&e.jsx("button",{type:"button",onClick:i,className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer exercice",title:"Supprimer exercice",children:e.jsx(R,{className:"h-4 w-4"})})]})]})})}const ut={nc:"NC",educ:"Educ",jambes:"Jambes"},mt={nc:"bg-sky-100 text-sky-900 ring-sky-200",educ:"bg-violet-100 text-violet-900 ring-violet-200",jambes:"bg-teal-100 text-teal-900 ring-teal-200"},pt={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5"},xt={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30"},me={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},ft=["V0","V1","V2","V3","Max"],O=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const i=s.toLowerCase();if(me[i])return me[i];const r=s.toUpperCase();if(r==="MAX")return"Max";if(r.startsWith("V")){const n=Number.parseInt(r.slice(1),10);if(Number.isFinite(n)&&n>=4)return"Max";if(ft.includes(r))return r}return s},ht=t=>t==="Max"?"MAX":t,bt=t=>{if(!t)return"";const s=Math.floor(t/60),i=t%60;return s>0&&i>0?`${s}'${i.toString().padStart(2,"0")}`:s>0?`${s}'00`:`${i}s`},pe=t=>{let s=0;return t.flatMap((i,r)=>i.exercises.map((n,p)=>{const u={block_title:i.title,block_description:i.description||null,block_order:r,block_repetitions:i.repetitions??null,block_modalities:i.modalities||null,block_equipment:i.equipment??[],exercise_repetitions:n.repetitions??null,exercise_rest:n.rest??null,exercise_rest_type:n.restType??"rest",exercise_stroke:n.stroke||null,exercise_stroke_type:n.strokeType||null,exercise_intensity:n.intensity?O(n.intensity):null,exercise_modalities:n.modalities||null,exercise_equipment:n.equipment??[],exercise_order:p},l=n.repetitions&&n.distance?`${n.repetitions}x${n.distance}m`:n.distance?`${n.distance}m`:null;return{ordre:s++,label:l,distance:n.distance??null,duration:null,intensity:n.intensity?O(n.intensity):null,notes:n.modalities||null,raw_payload:u}}))};function yt({session:t,onSessionChange:s,onSave:i,onCancel:r,userId:n,isSaving:p}){const[u,l]=W.useState(null),[x,f]=W.useState(null),N=g.useMemo(()=>ve(pe(t.blocks)),[t.blocks]),w=()=>{s({...t,blocks:[...t.blocks,{title:"Nouveau bloc",repetitions:1,description:"",modalities:"",equipment:[],exercises:[{repetitions:4,distance:50,rest:null,restType:"rest",stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}]}]})},y=(c,d,a)=>{const m=[...t.blocks];m[c]={...m[c],[d]:a},s({...t,blocks:m})},L=c=>{const d=t.blocks.filter((a,m)=>m!==c);s({...t,blocks:d})},_=(c,d)=>{const a=d==="up"?c-1:c+1;if(a<0||a>=t.blocks.length)return;const m=[...t.blocks],[h]=m.splice(c,1);m.splice(a,0,h),s({...t,blocks:m})},T=c=>{const d=[...t.blocks];d[c].exercises.push({repetitions:4,distance:50,rest:null,restType:"rest",stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}),s({...t,blocks:d})},k=(c,d,a,m)=>{const h=[...t.blocks],v=[...h[c].exercises];v[d]={...v[d],[a]:m},h[c]={...h[c],exercises:v},s({...t,blocks:h})},j=(c,d)=>{const a=[...t.blocks];a[c].exercises=a[c].exercises.filter((m,h)=>h!==d),s({...t,blocks:a})},V=(c,d)=>{const a=[...t.blocks],h={...a[c].exercises[d]};a[c].exercises=[...a[c].exercises.slice(0,d+1),h,...a[c].exercises.slice(d+1)],s({...t,blocks:a}),l({blockIndex:c,exerciseIndex:d+1})};return e.jsxs("div",{className:"animate-in slide-in-from-bottom-4 motion-reduce:animate-none",children:[e.jsx(Ue,{isEditing:!!t.id,isSaving:p,onSave:i,onCancel:r,onPreview:()=>f({id:t.id??Date.now(),name:t.name,description:t.description,created_by:n??null,items:pe(t.blocks)})}),e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(Ie,{name:t.name,onNameChange:c=>s({...t,name:c}),estimatedDuration:t.estimatedDuration,onEstimatedDurationChange:c=>s({...t,estimatedDuration:c}),totalDistance:N,showDuration:!0,showTotalDistance:!0}),e.jsxs("div",{className:"space-y-3",children:[t.blocks.map((c,d)=>e.jsxs("div",{className:"rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 px-3 py-2",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-primary px-2 py-0.5 text-[11px] font-semibold text-primary-foreground",children:[e.jsx(ze,{className:"inline h-3 w-3"})," ",c.repetitions??1,"x"]}),e.jsx(C,{value:c.title,onChange:a=>y(d,"title",a.target.value),placeholder:`Bloc ${d+1}`,className:"h-7 rounded-lg border-none bg-transparent px-1 text-xs font-semibold shadow-none focus-visible:bg-muted focus-visible:ring-1"}),e.jsxs("div",{className:"text-[11px] text-muted-foreground whitespace-nowrap",children:["¬∑ ",c.exercises.length," ex"]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(C,{type:"number",min:1,value:c.repetitions??"",onChange:a=>y(d,"repetitions",a.target.value===""?null:Number(a.target.value)),className:"h-7 w-12 rounded-lg text-center text-xs",placeholder:"1"}),e.jsx("button",{type:"button",onClick:()=>_(d,"up"),className:"inline-flex h-8 w-8 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40",disabled:d===0,children:e.jsx(We,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>_(d,"down"),className:"inline-flex h-8 w-8 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40",disabled:d===t.blocks.length-1,children:e.jsx(Xe,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>L(d),className:"inline-flex h-8 w-8 items-center justify-center rounded-full text-destructive hover:bg-destructive/10",children:e.jsx(R,{className:"h-3.5 w-3.5"})})]})]}),e.jsx("div",{className:"border-t border-border",children:c.exercises.map((a,m)=>{const h=u?.blockIndex===d&&u?.exerciseIndex===m,v=O(a.intensity);return e.jsxs("div",{className:"border-b border-border last:border-b-0",children:[e.jsxs("button",{type:"button",onClick:()=>l(h?null:{blockIndex:d,exerciseIndex:m}),className:b("flex w-full items-center gap-1.5 px-3 py-2 text-left text-[11px] font-semibold transition-colors hover:bg-muted/50",h&&"bg-muted/50"),children:[e.jsxs("span",{className:"text-muted-foreground",children:[a.repetitions??"","√ó",a.distance??"","m"]}),e.jsx("span",{className:"text-muted-foreground",children:a.stroke}),e.jsx("span",{className:b("inline-flex items-center rounded-full px-1.5 py-0.5 ring-1",mt[a.strokeType]??"bg-muted ring-border"),children:ut[a.strokeType]??a.strokeType}),e.jsxs("span",{className:b("inline-flex items-center gap-1 rounded-full bg-card px-1.5 py-0.5 ring-1",xt[v],pt[v]),children:[e.jsx("span",{className:b("h-1.5 w-1.5 rounded-full",je[v]??"bg-muted")}),ht(v)]}),a.rest?e.jsxs("span",{className:"text-muted-foreground",children:[a.restType==="departure"?"‚è±":"‚è∏"," ",a.restType==="departure"?"D√©p.":"Repos"," ",bt(a.rest)]}):null,a.equipment.length>0?e.jsxs("span",{className:"text-muted-foreground",children:["üèä",a.equipment.length]}):null,e.jsx("span",{className:"ml-auto flex items-center gap-1",children:e.jsx("span",{onClick:M=>{M.stopPropagation(),j(d,m)},className:"inline-flex h-6 w-6 items-center justify-center rounded-full text-destructive hover:bg-destructive/10",children:e.jsx(R,{className:"h-3 w-3"})})})]}),h?e.jsx("div",{className:"border-t border-border bg-muted/30 px-3 py-3",children:e.jsx(dt,{exercise:a,onChange:(M,A)=>k(d,m,M,A),onDelete:()=>j(d,m),onDuplicate:()=>V(d,m),showDelete:!0})}):null]},m)})}),e.jsx("div",{className:"border-t border-border px-3 py-2",children:e.jsxs("button",{type:"button",onClick:()=>T(d),className:"inline-flex items-center gap-1 rounded-full bg-muted px-3 py-1.5 text-[11px] font-semibold text-muted-foreground hover:bg-muted/80",children:[e.jsx(z,{className:"h-3 w-3"})," Exercice"]})})]},d)),t.blocks.length?null:e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-muted px-3 py-6 text-center text-sm text-muted-foreground",children:"Aucun bloc. Ajoute un bloc pour commencer."})]}),e.jsxs(F,{variant:"outline",size:"sm",onClick:w,className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(z,{className:"h-4 w-4"})," Ajouter bloc"]}),e.jsx("div",{className:"h-8"})]}),e.jsx(ye,{open:!!x,onOpenChange:c=>{c||f(null)},children:e.jsx(ge,{className:"max-w-4xl",children:e.jsx(Ne,{title:x?.name??"",description:x?.description??void 0,items:x?.items})})})]})}function gt(t){g.useEffect(()=>{if(!t)return;const s=i=>{i.preventDefault()};return window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)},[t])}function xe(t){return`S√©ance du ${Qe(t,"dd/MM/yyyy")} - Soir - Matin`}const fe=t=>{const s=t.trim().toLowerCase();return s&&(s.startsWith("plaquette")?"plaquettes":s.startsWith("palm")?"palmes":s.startsWith("tuba")?"tuba":s.startsWith("pull")?"pull":s.startsWith("elas")?"elastique":s)},he={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},jt=["V0","V1","V2","V3","Max"],P=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const i=s.toLowerCase();if(he[i])return he[i];const r=s.toUpperCase();if(r==="MAX")return"Max";if(r.startsWith("V")){const n=Number.parseInt(r.slice(1),10);if(Number.isFinite(n)&&n>=4)return"Max";if(jt.includes(r))return r}return s},vt=t=>{let s=0;return t.flatMap((i,r)=>i.exercises.map((n,p)=>{const u={block_title:i.title,block_description:i.description||null,block_order:r,block_repetitions:i.repetitions??null,block_modalities:i.modalities||null,block_equipment:i.equipment??[],exercise_repetitions:n.repetitions??null,exercise_rest:n.rest??null,exercise_rest_type:n.restType??"rest",exercise_stroke:n.stroke||null,exercise_stroke_type:n.strokeType||null,exercise_intensity:n.intensity?P(n.intensity):null,exercise_modalities:n.modalities||null,exercise_equipment:n.equipment??[],exercise_order:p},l=n.repetitions&&n.distance?`${n.repetitions}x${n.distance}m`:n.distance?`${n.distance}m`:null;return{ordre:s++,label:l,distance:n.distance??null,duration:null,intensity:n.intensity?P(n.intensity):null,notes:n.modalities||null,raw_payload:u}}))},Nt=(t=[])=>{const s=new Map;return t.forEach(i=>{const r=i.raw_payload??{},n=r.block_title||r.section||"Bloc",p=Number(r.block_order??0),u=`${p}-${n}`,l=r.block_equipment??r.equipment??[],x=(Array.isArray(l)?l:String(l).split(",")).map(y=>String(y)).map(y=>fe(y)).filter(Boolean);s.has(u)||s.set(u,{title:n,repetitions:r.block_repetitions??null,description:r.block_description??"",modalities:r.block_modalities??r.modalities??"",equipment:x,exercises:[],order:Number.isFinite(p)?p:0,exerciseOrder:new Map});const f=s.get(u),N=Number(r.exercise_order??i.ordre??f.exercises.length),w=P(r.exercise_intensity??i.intensity??"V1");f.exerciseOrder.set(N,{repetitions:r.exercise_repetitions??null,distance:i.distance??null,rest:r.exercise_rest??null,restType:r.exercise_rest_type??"rest",stroke:r.exercise_stroke??r.stroke??"crawl",strokeType:r.exercise_stroke_type??r.stroke_type??"nc",intensity:w,modalities:r.exercise_modalities??i.notes??"",equipment:Array.isArray(r.exercise_equipment)?r.exercise_equipment.map(y=>fe(y)):[]})}),Array.from(s.values()).sort((i,r)=>i.order-r.order).map(i=>({title:i.title,repetitions:i.repetitions,description:i.description,modalities:i.modalities,equipment:i.equipment,exercises:Array.from(i.exerciseOrder.entries()).sort(([r],[n])=>r-n).map(([,r])=>r)}))},wt=(t=[])=>new Set(t.map(i=>{const r=i.raw_payload;return r?.block_title||r?.section||"Bloc"})).size,be="swim_catalog_archived_ids",St=(t,s)=>s===null?!1:!s.some(i=>i.session_type==="swim"&&i.session_id===t);function Qt(){const{toast:t}=Be(),s=$e(),{userId:i,role:r}=Fe(),[n,p]=g.useState(!1);gt(n);const[u,l]=g.useState(null),[x,f]=g.useState(null),[N,w]=g.useState(null),[y,L]=g.useState(""),[_,T]=g.useState(new Set),k=()=>({id:null,name:xe(new Date),description:"",estimatedDuration:0,blocks:[]}),[j,V]=g.useState(k),{data:c,isLoading:d,error:a,refetch:m}=X({queryKey:["swim_catalog"],queryFn:()=>q.getSwimCatalog()}),{data:h,isLoading:v,isError:M,error:A,refetch:we}=X({queryKey:["coach-assignments"],queryFn:()=>q.getAssignmentsForCoach(),enabled:r==="coach"||r==="admin"});g.useEffect(()=>{if(typeof window>"u")return;const o=window.localStorage.getItem(be);if(o)try{const S=JSON.parse(o);Array.isArray(S)&&T(new Set(S.map(D=>Number(D)).filter(D=>Number.isFinite(D))))}catch{return}},[]),g.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(be,JSON.stringify(Array.from(_.values())))},[_]);const Se=g.useMemo(()=>{const o=y.trim().toLowerCase();return o?(c??[]).filter(S=>S.name.toLowerCase().includes(o)):c??[]},[c,y]).filter(o=>!_.has(o.id)),U=K({mutationFn:o=>q.createSwimSession(o),onSuccess:(o,S)=>{s.invalidateQueries({queryKey:["swim_catalog"]}),p(!1),V(k()),t({title:S?.id?"S√©ance natation mise √† jour":"S√©ance natation cr√©√©e"})}}),I=K({mutationFn:o=>q.deleteSwimSession(o),onSuccess:()=>{s.invalidateQueries({queryKey:["swim_catalog"]}),f(null),t({title:"S√©ance supprim√©e"})},onError:()=>{t({title:"Suppression impossible",description:"Cette s√©ance est utilis√©e dans une assignation.",variant:"destructive"})}}),Ve=()=>{if(!j.name.trim()){t({title:"Titre requis",description:"Ajoutez un nom de s√©ance avant d'enregistrer.",variant:"destructive"});return}U.mutate({id:j.id??void 0,name:j.name,description:j.description,estimated_duration:j.estimatedDuration||null,items:vt(j.blocks),created_by:i??null})},_e=()=>{p(!1),V(k())},ke=o=>{V({id:o.id??null,name:o.name??xe(new Date),description:o.description??"",estimatedDuration:Number(o.estimated_duration??0),blocks:Nt(o.items??[])}),p(!0)},Ce=o=>{w(o)},Me=()=>{N&&(T(o=>new Set([...Array.from(o),N.id])),w(null),t({title:"S√©ance archiv√©e"}))},Te=o=>{f(o)},Ae=()=>{x&&I.mutate(x.id)};return n?e.jsx(yt,{session:j,onSessionChange:V,onSave:Ve,onCancel:_e,userId:i,isSaving:U.isPending}):d||v?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx(E,{className:"h-5 w-16 mb-1"}),e.jsx(E,{className:"h-3 w-20"})]}),e.jsx(E,{className:"h-9 w-24 rounded-full"})]}),e.jsxs("div",{className:"p-4",children:[e.jsx(E,{className:"h-10 w-full rounded-2xl mb-4"}),e.jsx(se,{sessions:[],isLoading:!0,renderTitle:()=>"",renderMetrics:()=>null,onPreview:()=>{},onEdit:()=>{},onArchive:()=>{},onDelete:()=>{},canDelete:()=>!1})]})]}):a?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(oe,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les donn√©es"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:a instanceof Error?a.message:"Une erreur s'est produite"}),e.jsx(F,{variant:"default",onClick:()=>m(),className:"mt-4 h-12 md:h-10",children:"R√©essayer"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:"Coach"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Cr√©ation"})]}),e.jsxs("button",{type:"button",onClick:()=>{V(k()),p(!0)},className:"inline-flex items-center gap-2 rounded-full bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground",children:[e.jsx(z,{className:"h-4 w-4"})," Nouvelle"]})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-2xl border border-border bg-card px-3 py-2",children:[e.jsx(Je,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{className:"w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground",placeholder:"Rechercher une s√©ance",value:y,onChange:o=>L(o.target.value)})]}),M&&e.jsxs("div",{className:"mt-4 flex flex-col items-center rounded-lg border border-destructive/20 bg-destructive/10 p-4",children:[e.jsx(oe,{className:"h-8 w-8 text-destructive mb-2"}),e.jsx("p",{className:"text-sm text-destructive font-semibold",children:"Impossible de charger les assignations"}),e.jsx("p",{className:"text-xs text-destructive/80 mt-1",children:A instanceof Error?A.message:"Une erreur s'est produite"}),e.jsx(F,{variant:"outline",size:"sm",onClick:()=>we(),className:"mt-2 h-10",children:"R√©essayer"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(se,{sessions:Se,isLoading:d,error:a,renderTitle:o=>o.name,renderMetrics:o=>{const S=ve(o.items??[]),De=o.items?.some(B=>B.duration!=null)??!1?o.items?.reduce((B,Ee)=>B+(Ee.duration??0),0)??0:null,qe=wt(o.items??[]);return e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Oe,{className:"h-3.5 w-3.5"}),S,"m"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(He,{className:"h-3.5 w-3.5"}),"~",De??"‚Äî"," min"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Pe,{className:"h-3.5 w-3.5"}),qe]})]})},onPreview:l,onEdit:ke,onArchive:Ce,onDelete:Te,canDelete:o=>St(o,h??null),isDeleting:I.isPending})}),e.jsx("div",{className:"h-8"})]}),e.jsx(ye,{open:!!u,onOpenChange:o=>{o||l(null)},children:e.jsx(ge,{className:"max-w-4xl",children:e.jsx(Ne,{title:u?.name??"",description:u?.description??void 0,items:u?.items})})}),e.jsx(Q,{open:!!N,onOpenChange:o=>{o||w(null)},children:e.jsxs(J,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Archiver la s√©ance ?"}),e.jsx(G,{children:"La s√©ance sera masqu√©e du catalogue (sans suppression)."})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Annuler"}),e.jsx(te,{onClick:Me,children:"Archiver"})]})]})}),e.jsx(Q,{open:!!x,onOpenChange:o=>{o||f(null)},children:e.jsxs(J,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Supprimer la s√©ance ?"}),e.jsx(G,{children:"Cette action est d√©finitive. La s√©ance sera supprim√©e du catalogue."})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Annuler"}),e.jsx(te,{onClick:Ae,children:"Supprimer"})]})]})})]})}export{St as canDeleteSwimCatalog,Qt as default};
