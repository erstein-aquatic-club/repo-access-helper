import{c as xe,R as pe,u as se,d as j,j as e}from"./vendor-query-BiSH4r2z.js";import{c as ie,u as $,d as je,p as fe,B as h,C as I,h as _,j as E,l as k,g as U,L as x,I as R,S as ve}from"./index-C8Ys7NvK.js";import{u as ge,t as ye,o as Ne,s as F}from"./types-D6NFhoV1.js";import{a as o}from"./api-R6k1jfwT.js";import{S as H,a as G,b as O,c as X,d as i}from"./select-DsJlP3hw.js";import{S as be}from"./switch-DvRcL8hh.js";import{B as f}from"./badge-DJWnxWLy.js";import{T as Ce,a as we,b as ae,c as v,d as Ae,e as g}from"./table-DP4CJcvE.js";import{C as Se}from"./circle-alert-Cg7m_XSV.js";import{C as Ie}from"./clock-BEHiY6By.js";import{C as _e}from"./circle-x-Dk5c2Ejz.js";import{S as Ee}from"./search-y-Cl9q0T.js";import{a as ke,U as Ue}from"./user-plus-Div_wJvt.js";import{s as Re}from"./swim-CkD6PybV.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";import"./index-BRt7zf33.js";import"./chevron-down-BgKZKOjT.js";import"./check-B-52Crui.js";import"./chevron-up-Ct0_XNME.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],Le=ie("circle-check-big",Fe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Pe=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Te=ie("shield-check",Pe),re=["athlete","coach","comite","admin"],Z=a=>!(a===!1||a===0),qe=Ne({display_name:F().min(2,"Le nom doit contenir au moins 2 caractères"),email:F().optional().refine(a=>!a||F().email().safeParse(a).success,"L'email doit être valide"),password:F().optional().refine(a=>!a||a.length>=8&&/[A-Z]/.test(a)&&/\d/.test(a),"Le mot de passe doit contenir au moins 8 caractères, une majuscule et un chiffre")}),ze=(a,n,L)=>a.map(p=>p.id===n?{...p,role:L}:p),y=(a,n)=>Re(a,n).message;function ts(){const{useMemo:a,useState:n}=pe,L=typeof window>"u"?$.getState().role:$(s=>s.role),p=$(s=>s.userId),{toast:l}=je(),c=xe(),[P,te]=n(""),[N,le]=n("all"),[b,ne]=n(!1),[C,ce]=n(null),[J,W]=n(null),{register:T,handleSubmit:de,reset:oe,formState:{errors:m}}=ge({resolver:ye(qe),defaultValues:{display_name:"",email:"",password:""}}),q=L==="admin",{data:u=[],isLoading:me,error:z,refetch:ue}=se({queryKey:["admin-users",b],queryFn:()=>o.listUsers({includeInactive:b}),enabled:q}),M=j({mutationFn:s=>o.createCoach(s),onMutate:()=>{W(null)},onSuccess:s=>{c.invalidateQueries({queryKey:["admin-users"]}),oe(),W(s.initialPassword??null),l({title:"Coach créé"})},onError:s=>{l({title:"Erreur création coach",description:y(s,"Impossible de créer le coach.")})}}),w=j({mutationFn:s=>o.updateUserRole(s),onSuccess:(s,r)=>{c.setQueryData(["admin-users",b],d=>d&&ze(d,r.userId,r.role)),c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Rôle mis à jour"})},onError:s=>{l({title:"Erreur mise à jour rôle",description:y(s,"Impossible de mettre à jour le rôle.")})}}),Y=j({mutationFn:s=>o.disableUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Compte désactivé"})},onError:s=>{l({title:"Erreur désactivation",description:y(s,"Impossible de désactiver le compte.")})}}),{data:Q=[],error:K,refetch:he}=se({queryKey:["pending-approvals"],queryFn:()=>o.getPendingApprovals(),enabled:q}),V=j({mutationFn:s=>o.approveUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Inscription validée"})},onError:s=>{l({title:"Erreur validation",description:y(s,"Impossible de valider l'inscription.")})}}),D=j({mutationFn:s=>o.rejectUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),l({title:"Inscription rejetée"})},onError:s=>{l({title:"Erreur rejet",description:y(s,"Impossible de rejeter l'inscription.")})}}),A=a(()=>u.find(r=>r.role==="admin")?.id??null,[u]),ee=a(()=>{const s=P.trim().toLowerCase();return u.filter(r=>{if(N!=="all"&&r.role!==N)return!1;const d=r.display_name?.toLowerCase()??"",B=r.email?.toLowerCase()??"";return!(s&&!d.includes(s)&&!B.includes(s))})},[u,N,P]),t=a(()=>C?u.find(s=>s.id===C)??null:null,[C,u]);return q?z||K?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Se,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:z instanceof Error?z.message:K instanceof Error?K.message:"Une erreur s'est produite"}),e.jsx(h,{variant:"default",onClick:()=>{ue(),he()},className:"mt-4 h-12 md:h-10",children:"Réessayer"})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Te,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:"Accès admin"})]})]}),Q.length>0?e.jsxs(I,{className:"border-status-warning/30 bg-status-warning-bg dark:border-status-warning/30 dark:bg-status-warning-bg",children:[e.jsxs(_,{children:[e.jsxs(E,{className:"flex items-center gap-2",children:[e.jsx(Ie,{className:"h-5 w-5 text-status-warning"}),"Inscriptions en attente",e.jsx(f,{variant:"secondary",className:"ml-2",children:Q.length})]}),e.jsx(k,{children:"Ces utilisateurs ont créé un compte et attendent votre validation."})]}),e.jsx(U,{children:e.jsx("div",{className:"space-y-3",children:Q.map(s=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-lg border bg-background p-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email||"Pas d'email"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Inscrit le ",new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{size:"sm",className:"bg-status-success hover:opacity-90 text-white h-10",onClick:()=>V.mutate(s.user_id),disabled:V.isPending||D.isPending,children:[e.jsx(Le,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(h,{size:"sm",variant:"destructive",onClick:()=>{window.confirm(`Rejeter l'inscription de "${s.display_name}" ? Le compte sera désactivé.`)&&D.mutate(s.user_id)},disabled:V.isPending||D.isPending,className:"h-10",children:[e.jsx(_e,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]},s.user_id))})})]}):null,e.jsxs(I,{children:[e.jsxs(_,{children:[e.jsx(E,{children:"Créer un coach"}),e.jsx(k,{children:"Laissez le mot de passe vide pour en générer un automatiquement (affiché une seule fois)."})]}),e.jsx(U,{children:e.jsxs("form",{className:"space-y-4",onSubmit:de(s=>{M.mutate({display_name:s.display_name.trim(),email:s.email?.trim()||void 0,password:s.password||void 0})}),children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"coach-create-name",children:"Nom affiché"}),e.jsx(R,{id:"coach-create-name",...T("display_name"),placeholder:"Ex: Coach Martin"}),m.display_name&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:m.display_name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"coach-create-email",children:"Email"}),e.jsx(R,{id:"coach-create-email",type:"email",...T("email"),placeholder:"coach@email.com"}),m.email&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:m.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{htmlFor:"coach-create-password",children:"Mot de passe (optionnel)"}),e.jsx(R,{id:"coach-create-password",type:"text",...T("password"),placeholder:"Laisser vide pour auto"}),m.password&&e.jsx("p",{className:"text-sm text-destructive",role:"alert","aria-live":"assertive",children:m.password.message})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(h,{variant:"default",type:"submit",disabled:M.isPending,className:"h-10",children:M.isPending?"Création...":"Créer le coach"}),J?e.jsxs("div",{className:"rounded-md border border-primary/30 bg-primary/5 px-4 py-2 text-sm",children:[e.jsx("p",{className:"font-medium text-primary",children:"Mot de passe initial (à copier)"}),e.jsx("p",{className:"font-mono",children:J})]}):null]})]})})]}),e.jsxs(I,{children:[e.jsxs(_,{children:[e.jsx(E,{children:"Gestion des comptes"}),e.jsx(k,{children:"Mettre à jour les rôles, filtrer et désactiver les comptes."})]}),e.jsxs(U,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(x,{htmlFor:"admin-search",children:"Recherche"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ee,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(R,{id:"admin-search",value:P,onChange:s=>te(s.target.value),placeholder:"Nom ou email",className:"pl-9"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(x,{children:"Rôle"}),e.jsxs(H,{value:N,onValueChange:s=>le(s),children:[e.jsx(G,{children:e.jsx(O,{placeholder:"Tous"})}),e.jsxs(X,{children:[e.jsx(i,{value:"all",children:"Tous"}),e.jsx(i,{value:"athlete",children:"Athlète"}),e.jsx(i,{value:"coach",children:"Entraineur EAC"}),e.jsx(i,{value:"comite",children:"Comité"}),e.jsx(i,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(be,{checked:b,onCheckedChange:ne,id:"inactive-toggle"}),e.jsx(x,{htmlFor:"inactive-toggle",className:"text-sm",children:"Inclure désactivés"})]})]}),me?e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((s,r)=>e.jsx("div",{className:"flex items-center gap-4 p-3 rounded-lg border",children:e.jsx(ve,{className:"h-10 w-full"})},`skeleton-${r}`))}):ee.length?e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(Ce,{children:[e.jsx(we,{children:e.jsxs(ae,{children:[e.jsx(v,{children:"Utilisateur"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Rôle"}),e.jsx(v,{children:"Statut"}),e.jsx(v,{className:"text-right",children:"Actions"})]})}),e.jsx(Ae,{children:ee.map(s=>{const r=Z(s.is_active),d=p===s.id,B=A!==null&&A!==s.id;return e.jsxs(ae,{"data-selected":C===s.id,children:[e.jsx(g,{className:"font-medium",children:e.jsx(h,{variant:"ghost",size:"sm",className:"px-2",onClick:()=>ce(s.id),children:s.display_name})}),e.jsx(g,{className:"text-sm text-muted-foreground",children:s.email||"-"}),e.jsx(g,{children:e.jsxs(H,{value:s.role,onValueChange:S=>{re.includes(S)&&s.id&&S!==s.role&&w.mutate({userId:s.id,role:S})},disabled:!r||w.isPending,children:[e.jsx(G,{className:"w-[140px]",children:e.jsx(O,{})}),e.jsxs(X,{children:[e.jsx(i,{value:"athlete",children:"Athlète"}),e.jsx(i,{value:"coach",children:"Entraineur EAC"}),e.jsx(i,{value:"comite",children:"Comité"}),e.jsx(i,{value:"admin",disabled:B,children:"Admin"})]})]})}),e.jsx(g,{children:r?e.jsx(f,{variant:"secondary",children:"Actif"}):e.jsx(f,{variant:"outline",children:"Désactivé"})}),e.jsx(g,{className:"text-right",children:e.jsxs(h,{variant:"destructive",size:"sm",onClick:()=>{if(!s.id)return;if(d){l({title:"Action impossible",description:"Vous ne pouvez pas désactiver votre propre compte."});return}window.confirm(`Confirmer la désactivation du compte "${s.display_name}" ?`)&&Y.mutate({userId:s.id})},disabled:!r||Y.isPending||d,className:"h-10",children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),"Désactiver"]})})]},s.id)})})]})}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ue,{className:"h-4 w-4"}),"Aucun utilisateur ne correspond à votre recherche."]})]})]}),e.jsxs(I,{children:[e.jsxs(_,{children:[e.jsx(E,{children:"Fiche utilisateur"}),e.jsx(k,{children:"Sélectionnez un compte pour afficher les détails."})]}),e.jsx(U,{children:t?e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nom affiché"}),e.jsx("p",{className:"text-lg font-semibold",children:t.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Email"}),e.jsx("p",{children:t.email||"-"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Rôle"}),e.jsxs(H,{value:t.role,onValueChange:s=>{re.includes(s)&&t.id&&s!==t.role&&w.mutate({userId:t.id,role:s})},disabled:!Z(t.is_active)||w.isPending,children:[e.jsx(G,{className:"w-[180px]",children:e.jsx(O,{})}),e.jsxs(X,{children:[e.jsx(i,{value:"athlete",children:"Athlète"}),e.jsx(i,{value:"coach",children:"Entraineur EAC"}),e.jsx(i,{value:"comite",children:"Comité"}),e.jsx(i,{value:"admin",disabled:A!==null&&A!==t.id,children:"Admin"})]})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Statut"}),Z(t.is_active)?e.jsx(f,{variant:"secondary",children:"Actif"}):e.jsx(f,{variant:"outline",children:"Désactivé"})]}),t.group_label?e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Groupe"}),e.jsx("p",{children:t.group_label})]}):null]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun utilisateur sélectionné."})})]})]}):typeof window>"u"?null:e.jsx(fe,{to:"/"})}export{ts as default,ze as updateUserRoleInList};
