import{j as e,R as W,r as y}from"./vendor-ui-DJQMR4VV.js";import{b as Pe,u as X,c as K}from"./vendor-query-BT4y-huw.js";import{c as $e,a as g,x as Le,I as C,B,f as Be,u as Fe,d as q,S as E}from"./index-p3lMzPTv.js";import{D as be,a as ye}from"./dialog-CzWpLOQP.js";import{A as Q,a as J,b as H,c as Y,d as G,e as Z,f as ee,g as te}from"./alert-dialog-gPCvsP3N.js";import{i as je,g as Re,c as ve,b as ze,a as Ne,R as Oe,L as Ue}from"./SwimSessionConsultation-CkoESfgS.js";import{F as Ie,S as We,A as Xe,a as Ke,b as se}from"./SessionListView-1YC8TR0r.js";import{T as Qe}from"./textarea-dgPf_0hf.js";import{S as ne,a as re,b as ie,c as ae,d as le}from"./select-BFT7QT53.js";import{T as F,P as R}from"./trash-2-Dy8-qqxu.js";import{f as Je}from"./vendor-date-cQbdWov0.js";import{C as oe}from"./circle-alert-DI28R9Xv.js";import{S as He}from"./search-BgMmQs7Z.js";import{T as Ye}from"./timer-CHzevl_A.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Db4xOvcx.js";import"./vendor-supabase-D7B1G6YZ.js";import"./badge-BHPa30oT.js";import"./chevron-up-VxPSOCWt.js";import"./chevron-left-CGUrpBr7.js";import"./save-FwOiHuZ-.js";import"./check-BguUDhs-.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]],Ze=$e("copy",Ge),ce=["V0","V1","V2","V3","Max","Prog"],et={V0:"bg-intensity-1",V1:"bg-intensity-2",V2:"bg-intensity-3",V3:"bg-intensity-4",Max:"bg-intensity-5",Prog:"bg-intensity-prog"},de={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},tt=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if(de[n])return de[n];if(n==="prog"||n==="progressif")return"Prog";const i=s.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const r=i.replace("V","V");return r==="V4"||r==="V5"?"Max":r}return s};function st({value:t,onChange:s,className:n,ariaLabel:i="S√©lection d'intensit√©"}){const r=tt(t),p=ce.includes(r)?r:"Max";return e.jsx("div",{role:"radiogroup","aria-label":i,className:g("flex flex-wrap items-center gap-1",n),children:ce.map(u=>{const a=p===u,x=u==="Max"?"MAX":u==="Prog"?"Prog":u;return e.jsxs("button",{type:"button",role:"radio","aria-checked":a,"aria-label":`Intensit√© ${x}`,onClick:()=>s(u),className:g("flex flex-col items-center gap-1 rounded-full px-2 py-1 text-[10px] font-semibold text-muted-foreground transition","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",a?"text-foreground":"hover:text-foreground"),children:[u==="Prog"?e.jsx(Le,{className:g("h-3 w-3",a?"text-intensity-prog":"text-muted-foreground")}):e.jsx("span",{className:g("h-3 w-3 rounded-full",a?et[u]??"bg-primary":"bg-muted")}),e.jsx("span",{children:x})]},u)})})}const P=t=>t?{min:Math.floor(t/60),sec:t%60}:{min:0,sec:0},nt=[{value:"palmes",label:"Palmes"},{value:"tuba",label:"Tuba"},{value:"plaquettes",label:"Plaquettes"},{value:"pull",label:"Pull"},{value:"elastique",label:"√âlastique"}],rt=[{value:"pap",label:"Papillon"},{value:"dos",label:"Dos"},{value:"brasse",label:"Brasse"},{value:"crawl",label:"Crawl"},{value:"4n",label:"4 nages"},{value:"spe",label:"Sp√©"}],it=[{value:"nc",label:"NC"},{value:"educ",label:"Educ"},{value:"jambes",label:"Jambes"}],ue={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},at=["V0","V1","V2","V3","Max","Prog"],lt=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if(n==="prog"||n==="progressif")return"Prog";if(ue[n])return ue[n];const i=s.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const r=Number.parseInt(i.slice(1),10);if(Number.isFinite(r)&&r>=4)return"Max";if(at.includes(i))return i}return s},ot=t=>t==="Max"?"MAX":t,ct={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5",Prog:"text-intensity-prog"},dt={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30",Prog:"ring-intensity-prog/30"};function ut({exercise:t,onChange:s,onDelete:n,onDuplicate:i,showDelete:r=!0}){const p=lt(t.intensity),u=t.modalities??"";return e.jsx("div",{className:"rounded-2xl border border-border bg-card p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"grid flex-1 grid-cols-2 sm:grid-cols-4 gap-2",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"R√©p."}),e.jsx("div",{className:"mt-1",children:e.jsx(C,{type:"number",min:1,value:t.repetitions??"",onChange:a=>s("repetitions",a.target.value===""?null:Number(a.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Dist. (m)"}),e.jsx("div",{className:"mt-1",children:e.jsx(C,{type:"number",min:0,value:t.distance??"",onChange:a=>s("distance",a.target.value===""?null:Number(a.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Nage"}),e.jsx("div",{className:"mt-1",children:e.jsxs(ne,{value:t.stroke,onValueChange:a=>s("stroke",a),children:[e.jsx(re,{className:"rounded-2xl",children:e.jsx(ie,{})}),e.jsx(ae,{children:rt.map(a=>e.jsx(le,{value:a.value,children:a.label},a.value))})]})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Type"}),e.jsx("div",{className:"mt-1",children:e.jsxs(ne,{value:t.strokeType,onValueChange:a=>s("strokeType",a),children:[e.jsx(re,{className:"rounded-2xl",children:e.jsx(ie,{})}),e.jsx(ae,{children:it.map(a=>e.jsx(le,{value:a.value,children:a.label},a.value))})]})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Intensit√© (clic sur points)"}),e.jsxs("span",{className:g("inline-flex items-center gap-2 rounded-full bg-card px-2.5 py-1 text-xs font-semibold ring-1",dt[p],ct[p]),children:[e.jsx("span",{className:g("h-2 w-2 rounded-full",je[p]??"bg-muted")}),ot(p)]})]}),e.jsx("div",{className:"mt-2 flex items-center justify-between gap-2",children:e.jsx(st,{value:t.intensity,onChange:a=>s("intensity",a)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"R√©cup√©ration"}),e.jsxs("div",{className:"mt-2 flex flex-wrap items-center gap-2",children:[e.jsxs("div",{className:"inline-flex rounded-full border border-border bg-card p-0.5 text-xs font-semibold",children:[e.jsx("button",{type:"button",onClick:()=>s("restType","departure"),className:g("rounded-full px-2.5 py-1 transition-colors",t.restType==="departure"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:"D√©part"}),e.jsx("button",{type:"button",onClick:()=>s("restType","rest"),className:g("rounded-full px-2.5 py-1 transition-colors",t.restType==="rest"?"bg-primary text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:"Repos"})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(C,{type:"number",min:0,max:59,value:P(t.rest).min||"",onChange:a=>{const x=a.target.value===""?0:Number(a.target.value),f=P(t.rest).sec;s("rest",x*60+f||null)},placeholder:"0",className:"w-12 rounded-2xl text-center"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"min"}),e.jsx(C,{type:"number",min:0,max:59,value:P(t.rest).sec||"",onChange:a=>{const x=a.target.value===""?0:Number(a.target.value),f=P(t.rest).min;s("rest",f*60+x||null)},placeholder:"0",className:"w-12 rounded-2xl text-center"}),e.jsx("span",{className:"text-[11px] text-muted-foreground",children:"sec"})]}),t.rest?e.jsx("button",{type:"button",onClick:()=>s("rest",null),className:"text-[11px] text-muted-foreground hover:text-foreground",children:"Effacer"}):null]})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"√âquipements"}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:nt.map(a=>{const x=t.equipment.includes(a.value),f=Re(a.value);return e.jsxs("button",{type:"button",onClick:()=>{const N=x?t.equipment.filter(w=>w!==a.value):[...t.equipment,a.value];s("equipment",N)},className:g("inline-flex items-center gap-2 rounded-full border px-3 py-2 text-xs font-semibold",x?"border-primary bg-primary text-primary-foreground":"border-border bg-card text-muted-foreground hover:bg-muted"),children:[e.jsx("span",{className:g("inline-flex h-7 w-7 items-center justify-center rounded-full",x?"bg-white/10":"bg-muted"),children:f?e.jsx("img",{src:f,alt:"",className:"h-4 w-4","aria-hidden":"true",loading:"lazy"}):null}),a.label]},a.value)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Modalit√©s"}),e.jsx("div",{className:"mt-1",children:e.jsx(Qe,{value:u,onChange:a=>s("modalities",a.target.value),placeholder:"Une modalit√© par ligne",rows:3,className:"rounded-2xl"})})]})]}),e.jsxs("div",{className:"flex flex-col gap-1",children:[i&&e.jsx("button",{type:"button",onClick:i,className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-muted-foreground hover:bg-muted","aria-label":"Dupliquer exercice",title:"Dupliquer exercice",children:e.jsx(Ze,{className:"h-4 w-4"})}),r&&n&&e.jsx("button",{type:"button",onClick:n,className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer exercice",title:"Supprimer exercice",children:e.jsx(F,{className:"h-4 w-4"})})]})]})})}const mt={nc:"NC",educ:"Educ",jambes:"Jambes"},pt={nc:"bg-sky-100 text-sky-900 ring-sky-200",educ:"bg-violet-100 text-violet-900 ring-violet-200",jambes:"bg-teal-100 text-teal-900 ring-teal-200"},xt={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5",Prog:"text-intensity-prog"},ft={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30",Prog:"ring-intensity-prog/30"},me={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},ht=["V0","V1","V2","V3","Max","Prog"],z=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if(n==="prog"||n==="progressif")return"Prog";if(me[n])return me[n];const i=s.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const r=Number.parseInt(i.slice(1),10);if(Number.isFinite(r)&&r>=4)return"Max";if(ht.includes(i))return i}return s},gt=t=>t==="Max"?"MAX":t,bt=t=>{if(!t)return"";const s=Math.floor(t/60),n=t%60;return s>0&&n>0?`${s}'${n.toString().padStart(2,"0")}`:s>0?`${s}'00`:`${n}s`},pe=t=>{let s=0;return t.flatMap((n,i)=>n.exercises.map((r,p)=>{const u={block_title:n.title,block_description:n.description||null,block_order:i,block_repetitions:n.repetitions??null,block_modalities:n.modalities||null,block_equipment:n.equipment??[],exercise_repetitions:r.repetitions??null,exercise_rest:r.rest??null,exercise_rest_type:r.restType??"rest",exercise_stroke:r.stroke||null,exercise_stroke_type:r.strokeType||null,exercise_intensity:r.intensity?z(r.intensity):null,exercise_modalities:r.modalities||null,exercise_equipment:r.equipment??[],exercise_order:p},a=r.repetitions&&r.distance?`${r.repetitions}x${r.distance}m`:r.distance?`${r.distance}m`:null;return{ordre:s++,label:a,distance:r.distance??null,duration:null,intensity:r.intensity?z(r.intensity):null,notes:r.modalities||null,raw_payload:u}}))};function yt({session:t,onSessionChange:s,onSave:n,onCancel:i,userId:r,isSaving:p}){const[u,a]=W.useState(null),[x,f]=W.useState(null),N=y.useMemo(()=>ve(pe(t.blocks)),[t.blocks]),w=()=>{s({...t,blocks:[...t.blocks,{title:"Nouveau bloc",repetitions:1,description:"",modalities:"",equipment:[],exercises:[{repetitions:4,distance:50,rest:null,restType:"rest",stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}]}]})},b=(c,d,l)=>{const m=[...t.blocks];m[c]={...m[c],[d]:l},s({...t,blocks:m})},$=c=>{const d=t.blocks.filter((l,m)=>m!==c);s({...t,blocks:d})},k=(c,d)=>{const l=d==="up"?c-1:c+1;if(l<0||l>=t.blocks.length)return;const m=[...t.blocks],[h]=m.splice(c,1);m.splice(l,0,h),s({...t,blocks:m})},D=c=>{const d=[...t.blocks];d[c].exercises.push({repetitions:4,distance:50,rest:null,restType:"rest",stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}),s({...t,blocks:d})},_=(c,d,l,m)=>{const h=[...t.blocks],v=[...h[c].exercises];v[d]={...v[d],[l]:m},h[c]={...h[c],exercises:v},s({...t,blocks:h})},j=(c,d)=>{const l=[...t.blocks];l[c].exercises=l[c].exercises.filter((m,h)=>h!==d),s({...t,blocks:l})},V=(c,d)=>{const l=[...t.blocks],h={...l[c].exercises[d]};l[c].exercises=[...l[c].exercises.slice(0,d+1),h,...l[c].exercises.slice(d+1)],s({...t,blocks:l}),a({blockIndex:c,exerciseIndex:d+1})};return e.jsxs("div",{className:"animate-in slide-in-from-bottom-4 motion-reduce:animate-none",children:[e.jsx(Ie,{isEditing:!!t.id,isSaving:p,onSave:n,onCancel:i,onPreview:()=>f({id:t.id??Date.now(),name:t.name,description:t.description,created_by:r??null,items:pe(t.blocks)})}),e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(We,{name:t.name,onNameChange:c=>s({...t,name:c}),estimatedDuration:t.estimatedDuration,onEstimatedDurationChange:c=>s({...t,estimatedDuration:c}),totalDistance:N,showDuration:!0,showTotalDistance:!0}),e.jsxs("div",{className:"space-y-3",children:[t.blocks.map((c,d)=>e.jsxs("div",{className:"rounded-2xl border border-border bg-card",children:[e.jsxs("div",{className:"flex items-center justify-between gap-1 px-3 py-2",children:[e.jsxs("div",{className:"flex min-w-0 flex-1 items-center gap-1.5",children:[e.jsxs("span",{className:"inline-flex shrink-0 items-center gap-1 rounded-full bg-primary px-2 py-0.5 text-[11px] font-semibold text-primary-foreground",children:[e.jsx(ze,{className:"inline h-3 w-3"})," ",c.repetitions??1,"x"]}),e.jsx(C,{value:c.title,onChange:l=>b(d,"title",l.target.value),placeholder:`Bloc ${d+1}`,className:"h-7 min-w-0 flex-1 rounded-lg border-none bg-transparent px-1 text-xs font-semibold shadow-none focus-visible:bg-muted focus-visible:ring-1"}),e.jsxs("div",{className:"shrink-0 text-[11px] text-muted-foreground whitespace-nowrap",children:["¬∑ ",c.exercises.length," ex"]})]}),e.jsxs("div",{className:"flex shrink-0 items-center gap-0.5",children:[e.jsx(C,{type:"number",min:1,value:c.repetitions??"",onChange:l=>b(d,"repetitions",l.target.value===""?null:Number(l.target.value)),className:"h-7 w-11 rounded-lg text-center text-xs",placeholder:"1"}),e.jsx("button",{type:"button",onClick:()=>k(d,"up"),className:"inline-flex h-7 w-7 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40",disabled:d===0,children:e.jsx(Xe,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>k(d,"down"),className:"inline-flex h-7 w-7 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40",disabled:d===t.blocks.length-1,children:e.jsx(Ke,{className:"h-3.5 w-3.5"})}),e.jsx("button",{type:"button",onClick:()=>$(d),className:"inline-flex h-7 w-7 items-center justify-center rounded-full text-destructive hover:bg-destructive/10",children:e.jsx(F,{className:"h-3.5 w-3.5"})})]})]}),e.jsx("div",{className:"border-t border-border",children:c.exercises.map((l,m)=>{const h=u?.blockIndex===d&&u?.exerciseIndex===m,v=z(l.intensity);return e.jsxs("div",{className:"border-b border-border last:border-b-0",children:[e.jsxs("button",{type:"button",onClick:()=>a(h?null:{blockIndex:d,exerciseIndex:m}),className:g("flex w-full items-center gap-1 px-3 py-2 text-left text-[11px] font-semibold transition-colors hover:bg-muted/50 overflow-hidden",h&&"bg-muted/50"),children:[e.jsxs("div",{className:"flex min-w-0 flex-1 flex-wrap items-center gap-1",children:[e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:[l.repetitions??"","√ó",l.distance??"","m"]}),e.jsx("span",{className:"text-muted-foreground whitespace-nowrap",children:l.stroke}),e.jsx("span",{className:g("inline-flex items-center rounded-full px-1.5 py-0.5 ring-1 whitespace-nowrap",pt[l.strokeType]??"bg-muted ring-border"),children:mt[l.strokeType]??l.strokeType}),e.jsxs("span",{className:g("inline-flex items-center gap-1 rounded-full bg-card px-1.5 py-0.5 ring-1 whitespace-nowrap",ft[v],xt[v]),children:[e.jsx("span",{className:g("h-1.5 w-1.5 rounded-full",je[v]??"bg-muted")}),gt(v)]}),l.rest?e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:[l.restType==="departure"?"‚è±":"‚è∏"," ",l.restType==="departure"?"D√©p.":"Repos"," ",bt(l.rest)]}):null,l.equipment.length>0?e.jsxs("span",{className:"text-muted-foreground whitespace-nowrap",children:["üèä",l.equipment.length]}):null]}),e.jsx("span",{onClick:T=>{T.stopPropagation(),j(d,m)},className:"inline-flex h-6 w-6 shrink-0 items-center justify-center rounded-full text-destructive hover:bg-destructive/10",children:e.jsx(F,{className:"h-3 w-3"})})]}),h?e.jsx("div",{className:"border-t border-border bg-muted/30 px-3 py-3",children:e.jsx(ut,{exercise:l,onChange:(T,M)=>_(d,m,T,M),onDelete:()=>j(d,m),onDuplicate:()=>V(d,m),showDelete:!0})}):null]},m)})}),e.jsx("div",{className:"border-t border-border px-3 py-2",children:e.jsxs("button",{type:"button",onClick:()=>D(d),className:"inline-flex items-center gap-1 rounded-full bg-muted px-3 py-1.5 text-[11px] font-semibold text-muted-foreground hover:bg-muted/80",children:[e.jsx(R,{className:"h-3 w-3"})," Exercice"]})})]},d)),t.blocks.length?null:e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-muted px-3 py-6 text-center text-sm text-muted-foreground",children:"Aucun bloc. Ajoute un bloc pour commencer."})]}),e.jsxs(B,{variant:"outline",size:"sm",onClick:w,className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(R,{className:"h-4 w-4"})," Ajouter bloc"]}),e.jsx("div",{className:"h-8"})]}),e.jsx(be,{open:!!x,onOpenChange:c=>{c||f(null)},children:e.jsx(ye,{className:"max-w-4xl",children:e.jsx(Ne,{title:x?.name??"",description:x?.description??void 0,items:x?.items})})})]})}function jt(t){y.useEffect(()=>{if(!t)return;const s=n=>{n.preventDefault()};return window.addEventListener("beforeunload",s),()=>window.removeEventListener("beforeunload",s)},[t])}function xe(t){return`S√©ance du ${Je(t,"dd/MM/yyyy")} - Soir - Matin`}const fe=t=>{const s=t.trim().toLowerCase();return s&&(s.startsWith("plaquette")?"plaquettes":s.startsWith("palm")?"palmes":s.startsWith("tuba")?"tuba":s.startsWith("pull")?"pull":s.startsWith("elas")?"elastique":s)},he={souple:"V0",facile:"V0",relache:"V0",rel√¢ch√©:"V0"},vt=["V0","V1","V2","V3","Max","Prog"],O=t=>{if(!t)return"V0";const s=t.trim();if(!s)return"V0";const n=s.toLowerCase();if(n==="prog"||n==="progressif")return"Prog";if(he[n])return he[n];const i=s.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const r=Number.parseInt(i.slice(1),10);if(Number.isFinite(r)&&r>=4)return"Max";if(vt.includes(i))return i}return s},Nt=t=>{let s=0;return t.flatMap((n,i)=>n.exercises.map((r,p)=>{const u={block_title:n.title,block_description:n.description||null,block_order:i,block_repetitions:n.repetitions??null,block_modalities:n.modalities||null,block_equipment:n.equipment??[],exercise_repetitions:r.repetitions??null,exercise_rest:r.rest??null,exercise_rest_type:r.restType??"rest",exercise_stroke:r.stroke||null,exercise_stroke_type:r.strokeType||null,exercise_intensity:r.intensity?O(r.intensity):null,exercise_modalities:r.modalities||null,exercise_equipment:r.equipment??[],exercise_order:p},a=r.repetitions&&r.distance?`${r.repetitions}x${r.distance}m`:r.distance?`${r.distance}m`:null;return{ordre:s++,label:a,distance:r.distance??null,duration:null,intensity:r.intensity?O(r.intensity):null,notes:r.modalities||null,raw_payload:u}}))},wt=(t=[])=>{const s=new Map;return t.forEach(n=>{const i=n.raw_payload??{},r=i.block_title||i.section||"Bloc",p=Number(i.block_order??0),u=`${p}-${r}`,a=i.block_equipment??i.equipment??[],x=(Array.isArray(a)?a:String(a).split(",")).map(b=>String(b)).map(b=>fe(b)).filter(Boolean);s.has(u)||s.set(u,{title:r,repetitions:i.block_repetitions??null,description:i.block_description??"",modalities:i.block_modalities??i.modalities??"",equipment:x,exercises:[],order:Number.isFinite(p)?p:0,exerciseOrder:new Map});const f=s.get(u),N=Number(i.exercise_order??n.ordre??f.exercises.length),w=O(i.exercise_intensity??n.intensity??"V1");f.exerciseOrder.set(N,{repetitions:i.exercise_repetitions??null,distance:n.distance??null,rest:i.exercise_rest??null,restType:i.exercise_rest_type??"rest",stroke:i.exercise_stroke??i.stroke??"crawl",strokeType:i.exercise_stroke_type??i.stroke_type??"nc",intensity:w,modalities:i.exercise_modalities??n.notes??"",equipment:Array.isArray(i.exercise_equipment)?i.exercise_equipment.map(b=>fe(b)):[]})}),Array.from(s.values()).sort((n,i)=>n.order-i.order).map(n=>({title:n.title,repetitions:n.repetitions,description:n.description,modalities:n.modalities,equipment:n.equipment,exercises:Array.from(n.exerciseOrder.entries()).sort(([i],[r])=>i-r).map(([,i])=>i)}))},St=(t=[])=>new Set(t.map(n=>{const i=n.raw_payload;return i?.block_title||i?.section||"Bloc"})).size,ge="swim_catalog_archived_ids",Vt=(t,s)=>s===null?!1:!s.some(n=>n.session_type==="swim"&&n.session_id===t);function Jt(){const{toast:t}=Be(),s=Pe(),{userId:n,role:i}=Fe(),[r,p]=y.useState(!1);jt(r);const[u,a]=y.useState(null),[x,f]=y.useState(null),[N,w]=y.useState(null),[b,$]=y.useState(""),[k,D]=y.useState(new Set),_=()=>({id:null,name:xe(new Date),description:"",estimatedDuration:0,blocks:[]}),[j,V]=y.useState(_),{data:c,isLoading:d,error:l,refetch:m}=X({queryKey:["swim_catalog"],queryFn:()=>q.getSwimCatalog()}),{data:h,isLoading:v,isError:T,error:M,refetch:we}=X({queryKey:["coach-assignments"],queryFn:()=>q.getAssignmentsForCoach(),enabled:i==="coach"||i==="admin"});y.useEffect(()=>{if(typeof window>"u")return;const o=window.localStorage.getItem(ge);if(o)try{const S=JSON.parse(o);Array.isArray(S)&&D(new Set(S.map(A=>Number(A)).filter(A=>Number.isFinite(A))))}catch{return}},[]),y.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(ge,JSON.stringify(Array.from(k.values())))},[k]);const Se=y.useMemo(()=>{const o=b.trim().toLowerCase();return o?(c??[]).filter(S=>S.name.toLowerCase().includes(o)):c??[]},[c,b]).filter(o=>!k.has(o.id)),U=K({mutationFn:o=>q.createSwimSession(o),onSuccess:(o,S)=>{s.invalidateQueries({queryKey:["swim_catalog"]}),p(!1),V(_()),t({title:S?.id?"S√©ance natation mise √† jour":"S√©ance natation cr√©√©e"})}}),I=K({mutationFn:o=>q.deleteSwimSession(o),onSuccess:()=>{s.invalidateQueries({queryKey:["swim_catalog"]}),f(null),t({title:"S√©ance supprim√©e"})},onError:()=>{t({title:"Suppression impossible",description:"Cette s√©ance est utilis√©e dans une assignation.",variant:"destructive"})}}),Ve=()=>{if(!j.name.trim()){t({title:"Titre requis",description:"Ajoutez un nom de s√©ance avant d'enregistrer.",variant:"destructive"});return}U.mutate({id:j.id??void 0,name:j.name,description:j.description,estimated_duration:j.estimatedDuration||null,items:Nt(j.blocks),created_by:n??null})},ke=()=>{p(!1),V(_())},_e=o=>{V({id:o.id??null,name:o.name??xe(new Date),description:o.description??"",estimatedDuration:Number(o.estimated_duration??0),blocks:wt(o.items??[])}),p(!0)},Ce=o=>{w(o)},Te=()=>{N&&(D(o=>new Set([...Array.from(o),N.id])),w(null),t({title:"S√©ance archiv√©e"}))},De=o=>{f(o)},Me=()=>{x&&I.mutate(x.id)};return r?e.jsx(yt,{session:j,onSessionChange:V,onSave:Ve,onCancel:ke,userId:n,isSaving:U.isPending}):d||v?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx(E,{className:"h-5 w-16 mb-1"}),e.jsx(E,{className:"h-3 w-20"})]}),e.jsx(E,{className:"h-9 w-24 rounded-full"})]}),e.jsxs("div",{className:"p-4",children:[e.jsx(E,{className:"h-10 w-full rounded-2xl mb-4"}),e.jsx(se,{sessions:[],isLoading:!0,renderTitle:()=>"",renderMetrics:()=>null,onPreview:()=>{},onEdit:()=>{},onArchive:()=>{},onDelete:()=>{},canDelete:()=>!1})]})]}):l?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(oe,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les donn√©es"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:l instanceof Error?l.message:"Une erreur s'est produite"}),e.jsx(B,{variant:"default",onClick:()=>m(),className:"mt-4 h-12 md:h-10",children:"R√©essayer"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:"Coach"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Cr√©ation"})]}),e.jsxs("button",{type:"button",onClick:()=>{V(_()),p(!0)},className:"inline-flex items-center gap-2 rounded-full bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground",children:[e.jsx(R,{className:"h-4 w-4"})," Nouvelle"]})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-2xl border border-border bg-card px-3 py-2",children:[e.jsx(He,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{className:"w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground",placeholder:"Rechercher une s√©ance",value:b,onChange:o=>$(o.target.value)})]}),T&&e.jsxs("div",{className:"mt-4 flex flex-col items-center rounded-lg border border-destructive/20 bg-destructive/10 p-4",children:[e.jsx(oe,{className:"h-8 w-8 text-destructive mb-2"}),e.jsx("p",{className:"text-sm text-destructive font-semibold",children:"Impossible de charger les assignations"}),e.jsx("p",{className:"text-xs text-destructive/80 mt-1",children:M instanceof Error?M.message:"Une erreur s'est produite"}),e.jsx(B,{variant:"outline",size:"sm",onClick:()=>we(),className:"mt-2 h-10",children:"R√©essayer"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(se,{sessions:Se,isLoading:d,error:l,renderTitle:o=>o.name,renderMetrics:o=>{const S=ve(o.items??[]),Ae=o.items?.some(L=>L.duration!=null)??!1?o.items?.reduce((L,Ee)=>L+(Ee.duration??0),0)??0:null,qe=St(o.items??[]);return e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Oe,{className:"h-3.5 w-3.5"}),S,"m"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ye,{className:"h-3.5 w-3.5"}),"~",Ae??"‚Äî"," min"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ue,{className:"h-3.5 w-3.5"}),qe]})]})},onPreview:a,onEdit:_e,onArchive:Ce,onDelete:De,canDelete:o=>Vt(o,h??null),isDeleting:I.isPending})}),e.jsx("div",{className:"h-8"})]}),e.jsx(be,{open:!!u,onOpenChange:o=>{o||a(null)},children:e.jsx(ye,{className:"max-w-4xl",children:e.jsx(Ne,{title:u?.name??"",description:u?.description??void 0,items:u?.items})})}),e.jsx(Q,{open:!!N,onOpenChange:o=>{o||w(null)},children:e.jsxs(J,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Archiver la s√©ance ?"}),e.jsx(G,{children:"La s√©ance sera masqu√©e du catalogue (sans suppression)."})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Annuler"}),e.jsx(te,{onClick:Te,children:"Archiver"})]})]})}),e.jsx(Q,{open:!!x,onOpenChange:o=>{o||f(null)},children:e.jsxs(J,{children:[e.jsxs(H,{children:[e.jsx(Y,{children:"Supprimer la s√©ance ?"}),e.jsx(G,{children:"Cette action est d√©finitive. La s√©ance sera supprim√©e du catalogue."})]}),e.jsxs(Z,{children:[e.jsx(ee,{children:"Annuler"}),e.jsx(te,{onClick:Me,children:"Supprimer"})]})]})})]})}export{Vt as canDeleteSwimCatalog,Jt as default};
