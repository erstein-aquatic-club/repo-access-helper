import{r as o,j as e}from"./vendor-ui-CDk0TPZB.js";import{b as te,u as re,c as h}from"./vendor-query-BoCJU2ZS.js";import{u as ae,i as ie,g as d,m as ne,B as p,C,b as w,c as F,d as E,f as A,I as m,S as le}from"./index-EzLKQy56.js";import{S as ce}from"./switch-BVL4QaIG.js";import{B as V}from"./badge-D6cHawzI.js";import{T as q,a as K,b as I,c as i,d as H,e as n}from"./table-D_4AT8pq.js";import{S as O,a as Q,b as G,c as J,d as X}from"./select-DXDhv7b9.js";import{E as de}from"./eye-Dn0Jet4s.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Cxv39Zhq.js";import"./vendor-supabase-CgI36rMY.js";import"./check-lTi3Xmhc.js";const W=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],oe=r=>r==="user"?"Compte":"Ancien",ue=r=>{if(!r)return"-";const a=new Date(r);return Number.isNaN(a.getTime())?r:a.toLocaleDateString("fr-FR")+" "+a.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},me=r=>{if(!r)return"Jamais";const a=new Date(r);return Number.isNaN(a.getTime())?r:a.toLocaleDateString("fr-FR")},xe=(r,a=30)=>{if(!r)return!0;const j=new Date(r);return Number.isNaN(j.getTime())?!0:Date.now()-j.getTime()>a*24*60*60*1e3},he=r=>{switch(r){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},pe=r=>{switch(r){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return r}};function Ee(){const r=ae(s=>s.role),{toast:a}=ie(),j=te(),[l,f]=o.useState({display_name:"",iuf:"",sex:"",birthdate:""}),[g,k]=o.useState([]),[L,D]=o.useState(!1),[v,$]=o.useState(null),[B,Y]=o.useState(!1),[u,b]=o.useState(null),N=r==="coach"||r==="admin",R=r==="admin",{data:M=[],refetch:y}=re({queryKey:["import-logs"],queryFn:()=>d.getImportLogs({limit:20}),enabled:N}),x=o.useCallback(async()=>{if(N){D(!0),$(null);try{await d.syncClubRecordSwimmersFromUsers();const s=await d.getClubRecordSwimmers();k(s)}catch(s){const t=ne(s,"Impossible de charger la liste.");$(t.message),k([])}finally{D(!1)}}},[N]);o.useEffect(()=>{x()},[x]),o.useEffect(()=>{R&&d.getAppSettings("import_rate_limits").then(s=>{s&&b(s)})},[R]);const P=h({mutationFn:()=>d.createClubRecordSwimmer({display_name:l.display_name.trim(),iuf:l.iuf.trim()||null,sex:l.sex?l.sex:null,birthdate:l.birthdate||null,is_active:!0}),onSuccess:()=>{a({title:"Nageur ajouté"}),f({display_name:"",iuf:"",sex:"",birthdate:""}),x()},onError:()=>{a({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),Z=h({mutationFn:({id:s,payload:t})=>d.updateClubRecordSwimmer(s,t),onSuccess:()=>{x(),a({title:"Sauvegardé"})},onError:()=>{a({title:"Mise à jour impossible",variant:"destructive"})}}),ee=h({mutationFn:({userId:s,payload:t})=>d.updateClubRecordSwimmerForUser(s,t),onSuccess:()=>{x(),a({title:"Sauvegardé"})},onError:()=>{a({title:"Mise à jour impossible",variant:"destructive"})}}),S=(s,t)=>{if(s.source_type==="user"&&s.user_id){ee.mutate({userId:s.user_id,payload:t});return}s.id&&Z.mutate({id:s.id,payload:t})},T=h({mutationFn:()=>d.importClubRecords(),onSuccess:s=>{a({title:"Import terminé",description:s?`Performances importées: ${s.imported??0}. Erreurs: ${s.errors??0}.`:""}),x(),y(),j.invalidateQueries({queryKey:["club-records"]})},onError:s=>{const t=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:"Import impossible";a({title:t,variant:"destructive"}),y()}}),z=h({mutationFn:({iuf:s,name:t})=>d.importSingleSwimmer(s,t),onSuccess:(s,t)=>{a({title:`Import de ${t.name??t.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),y(),d.recalculateClubRecords().then(()=>{j.invalidateQueries({queryKey:["club-records"]})}),x()},onError:(s,t)=>{const _=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:`Erreur import ${t.name??t.iuf}`;a({title:_,variant:"destructive"}),y()}}),U=h({mutationFn:s=>d.updateAppSettings("import_rate_limits",s),onSuccess:()=>{a({title:"Limites sauvegardées"})},onError:()=>{a({title:"Erreur de sauvegarde",variant:"destructive"})}}),se=o.useMemo(()=>[...g].sort((s,t)=>s.source_type!==t.source_type?s.source_type.localeCompare(t.source_type):s.display_name.localeCompare(t.display_name)),[g]);return N?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gérez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"outline",size:"sm",onClick:()=>{window.location.hash="#/records-club"},children:[e.jsx(de,{className:"h-4 w-4 mr-1"}),"Voir les records"]}),e.jsx(p,{onClick:()=>T.mutate(),disabled:T.isPending,children:T.isPending?"Import en cours...":"Mettre à jour les records"})]})]}),e.jsxs(C,{children:[e.jsxs(w,{children:[e.jsx(F,{children:"Ajouter un ancien nageur"}),e.jsx(E,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(A,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_1fr_auto]",children:[e.jsx(m,{placeholder:"Nom du nageur",value:l.display_name,onChange:s=>f(t=>({...t,display_name:s.target.value}))}),e.jsx(m,{placeholder:"IUF",value:l.iuf,onChange:s=>f(t=>({...t,iuf:s.target.value}))}),e.jsxs(O,{value:l.sex,onValueChange:s=>f(t=>({...t,sex:s})),children:[e.jsx(Q,{children:e.jsx(G,{placeholder:"Sexe"})}),e.jsx(J,{children:W.map(s=>e.jsx(X,{value:s.value,children:s.label},s.value))})]}),e.jsx(m,{type:"date",value:l.birthdate,onChange:s=>f(t=>({...t,birthdate:s.target.value}))}),e.jsx(p,{onClick:()=>P.mutate(),disabled:!l.display_name.trim()||P.isPending,children:"Ajouter"})]})]}),e.jsxs(C,{children:[e.jsxs(w,{children:[e.jsx(F,{children:"Liste des nageurs suivis"}),e.jsx(E,{children:"Mettre à jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(A,{children:[L&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s))}),v&&e.jsx("p",{className:"text-sm text-destructive",children:v}),!L&&!v&&g.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!L&&!v&&g.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(q,{children:[e.jsx(K,{children:e.jsxs(I,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Source"}),e.jsx(i,{children:"IUF"}),e.jsx(i,{children:"Sexe"}),e.jsx(i,{children:"Naissance"}),e.jsx(i,{children:"Dernière maj"}),e.jsx(i,{children:"Actif"}),e.jsx(i,{children:"Actions"})]})}),e.jsx(H,{children:se.map(s=>{const t=s.id??`user-${s.user_id??"unknown"}`,_=xe(s.last_imported_at);return e.jsxs(I,{className:_?"bg-amber-50/50 dark:bg-amber-950/10":"",children:[e.jsx(n,{className:"font-medium",children:s.display_name}),e.jsx(n,{children:e.jsx(V,{variant:s.source_type==="manual"?"secondary":"outline",children:oe(s.source_type)})}),e.jsx(n,{children:e.jsx(m,{defaultValue:s.iuf??"",onBlur:c=>S(s,{iuf:c.target.value.trim()||null}),className:"w-24"},`${t}-${s.iuf??""}`)}),e.jsx(n,{children:e.jsxs(O,{value:s.sex??"",onValueChange:c=>S(s,{sex:c||null}),children:[e.jsx(Q,{className:"w-28",children:e.jsx(G,{placeholder:"Sexe"})}),e.jsx(J,{children:W.map(c=>e.jsx(X,{value:c.value,children:c.label},c.value))})]})}),e.jsx(n,{children:e.jsx(m,{type:"date",defaultValue:s.birthdate??"",onBlur:c=>S(s,{birthdate:c.target.value||null}),className:"w-36"},`${t}-${s.birthdate??""}`)}),e.jsx(n,{children:e.jsx("span",{className:_?"text-amber-600 dark:text-amber-400 text-xs font-medium":"text-xs text-muted-foreground",children:me(s.last_imported_at)})}),e.jsx(n,{children:e.jsx(ce,{checked:!!s.is_active,onCheckedChange:c=>S(s,{is_active:c})})}),e.jsx(n,{children:s.iuf?e.jsx(p,{size:"sm",variant:"outline",disabled:z.isPending,onClick:()=>z.mutate({iuf:s.iuf,name:s.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},t)})})]})})]})]}),e.jsxs(C,{children:[e.jsxs(w,{children:[e.jsx(F,{children:"Historique des imports"}),e.jsx(E,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(A,{children:M.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectué."}):e.jsxs(q,{children:[e.jsx(K,{children:e.jsxs(I,{children:[e.jsx(i,{children:"Nageur"}),e.jsx(i,{children:"Statut"}),e.jsx(i,{children:"Trouvées"}),e.jsx(i,{children:"Importées"}),e.jsx(i,{children:"Date"}),e.jsx(i,{children:"Erreur"})]})}),e.jsx(H,{children:M.map(s=>e.jsxs(I,{children:[e.jsx(n,{className:"font-medium",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(n,{children:e.jsx(V,{variant:he(s.status),children:pe(s.status)})}),e.jsx(n,{children:s.performances_found??"-"}),e.jsx(n,{children:s.performances_imported??"-"}),e.jsx(n,{className:"text-xs",children:ue(s.started_at)}),e.jsx(n,{className:"max-w-[200px] truncate text-xs text-destructive",children:s.error_message??""})]},s.id))})]})})]}),R&&e.jsxs(C,{children:[e.jsxs(w,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(F,{children:"Paramètres d'import"}),e.jsx(E,{children:"Limites mensuelles d'import par rôle."})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>Y(!B),children:e.jsx(le,{className:"h-4 w-4"})})]}),B&&u&&e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Coach (par mois)"}),e.jsx(m,{type:"number",value:u.coach_monthly,onChange:s=>b({...u,coach_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Nageur (par mois)"}),e.jsx(m,{type:"number",value:u.athlete_monthly,onChange:s=>b({...u,athlete_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Admin (par mois, -1=illimité)"}),e.jsx(m,{type:"number",value:u.admin_monthly,onChange:s=>b({...u,admin_monthly:Number(s.target.value)}),min:-1})]})]}),e.jsx(p,{size:"sm",onClick:()=>U.mutate(u),disabled:U.isPending,children:"Enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Accès réservé aux coachs."})]})}export{Ee as default};
