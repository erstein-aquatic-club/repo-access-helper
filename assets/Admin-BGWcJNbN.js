import{b as me,j as e}from"./vendor-ui-C9ymspZo.js";import{h as y,u as D,i as ue,R as he,C as I,b as S,c as _,d as E,f as R,B as x,L as u,I as U,g as o,m as xe}from"./index-B02B6PIp.js";import{b as pe,u as ae,c as p}from"./vendor-query-kM2vrB_e.js";import{S as V,a as B,b as $,c as H,d as a}from"./select-B8VCsnm3.js";import{S as je}from"./switch-0qIHpxWx.js";import{B as j}from"./badge-mOauAOYw.js";import{T as ve,a as fe,b as te,c as v,d as ge,e as f}from"./table-BnzbwCqN.js";import{C as ye}from"./clock-VKW9aFMX.js";import{S as Ne}from"./search-DFQ5bRVI.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-B94mr-Ia.js";import"./check-BXLnPru7.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ce=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],be=y("circle-check-big",Ce);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const we=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],ke=y("circle-x",we);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ae=[["path",{d:"M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z",key:"oel41y"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]],Ie=y("shield-check",Ae);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],_e=y("user-minus",Se);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]],Re=y("user-plus",Ee),re=["athlete","coach","comite","admin"],G=l=>!(l===!1||l===0),Ue=(l,t,q)=>l.map(h=>h.id===t?{...h,role:q}:h),g=(l,t)=>xe(l,t).message;function Ge(){const{useMemo:l,useState:t}=me,q=typeof window>"u"?D.getState().role:D(s=>s.role),h=D(s=>s.userId),{toast:n}=ue(),c=pe(),[P,ne]=t(""),[N,le]=t("all"),[C,ce]=t(!1),[b,de]=t(null),[F,O]=t(""),[X,J]=t(""),[W,Y]=t(""),[Z,ee]=t(null),z=q==="admin",{data:m=[],isLoading:oe}=ae({queryKey:["admin-users",C],queryFn:()=>o.listUsers({includeInactive:C}),enabled:z}),L=p({mutationFn:s=>o.createCoach(s),onMutate:()=>{ee(null)},onSuccess:s=>{c.invalidateQueries({queryKey:["admin-users"]}),O(""),J(""),Y(""),ee(s.initialPassword??null),n({title:"Coach créé"})},onError:s=>{n({title:"Erreur création coach",description:g(s,"Impossible de créer le coach.")})}}),w=p({mutationFn:s=>o.updateUserRole(s),onSuccess:(s,i)=>{c.setQueryData(["admin-users",C],d=>d&&Ue(d,i.userId,i.role)),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Rôle mis à jour"})},onError:s=>{n({title:"Erreur mise à jour rôle",description:g(s,"Impossible de mettre à jour le rôle.")})}}),se=p({mutationFn:s=>o.disableUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Compte désactivé"})},onError:s=>{n({title:"Erreur désactivation",description:g(s,"Impossible de désactiver le compte.")})}}),{data:M=[]}=ae({queryKey:["pending-approvals"],queryFn:()=>o.getPendingApprovals(),enabled:z}),T=p({mutationFn:s=>o.approveUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription validée"})},onError:s=>{n({title:"Erreur validation",description:g(s,"Impossible de valider l'inscription.")})}}),Q=p({mutationFn:s=>o.rejectUser(s),onSuccess:()=>{c.invalidateQueries({queryKey:["pending-approvals"]}),c.invalidateQueries({queryKey:["admin-users"]}),n({title:"Inscription rejetée"})},onError:s=>{n({title:"Erreur rejet",description:g(s,"Impossible de rejeter l'inscription.")})}}),k=l(()=>m.find(i=>i.role==="admin")?.id??null,[m]),ie=l(()=>{const s=P.trim().toLowerCase();return m.filter(i=>{if(N!=="all"&&i.role!==N)return!1;const d=i.display_name?.toLowerCase()??"",K=i.email?.toLowerCase()??"";return!(s&&!d.includes(s)&&!K.includes(s))})},[m,N,P]),r=l(()=>b?m.find(s=>s.id===b)??null:null,[b,m]);return z?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration"}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ie,{className:"h-4 w-4 text-primary"}),e.jsx("span",{children:"Accès admin"})]})]}),M.length>0?e.jsxs(I,{className:"border-status-warning/30 bg-status-warning-bg dark:border-status-warning/30 dark:bg-status-warning-bg",children:[e.jsxs(S,{children:[e.jsxs(_,{className:"flex items-center gap-2",children:[e.jsx(ye,{className:"h-5 w-5 text-status-warning"}),"Inscriptions en attente",e.jsx(j,{variant:"secondary",className:"ml-2",children:M.length})]}),e.jsx(E,{children:"Ces utilisateurs ont créé un compte et attendent votre validation."})]}),e.jsx(R,{children:e.jsx("div",{className:"space-y-3",children:M.map(s=>e.jsxs("div",{className:"flex flex-col gap-3 rounded-lg border bg-background p-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"font-medium",children:s.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.email||"Pas d'email"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Inscrit le ",new Date(s.created_at).toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(x,{size:"sm",className:"bg-status-success hover:opacity-90 text-white",onClick:()=>T.mutate(s.user_id),disabled:T.isPending||Q.isPending,children:[e.jsx(be,{className:"mr-2 h-4 w-4"}),"Approuver"]}),e.jsxs(x,{size:"sm",variant:"destructive",onClick:()=>{window.confirm(`Rejeter l'inscription de "${s.display_name}" ? Le compte sera désactivé.`)&&Q.mutate(s.user_id)},disabled:T.isPending||Q.isPending,children:[e.jsx(ke,{className:"mr-2 h-4 w-4"}),"Rejeter"]})]})]},s.user_id))})})]}):null,e.jsxs(I,{children:[e.jsxs(S,{children:[e.jsx(_,{children:"Créer un coach"}),e.jsx(E,{children:"Laissez le mot de passe vide pour en générer un automatiquement (affiché une seule fois)."})]}),e.jsx(R,{children:e.jsxs("form",{className:"space-y-4",onSubmit:s=>{s.preventDefault();const i=F.trim();i&&L.mutate({display_name:i,email:X.trim()||void 0,password:W||void 0})},children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"coach-create-name",children:"Nom affiché"}),e.jsx(U,{id:"coach-create-name",value:F,onChange:s=>O(s.target.value),placeholder:"Ex: Coach Martin",required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"coach-create-email",children:"Email"}),e.jsx(U,{id:"coach-create-email",type:"email",value:X,onChange:s=>J(s.target.value),placeholder:"coach@email.com"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"coach-create-password",children:"Mot de passe (optionnel)"}),e.jsx(U,{id:"coach-create-password",type:"text",value:W,onChange:s=>Y(s.target.value),placeholder:"Laisser vide pour auto"})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx(x,{type:"submit",disabled:!F.trim()||L.isPending,children:L.isPending?"Création...":"Créer le coach"}),Z?e.jsxs("div",{className:"rounded-md border border-primary/30 bg-primary/5 px-4 py-2 text-sm",children:[e.jsx("p",{className:"font-medium text-primary",children:"Mot de passe initial (à copier)"}),e.jsx("p",{className:"font-mono",children:Z})]}):null]})]})})]}),e.jsxs(I,{children:[e.jsxs(S,{children:[e.jsx(_,{children:"Gestion des comptes"}),e.jsx(E,{children:"Mettre à jour les rôles, filtrer et désactiver les comptes."})]}),e.jsxs(R,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-4",children:[e.jsxs("div",{className:"md:col-span-2 space-y-2",children:[e.jsx(u,{htmlFor:"admin-search",children:"Recherche"}),e.jsxs("div",{className:"relative",children:[e.jsx(Ne,{className:"absolute left-3 top-3 h-4 w-4 text-muted-foreground"}),e.jsx(U,{id:"admin-search",value:P,onChange:s=>ne(s.target.value),placeholder:"Nom ou email",className:"pl-9"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Rôle"}),e.jsxs(V,{value:N,onValueChange:s=>le(s),children:[e.jsx(B,{children:e.jsx($,{placeholder:"Tous"})}),e.jsxs(H,{children:[e.jsx(a,{value:"all",children:"Tous"}),e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",children:"Admin"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{checked:C,onCheckedChange:ce,id:"inactive-toggle"}),e.jsx(u,{htmlFor:"inactive-toggle",className:"text-sm",children:"Inclure désactivés"})]})]}),oe?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Chargement des utilisateurs..."}):ie.length?e.jsx("div",{className:"w-full overflow-x-auto",children:e.jsxs(ve,{children:[e.jsx(fe,{children:e.jsxs(te,{children:[e.jsx(v,{children:"Utilisateur"}),e.jsx(v,{children:"Email"}),e.jsx(v,{children:"Rôle"}),e.jsx(v,{children:"Statut"}),e.jsx(v,{className:"text-right",children:"Actions"})]})}),e.jsx(ge,{children:ie.map(s=>{const i=G(s.is_active),d=h===s.id,K=k!==null&&k!==s.id;return e.jsxs(te,{"data-selected":b===s.id,children:[e.jsx(f,{className:"font-medium",children:e.jsx(x,{variant:"ghost",size:"sm",className:"px-2",onClick:()=>de(s.id),children:s.display_name})}),e.jsx(f,{className:"text-sm text-muted-foreground",children:s.email||"-"}),e.jsx(f,{children:e.jsxs(V,{value:s.role,onValueChange:A=>{re.includes(A)&&s.id&&A!==s.role&&w.mutate({userId:s.id,role:A})},disabled:!i||w.isPending,children:[e.jsx(B,{className:"w-[140px]",children:e.jsx($,{})}),e.jsxs(H,{children:[e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",disabled:K,children:"Admin"})]})]})}),e.jsx(f,{children:i?e.jsx(j,{variant:"secondary",children:"Actif"}):e.jsx(j,{variant:"outline",children:"Désactivé"})}),e.jsx(f,{className:"text-right",children:e.jsxs(x,{variant:"destructive",size:"sm",onClick:()=>{if(!s.id)return;if(d){n({title:"Action impossible",description:"Vous ne pouvez pas désactiver votre propre compte."});return}window.confirm(`Confirmer la désactivation du compte "${s.display_name}" ?`)&&se.mutate({userId:s.id})},disabled:!i||se.isPending||d,children:[e.jsx(_e,{className:"mr-2 h-4 w-4"}),"Désactiver"]})})]},s.id)})})]})}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Re,{className:"h-4 w-4"}),"Aucun utilisateur ne correspond à votre recherche."]})]})]}),e.jsxs(I,{children:[e.jsxs(S,{children:[e.jsx(_,{children:"Fiche utilisateur"}),e.jsx(E,{children:"Sélectionnez un compte pour afficher les détails."})]}),e.jsx(R,{children:r?e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Nom affiché"}),e.jsx("p",{className:"text-lg font-semibold",children:r.display_name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Email"}),e.jsx("p",{children:r.email||"-"})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Rôle"}),e.jsxs(V,{value:r.role,onValueChange:s=>{re.includes(s)&&r.id&&s!==r.role&&w.mutate({userId:r.id,role:s})},disabled:!G(r.is_active)||w.isPending,children:[e.jsx(B,{className:"w-[180px]",children:e.jsx($,{})}),e.jsxs(H,{children:[e.jsx(a,{value:"athlete",children:"Athlète"}),e.jsx(a,{value:"coach",children:"Entraineur EAC"}),e.jsx(a,{value:"comite",children:"Comité"}),e.jsx(a,{value:"admin",disabled:k!==null&&k!==r.id,children:"Admin"})]})]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Statut"}),G(r.is_active)?e.jsx(j,{variant:"secondary",children:"Actif"}):e.jsx(j,{variant:"outline",children:"Désactivé"})]}),r.group_label?e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Groupe"}),e.jsx("p",{children:r.group_label})]}):null]})]}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun utilisateur sélectionné."})})]})]}):typeof window>"u"?null:e.jsx(he,{to:"/"})}export{Ge as default,Ue as updateUserRoleInList};
