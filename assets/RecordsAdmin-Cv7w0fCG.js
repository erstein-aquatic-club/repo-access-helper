import{r as c,j as e}from"./vendor-ui-C9ymspZo.js";import{b as ae,u as ne,c as x}from"./vendor-query-kM2vrB_e.js";import{u as le,i as ce,g as l,m as oe,B as h,k as P,C as w,b as F,c as E,d as R,f as I,I as g,S as de}from"./index-BDPdC51m.js";import{S as ue}from"./switch-B_IZIPgs.js";import{B as Q}from"./badge-DPsI4hZI.js";import{T as H,a as O,b as A,c as a,d as G,e as n}from"./table-cQBKbW8y.js";import{S as J,a as X,b as W,c as Y,d as Z}from"./select-CaPh-T-u.js";import{E as me}from"./eye-CYVAfHiN.js";import{R as xe}from"./refresh-cw-CvBSfKf7.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-D4isxuEU.js";import"./check-By9BhXNd.js";const ee=[{value:"M",label:"Garçon"},{value:"F",label:"Fille"}],he=i=>i==="user"?"Compte":"Ancien",pe=i=>{if(!i)return"-";const r=new Date(i);return Number.isNaN(r.getTime())?i:r.toLocaleDateString("fr-FR")+" "+r.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},je=i=>{if(!i)return"Jamais";const r=new Date(i);return Number.isNaN(r.getTime())?i:r.toLocaleDateString("fr-FR")},ge=(i,r=30)=>{if(!i)return!0;const p=new Date(i);return Number.isNaN(p.getTime())?!0:Date.now()-p.getTime()>r*24*60*60*1e3},fe=i=>{switch(i){case"success":return"default";case"running":return"secondary";case"error":return"destructive";default:return"outline"}},ve=i=>{switch(i){case"success":return"OK";case"running":return"En cours";case"error":return"Erreur";case"pending":return"En attente";default:return i}};function ke(){const i=le(s=>s.role),{toast:r}=ce(),p=ae(),[o,f]=c.useState({display_name:"",iuf:"",sex:""}),[j,M]=c.useState([]),[v,z]=c.useState(!1),[b,$]=c.useState(null),[q,se]=c.useState(!1),[u,N]=c.useState(null),S=i==="coach"||i==="admin",L=i==="admin",{data:B=[],refetch:y}=ne({queryKey:["import-logs"],queryFn:()=>l.getImportLogs({limit:20}),enabled:S}),m=c.useCallback(async()=>{if(S){z(!0),$(null);try{await l.syncClubRecordSwimmersFromUsers();const s=await l.getClubRecordSwimmers();M(s)}catch(s){const t=oe(s,"Impossible de charger la liste.");$(t.message),M([])}finally{z(!1)}}},[S]);c.useEffect(()=>{m()},[m]),c.useEffect(()=>{L&&l.getAppSettings("import_rate_limits").then(s=>{s&&N(s)})},[L]);const U=x({mutationFn:()=>l.createClubRecordSwimmer({display_name:o.display_name.trim(),iuf:o.iuf.trim()||null,sex:o.sex?o.sex:null,is_active:!0}),onSuccess:()=>{r({title:"Nageur ajouté"}),f({display_name:"",iuf:"",sex:""}),m()},onError:()=>{r({title:"Impossible d'ajouter le nageur",variant:"destructive"})}}),te=x({mutationFn:({id:s,payload:t})=>l.updateClubRecordSwimmer(s,t),onSuccess:()=>{m(),r({title:"Sauvegardé"})},onError:()=>{r({title:"Mise à jour impossible",variant:"destructive"})}}),re=x({mutationFn:({userId:s,payload:t})=>l.updateClubRecordSwimmerForUser(s,t),onSuccess:()=>{m(),r({title:"Sauvegardé"})},onError:()=>{r({title:"Mise à jour impossible",variant:"destructive"})}}),T=(s,t)=>{if(s.source_type==="user"&&s.user_id){re.mutate({userId:s.user_id,payload:t});return}s.id&&te.mutate({id:s.id,payload:t})},k=x({mutationFn:()=>l.importClubRecords(),onSuccess:s=>{r({title:"Import terminé",description:s?`Performances importées: ${s.imported??0}. Erreurs: ${s.errors??0}.`:""}),m(),y(),p.invalidateQueries({queryKey:["club-records"]})},onError:s=>{const t=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:"Import impossible";r({title:t,variant:"destructive"}),y()}}),K=x({mutationFn:({iuf:s,name:t})=>l.importSingleSwimmer(s,t),onSuccess:(s,t)=>{r({title:`Import de ${t.name??t.iuf}`,description:`${s.total_found} performances trouvées, ${s.new_imported} nouvelles importées.`}),y(),l.recalculateClubRecords().then(()=>{p.invalidateQueries({queryKey:["club-records"]})}),m()},onError:(s,t)=>{const C=s?.message?.includes("Rate limit")||s?.message?.includes("Limite")?s.message:`Erreur import ${t.name??t.iuf}`;r({title:C,variant:"destructive"}),y()}}),V=x({mutationFn:s=>l.updateAppSettings("import_rate_limits",s),onSuccess:()=>{r({title:"Limites sauvegardées"})},onError:()=>{r({title:"Erreur de sauvegarde",variant:"destructive"})}}),ie=c.useMemo(()=>[...j].sort((s,t)=>s.source_type!==t.source_type?s.source_type.localeCompare(t.source_type):s.display_name.localeCompare(t.display_name)),[j]),_=c.useMemo(()=>j.filter(s=>s.is_active&&(!s.iuf||!s.sex)).length,[j]),D=x({mutationFn:()=>l.recalculateClubRecords(),onSuccess:()=>{r({title:"Records recalculés"}),p.invalidateQueries({queryKey:["club-records"]})},onError:()=>{r({title:"Erreur de recalcul",variant:"destructive"})}});return S?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Gérez les nageurs pris en compte pour les records et lancez l'import FFN."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>{window.location.hash="#/records-club"},children:[e.jsx(me,{className:"h-4 w-4 mr-1"}),"Voir les records"]}),e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>D.mutate(),disabled:D.isPending,children:[e.jsx(xe,{className:P("h-4 w-4 mr-1",D.isPending&&"animate-spin")}),"Recalculer"]}),e.jsx(h,{onClick:()=>k.mutate(),disabled:k.isPending,children:k.isPending?"Import en cours...":"Mettre à jour les records"})]})]}),e.jsxs(w,{children:[e.jsxs(F,{children:[e.jsx(E,{children:"Ajouter un ancien nageur"}),e.jsx(R,{children:"Ajoutez un nageur sans compte pour l'import des performances FFN."})]}),e.jsxs(I,{className:"grid gap-4 md:grid-cols-[2fr_1fr_1fr_auto]",children:[e.jsx(g,{placeholder:"Nom du nageur",value:o.display_name,onChange:s=>f(t=>({...t,display_name:s.target.value}))}),e.jsx(g,{placeholder:"IUF",value:o.iuf,onChange:s=>f(t=>({...t,iuf:s.target.value}))}),e.jsxs(J,{value:o.sex,onValueChange:s=>f(t=>({...t,sex:s})),children:[e.jsx(X,{children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Y,{children:ee.map(s=>e.jsx(Z,{value:s.value,children:s.label},s.value))})]}),e.jsx(h,{onClick:()=>U.mutate(),disabled:!o.display_name.trim()||U.isPending,children:"Ajouter"})]})]}),e.jsxs(w,{children:[e.jsxs(F,{children:[e.jsx(E,{children:"Liste des nageurs suivis"}),e.jsx(R,{children:"Mettre à jour l'IUF, le sexe ou l'activation pour l'import FFN."})]}),e.jsxs(I,{children:[!v&&_>0&&e.jsxs("div",{className:"mb-4 rounded-lg border border-amber-300 bg-amber-50 p-3 text-sm text-amber-800 dark:border-amber-700 dark:bg-amber-950/30 dark:text-amber-300",children:[e.jsxs("strong",{children:[_," nageur",_>1?"s":""," incomplet",_>1?"s":""]})," ","— les champs IUF et Sexe sont requis pour le calcul des records."]}),v&&e.jsx("div",{className:"space-y-3",children:[1,2,3,4].map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"h-4 w-32 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-20 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-16 rounded bg-muted animate-pulse motion-reduce:animate-none"}),e.jsx("div",{className:"h-4 w-24 rounded bg-muted animate-pulse motion-reduce:animate-none"})]},s))}),b&&e.jsx("p",{className:"text-sm text-destructive",children:b}),!v&&!b&&j.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun nageur disponible."}),!v&&!b&&j.length>0&&e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(A,{children:[e.jsx(a,{children:"Nageur"}),e.jsx(a,{children:"Source"}),e.jsx(a,{children:"IUF"}),e.jsx(a,{children:"Sexe"}),e.jsx(a,{children:"Dernière maj"}),e.jsx(a,{children:"Actif"}),e.jsx(a,{children:"Actions"})]})}),e.jsx(G,{children:ie.map(s=>{const t=s.id??`user-${s.user_id??"unknown"}`,C=ge(s.last_imported_at);return e.jsxs(A,{className:C?"bg-amber-50/50 dark:bg-amber-950/10":"",children:[e.jsx(n,{className:"font-medium",children:s.display_name}),e.jsx(n,{children:e.jsx(Q,{variant:s.source_type==="manual"?"secondary":"outline",children:he(s.source_type)})}),e.jsx(n,{children:e.jsx(g,{defaultValue:s.iuf??"",onBlur:d=>T(s,{iuf:d.target.value.trim()||null}),className:P("w-24",s.is_active&&!s.iuf&&"ring-2 ring-destructive/50")},`${t}-${s.iuf??""}`)}),e.jsx(n,{children:e.jsxs(J,{value:s.sex??"",onValueChange:d=>T(s,{sex:d||null}),children:[e.jsx(X,{className:P("w-28",s.is_active&&!s.sex&&"ring-2 ring-destructive/50"),children:e.jsx(W,{placeholder:"Sexe"})}),e.jsx(Y,{children:ee.map(d=>e.jsx(Z,{value:d.value,children:d.label},d.value))})]})}),e.jsx(n,{children:e.jsx("span",{className:C?"text-amber-600 dark:text-amber-400 text-xs font-medium":"text-xs text-muted-foreground",children:je(s.last_imported_at)})}),e.jsx(n,{children:e.jsx(ue,{checked:!!s.is_active,onCheckedChange:d=>T(s,{is_active:d})})}),e.jsx(n,{children:s.iuf?e.jsx(h,{size:"sm",variant:"outline",disabled:K.isPending,onClick:()=>K.mutate({iuf:s.iuf,name:s.display_name}),children:"Importer"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Pas d'IUF"})})]},t)})})]})})]})]}),e.jsxs(w,{children:[e.jsxs(F,{children:[e.jsx(E,{children:"Historique des imports"}),e.jsx(R,{children:"Les 20 derniers imports de performances FFN."})]}),e.jsx(I,{children:B.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aucun import effectué."}):e.jsxs(H,{children:[e.jsx(O,{children:e.jsxs(A,{children:[e.jsx(a,{children:"Nageur"}),e.jsx(a,{children:"Statut"}),e.jsx(a,{children:"Trouvées"}),e.jsx(a,{children:"Importées"}),e.jsx(a,{children:"Date"}),e.jsx(a,{children:"Erreur"})]})}),e.jsx(G,{children:B.map(s=>e.jsxs(A,{children:[e.jsx(n,{className:"font-medium",children:s.swimmer_name??s.swimmer_iuf}),e.jsx(n,{children:e.jsx(Q,{variant:fe(s.status),children:ve(s.status)})}),e.jsx(n,{children:s.performances_found??"-"}),e.jsx(n,{children:s.performances_imported??"-"}),e.jsx(n,{className:"text-xs",children:pe(s.started_at)}),e.jsx(n,{className:"max-w-[200px] truncate text-xs text-destructive",children:s.error_message??""})]},s.id))})]})})]}),L&&e.jsxs(w,{children:[e.jsxs(F,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(E,{children:"Paramètres d'import"}),e.jsx(R,{children:"Limites mensuelles d'import par rôle."})]}),e.jsx(h,{variant:"ghost",size:"sm",onClick:()=>se(!q),children:e.jsx(de,{className:"h-4 w-4"})})]}),q&&u&&e.jsxs(I,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 sm:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Coach (par mois)"}),e.jsx(g,{type:"number",value:u.coach_monthly,onChange:s=>N({...u,coach_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Nageur (par mois)"}),e.jsx(g,{type:"number",value:u.athlete_monthly,onChange:s=>N({...u,athlete_monthly:Number(s.target.value)}),min:-1})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs text-muted-foreground",children:"Admin (par mois, -1=illimité)"}),e.jsx(g,{type:"number",value:u.admin_monthly,onChange:s=>N({...u,admin_monthly:Number(s.target.value)}),min:-1})]})]}),e.jsx(h,{size:"sm",onClick:()=>V.mutate(u),disabled:V.isPending,children:"Enregistrer"})]})]})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h1",{className:"text-3xl font-display font-bold uppercase italic text-primary",children:"Administration des records"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Accès réservé aux coachs."})]})}export{ke as default};
