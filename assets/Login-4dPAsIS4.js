import{j as e,r as d}from"./vendor-ui-C9ymspZo.js";import{c as y,u as D,a as $,C as J,b as Y,e as ee,d as se,f as re,g as te,L as c,I as h,B as j,s as v,h as ae}from"./index-BxtzGphB.js";import{u as ie}from"./vendor-query-kM2vrB_e.js";import{u as S,t as C,o as I,s as u,e as oe}from"./types-BSfQlzoI.js";import{D as R,a as A,b as L,c as T,d as q}from"./dialog-4E4d5p9_.js";import{S as z,a as M,b as P,c as U,d as E}from"./select-Cw2dy6L7.js";import{C as ne}from"./circle-check-eyKt5I_R.js";import{C as le}from"./circle-x-mketxNzu.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";import"./chevron-up-YGBxaPqZ.js";import"./check-BFc-O_92.js";const F=[{label:"Au moins 8 caractères",test:t=>t.length>=8},{label:"Une majuscule",test:t=>/[A-Z]/.test(t)},{label:"Un chiffre",test:t=>/[0-9]/.test(t)}];function ce({password:t}){const a=F.filter(m=>m.test(t)).length,g=a===0||a===1?"Faible":a===2?"Moyen":"Fort",b=a===0||a===1?"bg-destructive":a===2?"bg-orange-500":"bg-status-success";return t?e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:y("h-full transition-all duration-300",b),style:{width:`${a/F.length*100}%`}})}),e.jsx("span",{className:y("text-xs font-medium",b.replace("bg-","text-")),children:g})]}),e.jsx("div",{className:"space-y-1",children:F.map((m,w)=>{const x=m.test(t);return e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[x?e.jsx(ne,{className:"h-3.5 w-3.5 text-status-success shrink-0"}):e.jsx(le,{className:"h-3.5 w-3.5 text-muted-foreground shrink-0"}),e.jsx("span",{className:y(x?"text-foreground":"text-muted-foreground"),children:m.label})]},w)})})]}):null}const me=t=>t,de=t=>{switch(t){case"coach":return"/coach";case"admin":return"/admin";case"comite":return"/comite";default:return"/"}},ue=I({email:u().min(1,"Email requis").email("Email invalide"),password:u().min(1,"Mot de passe requis")}),xe=I({name:u().min(2,"Minimum 2 caractères"),email:u().min(1,"Email requis").email("Email invalide"),birthdate:u().min(1,"Date de naissance requise").refine(t=>{const p=new Date(t);if(Number.isNaN(p.getTime()))return!1;const a=(Date.now()-p.getTime())/(365.25*24*60*60*1e3);return a>=6&&a<=100},"Âge invalide (6-100 ans)"),sex:oe(["M","F"],{required_error:"Sexe requis"}),groupId:u().min(1,"Groupe requis"),password:u().min(8,"Minimum 8 caractères").regex(/[A-Z]/,"Au moins une majuscule").regex(/[0-9]/,"Au moins un chiffre")}),he=I({email:u().min(1,"Email requis").email("Email invalide")});function Ve(){const[t,p]=d.useState(null),[a,g]=d.useState(!1),[b,m]=d.useState(!1),[w,x]=d.useState(!1),[G,N]=d.useState(!1),{loginFromSession:O,loadUser:_}=D(),[,B]=$(),V=d.useRef(null),o=S({resolver:C(ue),defaultValues:{email:"",password:""}}),r=S({resolver:C(xe),defaultValues:{name:"",email:"",birthdate:"",sex:void 0,groupId:"",password:""}}),n=S({resolver:C(he),defaultValues:{email:""}}),{data:f=[],isLoading:k,isError:H}=ie({queryKey:["register-groups"],queryFn:()=>ae.getGroups(),enabled:a,retry:2});d.useEffect(()=>{if(!a)return;!r.watch("groupId")&&f.length>0&&r.setValue("groupId",String(f[0].id))},[f,a,r]),d.useEffect(()=>{me(a)&&V.current?.focus()},[a]);const X=s=>s.includes("Invalid login")?"Identifiant ou mot de passe incorrect.":s.includes("Email not confirmed")?"Veuillez confirmer votre email avant de vous connecter.":s,Z=async s=>{p(null);try{const{data:i,error:l}=await v.auth.signInWithPassword({email:s.email.trim(),password:s.password});if(l)throw new Error(X(l.message));if(!i.session)throw new Error("Session non reçue.");if(O(i.session),!await _())throw new Error("Impossible de récupérer le profil utilisateur.");const W=D.getState().role;B(de(W),{replace:!0})}catch(i){const l=i instanceof Error?i.message:"Connexion impossible.";p(l)}},K=async s=>{try{const{data:i,error:l}=await v.auth.signUp({email:s.email.trim(),password:s.password,options:{data:{display_name:s.name.trim(),birthdate:s.birthdate,group_id:Number(s.groupId),sex:s.sex}}});if(l)throw new Error(l.message);i.user&&(await v.auth.signOut(),m(!0))}catch(i){const l=i instanceof Error?i.message:"Création impossible.";r.setError("root",{message:l})}},Q=async s=>{try{const{error:i}=await v.auth.resetPasswordForEmail(s.email.trim(),{redirectTo:window.location.origin+"/competition/#/reset-password"});if(i)throw i;N(!0)}catch(i){const l=i instanceof Error?i.message:"Erreur lors de l'envoi";n.setError("root",{message:l})}};return e.jsxs("div",{className:"min-h-screen flex items-center justify-center p-4 bg-background relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-[-20%] right-[-10%] w-[600px] h-[600px] bg-primary/10 rounded-full blur-3xl pointer-events-none"}),e.jsxs(J,{className:"w-full max-w-sm relative z-10 shadow-2xl border-t-8 border-t-primary animate-in fade-in zoom-in duration-500 motion-reduce:animate-none",children:[e.jsxs(Y,{className:"text-center pb-2",children:[e.jsx("div",{className:"mx-auto mb-6 h-24 w-24 rounded-full bg-foreground flex items-center justify-center border-4 border-primary shadow-lg",children:e.jsx("img",{src:ee,alt:"EAC Logo",loading:"lazy",className:"h-full w-full object-cover rounded-full opacity-90"})}),e.jsxs(se,{className:"text-3xl font-display italic uppercase tracking-tighter",children:["SUIVI",e.jsx("span",{className:"text-primary",children:"NATATION"})]}),e.jsx(re,{className:"uppercase tracking-widest text-xs font-bold",children:"Erstein Aquatic Club"})]}),e.jsx(te,{children:e.jsxs("form",{onSubmit:o.handleSubmit(Z),className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"login-email",className:"sr-only",children:"Email"}),e.jsx(h,{id:"login-email","aria-label":"Email",placeholder:"Email",type:"email",...o.register("email"),onChange:s=>{o.register("email").onChange(s),a&&g(!1)},className:"text-center text-lg h-12 border-2 focus-visible:ring-primary",autoFocus:!0}),o.formState.errors.email&&e.jsx("p",{className:"text-xs text-destructive text-center",children:o.formState.errors.email.message}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Saisissez votre email et votre mot de passe."}),e.jsx(c,{htmlFor:"login-password",className:"sr-only",children:"Mot de passe"}),e.jsx(h,{id:"login-password","aria-label":"Mot de passe",placeholder:"Mot de passe",type:"password",...o.register("password"),className:"text-center text-lg h-12 border-2 focus-visible:ring-primary"}),o.formState.errors.password&&e.jsx("p",{className:"text-xs text-destructive text-center",children:o.formState.errors.password.message}),t&&e.jsx("div",{className:"rounded-lg border border-destructive/20 bg-destructive/10 p-3 text-sm text-destructive text-center",children:t})]}),e.jsx(j,{type:"submit",className:"w-full h-12 text-lg font-bold uppercase tracking-wider shadow-md hover:scale-[1.02] transition-transform",disabled:o.formState.isSubmitting,children:o.formState.isSubmitting?"Connexion...":"CONNEXION"}),e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>{g(!0);const s=o.getValues("email").trim();r.setValue("email",s)},className:"text-xs text-muted-foreground underline underline-offset-4 transition-colors hover:text-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2",children:"Créer un compte"}),e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-primary underline",onClick:()=>{x(!0);const s=o.getValues("email").trim();n.setValue("email",s)},children:"Mot de passe oublié ?"})]})]})})]}),e.jsx(R,{open:a,onOpenChange:s=>{g(s),s||(r.reset(),m(!1))},children:e.jsx(A,{className:"sm:max-w-md",children:b?e.jsxs("div",{className:"text-center space-y-4 py-4",children:[e.jsx("div",{className:"mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-muted",children:e.jsx("span",{className:"text-3xl text-primary",children:"✓"})}),e.jsx("h2",{className:"text-xl font-semibold",children:"Compte créé avec succès !"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Un coach ou un administrateur doit valider votre inscription avant votre première connexion."}),e.jsx(j,{className:"w-full",variant:"outline",onClick:()=>{m(!1),g(!1)},children:"Retour à la connexion"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(L,{children:[e.jsx(T,{children:"Créer un compte"}),e.jsx(q,{children:"Complétez les informations pour créer votre profil."})]}),e.jsxs("form",{onSubmit:r.handleSubmit(K),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"register-name",children:"Nom d'affichage"}),e.jsx(h,{id:"register-name",...r.register("name"),placeholder:"Votre nom",ref:V}),r.formState.errors.name&&e.jsx("p",{className:"text-xs text-destructive",children:r.formState.errors.name.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"register-email",children:"Email"}),e.jsx(h,{id:"register-email",type:"email",...r.register("email"),placeholder:"prenom.nom@email.com"}),r.formState.errors.email&&e.jsx("p",{className:"text-xs text-destructive",children:r.formState.errors.email.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"register-birthdate",children:"Date de naissance"}),e.jsx(h,{id:"register-birthdate",type:"date",...r.register("birthdate")}),r.formState.errors.birthdate&&e.jsx("p",{className:"text-xs text-destructive",children:r.formState.errors.birthdate.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"register-sex",children:"Sexe"}),e.jsxs(z,{value:r.watch("sex"),onValueChange:s=>r.setValue("sex",s),children:[e.jsx(M,{id:"register-sex",children:e.jsx(P,{placeholder:"Sélectionnez"})}),e.jsxs(U,{children:[e.jsx(E,{value:"M",children:"Garçon"}),e.jsx(E,{value:"F",children:"Fille"})]})]}),r.formState.errors.sex&&e.jsx("p",{className:"text-xs text-destructive",children:r.formState.errors.sex.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"register-group",children:"Groupe"}),e.jsxs(z,{value:r.watch("groupId"),onValueChange:s=>r.setValue("groupId",s),disabled:k||f.length===0,children:[e.jsx(M,{id:"register-group",children:e.jsx(P,{placeholder:k?"Chargement...":H?"Erreur de chargement":"Sélectionnez un groupe"})}),e.jsx(U,{children:f.map(s=>e.jsx(E,{value:String(s.id),children:s.name},s.id))})]}),r.formState.errors.groupId&&e.jsx("p",{className:"text-xs text-destructive",children:r.formState.errors.groupId.message})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"register-password",children:"Mot de passe"}),e.jsx(h,{id:"register-password",type:"password",...r.register("password"),placeholder:"Choisissez un mot de passe"}),r.formState.errors.password&&e.jsx("p",{className:"text-xs text-destructive",children:r.formState.errors.password.message}),e.jsx(ce,{password:r.watch("password")})]}),r.formState.errors.root&&e.jsx("p",{className:"text-sm text-destructive",children:r.formState.errors.root.message}),e.jsx(j,{type:"submit",className:"w-full",disabled:r.formState.isSubmitting,children:r.formState.isSubmitting?"Création...":"Créer le compte"})]})]})})}),e.jsx(R,{open:w,onOpenChange:s=>{x(s),s||(n.reset(),N(!1))},children:e.jsx(A,{className:"sm:max-w-md",children:G?e.jsxs("div",{className:"text-center space-y-4 py-4",children:[e.jsx("div",{className:"mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-muted",children:e.jsx("span",{className:"text-3xl text-primary",children:"✉"})}),e.jsx("h2",{className:"text-xl font-semibold",children:"Email envoyé"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Un email de réinitialisation a été envoyé. Vérifiez votre boîte de réception."}),e.jsx(j,{className:"w-full",variant:"outline",onClick:()=>{x(!1),N(!1)},children:"Retour à la connexion"})]}):e.jsxs(e.Fragment,{children:[e.jsxs(L,{children:[e.jsx(T,{children:"Réinitialiser le mot de passe"}),e.jsx(q,{children:"Entrez votre adresse email pour recevoir un lien de réinitialisation."})]}),e.jsxs("form",{onSubmit:n.handleSubmit(Q),className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(c,{htmlFor:"reset-email",children:"Email"}),e.jsx(h,{id:"reset-email",type:"email",...n.register("email"),placeholder:"votre@email.com",autoFocus:!0}),n.formState.errors.email&&e.jsx("p",{className:"text-xs text-destructive",children:n.formState.errors.email.message})]}),n.formState.errors.root&&e.jsx("div",{className:"rounded-lg border border-destructive/20 bg-destructive/10 p-3 text-sm text-destructive text-center",children:n.formState.errors.root.message}),e.jsx(j,{type:"submit",className:"w-full",disabled:n.formState.isSubmitting,children:n.formState.isSubmitting?"Envoi...":"Envoyer le lien"}),e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{type:"button",className:"text-xs text-muted-foreground hover:text-primary underline",onClick:()=>x(!1),children:"Retour à la connexion"})})]})]})})}),e.jsx("div",{className:"absolute bottom-4 text-xs text-muted-foreground opacity-50 uppercase font-bold tracking-widest",children:"EAC Performance Tracking"})]})}export{Ve as default};
