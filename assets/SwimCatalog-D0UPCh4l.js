import{j as e,R as U,r as v}from"./vendor-ui-DJQMR4VV.js";import{b as Ee,u as W,c as X}from"./vendor-query-BT4y-huw.js";import{c as L,C as E,S as N,a as g,I as D,B as C,f as $e,u as Le,d as $}from"./index-DEbtO7mD.js";import{D as je,a as ge}from"./dialog--8wTSXVb.js";import{P as Be,A as K,a as Q,b as J,c as G,d as H,e as Y,f as Z,g as ee}from"./alert-dialog-Bn12JZyD.js";import{R as ze,L as Pe,c as ye,i as ve,g as Fe,b as Oe,a as Ne}from"./SwimSessionConsultation-CXT6RUjs.js";import{C as z}from"./circle-alert-BJhKOhot.js";import{T as Ie}from"./timer-B0rkFcA7.js";import{T,P as q}from"./trash-2-DT6l_RIt.js";import{T as Re}from"./textarea-C_k3ugiN.js";import{S as te,a as se,b as ne,c as ie,d as re}from"./select-CIA5Ao1g.js";import{F as Ue,G as We}from"./FormActions-BQCd4oFr.js";import{f as Xe}from"./vendor-date-cQbdWov0.js";import{S as Ke}from"./search-CsIxO5Ce.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-Db4xOvcx.js";import"./vendor-supabase-D7B1G6YZ.js";import"./badge-nM1BMyW6.js";import"./chevron-up-CVqo8Jbl.js";import"./check-CU62I3Qf.js";import"./chevron-left-Cu-VlNBU.js";import"./save-C4QMocUH.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Qe=[["rect",{width:"20",height:"5",x:"2",y:"3",rx:"1",key:"1wp1u1"}],["path",{d:"M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8",key:"1s80jp"}],["path",{d:"M10 12h4",key:"a56b0p"}]],Je=L("archive",Qe);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ge=[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]],le=L("arrow-down",Ge);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const He=[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]],ae=L("arrow-up",He);/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ye=[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}],["path",{d:"m15 5 4 4",key:"1mk7zo"}]],Ze=L("pencil",Ye),et=(t=[])=>new Set(t.map(r=>{const i=r.raw_payload;return i?.block_title||i?.section||"Bloc"})).size,tt=t=>{const n=ye(t.items??[]),i=t.items?.some(u=>u.duration!=null)??!1?t.items?.reduce((u,l)=>u+(l.duration??0),0)??0:null,s=et(t.items??[]);return{totalDistance:n,totalDuration:i,blockCount:s}};function oe({sessions:t,isLoading:n,error:r,onPreview:i,onEdit:s,onArchive:u,onDelete:l,canDelete:m,isDeleting:p,assignments:j}){return n?e.jsx("div",{className:"space-y-3",children:Array.from({length:4}).map((h,y)=>e.jsx(E,{className:"rounded-2xl border-border",children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(N,{className:"h-5 w-3/4 mb-2"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-4 w-16"}),e.jsx(N,{className:"h-4 w-16"}),e.jsx(N,{className:"h-4 w-12"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(N,{className:"h-9 w-9 rounded-full"}),e.jsx(N,{className:"h-9 w-9 rounded-full"}),e.jsx(N,{className:"h-9 w-9 rounded-full"}),e.jsx(N,{className:"h-9 w-9 rounded-full"})]})]})})},`skeleton-${y}`))}):r?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(z,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:r instanceof Error?r.message:"Une erreur s'est produite"})]}):t.length===0?e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-muted px-3 py-6 text-center text-sm text-muted-foreground",children:"Aucune séance trouvée. Crée une nouvelle séance pour commencer."}):e.jsx("div",{className:"space-y-3",children:t.map(h=>{const{totalDistance:y,totalDuration:b,blockCount:_}=tt(h),w=m(h.id),k=!w||p;return e.jsx(E,{className:"rounded-2xl border-border",children:e.jsx("div",{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold tracking-tight",children:h.name}),e.jsxs("div",{className:"mt-1 flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(ze,{className:"h-3.5 w-3.5"}),y,"m"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Ie,{className:"h-3.5 w-3.5"}),"~",b??"—"," min"]}),e.jsxs("span",{className:"inline-flex items-center gap-1",children:[e.jsx(Pe,{className:"h-3.5 w-3.5"}),_]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:()=>i(h),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Aperçu nageur",title:"Aperçu nageur",children:e.jsx(Be,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>s(h),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Modifier",title:"Modifier",children:e.jsx(Ze,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>u(h),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted","aria-label":"Archiver",title:"Archiver",children:e.jsx(Je,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>{k||l(h)},className:g("inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted",k&&"cursor-not-allowed text-muted-foreground"),"aria-label":"Supprimer",title:j===null?"Suppression désactivée":w?"Supprimer":"Séance déjà assignée",children:e.jsx(T,{className:"h-4 w-4"})})]})]})})},h.id)})})}const ce=["V0","V1","V2","V3","Max"],st={V0:"bg-intensity-1",V1:"bg-intensity-2",V2:"bg-intensity-3",V3:"bg-intensity-4",Max:"bg-intensity-5"},de={souple:"V0",facile:"V0",relache:"V0",relâché:"V0"},nt=t=>{if(!t)return"V0";const n=t.trim();if(!n)return"V0";const r=n.toLowerCase();if(de[r])return de[r];const i=n.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const s=i.replace("V","V");return s==="V4"||s==="V5"?"Max":s}return n};function it({value:t,onChange:n,className:r,ariaLabel:i="Sélection d'intensité"}){const s=nt(t),u=ce.includes(s)?s:"Max";return e.jsx("div",{role:"radiogroup","aria-label":i,className:g("flex flex-wrap items-center gap-2",r),children:ce.map(l=>{const m=u===l;return e.jsxs("button",{type:"button",role:"radio","aria-checked":m,"aria-label":`Intensité ${l==="Max"?"MAX":l}`,onClick:()=>n(l),className:g("flex flex-col items-center gap-1 rounded-full px-2 py-1 text-[10px] font-semibold text-muted-foreground transition","focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary",m?"text-foreground":"hover:text-foreground"),children:[e.jsx("span",{className:g("h-3 w-3 rounded-full",m?st[l]??"bg-primary":"bg-muted")}),e.jsx("span",{children:l==="Max"?"MAX":l})]},l)})})}const rt=[{value:"palmes",label:"Palmes"},{value:"tuba",label:"Tuba"},{value:"plaquettes",label:"Plaquettes"},{value:"pull",label:"Pull"},{value:"elastique",label:"Élastique"}],lt=[{value:"pap",label:"Papillon"},{value:"dos",label:"Dos"},{value:"brasse",label:"Brasse"},{value:"crawl",label:"Crawl"},{value:"4n",label:"4 nages"},{value:"spe",label:"Spé"}],at=[{value:"nc",label:"NC"},{value:"educ",label:"Educ"},{value:"jambes",label:"Jambes"}],ue={souple:"V0",facile:"V0",relache:"V0",relâché:"V0"},ot=["V0","V1","V2","V3","Max"],ct=t=>{if(!t)return"V0";const n=t.trim();if(!n)return"V0";const r=n.toLowerCase();if(ue[r])return ue[r];const i=n.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const s=Number.parseInt(i.slice(1),10);if(Number.isFinite(s)&&s>=4)return"Max";if(ot.includes(i))return i}return n},dt=t=>t==="Max"?"MAX":t,ut={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5"},mt={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30"};function xt({exercise:t,onChange:n,onDelete:r,showDelete:i=!0}){const s=ct(t.intensity),u=t.modalities??"";return e.jsx("div",{className:"rounded-2xl border border-border bg-card p-3",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"grid flex-1 grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Répétitions"}),e.jsx("div",{className:"mt-1",children:e.jsx(D,{type:"number",min:1,value:t.repetitions??"",onChange:l=>n("repetitions",l.target.value===""?null:Number(l.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Distance (m)"}),e.jsx("div",{className:"mt-1",children:e.jsx(D,{type:"number",min:0,value:t.distance??"",onChange:l=>n("distance",l.target.value===""?null:Number(l.target.value)),className:"rounded-2xl"})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Nage"}),e.jsx("div",{className:"mt-1",children:e.jsxs(te,{value:t.stroke,onValueChange:l=>n("stroke",l),children:[e.jsx(se,{className:"rounded-2xl",children:e.jsx(ne,{})}),e.jsx(ie,{children:lt.map(l=>e.jsx(re,{value:l.value,children:l.label},l.value))})]})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Type"}),e.jsx("div",{className:"mt-1",children:e.jsxs(te,{value:t.strokeType,onValueChange:l=>n("strokeType",l),children:[e.jsx(se,{className:"rounded-2xl",children:e.jsx(ne,{})}),e.jsx(ie,{children:at.map(l=>e.jsx(re,{value:l.value,children:l.label},l.value))})]})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Intensité (clic sur points)"}),e.jsxs("span",{className:g("inline-flex items-center gap-2 rounded-full bg-card px-2.5 py-1 text-xs font-semibold ring-1",mt[s],ut[s]),children:[e.jsx("span",{className:g("h-2 w-2 rounded-full",ve[s]??"bg-muted")}),dt(s)]})]}),e.jsx("div",{className:"mt-2 flex items-center justify-between gap-2",children:e.jsx(it,{value:t.intensity,onChange:l=>n("intensity",l)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Équipements"}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:rt.map(l=>{const m=t.equipment.includes(l.value),p=Fe(l.value);return e.jsxs("button",{type:"button",onClick:()=>{const j=m?t.equipment.filter(h=>h!==l.value):[...t.equipment,l.value];n("equipment",j)},className:g("inline-flex items-center gap-2 rounded-full border px-3 py-2 text-xs font-semibold",m?"border-primary bg-primary text-primary-foreground":"border-border bg-card text-muted-foreground hover:bg-muted"),children:[e.jsx("span",{className:g("inline-flex h-7 w-7 items-center justify-center rounded-full",m?"bg-white/10":"bg-muted"),children:p?e.jsx("img",{src:p,alt:"",className:"h-4 w-4","aria-hidden":"true",loading:"lazy"}):null}),l.label]},l.value)})})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-[11px] font-semibold text-muted-foreground",children:"Modalités"}),e.jsx("div",{className:"mt-1",children:e.jsx(Re,{value:u,onChange:l=>n("modalities",l.target.value),placeholder:"Une modalité par ligne",rows:3,className:"rounded-2xl"})})]})]}),i&&r&&e.jsx("button",{type:"button",onClick:r,className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer exercice",title:"Supprimer exercice",children:e.jsx(T,{className:"h-4 w-4"})})]})})}function pt({name:t,onNameChange:n,estimatedDuration:r,onEstimatedDurationChange:i,totalDistance:s,showDuration:u=!0,showTotalDistance:l=!0,additionalFields:m}){return e.jsx(E,{className:"rounded-2xl border-border",children:e.jsxs("div",{className:"space-y-3 p-4",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Infos séance"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"col-span-2",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Nom"}),e.jsx("div",{className:"mt-1",children:e.jsx(D,{value:t,onChange:p=>n(p.target.value),placeholder:"Nom de la séance",className:"rounded-2xl"})})]}),u&&i&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Durée estimée (min)"}),e.jsx("div",{className:"mt-1",children:e.jsx(D,{type:"number",min:0,value:r||"",onChange:p=>i(p.target.value===""?0:Number(p.target.value)),placeholder:"55",className:"rounded-2xl"})})]}),l&&s!==void 0&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Distance totale"}),e.jsxs("div",{className:"mt-1 rounded-2xl border border-border bg-muted px-3 py-2 text-sm font-semibold",children:[s,"m"]})]}),m]})]})})}const ht={nc:"NC",educ:"Educ",jambes:"Jambes"},ft={nc:"bg-sky-100 text-sky-900 ring-sky-200",educ:"bg-violet-100 text-violet-900 ring-violet-200",jambes:"bg-teal-100 text-teal-900 ring-teal-200"},bt={V0:"text-intensity-1",V1:"text-intensity-2",V2:"text-intensity-3",V3:"text-intensity-4",Max:"text-intensity-5"},jt={V0:"ring-intensity-1/30",V1:"ring-intensity-2/30",V2:"ring-intensity-3/30",V3:"ring-intensity-4/30",Max:"ring-intensity-5/30"},me={souple:"V0",facile:"V0",relache:"V0",relâché:"V0"},gt=["V0","V1","V2","V3","Max"],P=t=>{if(!t)return"V0";const n=t.trim();if(!n)return"V0";const r=n.toLowerCase();if(me[r])return me[r];const i=n.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const s=Number.parseInt(i.slice(1),10);if(Number.isFinite(s)&&s>=4)return"Max";if(gt.includes(i))return i}return n},yt=t=>t==="Max"?"MAX":t,vt=t=>t?t.length>48?`${t.slice(0,45).trim()}…`:t:"",xe=t=>{let n=0;return t.flatMap((r,i)=>r.exercises.map((s,u)=>{const l={block_title:r.title,block_description:r.description||null,block_order:i,block_repetitions:r.repetitions??null,block_modalities:r.modalities||null,block_equipment:r.equipment??[],exercise_repetitions:s.repetitions??null,exercise_rest:s.rest??null,exercise_stroke:s.stroke||null,exercise_stroke_type:s.strokeType||null,exercise_intensity:s.intensity?P(s.intensity):null,exercise_modalities:s.modalities||null,exercise_equipment:s.equipment??[],exercise_order:u},m=s.repetitions&&s.distance?`${s.repetitions}x${s.distance}m`:s.distance?`${s.distance}m`:null;return{ordre:n++,label:m,distance:s.distance??null,duration:null,intensity:s.intensity?P(s.intensity):null,notes:s.modalities||null,raw_payload:l}}))};function Nt({session:t,onSessionChange:n,onSave:r,onCancel:i,userId:s,isSaving:u}){const[l,m]=U.useState("compact"),[p,j]=U.useState(null),h=v.useMemo(()=>ye(xe(t.blocks)),[t.blocks]),y=()=>{n({...t,blocks:[...t.blocks,{title:"Nouveau bloc",repetitions:1,description:"",modalities:"",equipment:[],exercises:[{repetitions:4,distance:50,rest:null,stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}]}]})},b=(a,o,c)=>{const x=[...t.blocks];x[a]={...x[a],[o]:c},n({...t,blocks:x})},_=a=>{const o=t.blocks.filter((c,x)=>x!==a);n({...t,blocks:o})},w=(a,o)=>{const c=o==="up"?a-1:a+1;if(c<0||c>=t.blocks.length)return;const x=[...t.blocks],[f]=x.splice(a,1);x.splice(c,0,f),n({...t,blocks:x})},k=a=>{const o=[...t.blocks];o[a].exercises.push({repetitions:4,distance:50,rest:null,stroke:"crawl",strokeType:"nc",intensity:"V2",modalities:"",equipment:[]}),n({...t,blocks:o})},M=(a,o,c,x)=>{const f=[...t.blocks],S=[...f[a].exercises];S[o]={...S[o],[c]:x},f[a]={...f[a],exercises:S},n({...t,blocks:f})},V=(a,o)=>{const c=[...t.blocks];c[a].exercises=c[a].exercises.filter((x,f)=>f!==o),n({...t,blocks:c})};return e.jsxs("div",{className:"animate-in slide-in-from-bottom-4 motion-reduce:animate-none",children:[e.jsx(Ue,{isEditing:!!t.id,isSaving:u,onSave:r,onCancel:i,onPreview:()=>j({id:t.id??Date.now(),name:t.name,description:t.description,created_by:s??null,items:xe(t.blocks)})}),e.jsxs("div",{className:"space-y-4 p-4",children:[e.jsx(pt,{name:t.name,onNameChange:a=>n({...t,name:a}),estimatedDuration:t.estimatedDuration,onEstimatedDurationChange:a=>n({...t,estimatedDuration:a}),totalDistance:h,showDuration:!0,showTotalDistance:!0}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Vue coach"}),e.jsxs("div",{className:"inline-flex rounded-full border border-border bg-card p-1 text-xs font-semibold",children:[e.jsx("button",{type:"button",onClick:()=>m("compact"),className:g("rounded-full px-3 py-1",l==="compact"?"bg-primary text-primary-foreground":"text-muted-foreground"),children:"Condensé"}),e.jsx("button",{type:"button",onClick:()=>m("detailed"),className:g("rounded-full px-3 py-1",l==="detailed"?"bg-primary text-primary-foreground":"text-muted-foreground"),children:"Détail"})]})]}),l==="compact"?e.jsx(E,{className:"rounded-2xl border-border",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-semibold",children:"Plan (ultra compact)"}),e.jsx("div",{className:"mt-1 text-xs text-muted-foreground",children:'Manipule les blocs vite. Passe en "Détail" pour éditer.'})]}),e.jsxs(C,{variant:"outline",size:"sm",onClick:y,className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(q,{className:"h-4 w-4"})," Bloc"]})]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[t.blocks.map((a,o)=>e.jsx("div",{className:"rounded-2xl border border-border bg-card px-3 py-2",children:e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-primary px-2 py-0.5 text-[11px] font-semibold text-primary-foreground",children:[e.jsx(Oe,{className:"inline h-3 w-3"})," ",a.repetitions??1,"x"]}),e.jsx("div",{className:"truncate text-xs font-semibold",children:a.title?a.title:`Bloc ${o+1}`}),e.jsxs("div",{className:"text-[11px] text-muted-foreground",children:["· ",a.exercises.length," ex"]})]}),e.jsxs("div",{className:"mt-1 flex flex-wrap gap-1",children:[a.exercises.slice(0,4).map((c,x)=>{const f=P(c.intensity),S=ht[c.strokeType]??c.strokeType;return e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-muted px-2 py-0.5 text-[11px] font-semibold text-muted-foreground",title:c.modalities?vt(c.modalities):"",children:[c.repetitions&&c.distance?`${c.repetitions}x`:"",c.distance?`${c.distance}m`:"—",e.jsx("span",{className:g("ml-1 inline-flex items-center rounded-full px-2 py-0.5 ring-1",ft[c.strokeType]??"bg-muted text-muted-foreground ring-border"),children:S}),e.jsxs("span",{className:g("ml-1 inline-flex items-center gap-1 rounded-full bg-card px-2 py-0.5 ring-1",jt[f],bt[f]),children:[e.jsx("span",{className:g("h-2 w-2 rounded-full",ve[f]??"bg-muted")}),yt(f)]})]},`${o}-${x}`)}),a.exercises.length>4?e.jsxs("span",{className:"text-[11px] text-muted-foreground",children:["+",a.exercises.length-4]}):null]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>w(o,"up"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Monter",title:"Monter",disabled:o===0,children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>w(o,"down"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Descendre",title:"Descendre",disabled:o===t.blocks.length-1,children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>_(o),className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer bloc",title:"Supprimer bloc",children:e.jsx(T,{className:"h-4 w-4"})})]})]})},o)),t.blocks.length?null:e.jsx("div",{className:"rounded-2xl border border-dashed border-border bg-muted px-3 py-6 text-center text-sm text-muted-foreground",children:"Aucun bloc. Ajoute un bloc pour commencer."})]})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-sm font-semibold",children:"Édition détaillée"}),e.jsxs(C,{variant:"outline",size:"sm",onClick:y,className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(q,{className:"h-4 w-4"})," Ajouter bloc"]})]}),e.jsx("div",{className:"space-y-4",children:t.blocks.map((a,o)=>e.jsx(E,{className:"rounded-2xl border-border",children:e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("span",{className:"mt-1 inline-flex h-9 w-9 items-center justify-center rounded-2xl bg-muted text-muted-foreground",children:e.jsx(We,{className:"h-4 w-4"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Titre bloc"}),e.jsx(D,{value:a.title,onChange:c=>b(o,"title",c.target.value),placeholder:`Bloc ${o+1}`,className:"rounded-2xl"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("button",{type:"button",onClick:()=>w(o,"up"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Monter",title:"Monter",disabled:o===0,children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>w(o,"down"),className:"inline-flex h-9 w-9 items-center justify-center rounded-full hover:bg-muted disabled:opacity-40","aria-label":"Descendre",title:"Descendre",disabled:o===t.blocks.length-1,children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>_(o),className:"inline-flex h-9 w-9 items-center justify-center rounded-full text-destructive hover:bg-destructive/10","aria-label":"Supprimer bloc",title:"Supprimer bloc",children:e.jsx(T,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"mt-3 grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground",children:"Répétitions du bloc"}),e.jsx("div",{className:"mt-1",children:e.jsx(D,{type:"number",min:1,value:a.repetitions??"",onChange:c=>b(o,"repetitions",c.target.value===""?null:Number(c.target.value)),placeholder:"1",className:"rounded-2xl"})})]}),e.jsx("div",{className:"flex items-end justify-end",children:e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>k(o),className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(q,{className:"h-4 w-4"})," Exercice"]})})]}),e.jsx("div",{className:"mt-4 space-y-3",children:a.exercises.map((c,x)=>e.jsx(xt,{exercise:c,onChange:(f,S)=>M(o,x,f,S),onDelete:()=>V(o,x),showDelete:!0},x))}),e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs(C,{variant:"outline",size:"sm",onClick:()=>k(o),className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(q,{className:"h-4 w-4"})," Ajouter exercice"]}),e.jsxs(C,{variant:"destructive",size:"sm",onClick:()=>_(o),className:"h-10 rounded-full px-3 text-xs",children:[e.jsx(T,{className:"h-4 w-4"})," Supprimer bloc"]})]})]})},o))})]}),e.jsx("div",{className:"h-8"})]}),e.jsx(je,{open:!!p,onOpenChange:a=>{a||j(null)},children:e.jsx(ge,{className:"max-w-4xl",children:e.jsx(Ne,{title:p?.name??"",description:p?.description??void 0,items:p?.items})})})]})}function wt(t){v.useEffect(()=>{if(!t)return;const n=r=>{r.preventDefault()};return window.addEventListener("beforeunload",n),()=>window.removeEventListener("beforeunload",n)},[t])}function pe(t){return`Séance du ${Xe(t,"dd/MM/yyyy")} - Soir - Matin`}const he=t=>{const n=t.trim().toLowerCase();return n&&(n.startsWith("plaquette")?"plaquettes":n.startsWith("palm")?"palmes":n.startsWith("tuba")?"tuba":n.startsWith("pull")?"pull":n.startsWith("elas")?"elastique":n)},fe={souple:"V0",facile:"V0",relache:"V0",relâché:"V0"},St=["V0","V1","V2","V3","Max"],F=t=>{if(!t)return"V0";const n=t.trim();if(!n)return"V0";const r=n.toLowerCase();if(fe[r])return fe[r];const i=n.toUpperCase();if(i==="MAX")return"Max";if(i.startsWith("V")){const s=Number.parseInt(i.slice(1),10);if(Number.isFinite(s)&&s>=4)return"Max";if(St.includes(i))return i}return n},Vt=t=>{let n=0;return t.flatMap((r,i)=>r.exercises.map((s,u)=>{const l={block_title:r.title,block_description:r.description||null,block_order:i,block_repetitions:r.repetitions??null,block_modalities:r.modalities||null,block_equipment:r.equipment??[],exercise_repetitions:s.repetitions??null,exercise_rest:s.rest??null,exercise_stroke:s.stroke||null,exercise_stroke_type:s.strokeType||null,exercise_intensity:s.intensity?F(s.intensity):null,exercise_modalities:s.modalities||null,exercise_equipment:s.equipment??[],exercise_order:u},m=s.repetitions&&s.distance?`${s.repetitions}x${s.distance}m`:s.distance?`${s.distance}m`:null;return{ordre:n++,label:m,distance:s.distance??null,duration:null,intensity:s.intensity?F(s.intensity):null,notes:s.modalities||null,raw_payload:l}}))},kt=(t=[])=>{const n=new Map;return t.forEach(r=>{const i=r.raw_payload??{},s=i.block_title||i.section||"Bloc",u=Number(i.block_order??0),l=`${u}-${s}`,m=i.block_equipment??i.equipment??[],p=(Array.isArray(m)?m:String(m).split(",")).map(b=>String(b)).map(b=>he(b)).filter(Boolean);n.has(l)||n.set(l,{title:s,repetitions:i.block_repetitions??null,description:i.block_description??"",modalities:i.block_modalities??i.modalities??"",equipment:p,exercises:[],order:Number.isFinite(u)?u:0,exerciseOrder:new Map});const j=n.get(l),h=Number(i.exercise_order??r.ordre??j.exercises.length),y=F(i.exercise_intensity??r.intensity??"V1");j.exerciseOrder.set(h,{repetitions:i.exercise_repetitions??null,distance:r.distance??null,rest:i.exercise_rest??null,stroke:i.exercise_stroke??i.stroke??"crawl",strokeType:i.exercise_stroke_type??i.stroke_type??"nc",intensity:y,modalities:i.exercise_modalities??r.notes??"",equipment:Array.isArray(i.exercise_equipment)?i.exercise_equipment.map(b=>he(b)):[]})}),Array.from(n.values()).sort((r,i)=>r.order-i.order).map(r=>({title:r.title,repetitions:r.repetitions,description:r.description,modalities:r.modalities,equipment:r.equipment,exercises:Array.from(r.exerciseOrder.entries()).sort(([i],[s])=>i-s).map(([,i])=>i)}))},be="swim_catalog_archived_ids",_t=(t,n)=>n===null?!1:!n.some(r=>r.session_type==="swim"&&r.session_id===t);function Ht(){const{toast:t}=$e(),n=Ee(),{userId:r,role:i}=Le(),[s,u]=v.useState(!1);wt(s);const[l,m]=v.useState(null),[p,j]=v.useState(null),[h,y]=v.useState(null),[b,_]=v.useState(""),[w,k]=v.useState(new Set),M=()=>({id:null,name:pe(new Date),description:"",estimatedDuration:0,blocks:[]}),[V,a]=v.useState(M),{data:o,isLoading:c,error:x,refetch:f}=W({queryKey:["swim_catalog"],queryFn:()=>$.getSwimCatalog()}),{data:S,isLoading:we,isError:Se,error:O,refetch:Ve}=W({queryKey:["coach-assignments"],queryFn:()=>$.getAssignmentsForCoach(),enabled:i==="coach"||i==="admin"});v.useEffect(()=>{if(typeof window>"u")return;const d=window.localStorage.getItem(be);if(d)try{const A=JSON.parse(d);Array.isArray(A)&&k(new Set(A.map(B=>Number(B)).filter(B=>Number.isFinite(B))))}catch{return}},[]),v.useEffect(()=>{typeof window>"u"||window.localStorage.setItem(be,JSON.stringify(Array.from(w.values())))},[w]);const ke=v.useMemo(()=>{const d=b.trim().toLowerCase();return d?(o??[]).filter(A=>A.name.toLowerCase().includes(d)):o??[]},[o,b]).filter(d=>!w.has(d.id)),I=X({mutationFn:d=>$.createSwimSession(d),onSuccess:(d,A)=>{n.invalidateQueries({queryKey:["swim_catalog"]}),u(!1),a(M()),t({title:A?.id?"Séance natation mise à jour":"Séance natation créée"})}}),R=X({mutationFn:d=>$.deleteSwimSession(d),onSuccess:()=>{n.invalidateQueries({queryKey:["swim_catalog"]}),j(null),t({title:"Séance supprimée"})},onError:()=>{t({title:"Suppression impossible",description:"Cette séance est utilisée dans une assignation.",variant:"destructive"})}}),_e=()=>{if(!V.name.trim()){t({title:"Titre requis",description:"Ajoutez un nom de séance avant d'enregistrer.",variant:"destructive"});return}I.mutate({id:V.id??void 0,name:V.name,description:V.description,estimated_duration:V.estimatedDuration||null,items:Vt(V.blocks),created_by:r??null})},Ce=()=>{u(!1),a(M())},Me=d=>{a({id:d.id??null,name:d.name??pe(new Date),description:d.description??"",estimatedDuration:Number(d.estimated_duration??0),blocks:kt(d.items??[])}),u(!0)},Ae=d=>{y(d)},De=()=>{h&&(k(d=>new Set([...Array.from(d),h.id])),y(null),t({title:"Séance archivée"}))},qe=d=>{j(d)},Te=()=>{p&&R.mutate(p.id)};return s?e.jsx(Nt,{session:V,onSessionChange:a,onSave:_e,onCancel:Ce,userId:r,isSaving:I.isPending}):c||we?e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx(N,{className:"h-5 w-16 mb-1"}),e.jsx(N,{className:"h-3 w-20"})]}),e.jsx(N,{className:"h-9 w-24 rounded-full"})]}),e.jsxs("div",{className:"p-4",children:[e.jsx(N,{className:"h-10 w-full rounded-2xl mb-4"}),e.jsx(oe,{sessions:[],isLoading:!0,onPreview:()=>{},onEdit:()=>{},onArchive:()=>{},onDelete:()=>{},canDelete:()=>!1})]})]}):x?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(z,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:x instanceof Error?x.message:"Une erreur s'est produite"}),e.jsx(C,{variant:"default",onClick:()=>f(),className:"mt-4 h-12 md:h-10",children:"Réessayer"})]}):e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-base font-semibold",children:"Coach"}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Création"})]}),e.jsxs("button",{type:"button",onClick:()=>{a(M()),u(!0)},className:"inline-flex items-center gap-2 rounded-full bg-primary px-3 py-2 text-xs font-semibold text-primary-foreground",children:[e.jsx(q,{className:"h-4 w-4"})," Nouvelle"]})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center gap-2 rounded-2xl border border-border bg-card px-3 py-2",children:[e.jsx(Ke,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("input",{className:"w-full bg-transparent text-sm outline-none placeholder:text-muted-foreground",placeholder:"Rechercher une séance",value:b,onChange:d=>_(d.target.value)})]}),Se&&e.jsxs("div",{className:"mt-4 flex flex-col items-center rounded-lg border border-destructive/20 bg-destructive/10 p-4",children:[e.jsx(z,{className:"h-8 w-8 text-destructive mb-2"}),e.jsx("p",{className:"text-sm text-destructive font-semibold",children:"Impossible de charger les assignations"}),e.jsx("p",{className:"text-xs text-destructive/80 mt-1",children:O instanceof Error?O.message:"Une erreur s'est produite"}),e.jsx(C,{variant:"outline",size:"sm",onClick:()=>Ve(),className:"mt-2 h-10",children:"Réessayer"})]}),e.jsx("div",{className:"mt-4",children:e.jsx(oe,{sessions:ke,isLoading:c,error:x,onPreview:m,onEdit:Me,onArchive:Ae,onDelete:qe,canDelete:d=>_t(d,S??null),isDeleting:R.isPending,assignments:S})}),e.jsx("div",{className:"h-8"})]}),e.jsx(je,{open:!!l,onOpenChange:d=>{d||m(null)},children:e.jsx(ge,{className:"max-w-4xl",children:e.jsx(Ne,{title:l?.name??"",description:l?.description??void 0,items:l?.items})})}),e.jsx(K,{open:!!h,onOpenChange:d=>{d||y(null)},children:e.jsxs(Q,{children:[e.jsxs(J,{children:[e.jsx(G,{children:"Archiver la séance ?"}),e.jsx(H,{children:"La séance sera masquée du catalogue (sans suppression)."})]}),e.jsxs(Y,{children:[e.jsx(Z,{children:"Annuler"}),e.jsx(ee,{onClick:De,children:"Archiver"})]})]})}),e.jsx(K,{open:!!p,onOpenChange:d=>{d||j(null)},children:e.jsxs(Q,{children:[e.jsxs(J,{children:[e.jsx(G,{children:"Supprimer la séance ?"}),e.jsx(H,{children:"Cette action est définitive. La séance sera supprimée du catalogue."})]}),e.jsxs(Y,{children:[e.jsx(Z,{children:"Annuler"}),e.jsx(ee,{onClick:Te,children:"Supprimer"})]})]})})]})}export{_t as canDeleteSwimCatalog,Ht as default};
