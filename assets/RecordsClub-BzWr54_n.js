import{r as x,j as e}from"./vendor-ui-C9ymspZo.js";import{u as R}from"./vendor-query-kM2vrB_e.js";import{T as I,k as _,B as q,g as F}from"./index-BJidZWdX.js";import{B as P}from"./badge-BOGU1Mgc.js";import{T as V,a as O,b as T,c as y,d as G,e as h}from"./table-Dp5f6la2.js";import{T as H,a as U,b as z}from"./tabs-Cqd1KPXz.js";import{a as J,C as Q}from"./chevron-up-WA80GE6h.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-charts-DSuxWnoS.js";import"./vendor-supabase-B2MyMyC0.js";const X=[{key:"25",label:"25 m"},{key:"50",label:"50 m"}],W=[{key:"M",label:"G"},{key:"F",label:"F"}],Z=[{key:"8",label:"8-"},{key:"9",label:"9"},{key:"10",label:"10"},{key:"11",label:"11"},{key:"12",label:"12"},{key:"13",label:"13"},{key:"14",label:"14"},{key:"15",label:"15"},{key:"16",label:"16"},{key:"17",label:"17+"}],ee=[{key:"ALL",label:"Toutes"},{key:"FREE",label:"NL"},{key:"BACK",label:"Dos"},{key:"BREAST",label:"Brasse"},{key:"FLY",label:"Pap"},{key:"IM",label:"4N"}],C=[{id:"50_FREE",label:"50 NL",stroke:"FREE"},{id:"100_FREE",label:"100 NL",stroke:"FREE"},{id:"200_FREE",label:"200 NL",stroke:"FREE"},{id:"400_FREE",label:"400 NL",stroke:"FREE"},{id:"800_FREE",label:"800 NL",stroke:"FREE"},{id:"1500_FREE",label:"1500 NL",stroke:"FREE"},{id:"50_BACK",label:"50 Dos",stroke:"BACK"},{id:"100_BACK",label:"100 Dos",stroke:"BACK"},{id:"200_BACK",label:"200 Dos",stroke:"BACK"},{id:"50_BREAST",label:"50 Br",stroke:"BREAST"},{id:"100_BREAST",label:"100 Br",stroke:"BREAST"},{id:"200_BREAST",label:"200 Br",stroke:"BREAST"},{id:"50_FLY",label:"50 Pap",stroke:"FLY"},{id:"100_FLY",label:"100 Pap",stroke:"FLY"},{id:"200_FLY",label:"200 Pap",stroke:"FLY"},{id:"100_IM",label:"100 4N",stroke:"IM"},{id:"200_IM",label:"200 4N",stroke:"IM"},{id:"400_IM",label:"400 4N",stroke:"IM"}],$=s=>{if(!s&&s!==0)return"-";const r=Math.round(s/10),o=r%100,p=Math.floor(r/100),d=p%60,u=Math.floor(p/60),n=b=>String(b).padStart(2,"0");return u>0?`${u}:${n(d)}.${n(o)}`:`${d}.${n(o)}`},D=s=>{if(!s)return"-";const r=new Date(s);return Number.isNaN(r.getTime())?s:r.toLocaleDateString("fr-FR")},te=s=>{if(!s)return null;const r=new Date(s);return Number.isNaN(r.getTime())?null:r.toLocaleDateString("fr-FR")+" à "+r.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})},se=s=>s.replace(/^\d+_/,"");function pe(){const[s,r]=x.useState("25"),[o,p]=x.useState("M"),[d,u]=x.useState("ALL"),[n,b]=x.useState("ALL"),[i,g]=x.useState(null),a=d==="ALL"?null:Number(d),{data:m}=R({queryKey:["last-import"],queryFn:()=>F.getImportLogs({limit:1})}),{data:f=[],isLoading:N,error:v,refetch:Y}=R({queryKey:["club-records",s,o,d],queryFn:()=>F.getClubRecords({pool_m:Number(s),sex:o,age:a})}),{data:S,isFetching:w}=R({queryKey:["club-ranking",i],queryFn:()=>{if(!i)return[];const[t,l,c,k]=i.split("__");return F.getClubRanking({event_code:t,pool_m:Number(l),sex:c,age:k==="ALL"?null:Number(k)})},enabled:!!i}),E=x.useMemo(()=>new Map(C.map(t=>[t.id,t.label])),[]),L=x.useMemo(()=>new Map(C.map((t,l)=>[t.id,l])),[]),j=x.useMemo(()=>[...n==="ALL"?f:f.filter(l=>se(l.event_code)===n)].sort((l,c)=>{const k=L.get(l.event_code)??999,M=L.get(c.event_code)??999;return k!==M?k-M:l.age!==c.age?l.age-c.age:l.time_ms-c.time_ms}),[f,n,L]),A=x.useMemo(()=>{if(a!==null)return null;const t=new Map;for(const l of j){const c=t.get(l.event_code)??[];c.push(l),t.set(l.event_code,c)}return t},[j,a]),B=t=>{const l=`${t.event_code}__${s}__${o}__${t.age}`;g(c=>c===l?null:l)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-6 w-6 text-primary"}),e.jsx("h1",{className:"text-2xl font-display font-bold uppercase italic text-primary",children:"Records du club"})]}),m&&m.length>0&&m[0].status==="success"&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["MAJ :"," ",te(m[0].completed_at??m[0].started_at)??"-"]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx("div",{className:"inline-flex rounded-lg border bg-muted p-0.5",children:X.map(t=>e.jsx("button",{onClick:()=>r(t.key),className:_("rounded-md px-3 py-1 text-sm font-medium transition-colors",s===t.key?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:t.label},t.key))}),e.jsx("div",{className:"inline-flex rounded-lg border bg-muted p-0.5",children:W.map(t=>e.jsx("button",{onClick:()=>p(t.key),className:_("rounded-md px-3 py-1 text-sm font-medium transition-colors",o===t.key?"bg-background text-foreground shadow-sm":"text-muted-foreground hover:text-foreground"),children:t.label},t.key))}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[e.jsx("button",{onClick:()=>u("ALL"),className:_("rounded-full px-2.5 py-0.5 text-xs font-medium transition-colors",d==="ALL"?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-muted/80"),children:"Tous"}),Z.map(t=>e.jsx("button",{onClick:()=>u(t.key),className:_("rounded-full px-2.5 py-0.5 text-xs font-medium transition-colors",d===t.key?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground hover:bg-muted/80"),children:t.label},t.key))]})]}),e.jsx(H,{value:n,onValueChange:b,children:e.jsx(U,{className:"flex w-full justify-start gap-1 overflow-x-auto",children:ee.map(t=>e.jsx(z,{value:t.key,className:"shrink-0 text-xs",children:t.label},t.key))})}),N&&e.jsx("div",{className:"space-y-2",children:[1,2,3,4,5].map(t=>e.jsx("div",{className:"h-10 w-full rounded bg-muted animate-pulse motion-reduce:animate-none"},t))}),v&&e.jsxs("div",{className:"rounded-lg border border-destructive/20 bg-destructive/10 p-4 text-sm text-destructive",children:[e.jsx("p",{children:"Impossible de charger les records."}),e.jsx(q,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>Y(),children:"Réessayer"})]}),!N&&!v&&j.length===0&&e.jsx("p",{className:"py-8 text-center text-sm text-muted-foreground",children:"Aucun record pour ces filtres."}),!N&&!v&&j.length>0&&e.jsx(e.Fragment,{children:a!==null?e.jsx(K,{records:j,eventMap:E,expandedKey:i,onToggle:B,pool:s,sex:o,rankingData:S,rankingLoading:w,showAge:!1}):e.jsx("div",{className:"space-y-6",children:A&&[...A.entries()].map(([t,l])=>{const c=l[0]?.event_label||E.get(t)||t;return e.jsxs("div",{children:[e.jsx("h3",{className:"mb-1.5 text-sm font-semibold text-foreground",children:c}),e.jsx(K,{records:l,eventMap:E,expandedKey:i,onToggle:B,pool:s,sex:o,rankingData:S,rankingLoading:w,showAge:!0,hideEventColumn:!0})]},t)})})})]})}function K({records:s,eventMap:r,expandedKey:o,onToggle:p,pool:d,sex:u,rankingData:n,rankingLoading:b,showAge:i,hideEventColumn:g}){return e.jsx("div",{className:"rounded-lg border",children:e.jsxs(V,{children:[e.jsx(O,{children:e.jsxs(T,{className:"hover:bg-transparent",children:[!g&&e.jsx(y,{className:"w-[110px]",children:"Épreuve"}),e.jsx(y,{className:"w-[85px]",children:"Temps"}),e.jsx(y,{children:"Détenteur"}),i&&e.jsx(y,{className:"w-[50px]",children:"Âge"}),e.jsx(y,{className:"hidden w-[85px] sm:table-cell",children:"Date"}),e.jsx(y,{className:"w-[32px]"})]})}),e.jsx(G,{children:s.map(a=>{const m=`${a.event_code}__${d}__${u}__${a.age}`,f=o===m,N=a.event_label||r.get(a.event_code)||a.event_code;return e.jsx(ae,{record:a,label:N,isExpanded:f,onToggle:p,rankingData:f?n:void 0,rankingLoading:b,showAge:i,hideEventColumn:g},`${a.event_code}-${a.age}`)})})]})})}function ae({record:s,label:r,isExpanded:o,onToggle:p,rankingData:d,rankingLoading:u,showAge:n,hideEventColumn:b}){const i=(b?0:1)+3+(n?1:0)+1,g=s.age===8?"≤8":s.age===17?"≥17":String(s.age);return e.jsxs(e.Fragment,{children:[e.jsxs(T,{className:"cursor-pointer",onClick:()=>p(s),children:[!b&&e.jsx(h,{className:"font-medium text-xs",children:r}),e.jsx(h,{className:"font-mono text-primary font-semibold tabular-nums text-sm",children:$(s.time_ms)}),e.jsx(h,{className:"text-sm",children:s.athlete_name}),n&&e.jsx(h,{children:e.jsx(P,{variant:"outline",className:"text-[10px] px-1.5 py-0",children:g})}),e.jsx(h,{className:"hidden text-xs text-muted-foreground sm:table-cell",children:D(s.record_date)}),e.jsx(h,{className:"px-1",children:o?e.jsx(J,{className:"h-4 w-4 text-muted-foreground"}):e.jsx(Q,{className:"h-4 w-4 text-muted-foreground"})})]}),o&&e.jsx(T,{className:"hover:bg-transparent",children:e.jsx(h,{colSpan:i,className:"p-0",children:e.jsxs("div",{className:"bg-muted/30 px-4 py-3",children:[e.jsxs("p",{className:"mb-2 text-xs font-semibold uppercase tracking-wide text-muted-foreground",children:["Classement — ",r,!n&&` (${g} ans)`]}),u?e.jsx("div",{className:"space-y-1.5",children:[1,2,3].map(a=>e.jsx("div",{className:"h-6 w-full rounded bg-muted animate-pulse motion-reduce:animate-none"},a))}):!d||d.length===0?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Aucune donnée de classement."}):e.jsxs("table",{className:"w-full text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-muted-foreground",children:[e.jsx("th",{className:"w-8 py-1 text-left",children:"#"}),e.jsx("th",{className:"py-1 text-left",children:"Nageur"}),e.jsx("th",{className:"w-[80px] py-1 text-left",children:"Temps"}),n&&e.jsx("th",{className:"w-[40px] py-1 text-left",children:"Âge"}),e.jsx("th",{className:"hidden w-[80px] py-1 text-left sm:table-cell",children:"Date"})]})}),e.jsx("tbody",{children:d.map((a,m)=>e.jsxs("tr",{className:_("border-t border-border/50",m===0&&"font-semibold text-primary"),children:[e.jsx("td",{className:"py-1",children:m===0?e.jsx(I,{className:"inline h-3 w-3 text-yellow-500"}):m+1}),e.jsx("td",{className:"py-1",children:a.athlete_name}),e.jsx("td",{className:"py-1 font-mono tabular-nums",children:$(a.time_ms)}),n&&e.jsx("td",{className:"py-1 text-muted-foreground",children:a.age}),e.jsx("td",{className:"hidden py-1 text-muted-foreground sm:table-cell",children:D(a.record_date)})]},a.id))})]})]})})})]})}export{pe as default};
