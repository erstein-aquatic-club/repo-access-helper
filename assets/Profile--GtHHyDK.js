import{r as m,j as e,c as he,u as B,d as A}from"./vendor-query-BiSH4r2z.js";import{c as ge,H as je,J as ve,G as Ne,r as I,a as E,u as we,d as be,S as f,C as F,h as V,g as L,B as N,L as x,I as b,j as Se,l as ye,R as Ce,i as _e,o as Fe}from"./index-AQJx-bCr.js";import{a as C}from"./api-CT4965yV.js";import{C as Le,a as Pe,b as Re}from"./collapsible-nmHcyaeB.js";import{T as Ae}from"./textarea-hp2SskBm.js";import{S as Ie,a as Ee,b as ke,c as Me,d as Te}from"./select-DURImCHb.js";import{B as Ue}from"./badge-BmoHRasd.js";import{S as $e,a as De,b as qe,c as Be,d as Ve}from"./sheet-Dhb0eYQi.js";import{u as H,t as G,o as z,s as w,l as He}from"./types-D6NFhoV1.js";import{f as Ge}from"./animations-CrcLFysI.js";import{C as Oe}from"./circle-alert-KbUCFDRW.js";import{m as ze}from"./proxy-Dh0N-Z8G.js";import{P as Ke}from"./pen-C8orV0Fg.js";import{S as Qe}from"./save-mGlH2kFH.js";import{C as We}from"./chevron-right-BrtQbrlZ.js";import"./vendor-react-BzrpNAyj.js";import"./vendor-supabase-6k692oZB.js";import"./swim-C_-X8mId.js";import"./index-DlbB1B3d.js";import"./chevron-down-CCJpk06U.js";import"./check-Bfd-iumc.js";import"./chevron-up-BGsP-4NW.js";import"./index-C8wJM1Ai.js";import"./design-tokens-CKgCpdH6.js";/**
 * @license lucide-react v0.545.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ze=[["path",{d:"m16 17 5-5-5-5",key:"1bji2h"}],["path",{d:"M21 12H9",key:"dn1m92"}],["path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4",key:"1uf3rs"}]],Je=ge("log-out",Ze);function Xe(s,t=[]){let i=[];function l(a,d){const u=m.createContext(d);u.displayName=a+"Context";const p=i.length;i=[...i,d];const h=g=>{const{scope:S,children:y,...o}=g,v=S?.[s]?.[p]||u,c=m.useMemo(()=>o,Object.values(o));return e.jsx(v.Provider,{value:c,children:y})};h.displayName=a+"Provider";function j(g,S){const y=S?.[s]?.[p]||u,o=m.useContext(y);if(o)return o;if(d!==void 0)return d;throw new Error(`\`${g}\` must be used within \`${a}\``)}return[h,j]}const n=()=>{const a=i.map(d=>m.createContext(d));return function(u){const p=u?.[s]||a;return m.useMemo(()=>({[`__scope${s}`]:{...u,[s]:p}}),[u,p])}};return n.scopeName=s,[l,Ye(n,...t)]}function Ye(...s){const t=s[0];if(s.length===1)return t;const i=()=>{const l=s.map(n=>({useScope:n(),scopeName:n.scopeName}));return function(a){const d=l.reduce((u,{useScope:p,scopeName:h})=>{const g=p(a)[`__scope${h}`];return{...u,...g}},{});return m.useMemo(()=>({[`__scope${t.scopeName}`]:d}),[d])}};return i.scopeName=t.scopeName,i}var es=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"],k=es.reduce((s,t)=>{const i=je(`Primitive.${t}`),l=m.forwardRef((n,a)=>{const{asChild:d,...u}=n,p=d?i:t;return typeof window<"u"&&(window[Symbol.for("radix-ui")]=!0),e.jsx(p,{...u,ref:a})});return l.displayName=`Primitive.${t}`,{...s,[t]:l}},{});function ss(){return ve.useSyncExternalStore(rs,()=>!0,()=>!1)}function rs(){return()=>{}}var M="Avatar",[ts]=Xe(M),[as,K]=ts(M),Q=m.forwardRef((s,t)=>{const{__scopeAvatar:i,...l}=s,[n,a]=m.useState("idle");return e.jsx(as,{scope:i,imageLoadingStatus:n,onImageLoadingStatusChange:a,children:e.jsx(k.span,{...l,ref:t})})});Q.displayName=M;var W="AvatarImage",Z=m.forwardRef((s,t)=>{const{__scopeAvatar:i,src:l,onLoadingStatusChange:n=()=>{},...a}=s,d=K(W,i),u=is(l,a),p=Ne(h=>{n(h),d.onImageLoadingStatusChange(h)});return I(()=>{u!=="idle"&&p(u)},[u,p]),u==="loaded"?e.jsx(k.img,{...a,ref:t,src:l}):null});Z.displayName=W;var J="AvatarFallback",X=m.forwardRef((s,t)=>{const{__scopeAvatar:i,delayMs:l,...n}=s,a=K(J,i),[d,u]=m.useState(l===void 0);return m.useEffect(()=>{if(l!==void 0){const p=window.setTimeout(()=>u(!0),l);return()=>window.clearTimeout(p)}},[l]),d&&a.imageLoadingStatus!=="loaded"?e.jsx(k.span,{...n,ref:t}):null});X.displayName=J;function O(s,t){return s?t?(s.src!==t&&(s.src=t),s.complete&&s.naturalWidth>0?"loaded":"loading"):"error":"idle"}function is(s,{referrerPolicy:t,crossOrigin:i}){const l=ss(),n=m.useRef(null),a=l?(n.current||(n.current=new window.Image),n.current):null,[d,u]=m.useState(()=>O(a,s));return I(()=>{u(O(a,s))},[a,s]),I(()=>{const p=g=>()=>{u(g)};if(!a)return;const h=p("loaded"),j=p("error");return a.addEventListener("load",h),a.addEventListener("error",j),t&&(a.referrerPolicy=t),typeof i=="string"&&(a.crossOrigin=i),()=>{a.removeEventListener("load",h),a.removeEventListener("error",j)}},[a,i,t]),d}var Y=Q,ee=Z,se=X;const re=m.forwardRef(({className:s,...t},i)=>e.jsx(Y,{ref:i,className:E("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",s),...t}));re.displayName=Y.displayName;const te=m.forwardRef(({className:s,...t},i)=>e.jsx(ee,{ref:i,className:E("aspect-square h-full w-full",s),...t}));te.displayName=ee.displayName;const ae=m.forwardRef(({className:s,...t},i)=>e.jsx(se,{ref:i,className:E("flex h-full w-full items-center justify-center rounded-full bg-muted",s),...t}));ae.displayName=se.displayName;const ns=s=>s!=="coach"&&s!=="admin"&&s!=="comite",os=s=>{switch(s){case"coach":return"Entraineur EAC";case"admin":return"Admin";case"comite":return"Comité";default:return"Nageur"}};function cs(s){if(!s)return"-";const t=new Date(s);return Number.isNaN(t.getTime())?s:t.toLocaleDateString("fr-FR")}const ls=z({group_id:w().optional(),objectives:w().optional(),bio:w().optional(),avatar_url:w().url("URL invalide").optional().or(He("")),birthdate:w().optional().refine(s=>{if(!s)return!0;const t=new Date(s);if(isNaN(t.getTime()))return!1;const i=(new Date().getTime()-t.getTime())/(1e3*60*60*24*365.25);return i>=6&&i<=100},{message:"L'âge doit être entre 6 et 100 ans"}),ffn_iuf:w().optional().refine(s=>s?/^\d+$/.test(s):!0,{message:"L'IUF FFN doit être un nombre"})}),ds=z({password:w().min(8,"Le mot de passe doit contenir au moins 8 caractères").regex(/[A-Z]/,"Le mot de passe doit contenir au moins une majuscule").regex(/\d/,"Le mot de passe doit contenir au moins un chiffre"),confirmPassword:w()}).refine(s=>s.password===s.confirmPassword,{message:"Les mots de passe ne correspondent pas",path:["confirmPassword"]});function Ms(){const{user:s,userId:t,logout:i,role:l}=we(),{toast:n}=be(),a=he(),d=ns(l),u=l==="athlete"||l==="coach"||l==="admin",p=os(l),[h,j]=m.useState(!1),[g,S]=m.useState(!1),y=async()=>{S(!0),localStorage.removeItem("app_build_timestamp");try{const r=window.__pwaRegistration??await navigator.serviceWorker?.getRegistration();if(r&&(await r.update(),await new Promise(R=>setTimeout(R,1500))),"caches"in window){const R=await caches.keys();await Promise.all(R.map(xe=>caches.delete(xe)))}window.location.reload()}catch{window.location.reload()}},o=H({resolver:G(ls),defaultValues:{group_id:"",objectives:"",bio:"",avatar_url:"",birthdate:"",ffn_iuf:""}}),v=H({resolver:G(ds),defaultValues:{password:"",confirmPassword:""}}),{data:c,isLoading:ie,error:ne,refetch:oe}=B({queryKey:["profile",s,t],queryFn:()=>C.getProfile({displayName:s,userId:t}),enabled:!!s}),{data:T=[],isLoading:U,error:ce,refetch:le}=B({queryKey:["profile-groups"],queryFn:()=>C.getGroups(),enabled:!!s}),$=ne||ce,de=()=>{oe(),le()},ue=m.useMemo(()=>{const r=c?.avatar_url;return r||(s?`https://api.dicebear.com/7.x/initials/svg?seed=${encodeURIComponent(s)}`:"")},[c,s]),P=A({mutationFn:r=>C.updateProfile({userId:t,profile:{group_id:r.group_id?Number(r.group_id):null,birthdate:r.birthdate||null,objectives:r.objectives,bio:r.bio,avatar_url:r.avatar_url,ffn_iuf:(r.ffn_iuf||"").trim()||null}}),onSuccess:()=>{a.invalidateQueries({queryKey:["profile"]}),j(!1),n({title:"Profil mis à jour"})},onError:r=>{n({title:"Mise à jour impossible",description:String(r?.message||r),variant:"destructive"})}}),D=A({mutationFn:r=>C.authPasswordUpdate(r),onSuccess:()=>{v.reset(),n({title:"Mot de passe mis à jour"})},onError:r=>{n({title:"Mise à jour impossible",description:String(r?.message||r),variant:"destructive"})}}),_=A({mutationFn:async()=>{const r=String(c?.ffn_iuf??"").trim();if(!r)throw new Error("IUF FFN manquant. Ajoutez-le dans votre profil.");return C.syncFfnSwimRecords({athleteId:t??void 0,athleteName:s??void 0,iuf:r})},onSuccess:r=>{a.invalidateQueries({queryKey:["swim-records"]}),n({title:"Records FFN importés",description:`${r?.inserted??0} ajouté(s), ${r?.updated??0} mis à jour, ${r?.skipped??0} inchangé(s)`})},onError:r=>{n({title:"Import FFN impossible",description:String(r?.message||r),variant:"destructive"})}}),me=()=>{o.reset({group_id:c?.group_id?String(c.group_id):"",objectives:c?.objectives||"",bio:c?.bio||"",avatar_url:c?.avatar_url||"",birthdate:c?.birthdate?String(c.birthdate).split("T")[0]:"",ffn_iuf:c?.ffn_iuf?String(c.ffn_iuf):""}),j(!0)},pe=o.handleSubmit(r=>{P.mutate(r)}),fe=v.handleSubmit(r=>{D.mutate({password:r.password})}),q=T.find(r=>r.id===c?.group_id)?.name||c?.group_label||"Non défini";return ie?e.jsxs("div",{className:"space-y-6",children:[e.jsx(f,{className:"h-10 w-32"}),e.jsxs(F,{children:[e.jsx(V,{children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(f,{className:"h-16 w-16 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-6 w-32"}),e.jsx(f,{className:"h-4 w-24"})]})]})}),e.jsx(L,{children:e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 w-16"}),e.jsx(f,{className:"h-5 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 w-24"}),e.jsx(f,{className:"h-5 w-20"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 w-20"}),e.jsx(f,{className:"h-5 w-28"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(f,{className:"h-4 w-16"}),e.jsx(f,{className:"h-5 w-32"})]}),e.jsxs("div",{className:"col-span-2 space-y-2",children:[e.jsx(f,{className:"h-4 w-12"}),e.jsx(f,{className:"h-12 w-full"})]})]})})]})]}):$?e.jsxs("div",{className:"flex flex-col items-center justify-center p-8 text-center",children:[e.jsx(Oe,{className:"h-12 w-12 text-destructive mb-4"}),e.jsx("h3",{className:"font-semibold",children:"Impossible de charger les données"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-2",children:$.message}),e.jsx(N,{onClick:()=>de(),className:"mt-4",children:"Réessayer"})]}):e.jsxs(ze.div,{className:"space-y-6",variants:Ge,initial:"hidden",animate:"visible",children:[e.jsx("div",{className:"rounded-xl bg-accent text-accent-foreground p-5",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(re,{className:"h-20 w-20 ring-2 ring-primary ring-offset-2 ring-offset-accent",children:[e.jsx(te,{src:ue,alt:s||"Profil"}),e.jsx(ae,{className:"text-lg",children:(s||"?").slice(0,2).toUpperCase()})]}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("h1",{className:"text-2xl font-display font-bold uppercase italic text-accent-foreground truncate",children:s}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mt-1",children:[e.jsx(Ue,{variant:"secondary",className:"text-xs",children:p}),e.jsx("span",{className:"text-sm opacity-80",children:q})]}),d&&String(c?.ffn_iuf??"").trim()&&e.jsxs("p",{className:"text-xs opacity-60 mt-1",children:["IUF ",c?.ffn_iuf]})]}),e.jsx(N,{variant:"ghost",size:"icon",className:"shrink-0 text-accent-foreground hover:bg-accent-foreground/10",onClick:me,"aria-label":"Modifier le profil",children:e.jsx(Ke,{className:"h-4 w-4"})})]})}),e.jsx(F,{children:e.jsx(L,{className:"space-y-4 pt-6",children:e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx(x,{className:"text-xs text-muted-foreground uppercase",children:"Groupe"}),e.jsx("div",{className:"font-medium",children:q})]}),e.jsxs("div",{children:[e.jsx(x,{className:"text-xs text-muted-foreground uppercase",children:"Date de naissance"}),e.jsx("div",{className:"font-medium",children:cs(c?.birthdate??null)})]}),d?e.jsxs("div",{children:[e.jsx(x,{className:"text-xs text-muted-foreground uppercase",children:"IUF FFN"}),e.jsx("div",{className:"font-medium",children:String(c?.ffn_iuf??"")||"Non renseigné"})]}):null,e.jsxs("div",{className:d?"":"col-span-2",children:[e.jsx(x,{className:"text-xs text-muted-foreground uppercase",children:"Objectifs"}),e.jsx("div",{className:"font-medium",children:c?.objectives||"Aucun objectif défini."})]}),e.jsxs("div",{className:"col-span-2",children:[e.jsx(x,{className:"text-xs text-muted-foreground uppercase",children:"Bio"}),e.jsx("div",{className:"font-medium",children:c?.bio||"Non renseignée."})]})]})})}),e.jsx($e,{open:h,onOpenChange:j,children:e.jsxs(De,{side:"bottom",className:"max-h-[85vh] overflow-y-auto",children:[e.jsxs(qe,{children:[e.jsx(Be,{children:"Modifier le profil"}),e.jsx(Ve,{children:"Mettez à jour vos informations personnelles."})]}),e.jsxs("form",{onSubmit:pe,className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"Groupe"}),e.jsxs(Ie,{value:o.watch("group_id"),onValueChange:r=>o.setValue("group_id",r),disabled:U,children:[e.jsx(Ee,{children:e.jsx(ke,{placeholder:U?"Chargement...":"Choisir un groupe"})}),e.jsx(Me,{children:T.map(r=>e.jsx(Te,{value:String(r.id),children:r.name},r.id))})]})]}),d?e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"IUF FFN"}),e.jsx(b,{...o.register("ffn_iuf"),placeholder:"879576",inputMode:"numeric"}),o.formState.errors.ffn_iuf&&e.jsx("p",{className:"text-xs text-destructive",role:"alert","aria-live":"assertive",children:o.formState.errors.ffn_iuf.message}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Identifiant unique FFN (utilisé pour importer vos records compétition)."})]}):null,e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"Objectifs"}),e.jsx(b,{...o.register("objectives")}),o.formState.errors.objectives&&e.jsx("p",{className:"text-xs text-destructive",role:"alert","aria-live":"assertive",children:o.formState.errors.objectives.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"Bio"}),e.jsx(Ae,{...o.register("bio")}),o.formState.errors.bio&&e.jsx("p",{className:"text-xs text-destructive",role:"alert","aria-live":"assertive",children:o.formState.errors.bio.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"Avatar (URL)"}),e.jsx(b,{...o.register("avatar_url"),placeholder:"https://..."}),o.formState.errors.avatar_url&&e.jsx("p",{className:"text-xs text-destructive",role:"alert","aria-live":"assertive",children:o.formState.errors.avatar_url.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"Date de naissance"}),e.jsx(b,{type:"date",...o.register("birthdate")}),o.formState.errors.birthdate&&e.jsx("p",{className:"text-xs text-destructive",role:"alert","aria-live":"assertive",children:o.formState.errors.birthdate.message})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(N,{type:"submit",disabled:P.isPending,className:"w-full",children:[e.jsx(Qe,{className:"mr-2 h-4 w-4"}),"Enregistrer"]}),e.jsx(N,{type:"button",variant:"outline",onClick:()=>j(!1),disabled:P.isPending,children:"Annuler"})]})]})]})}),d?e.jsxs(F,{children:[e.jsxs(V,{children:[e.jsx(Se,{children:"FFN & Records"}),e.jsx(ye,{children:"Gérez vos records de natation et l'import FFN."})]}),e.jsxs(L,{className:"space-y-3",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["IUF enregistré : ",e.jsx("span",{className:"font-medium text-foreground",children:String(c?.ffn_iuf??"")||"—"})]}),e.jsxs(N,{className:"w-full gap-2",onClick:()=>_.mutate(),disabled:_.isPending||!String(c?.ffn_iuf??"").trim(),children:[e.jsx(Ce,{className:["h-4 w-4",_.isPending?"animate-spin":""].join(" ")}),_.isPending?"Import en cours...":"Récupérer records depuis FFN"]}),String(c?.ffn_iuf??"").trim()?null:e.jsx("div",{className:"text-xs text-muted-foreground",children:"Ajoutez votre IUF FFN dans le profil (bouton crayon) pour activer l'import."}),e.jsx(_e,{href:"/records",children:e.jsx(N,{variant:"outline",className:"w-full",children:"Voir mes records"})})]})]}):null,u?e.jsxs(Le,{className:"group",children:[e.jsx(Pe,{asChild:!0,children:e.jsxs("button",{className:"flex items-center gap-2 w-full text-left py-3 px-1 text-sm font-semibold uppercase tracking-wider text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(We,{className:"h-4 w-4 transition-transform duration-200 group-data-[state=open]:rotate-90"}),"Sécurité"]})}),e.jsx(Re,{children:e.jsx(F,{children:e.jsx(L,{className:"pt-4",children:e.jsxs("form",{onSubmit:fe,className:"space-y-3",children:[e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"Nouveau mot de passe"}),e.jsx(b,{type:"password",...v.register("password"),placeholder:"••••••••"}),v.formState.errors.password&&e.jsx("p",{className:"text-xs text-destructive",role:"alert","aria-live":"assertive",children:v.formState.errors.password.message})]}),e.jsxs("div",{className:"grid gap-2",children:[e.jsx(x,{children:"Confirmer"}),e.jsx(b,{type:"password",...v.register("confirmPassword"),placeholder:"••••••••"}),v.formState.errors.confirmPassword&&e.jsx("p",{className:"text-xs text-destructive",role:"alert","aria-live":"assertive",children:v.formState.errors.confirmPassword.message})]}),e.jsx(N,{type:"submit",className:"w-full",disabled:D.isPending,children:"Mettre à jour le mot de passe"})]})})})})]}):null,e.jsxs(N,{variant:"destructive",onClick:i,className:"w-full gap-2",children:[e.jsx(Je,{className:"h-4 w-4"}),"Se déconnecter"]}),e.jsxs("div",{className:"space-y-1 pt-2",children:[e.jsxs("button",{type:"button",onClick:y,disabled:g,className:"w-full flex items-center justify-center gap-2 text-xs text-muted-foreground hover:text-foreground transition-colors py-2",children:[e.jsx(Fe,{className:["h-3 w-3",g?"animate-bounce":""].join(" ")}),g?"Recherche en cours...":"Rechercher des mises à jour"]}),e.jsxs("p",{className:"text-[10px] text-center text-muted-foreground/60",children:["Version du ",new Date("2026-02-21T14:31:15.670Z").toLocaleDateString("fr-FR",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]})}export{Ms as default,os as getRoleLabel,ns as shouldShowRecords};
